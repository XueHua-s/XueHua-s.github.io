import{j as l}from"./jsx-runtime.D_zvdyIk.js";import{a as k}from"./design-tokens.BqHQxG4B.js";import{r as y}from"./index.vDeobAm6.js";import{a as ee}from"./useMediaQuery.C_H-pvMT.js";import{d as I,H as te,u as ne,a as se,b as re,c as oe,f as ie}from"./blogLayoutConfig.b5Oa9FIj.js";import{A as R,R as le}from"./router.hwxBaD47.js";import{f as b,g as _,r as ce,n as ae,v as ue,h as fe,o as de,q as ge,c as pe,s as me,t as he,u as ve,a as S,b as xe,w as ye,m as H}from"./proxy.k8ZnVpfL.js";import{a as we}from"./use-spring._Izv2XOx.js";import{u as be,a as Ee,c as He,e as Se,f as Le,d as je,F as Ce,g as Oe}from"./useFloatingUI.IuZR6R1N.js";import{c as ze}from"./utils.BEHD0UYf.js";import"./_commonjsHelpers.CqkleIqs.js";import"./index.CVgE1JxM.js";function $(e,t){let s;const n=()=>{const{currentTime:r}=t,c=(r===null?0:r.value)/100;s!==c&&e(c),s=c};return b.update(n,!0),()=>_(n)}const L=new WeakMap;let h;function Ne(e,t){if(t){const{inlineSize:s,blockSize:n}=t[0];return{width:s,height:n}}else return e instanceof SVGElement&&"getBBox"in e?e.getBBox():{width:e.offsetWidth,height:e.offsetHeight}}function ke({target:e,contentRect:t,borderBoxSize:s}){var n;(n=L.get(e))===null||n===void 0||n.forEach(r=>{r({target:e,contentSize:t,get size(){return Ne(e,s)}})})}function Te(e){e.forEach(ke)}function Ie(){typeof ResizeObserver>"u"||(h=new ResizeObserver(Te))}function Re(e,t){h||Ie();const s=ce(e);return s.forEach(n=>{let r=L.get(n);r||(r=new Set,L.set(n,r)),r.add(t),h?.observe(n)}),()=>{s.forEach(n=>{const r=L.get(n);r?.delete(t),r?.size||h?.unobserve(n)})}}const j=new Set;let E;function Pe(){E=()=>{const e={width:window.innerWidth,height:window.innerHeight},t={target:window,size:e,contentSize:e};j.forEach(s=>s(t))},window.addEventListener("resize",E)}function We(e){return j.add(e),E||Pe(),()=>{j.delete(e),!j.size&&E&&(E=void 0)}}function Fe(e,t){return typeof e=="function"?We(e):Re(e,t)}const Me=50,F=()=>({current:0,offset:[],progress:0,scrollLength:0,targetOffset:0,targetLength:0,containerLength:0,velocity:0}),Ae=()=>({time:0,x:F(),y:F()}),Be={x:{length:"Width",position:"Left"},y:{length:"Height",position:"Top"}};function M(e,t,s,n){const r=s[t],{length:o,position:c}=Be[t],f=r.current,a=s.time;r.current=e[`scroll${c}`],r.scrollLength=e[`scroll${o}`]-e[`client${o}`],r.offset.length=0,r.offset[0]=0,r.offset[1]=r.scrollLength,r.progress=ae(0,r.scrollLength,r.current);const g=n-a;r.velocity=g>Me?0:ue(r.current-f,g)}function qe(e,t,s){M(e,"x",t,s),M(e,"y",t,s),t.time=s}function De(e,t){const s={x:0,y:0};let n=e;for(;n&&n!==t;)if(n instanceof HTMLElement)s.x+=n.offsetLeft,s.y+=n.offsetTop,n=n.offsetParent;else if(n.tagName==="svg"){const r=n.getBoundingClientRect();n=n.parentElement;const o=n.getBoundingClientRect();s.x+=r.left-o.left,s.y+=r.top-o.top}else if(n instanceof SVGGraphicsElement){const{x:r,y:o}=n.getBBox();s.x+=r,s.y+=o;let c=null,f=n.parentNode;for(;!c;)f.tagName==="svg"&&(c=f),f=n.parentNode;n=c}else break;return s}const T={start:0,center:.5,end:1};function A(e,t,s=0){let n=0;if(e in T&&(e=T[e]),typeof e=="string"){const r=parseFloat(e);e.endsWith("px")?n=r:e.endsWith("%")?e=r/100:e.endsWith("vw")?n=r/100*document.documentElement.clientWidth:e.endsWith("vh")?n=r/100*document.documentElement.clientHeight:e=r}return typeof e=="number"&&(n=t*e),s+n}const Ye=[0,0];function Ve(e,t,s,n){let r=Array.isArray(e)?e:Ye,o=0,c=0;return typeof e=="number"?r=[e,e]:typeof e=="string"&&(e=e.trim(),e.includes(" ")?r=e.split(" "):r=[e,T[e]?e:"0"]),o=A(r[0],s,n),c=A(r[1],t),o-c}const _e={All:[[0,0],[1,1]]},$e={x:0,y:0};function Xe(e){return"getBBox"in e&&e.tagName!=="svg"?e.getBBox():{width:e.clientWidth,height:e.clientHeight}}function Ge(e,t,s){const{offset:n=_e.All}=s,{target:r=e,axis:o="y"}=s,c=o==="y"?"height":"width",f=r!==e?De(r,e):$e,a=r===e?{width:e.scrollWidth,height:e.scrollHeight}:Xe(r),g={width:e.clientWidth,height:e.clientHeight};t[o].offset.length=0;let i=!t[o].interpolate;const m=n.length;for(let u=0;u<m;u++){const d=Ve(n[u],g[c],a[c],f[o]);!i&&d!==t[o].interpolatorOffsets[u]&&(i=!0),t[o].offset[u]=d}i&&(t[o].interpolate=fe(t[o].offset,de(n),{clamp:!1}),t[o].interpolatorOffsets=[...t[o].offset]),t[o].progress=ge(0,1,t[o].interpolate(t[o].current))}function Je(e,t=e,s){if(s.x.targetOffset=0,s.y.targetOffset=0,t!==e){let n=t;for(;n&&n!==e;)s.x.targetOffset+=n.offsetLeft,s.y.targetOffset+=n.offsetTop,n=n.offsetParent}s.x.targetLength=t===e?t.scrollWidth:t.clientWidth,s.y.targetLength=t===e?t.scrollHeight:t.clientHeight,s.x.containerLength=e.clientWidth,s.y.containerLength=e.clientHeight}function Qe(e,t,s,n={}){return{measure:()=>Je(e,n.target,s),update:r=>{qe(e,s,r),(n.offset||n.target)&&Ge(e,s,n)},notify:()=>t(s)}}const w=new WeakMap,B=new WeakMap,z=new WeakMap,q=e=>e===document.documentElement?window:e;function P(e,{container:t=document.documentElement,...s}={}){let n=z.get(t);n||(n=new Set,z.set(t,n));const r=Ae(),o=Qe(t,e,r,s);if(n.add(o),!w.has(t)){const f=()=>{for(const u of n)u.measure()},a=()=>{for(const u of n)u.update(pe.timestamp)},g=()=>{for(const u of n)u.notify()},i=()=>{b.read(f,!1,!0),b.read(a,!1,!0),b.update(g,!1,!0)};w.set(t,i);const m=q(t);window.addEventListener("resize",i,{passive:!0}),t!==document.documentElement&&B.set(t,Fe(t,i)),m.addEventListener("scroll",i,{passive:!0})}const c=w.get(t);return b.read(c,!1,!0),()=>{var f;_(c);const a=z.get(t);if(!a||(a.delete(o),a.size))return;const g=w.get(t);w.delete(t),g&&(q(t).removeEventListener("scroll",g),(f=B.get(t))===null||f===void 0||f(),window.removeEventListener("resize",g))}}function Ue({source:e,container:t,axis:s="y"}){e&&(t=e);const n={value:0},r=P(o=>{n.value=o[s].progress*100},{container:t,axis:s});return{currentTime:n,cancel:r}}const N=new Map;function X({source:e,container:t=document.documentElement,axis:s="y"}={}){e&&(t=e),N.has(t)||N.set(t,{});const n=N.get(t);return n[s]||(n[s]=he()?new ScrollTimeline({source:t,axis:s}):Ue({source:t,axis:s})),n[s]}function Ke(e){return e.length===2}function G(e){return e&&(e.target||e.offset)}function Ze(e,t){return Ke(e)||G(t)?P(s=>{e(s[t.axis].progress,s)},t):$(e,X(t))}function et(e,t){if(e.flatten(),G(t))return e.pause(),P(s=>{e.time=e.duration*s[t.axis].progress},t);{const s=X(t);return e.attachTimeline?e.attachTimeline(s,n=>(n.pause(),$(r=>{n.time=n.duration*r},s))):me}}function tt(e,{axis:t="y",...s}={}){const n={axis:t,...s};return typeof e=="function"?Ze(e,n):et(e,n)}function D(e,t){ye(!!(!t||t.current))}const nt=()=>({scrollX:S(0),scrollY:S(0),scrollXProgress:S(0),scrollYProgress:S(0)});function st({container:e,target:t,layoutEffect:s=!0,...n}={}){const r=ve(nt);return(s?xe:y.useEffect)(()=>(D("target",t),D("container",e),tt((c,{x:f,y:a})=>{r.scrollX.set(f.current),r.scrollXProgress.set(f.progress),r.scrollY.set(a.current),r.scrollYProgress.set(a.progress)},{...n,container:e?.current||void 0,target:t?.current||void 0})),[e,t,JSON.stringify(n.offset)]),r}function rt(e){let t=null;const s=new Set;let n=null;const r=new Map,o=()=>{s.forEach(i=>i())},c=i=>{t?.id!==i?.id&&(t=i,o())},f=()=>{if(r.size===0)return;let i="",m=Number.POSITIVE_INFINITY,u=null;if(r.forEach(({top:d,element:p},v)=>{d<m&&(m=d,i=v,u=p)}),u&&i){const d=parseInt(u.tagName.substring(1),10);c({id:i,text:u.textContent?.trim()||"",level:d})}},a=()=>{n&&n.disconnect(),r.clear(),t=null;const i=document.querySelector(".custom-content")??document.querySelector("article");if(!i)return;const m=`-${e}px 0px -70% 0px`;n=new IntersectionObserver(d=>{for(const p of d){const v=p.target,x=v.id;x&&(p.isIntersecting?r.set(x,{top:p.boundingClientRect.top,element:v}):r.delete(x))}f()},{rootMargin:m,threshold:0});const u=Array.from(i.querySelectorAll("h2, h3")).filter(d=>!d.closest(".link-preview-block"));u.forEach(d=>{d.id&&n?.observe(d)}),u.length>0&&r.size===0&&requestAnimationFrame(()=>{for(let d=u.length-1;d>=0;d--){const p=u[d];if(p.getBoundingClientRect().top<e&&p.id){const x=parseInt(p.tagName.substring(1),10);c({id:p.id,text:p.textContent?.trim()||"",level:x});break}}})},g=()=>{r.clear(),t=null,requestAnimationFrame(()=>{a()})};return{subscribe:i=>(s.size===0&&(requestAnimationFrame(()=>{requestAnimationFrame(()=>{a()})}),document.addEventListener("astro:page-load",g)),s.add(i),()=>{s.delete(i),s.size===0&&(n&&(n.disconnect(),n=null),document.removeEventListener("astro:page-load",g),r.clear())}),getSnapshot:()=>t,getServerSnapshot:()=>null}}function ot({offsetTop:e=80}={}){const t=y.useMemo(()=>rt(e),[e]);return y.useSyncExternalStore(t.subscribe,t.getSnapshot,t.getServerSnapshot)}function it({heading:e,className:t}){const s=I();return l.jsx(R,{mode:"wait",children:e&&l.jsx(H.span,{className:`block truncate text-sm font-medium ${t||""}`,initial:s?{opacity:0}:{opacity:0,y:20,filter:"blur(4px)"},animate:s?{opacity:1}:{opacity:1,y:0,filter:"blur(0px)"},exit:s?{opacity:0}:{opacity:0,y:-12,filter:"blur(4px)"},transition:{default:{type:"spring",stiffness:400,damping:30},filter:{type:"tween",duration:.2,ease:"easeOut"}},children:e.text},e.id)})}function lt({size:e=28,strokeWidth:t=2,className:s}){const n=I(),{scrollYProgress:r}=st(),o=we(r,{stiffness:100,damping:30,restDelta:.001}),c=n?r:o,f=(e-t)/2,a=e/2;return l.jsxs("svg",{width:e,height:e,className:s,"aria-label":"阅读进度",role:"progressbar",style:{transform:"rotate(-90deg)"},children:[l.jsx("circle",{cx:a,cy:a,r:f,fill:"transparent",stroke:"currentColor",strokeWidth:t,className:"opacity-20"}),l.jsx(H.circle,{cx:a,cy:a,r:f,fill:"transparent",stroke:"currentColor",strokeWidth:t,strokeLinecap:"round",className:"text-primary",style:{pathLength:c}})]})}function ct({headings:e,activeId:t,expandedIds:s,onHeadingClick:n,trigger:r,open:o,onOpenChange:c,enableNumbering:f=!0}){const[a,g]=be({value:o,defaultValue:!1,onChange:c}),{refs:i,floatingStyles:m,context:u}=Ee({open:a,onOpenChange:g,placement:"bottom-start",offset:8,transform:!1}),d=He(u),p=Se(u,{ancestorScroll:!0}),v=Le(u),{getReferenceProps:x,getFloatingProps:J}=je([d,p,v]),C=y.useRef(null),O=y.useRef(null);y.useEffect(()=>{C.current&&i.setReference(C.current)},[i]),y.useEffect(()=>{a&&O.current&&i.setFloating(O.current)},[a,i]);const Q=Z=>{n(Z),g(!1)},{className:W,...U}=x(),K=J();return l.jsxs(l.Fragment,{children:[l.jsx("span",{ref:C,className:ze("contents",typeof W=="string"?W:void 0),...U,children:r}),l.jsx(R,{children:a&&l.jsx(Ce,{children:l.jsx(Oe,{context:u,modal:!1,children:l.jsx(H.div,{ref:O,style:m,className:"bg-background/80 border-border z-50 max-h-[60vh] w-72 overflow-auto rounded-2xl border p-3 backdrop-blur-md",initial:{opacity:0,scale:.85},animate:{opacity:1,scale:1,originY:0},exit:{opacity:0,scale:.85},transition:k.spring.popoverContent,...K,children:l.jsx("nav",{className:f?"":"toc-no-numbering","aria-label":"文章目录",children:l.jsx("div",{className:"space-y-1",children:l.jsx(te,{headings:e,depth:0,activeId:t,expandedIds:s,onHeadingClick:Q})})})})})})})]})}const Y=80;function V({logoElement:e,logoText:t,logoSrc:s}){return l.jsx("a",{href:le.Home,className:"flex items-center gap-1",children:e==="svg"&&s?l.jsx("img",{src:s,alt:ie?.alternate,className:"h-8",height:32}):l.jsx("span",{className:"logo-text text-primary",children:t})})}function bt({isPostPage:e,logoElement:t,logoText:s,logoSrc:n,enableNumbering:r=!0,sourceHeadings:o}){const c=I(),f=ee("(max-width: 992px)"),a=ot({offsetTop:Y}),g=ne(o),i=se({offsetTop:Y+40}),{expandedIds:m,setExpandedIds:u}=re({headings:g,activeId:i,defaultExpanded:!1}),d=e&&f&&g.length>0&&a!==null,p=oe({headings:g,setExpandedIds:u});return f?l.jsx("div",{className:"flex items-center gap-2",children:l.jsx(R,{mode:"wait",children:d?l.jsx(H.div,{className:"flex items-center",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:c?{duration:0}:k.spring.gentle,children:l.jsx(ct,{headings:g,activeId:i,expandedIds:m,onHeadingClick:p,enableNumbering:r,trigger:l.jsxs("button",{className:"bg-foreground/10 hover:bg-foreground/20 flex w-[calc(100vw-10.5rem)] items-center gap-2.5 rounded-full py-1 pr-3 pl-1.5 backdrop-blur-sm transition-colors","aria-label":"展开目录",children:[l.jsx("div",{className:"relative shrink-0",children:l.jsx(lt,{size:32,strokeWidth:2.5})}),l.jsx("div",{className:"overflow-hidden",children:l.jsx(it,{heading:a})})]})})},"heading-mode"):l.jsx(H.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:c?{duration:0}:k.spring.gentle,children:l.jsx(V,{logoElement:t,logoText:s,logoSrc:n})},"logo-mode")})}):l.jsx(V,{logoElement:t,logoText:s,logoSrc:n})}export{bt as MobilePostHeader};
