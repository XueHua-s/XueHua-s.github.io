import{j as e}from"./jsx-runtime.D_zvdyIk.js";import{a as C}from"./design-tokens.BqHQxG4B.js";import{r as b}from"./index.vDeobAm6.js";import{a as P}from"./useMediaQuery.C_H-pvMT.js";import{H as L,u as O,a as A,b as q,c as T}from"./HeadingList.CFds2oWA.js";import{u as N}from"./use-reduced-motion.G-muIoyJ.js";import{A as H}from"./index.CvmSC7dN.js";import{m as y}from"./proxy.DepoKxzr.js";import{u as _}from"./use-scroll.DCQs0f0o.js";import{u as z}from"./use-spring.DQe6yioT.js";import{u as D,a as Y,c as $,e as V,f as B,d as Q,F as U,g as G,R as J}from"./router.CzEfTywb.js";import{c as K}from"./utils.BEHD0UYf.js";import"./_commonjsHelpers.CqkleIqs.js";import"./index.CVgE1JxM.js";function X(n){let t=null;const r=new Set;let d=null;const a=new Map,g=()=>{r.forEach(s=>s())},m=s=>{t?.id!==s?.id&&(t=s,g())},p=()=>{if(a.size===0)return;let s="",f=Number.POSITIVE_INFINITY,i=null;if(a.forEach(({top:o,element:l},x)=>{o<f&&(f=o,s=x,i=l)}),i&&s){const o=parseInt(i.tagName.substring(1),10);m({id:s,text:i.textContent?.trim()||"",level:o})}},c=()=>{d&&d.disconnect(),a.clear(),t=null;const s=document.querySelector(".custom-content")??document.querySelector("article");if(!s)return;const f=`-${n}px 0px -70% 0px`;d=new IntersectionObserver(o=>{for(const l of o){const x=l.target,h=x.id;h&&(l.isIntersecting?a.set(h,{top:l.boundingClientRect.top,element:x}):a.delete(h))}p()},{rootMargin:f,threshold:0});const i=Array.from(s.querySelectorAll("h2, h3")).filter(o=>!o.closest(".link-preview-block"));i.forEach(o=>{o.id&&d?.observe(o)}),i.length>0&&a.size===0&&requestAnimationFrame(()=>{for(let o=i.length-1;o>=0;o--){const l=i[o];if(l.getBoundingClientRect().top<n&&l.id){const h=parseInt(l.tagName.substring(1),10);m({id:l.id,text:l.textContent?.trim()||"",level:h});break}}})},u=()=>{a.clear(),t=null,requestAnimationFrame(()=>{c()})};return{subscribe:s=>(r.size===0&&(requestAnimationFrame(()=>{requestAnimationFrame(()=>{c()})}),document.addEventListener("astro:page-load",u)),r.add(s),()=>{r.delete(s),r.size===0&&(d&&(d.disconnect(),d=null),document.removeEventListener("astro:page-load",u),a.clear())}),getSnapshot:()=>t,getServerSnapshot:()=>null}}function Z({offsetTop:n=80}={}){const t=b.useMemo(()=>X(n),[n]);return b.useSyncExternalStore(t.subscribe,t.getSnapshot,t.getServerSnapshot)}function W({heading:n,className:t}){const r=N();return e.jsx(H,{mode:"wait",children:n&&e.jsx(y.span,{className:`block truncate text-sm font-medium ${t||""}`,initial:r?{opacity:0}:{opacity:0,y:20,filter:"blur(4px)"},animate:r?{opacity:1}:{opacity:1,y:0,filter:"blur(0px)"},exit:r?{opacity:0}:{opacity:0,y:-12,filter:"blur(4px)"},transition:{default:{type:"spring",stiffness:400,damping:30},filter:{type:"tween",duration:.2,ease:"easeOut"}},children:n.text},n.id)})}function ee({size:n=28,strokeWidth:t=2,className:r}){const d=N(),{scrollYProgress:a}=_(),g=z(a,{stiffness:100,damping:30,restDelta:.001}),m=d?a:g,p=(n-t)/2,c=n/2;return e.jsxs("svg",{width:n,height:n,className:r,"aria-label":"阅读进度",role:"progressbar",style:{transform:"rotate(-90deg)"},children:[e.jsx("circle",{cx:c,cy:c,r:p,fill:"transparent",stroke:"currentColor",strokeWidth:t,className:"opacity-20"}),e.jsx(y.circle,{cx:c,cy:c,r:p,fill:"transparent",stroke:"currentColor",strokeWidth:t,strokeLinecap:"round",className:"text-primary",style:{pathLength:m}})]})}function te({headings:n,activeId:t,expandedIds:r,onHeadingClick:d,trigger:a,open:g,onOpenChange:m,enableNumbering:p=!0}){const[c,u]=D({value:g,defaultValue:!1,onChange:m}),{refs:s,floatingStyles:f,context:i}=Y({open:c,onOpenChange:u,placement:"bottom-start",offset:8,transform:!1}),o=$(i),l=V(i,{ancestorScroll:!0}),x=B(i),{getReferenceProps:h,getFloatingProps:R}=Q([o,l,x]),v=b.useRef(null),j=b.useRef(null);b.useEffect(()=>{v.current&&s.setReference(v.current)},[s]),b.useEffect(()=>{c&&j.current&&s.setFloating(j.current)},[c,s]);const I=M=>{d(M),u(!1)},{className:S,...E}=h(),F=R();return e.jsxs(e.Fragment,{children:[e.jsx("span",{ref:v,className:K("contents",typeof S=="string"?S:void 0),...E,children:a}),e.jsx(H,{children:c&&e.jsx(U,{children:e.jsx(G,{context:i,modal:!1,children:e.jsx(y.div,{ref:j,style:f,className:"bg-background/80 border-border z-50 max-h-[60vh] w-72 overflow-auto rounded-2xl border p-3 backdrop-blur-md",initial:{opacity:0,scale:.85},animate:{opacity:1,scale:1,originY:0},exit:{opacity:0,scale:.85},transition:C.spring.popoverContent,...F,children:e.jsx("nav",{className:p?"":"toc-no-numbering","aria-label":"文章目录",children:e.jsx("div",{className:"space-y-1",children:e.jsx(L,{headings:n,depth:0,activeId:t,expandedIds:r,onHeadingClick:I})})})})})})})]})}const ne={alternate:"snow"};Array.from({length:13},(n,t)=>t+1).map(n=>`/img/cover/${n}.webp`);const k=80;function w({logoElement:n,logoText:t,logoSrc:r}){return e.jsx("a",{href:J.Home,className:"flex items-center gap-1",children:n==="svg"&&r?e.jsx("img",{src:r,alt:ne?.alternate,className:"h-8",height:32}):e.jsx("span",{className:"logo-text text-primary",children:t})})}function he({isPostPage:n,logoElement:t,logoText:r,logoSrc:d,enableNumbering:a=!0,sourceHeadings:g}){const m=N(),p=P("(max-width: 992px)"),c=Z({offsetTop:k}),u=O(g),s=A({offsetTop:k+40}),{expandedIds:f,setExpandedIds:i}=q({headings:u,activeId:s,defaultExpanded:!1}),o=n&&p&&u.length>0&&c!==null,l=T({headings:u,setExpandedIds:i});return p?e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(H,{mode:"wait",children:o?e.jsx(y.div,{className:"flex items-center",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:m?{duration:0}:C.spring.gentle,children:e.jsx(te,{headings:u,activeId:s,expandedIds:f,onHeadingClick:l,enableNumbering:a,trigger:e.jsxs("button",{className:"bg-foreground/10 hover:bg-foreground/20 flex w-[calc(100vw-10.5rem)] items-center gap-2.5 rounded-full py-1 pr-3 pl-1.5 backdrop-blur-sm transition-colors","aria-label":"展开目录",children:[e.jsx("div",{className:"relative shrink-0",children:e.jsx(ee,{size:32,strokeWidth:2.5})}),e.jsx("div",{className:"overflow-hidden",children:e.jsx(W,{heading:c})})]})})},"heading-mode"):e.jsx(y.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:m?{duration:0}:C.spring.gentle,children:e.jsx(w,{logoElement:t,logoText:r,logoSrc:d})},"logo-mode")})}):e.jsx(w,{logoElement:t,logoText:r,logoSrc:d})}export{he as MobilePostHeader};
