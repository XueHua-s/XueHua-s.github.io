import{j as e}from"./jsx-runtime.D_zvdyIk.js";import{a as N}from"./design-tokens.BqHQxG4B.js";import{r as b}from"./index.vDeobAm6.js";import{a as P}from"./useMediaQuery.C_H-pvMT.js";import{H as L,u as O,a as A,b as T,c as q}from"./HeadingList.B3rxGOWI.js";import{u as H}from"./use-reduced-motion.G-muIoyJ.js";import{A as S}from"./index.CvmSC7dN.js";import{m as y}from"./proxy.DepoKxzr.js";import{u as _}from"./use-scroll.DCQs0f0o.js";import{u as $}from"./use-spring.DQe6yioT.js";import{u as z,a as D,c as Y,e as V,f as B,d as Q,F as U,g as G,R as J}from"./router.CzEfTywb.js";import"./_commonjsHelpers.CqkleIqs.js";import"./utils.BEHD0UYf.js";import"./index.CVgE1JxM.js";function K(n){let t=null;const r=new Set;let l=null;const i=new Map,f=()=>{r.forEach(s=>s())},p=s=>{t?.id!==s?.id&&(t=s,f())},m=()=>{if(i.size===0)return;let s="",x=Number.POSITIVE_INFINITY,c=null;if(i.forEach(({top:a,element:u},d)=>{a<x&&(x=a,s=d,c=u)}),c&&s){const a=parseInt(c.tagName.substring(1),10);p({id:s,text:c.textContent?.trim()||"",level:a})}},o=()=>{l&&l.disconnect(),i.clear(),t=null;const s=document.querySelector("article");if(!s)return;const x=`-${n}px 0px -70% 0px`;l=new IntersectionObserver(a=>{for(const u of a){const d=u.target,h=d.id;h&&(u.isIntersecting?i.set(h,{top:u.boundingClientRect.top,element:d}):i.delete(h))}m()},{rootMargin:x,threshold:0});const c=s.querySelectorAll("h2:not(.link-preview-block h2), h3:not(.link-preview-block h3)");c.forEach(a=>{a.id&&l?.observe(a)}),c.length>0&&i.size===0&&requestAnimationFrame(()=>{const a=Array.from(c);for(let u=a.length-1;u>=0;u--){const d=a[u];if(d.getBoundingClientRect().top<n&&d.id){const v=parseInt(d.tagName.substring(1),10);p({id:d.id,text:d.textContent?.trim()||"",level:v});break}}})},g=()=>{i.clear(),t=null,requestAnimationFrame(()=>{o()})};return{subscribe:s=>(r.size===0&&(document.readyState!=="loading"&&o(),document.addEventListener("astro:page-load",g)),r.add(s),()=>{r.delete(s),r.size===0&&(l&&(l.disconnect(),l=null),document.removeEventListener("astro:page-load",g),i.clear())}),getSnapshot:()=>t,getServerSnapshot:()=>null}}function X({offsetTop:n=80}={}){const t=b.useMemo(()=>K(n),[n]);return b.useSyncExternalStore(t.subscribe,t.getSnapshot,t.getServerSnapshot)}function Z({heading:n,className:t}){const r=H();return e.jsx(S,{mode:"wait",children:n&&e.jsx(y.span,{className:`block truncate text-sm font-medium ${t||""}`,initial:r?{opacity:0}:{opacity:0,y:20,filter:"blur(4px)"},animate:r?{opacity:1}:{opacity:1,y:0,filter:"blur(0px)"},exit:r?{opacity:0}:{opacity:0,y:-12,filter:"blur(4px)"},transition:{default:{type:"spring",stiffness:400,damping:30},filter:{type:"tween",duration:.2,ease:"easeOut"}},children:n.text},n.id)})}function W({size:n=28,strokeWidth:t=2,className:r}){const l=H(),{scrollYProgress:i}=_(),f=$(i,{stiffness:100,damping:30,restDelta:.001}),p=l?i:f,m=(n-t)/2,o=n/2;return e.jsxs("svg",{width:n,height:n,className:r,"aria-label":"阅读进度",role:"progressbar",style:{transform:"rotate(-90deg)"},children:[e.jsx("circle",{cx:o,cy:o,r:m,fill:"transparent",stroke:"currentColor",strokeWidth:t,className:"opacity-20"}),e.jsx(y.circle,{cx:o,cy:o,r:m,fill:"transparent",stroke:"currentColor",strokeWidth:t,strokeLinecap:"round",className:"text-primary",style:{pathLength:p}})]})}function ee({headings:n,activeId:t,expandedIds:r,onHeadingClick:l,trigger:i,open:f,onOpenChange:p,enableNumbering:m=!0}){const[o,g]=z({value:f,defaultValue:!1,onChange:p}),{refs:s,floatingStyles:x,context:c}=D({open:o,onOpenChange:g,placement:"bottom-start",offset:8,transform:!1}),a=Y(c),u=V(c,{ancestorScroll:!0}),d=B(c),{getReferenceProps:h,getFloatingProps:v}=Q([a,u,d]),j=b.useRef(null),C=b.useRef(null);b.useEffect(()=>{j.current&&s.setReference(j.current)},[s]),b.useEffect(()=>{o&&C.current&&s.setFloating(C.current)},[o,s]);const I=M=>{l(M),g(!1)},{className:k,...E}=h(),F=v();return e.jsxs(e.Fragment,{children:[e.jsx("span",{ref:j,className:k?`contents ${k}`:"contents",...E,children:i}),e.jsx(S,{children:o&&e.jsx(U,{children:e.jsx(G,{context:c,modal:!1,children:e.jsx(y.div,{ref:C,style:x,className:"bg-background/80 border-border z-50 max-h-[60vh] w-72 overflow-auto rounded-2xl border p-3 backdrop-blur-md",initial:{opacity:0,scale:.85},animate:{opacity:1,scale:1,originY:0},exit:{opacity:0,scale:.85},transition:N.spring.popoverContent,...F,children:e.jsx("nav",{className:m?"":"toc-no-numbering","aria-label":"文章目录",children:e.jsx("div",{className:"space-y-1",children:e.jsx(L,{headings:n,depth:0,activeId:t,expandedIds:r,onHeadingClick:I})})})})})})})]})}const te={alternate:"snow"};Array.from({length:13},(n,t)=>t+1).map(n=>`/img/cover/${n}.webp`);const w=80;function R({logoElement:n,logoText:t,logoSrc:r}){return e.jsx("a",{href:J.Home,className:"flex items-center gap-1",children:n==="svg"&&r?e.jsx("img",{src:r,alt:te?.alternate,className:"h-8",height:32}):e.jsx("span",{className:"logo-text text-primary",children:t})})}function xe({isPostPage:n,logoElement:t,logoText:r,logoSrc:l,enableNumbering:i=!0}){const f=H(),p=P("(max-width: 992px)"),m=X({offsetTop:w}),o=O(),g=A({offsetTop:w+40}),{expandedIds:s,setExpandedIds:x}=T({headings:o,activeId:g,defaultExpanded:!1}),c=n&&p&&o.length>0&&m!==null,a=q({headings:o,setExpandedIds:x});return p?e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(S,{mode:"wait",children:c?e.jsx(y.div,{className:"flex items-center",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:f?{duration:0}:N.spring.gentle,children:e.jsx(ee,{headings:o,activeId:g,expandedIds:s,onHeadingClick:a,enableNumbering:i,trigger:e.jsxs("button",{className:"bg-foreground/10 hover:bg-foreground/20 flex w-[calc(100vw-10.5rem)] items-center gap-2.5 rounded-full py-1 pr-3 pl-1.5 backdrop-blur-sm transition-colors","aria-label":"展开目录",children:[e.jsx("div",{className:"relative shrink-0",children:e.jsx(W,{size:32,strokeWidth:2.5})}),e.jsx("div",{className:"overflow-hidden",children:e.jsx(Z,{heading:m})})]})})},"heading-mode"):e.jsx(y.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:f?{duration:0}:N.spring.gentle,children:e.jsx(R,{logoElement:t,logoText:r,logoSrc:l})},"logo-mode")})}):e.jsx(R,{logoElement:t,logoText:r,logoSrc:l})}export{xe as MobilePostHeader};
