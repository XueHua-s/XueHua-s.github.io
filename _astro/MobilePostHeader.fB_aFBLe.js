import{j as e}from"./jsx-runtime.D_zvdyIk.js";import{a as C}from"./design-tokens.BqHQxG4B.js";import{r as b}from"./index.vDeobAm6.js";import{a as P}from"./useMediaQuery.C_H-pvMT.js";import{H as L,u as O,a as A,b as q,c as T}from"./HeadingList.tBRDNhMv.js";import{u as N}from"./use-reduced-motion.G-muIoyJ.js";import{A as H}from"./index.CvmSC7dN.js";import{m as y}from"./proxy.DepoKxzr.js";import{u as _}from"./use-scroll.DCQs0f0o.js";import{u as $}from"./use-spring.DQe6yioT.js";import{u as z,a as D,c as Y,e as V,f as B,d as Q,F as U,g as G,R as J}from"./router.CzEfTywb.js";import"./_commonjsHelpers.CqkleIqs.js";import"./utils.BEHD0UYf.js";import"./index.CVgE1JxM.js";function K(n){let t=null;const r=new Set;let l=null;const c=new Map,p=()=>{r.forEach(s=>s())},u=s=>{t?.id!==s?.id&&(t=s,p())},m=()=>{if(c.size===0)return;let s="",g=Number.POSITIVE_INFINITY,a=null;if(c.forEach(({top:o,element:d},x)=>{o<g&&(g=o,s=x,a=d)}),a&&s){const o=parseInt(a.tagName.substring(1),10);u({id:s,text:a.textContent?.trim()||"",level:o})}},i=()=>{l&&l.disconnect(),c.clear(),t=null;const s=document.querySelector(".custom-content")??document.querySelector("article");if(!s)return;const g=`-${n}px 0px -70% 0px`;l=new IntersectionObserver(o=>{for(const d of o){const x=d.target,h=x.id;h&&(d.isIntersecting?c.set(h,{top:d.boundingClientRect.top,element:x}):c.delete(h))}m()},{rootMargin:g,threshold:0});const a=Array.from(s.querySelectorAll("h2, h3")).filter(o=>!o.closest(".link-preview-block"));a.forEach(o=>{o.id&&l?.observe(o)}),a.length>0&&c.size===0&&requestAnimationFrame(()=>{for(let o=a.length-1;o>=0;o--){const d=a[o];if(d.getBoundingClientRect().top<n&&d.id){const h=parseInt(d.tagName.substring(1),10);u({id:d.id,text:d.textContent?.trim()||"",level:h});break}}})},f=()=>{c.clear(),t=null,requestAnimationFrame(()=>{i()})};return{subscribe:s=>(r.size===0&&(requestAnimationFrame(()=>{requestAnimationFrame(()=>{i()})}),document.addEventListener("astro:page-load",f)),r.add(s),()=>{r.delete(s),r.size===0&&(l&&(l.disconnect(),l=null),document.removeEventListener("astro:page-load",f),c.clear())}),getSnapshot:()=>t,getServerSnapshot:()=>null}}function X({offsetTop:n=80}={}){const t=b.useMemo(()=>K(n),[n]);return b.useSyncExternalStore(t.subscribe,t.getSnapshot,t.getServerSnapshot)}function Z({heading:n,className:t}){const r=N();return e.jsx(H,{mode:"wait",children:n&&e.jsx(y.span,{className:`block truncate text-sm font-medium ${t||""}`,initial:r?{opacity:0}:{opacity:0,y:20,filter:"blur(4px)"},animate:r?{opacity:1}:{opacity:1,y:0,filter:"blur(0px)"},exit:r?{opacity:0}:{opacity:0,y:-12,filter:"blur(4px)"},transition:{default:{type:"spring",stiffness:400,damping:30},filter:{type:"tween",duration:.2,ease:"easeOut"}},children:n.text},n.id)})}function W({size:n=28,strokeWidth:t=2,className:r}){const l=N(),{scrollYProgress:c}=_(),p=$(c,{stiffness:100,damping:30,restDelta:.001}),u=l?c:p,m=(n-t)/2,i=n/2;return e.jsxs("svg",{width:n,height:n,className:r,"aria-label":"阅读进度",role:"progressbar",style:{transform:"rotate(-90deg)"},children:[e.jsx("circle",{cx:i,cy:i,r:m,fill:"transparent",stroke:"currentColor",strokeWidth:t,className:"opacity-20"}),e.jsx(y.circle,{cx:i,cy:i,r:m,fill:"transparent",stroke:"currentColor",strokeWidth:t,strokeLinecap:"round",className:"text-primary",style:{pathLength:u}})]})}function ee({headings:n,activeId:t,expandedIds:r,onHeadingClick:l,trigger:c,open:p,onOpenChange:u,enableNumbering:m=!0}){const[i,f]=z({value:p,defaultValue:!1,onChange:u}),{refs:s,floatingStyles:g,context:a}=D({open:i,onOpenChange:f,placement:"bottom-start",offset:8,transform:!1}),o=Y(a),d=V(a,{ancestorScroll:!0}),x=B(a),{getReferenceProps:h,getFloatingProps:R}=Q([o,d,x]),v=b.useRef(null),j=b.useRef(null);b.useEffect(()=>{v.current&&s.setReference(v.current)},[s]),b.useEffect(()=>{i&&j.current&&s.setFloating(j.current)},[i,s]);const I=M=>{l(M),f(!1)},{className:S,...E}=h(),F=R();return e.jsxs(e.Fragment,{children:[e.jsx("span",{ref:v,className:S?`contents ${S}`:"contents",...E,children:c}),e.jsx(H,{children:i&&e.jsx(U,{children:e.jsx(G,{context:a,modal:!1,children:e.jsx(y.div,{ref:j,style:g,className:"bg-background/80 border-border z-50 max-h-[60vh] w-72 overflow-auto rounded-2xl border p-3 backdrop-blur-md",initial:{opacity:0,scale:.85},animate:{opacity:1,scale:1,originY:0},exit:{opacity:0,scale:.85},transition:C.spring.popoverContent,...F,children:e.jsx("nav",{className:m?"":"toc-no-numbering","aria-label":"文章目录",children:e.jsx("div",{className:"space-y-1",children:e.jsx(L,{headings:n,depth:0,activeId:t,expandedIds:r,onHeadingClick:I})})})})})})})]})}const te={alternate:"snow"};Array.from({length:13},(n,t)=>t+1).map(n=>`/img/cover/${n}.webp`);const k=80;function w({logoElement:n,logoText:t,logoSrc:r}){return e.jsx("a",{href:J.Home,className:"flex items-center gap-1",children:n==="svg"&&r?e.jsx("img",{src:r,alt:te?.alternate,className:"h-8",height:32}):e.jsx("span",{className:"logo-text text-primary",children:t})})}function xe({isPostPage:n,logoElement:t,logoText:r,logoSrc:l,enableNumbering:c=!0}){const p=N(),u=P("(max-width: 992px)"),m=X({offsetTop:k}),i=O(),f=A({offsetTop:k+40}),{expandedIds:s,setExpandedIds:g}=q({headings:i,activeId:f,defaultExpanded:!1}),a=n&&u&&i.length>0&&m!==null,o=T({headings:i,setExpandedIds:g});return u?e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(H,{mode:"wait",children:a?e.jsx(y.div,{className:"flex items-center",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:p?{duration:0}:C.spring.gentle,children:e.jsx(ee,{headings:i,activeId:f,expandedIds:s,onHeadingClick:o,enableNumbering:c,trigger:e.jsxs("button",{className:"bg-foreground/10 hover:bg-foreground/20 flex w-[calc(100vw-10.5rem)] items-center gap-2.5 rounded-full py-1 pr-3 pl-1.5 backdrop-blur-sm transition-colors","aria-label":"展开目录",children:[e.jsx("div",{className:"relative shrink-0",children:e.jsx(W,{size:32,strokeWidth:2.5})}),e.jsx("div",{className:"overflow-hidden",children:e.jsx(Z,{heading:m})})]})})},"heading-mode"):e.jsx(y.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:p?{duration:0}:C.spring.gentle,children:e.jsx(w,{logoElement:t,logoText:r,logoSrc:l})},"logo-mode")})}):e.jsx(w,{logoElement:t,logoText:r,logoSrc:l})}export{xe as MobilePostHeader};
