<!DOCTYPE html><html lang="zh-CN" class="vertical-scrollbar" data-astro-transition-scope="astro-smooz4hq-1"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><meta name="generator" content="Astro v5.16.6"><title>Electron 热更新后启动性能优化：V8 缓存与代码拆包实战 | 技术教程 | 雪花の博客</title><!-- Preconnect to third-party origins for faster resource loading --><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="preconnect" href="https://chinese-font.netlify.app" crossorigin><link rel="dns-prefetch" href="https://chinese-font.netlify.app"><!-- Async load Chinese fonts to avoid render-blocking --><link rel="stylesheet" href="/fonts/ChillRoundFRegular/result.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="/fonts/ChillRoundFBold/result.css" media="print" onload="this.media='all'"><meta name="astro-view-transitions-enabled" content="true"><meta name="astro-view-transitions-fallback" content="animate"><script type="module" src="/_astro/ClientRouter.astro_astro_type_script_index_0_lang.QW52Ox2j.js"></script><style>.astro-loading-indicator {
  pointer-events: none;
  background-color: #e9536a;
  position: fixed;
  z-index: 1031;
  top: 0;
  left: 0;
  width: 100%;
  height: 2px;
  transition: transform 300ms ease-out, opacity 150ms 150ms ease-in;
	transform: translate3d(0, 0, 0) scaleX(var(--progress, 0));
  transform-origin: 0;
}

[dir="rtl"] .astro-loading-indicator {
  transform-origin: 100% 0;
}
</style><script>(function(){const className = "astro-loading-indicator";
const animationDuration = 300;
const threshold = 200;

(() => {
  let progress = 0.25
  let opacity = 0
  /** @type {number | undefined} */
  let trickleInterval = undefined
  /** @type {number | undefined} */
  let thresholdTimeout = undefined;

  const element = document.createElement("div")
  element.classList.add(className)
  element.ariaHidden = "true"

  /** @param {typeof progress} _progress */
  const setProgress = (_progress) => {
    progress = _progress
    element.style.setProperty('--progress', String(progress))
  }

  /** @param {typeof opacity} _opacity */
  const setOpacity = (_opacity) => {
    opacity = _opacity
    element.style.setProperty('opacity', String(opacity))
  }

  setOpacity(opacity)

  document.addEventListener("DOMContentLoaded", () => {
    document.body.prepend(element)
  })

  document.addEventListener("astro:before-preparation", () => {
    thresholdTimeout = setTimeout(() => {
      setOpacity(1)
      trickleInterval = window.setInterval(() => {
        setProgress(progress + Math.random() * 0.03)
      }, animationDuration)
    }, threshold)
  })

  document.addEventListener("astro:before-swap", (ev) => {
    if (!thresholdTimeout) {
      return
    }
    window.clearTimeout(thresholdTimeout)

    ev.newDocument.body.prepend(element)
    window.clearInterval(trickleInterval)
    trickleInterval = undefined

    setProgress(1)
    window.setTimeout(() => {
      setOpacity(0)
    }, animationDuration / 2)

    window.setTimeout(() => {
      setProgress(0.25)
    }, animationDuration * 2)
  })
})()
})();</script><script type="module" src="/_astro/Tooltips.astro_astro_type_script_index_0_lang.Bx2cGmPu.js"></script><!-- metadata --><meta name="description" content="深入实战 Electron 应用性能优化，通过启用 V8 代码缓存、Vite 模块拆包、按需导入和延迟加载等手段，将主进程启动时间从 1619ms 优化到 311ms，性能提升 80%。详解 V8 JIT 编译原理、manualChunks 拆包策略及实际优化效果对比。"><meta name="author" content="snow"><meta property="og:type" content="website"><meta property="og:site_name" content="snow"><meta property="og:url" content="https://xhblog.top/blog/post/33/"><meta property="og:title" content="Electron 热更新后启动性能优化：V8 缓存与代码拆包实战 | 技术教程 | 雪花の博客"><meta property="og:description" content="深入实战 Electron 应用性能优化，通过启用 V8 代码缓存、Vite 模块拆包、按需导入和延迟加载等手段，将主进程启动时间从 1619ms 优化到 311ms，性能提升 80%。详解 V8 JIT 编译原理、manualChunks 拆包策略及实际优化效果对比。"><!-- <meta property="og:image" content="/opengraph.png?v=1" /> TODO: og image--><meta name="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://xhblog.top/blog/post/33/"><meta name="twitter:title" content="Electron 热更新后启动性能优化：V8 缓存与代码拆包实战 | 技术教程 | 雪花の博客"><meta name="twitter:description" content="深入实战 Electron 应用性能优化，通过启用 V8 代码缓存、Vite 模块拆包、按需导入和延迟加载等手段，将主进程启动时间从 1619ms 优化到 311ms，性能提升 80%。详解 V8 JIT 编译原理、manualChunks 拆包策略及实际优化效果对比。"><script>
      // 立即执行主题检查 否则会闪烁
      if (
        localStorage.theme === 'dark' ||
        (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)
      ) {
        document.documentElement.classList.add('dark');
        document.documentElement.classList.remove('light');
        document.documentElement.dataset.theme = 'dark';
      } else {
        document.documentElement.classList.remove('dark');
        document.documentElement.classList.add('light');
        document.documentElement.dataset.theme = 'light';
      }
    </script><script>
      // iOS Safari pinch-zoom guard (viewport meta alone is not always respected)
      (() => {
        const blockGesture = (event) => event.preventDefault();
        document.addEventListener('gesturestart', blockGesture, { passive: false });
        document.addEventListener('gesturechange', blockGesture, { passive: false });
        document.addEventListener('gestureend', blockGesture, { passive: false });
      })();
    </script><!--主题检查切换对应值--><script type="module">function e(){localStorage.theme==="dark"||!("theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?(document.documentElement.classList.add("dark"),document.documentElement.classList.remove("light"),document.documentElement.dataset.theme="dark"):(document.documentElement.classList.remove("dark"),document.documentElement.classList.add("light"),document.documentElement.dataset.theme="light")}document.addEventListener("astro:page-load",e);</script><link rel="stylesheet" href="/_astro/about.DXB0Ts1e.css">
<link rel="stylesheet" href="/_astro/_slug_.D059aVq8.css">
<link rel="stylesheet" href="/_astro/about.gQg-K9MN.css">
<link rel="stylesheet" href="/_astro/index.Lf6pSiPd.css"><script type="module" src="/_astro/page.DI8DZ9wp.js"></script><style>[data-astro-transition-scope="astro-smooz4hq-1"] { view-transition-name: root; }@layer astro { ::view-transition-old(root) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }::view-transition-new(root) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }[data-astro-transition=back]::view-transition-old(root) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition=back]::view-transition-new(root) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; } }[data-astro-transition-fallback="old"] [data-astro-transition-scope="astro-smooz4hq-1"],
			[data-astro-transition-fallback="old"][data-astro-transition-scope="astro-smooz4hq-1"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition-fallback="new"] [data-astro-transition-scope="astro-smooz4hq-1"],
			[data-astro-transition-fallback="new"][data-astro-transition-scope="astro-smooz4hq-1"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }[data-astro-transition=back][data-astro-transition-fallback="old"] [data-astro-transition-scope="astro-smooz4hq-1"],
			[data-astro-transition=back][data-astro-transition-fallback="old"][data-astro-transition-scope="astro-smooz4hq-1"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition=back][data-astro-transition-fallback="new"] [data-astro-transition-scope="astro-smooz4hq-1"],
			[data-astro-transition=back][data-astro-transition-fallback="new"][data-astro-transition-scope="astro-smooz4hq-1"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }</style></head> <body> <div class="flex min-h-screen flex-col text-black dark:text-white"> <style>astro-island,astro-slot,astro-static-slot{display:contents}</style><script>(()=>{var a=(s,i,o)=>{let r=async()=>{await(await s())()},t=typeof i.value=="object"?i.value:void 0,c={rootMargin:t==null?void 0:t.rootMargin},n=new IntersectionObserver(e=>{for(let l of e)if(l.isIntersecting){n.disconnect(),r();break}},c);for(let e of o.children)n.observe(e)};(self.Astro||(self.Astro={})).visible=a;window.dispatchEvent(new Event("astro:visible"));})();</script><script>(()=>{var A=Object.defineProperty;var g=(i,o,a)=>o in i?A(i,o,{enumerable:!0,configurable:!0,writable:!0,value:a}):i[o]=a;var d=(i,o,a)=>g(i,typeof o!="symbol"?o+"":o,a);{let i={0:t=>m(t),1:t=>a(t),2:t=>new RegExp(t),3:t=>new Date(t),4:t=>new Map(a(t)),5:t=>new Set(a(t)),6:t=>BigInt(t),7:t=>new URL(t),8:t=>new Uint8Array(t),9:t=>new Uint16Array(t),10:t=>new Uint32Array(t),11:t=>1/0*t},o=t=>{let[l,e]=t;return l in i?i[l](e):void 0},a=t=>t.map(o),m=t=>typeof t!="object"||t===null?t:Object.fromEntries(Object.entries(t).map(([l,e])=>[l,o(e)]));class y extends HTMLElement{constructor(){super(...arguments);d(this,"Component");d(this,"hydrator");d(this,"hydrate",async()=>{var b;if(!this.hydrator||!this.isConnected)return;let e=(b=this.parentElement)==null?void 0:b.closest("astro-island[ssr]");if(e){e.addEventListener("astro:hydrate",this.hydrate,{once:!0});return}let c=this.querySelectorAll("astro-slot"),n={},h=this.querySelectorAll("template[data-astro-template]");for(let r of h){let s=r.closest(this.tagName);s!=null&&s.isSameNode(this)&&(n[r.getAttribute("data-astro-template")||"default"]=r.innerHTML,r.remove())}for(let r of c){let s=r.closest(this.tagName);s!=null&&s.isSameNode(this)&&(n[r.getAttribute("name")||"default"]=r.innerHTML)}let p;try{p=this.hasAttribute("props")?m(JSON.parse(this.getAttribute("props"))):{}}catch(r){let s=this.getAttribute("component-url")||"<unknown>",v=this.getAttribute("component-export");throw v&&(s+=` (export ${v})`),console.error(`[hydrate] Error parsing props for component ${s}`,this.getAttribute("props"),r),r}let u;await this.hydrator(this)(this.Component,p,n,{client:this.getAttribute("client")}),this.removeAttribute("ssr"),this.dispatchEvent(new CustomEvent("astro:hydrate"))});d(this,"unmount",()=>{this.isConnected||this.dispatchEvent(new CustomEvent("astro:unmount"))})}disconnectedCallback(){document.removeEventListener("astro:after-swap",this.unmount),document.addEventListener("astro:after-swap",this.unmount,{once:!0})}connectedCallback(){if(!this.hasAttribute("await-children")||document.readyState==="interactive"||document.readyState==="complete")this.childrenConnectedCallback();else{let e=()=>{document.removeEventListener("DOMContentLoaded",e),c.disconnect(),this.childrenConnectedCallback()},c=new MutationObserver(()=>{var n;((n=this.lastChild)==null?void 0:n.nodeType)===Node.COMMENT_NODE&&this.lastChild.nodeValue==="astro:end"&&(this.lastChild.remove(),e())});c.observe(this,{childList:!0}),document.addEventListener("DOMContentLoaded",e)}}async childrenConnectedCallback(){let e=this.getAttribute("before-hydration-url");e&&await import(e),this.start()}async start(){let e=JSON.parse(this.getAttribute("opts")),c=this.getAttribute("client");if(Astro[c]===void 0){window.addEventListener(`astro:${c}`,()=>this.start(),{once:!0});return}try{await Astro[c](async()=>{let n=this.getAttribute("renderer-url"),[h,{default:p}]=await Promise.all([import(this.getAttribute("component-url")),n?import(n):()=>()=>{}]),u=this.getAttribute("component-export")||"default";if(!u.includes("."))this.Component=h[u];else{this.Component=h;for(let f of u.split("."))this.Component=this.Component[f]}return this.hydrator=p,this.hydrate},e,this)}catch(n){console.error(`[astro-island] Error hydrating ${this.getAttribute("component-url")}`,n)}}attributeChangedCallback(){this.hydrate()}}d(y,"observedAttributes",["props"]),customElements.get("astro-island")||customElements.define("astro-island",y)}})();</script><astro-island uid="1ry4iC" prefix="r11" component-url="/_astro/Header.C8OaRJ2F.js" component-export="default" renderer-url="/_astro/client.lBR8ML2S.js" props="{&quot;isPostPage&quot;:[0,true],&quot;tocNumbering&quot;:[0,true],&quot;tocHeadings&quot;:[1,[[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;前言&quot;],&quot;text&quot;:[0,&quot;前言&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;性能数据对比&quot;],&quot;text&quot;:[0,&quot;性能数据对比&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;核心优化策略&quot;],&quot;text&quot;:[0,&quot;核心优化策略&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;1-启用-v8-代码缓存&quot;],&quot;text&quot;:[0,&quot;1. 启用 V8 代码缓存&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;实现方式&quot;],&quot;text&quot;:[0,&quot;实现方式&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;验证缓存效果&quot;],&quot;text&quot;:[0,&quot;验证缓存效果&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;工作原理&quot;],&quot;text&quot;:[0,&quot;工作原理&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;2-模块拆包code-splitting-核心优化&quot;],&quot;text&quot;:[0,&quot;2. 模块拆包（Code Splitting）—— 核心优化&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;问题背景为什么需要拆包&quot;],&quot;text&quot;:[0,&quot;问题背景：为什么需要拆包？&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;vite-配置方案&quot;],&quot;text&quot;:[0,&quot;Vite 配置方案&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;拆包效果对比&quot;],&quot;text&quot;:[0,&quot;拆包效果对比&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;拆包如何降低-jit-热点编译压力&quot;],&quot;text&quot;:[0,&quot;拆包如何降低 JIT 热点编译压力？&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;实际性能提升&quot;],&quot;text&quot;:[0,&quot;实际性能提升&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;注意事项&quot;],&quot;text&quot;:[0,&quot;注意事项&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;日志中的证据&quot;],&quot;text&quot;:[0,&quot;日志中的证据&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;3-按需导入依赖tree-shaking&quot;],&quot;text&quot;:[0,&quot;3. 按需导入依赖（Tree Shaking）&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;优化前&quot;],&quot;text&quot;:[0,&quot;优化前&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;优化后&quot;],&quot;text&quot;:[0,&quot;优化后&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;效果分析&quot;],&quot;text&quot;:[0,&quot;效果分析&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;4-延迟加载非关键模块&quot;],&quot;text&quot;:[0,&quot;4. 延迟加载非关键模块&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;实现方案&quot;],&quot;text&quot;:[0,&quot;实现方案&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;关键技术点&quot;],&quot;text&quot;:[0,&quot;关键技术点&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;5-性能监控埋点&quot;],&quot;text&quot;:[0,&quot;5. 性能监控埋点&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;常见问题&quot;],&quot;text&quot;:[0,&quot;常见问题&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;q1-v8-缓存文件会无限增长吗&quot;],&quot;text&quot;:[0,&quot;Q1: V8 缓存文件会无限增长吗？&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;q2-代码拆包会影响运行时性能吗&quot;],&quot;text&quot;:[0,&quot;Q2: 代码拆包会影响运行时性能吗？&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;q3-动态-import-会导致功能延迟吗&quot;],&quot;text&quot;:[0,&quot;Q3: 动态 import 会导致功能延迟吗？&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;总结&quot;],&quot;text&quot;:[0,&quot;总结&quot;]}]]]}" ssr client="visible" opts="{&quot;name&quot;:&quot;Header&quot;,&quot;value&quot;:true}" await-children><link rel="preload" as="image" href="/_astro/logo.Bpp0JPuA.webp"/><div id="site-header" class="shadow-text fixed inset-x-0 top-0 z-10 gap-4 py-2.5 text-white select-none tablet:backdrop-blur tablet:py-2 tablet:pl-3 tablet:pr-3" style="view-transition-name:site-header"><div class="site-header-bg pointer-events-none absolute inset-0"></div><div class="relative z-10 mx-auto flex items-center justify-between px-6 tablet:w-full tablet:px-0 max-w-7xl"><a class="tablet:hidden -my-4 mr-4 flex cursor-pointer items-center justify-center gap-1 whitespace-nowrap" href="/blog" target="_self" title="snow" aria-label="snow" data-astro-transition-persist="page-header-avatar" style="view-transition-name:page-header-avatar"><img src="/_astro/logo.Bpp0JPuA.webp" alt="snow" class="mt-2 mb-2 h-16"/></a><div class="tablet:flex w-full h-full tablet:grow hidden items-center justify-center"><a href="/blog" class="flex items-center gap-1"><img src="/_astro/logo.Bpp0JPuA.webp" alt="snow" class="h-8" height="32"/></a></div><div class="tablet:grow-0 flex grow items-center" style="view-transition-name:page-header"><div class="tablet:hidden flex grow items-center gap-4"><a href="/blog" aria-label="首页" class="inline-flex items-center justify-center whitespace-nowrap rounded-md ring-offset-background transition-colors focus-visible:outline-hidden focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 h-10 px-4 py-2 relative text-base tracking-wider after:absolute after:bottom-1 after:left-1/2 after:block after:h-0.5 after:w-0 after:-translate-x-1/2 after:transition-all after:duration-300 hover:after:w-9/12"><i class="mr-1.5 fa-solid fa-house-chimney" aria-hidden="true"></i>首页</a><button class="inline-flex h-10 items-center px-4 py-2 text-base tracking-wider relative after:absolute after:bottom-1 after:left-1/2 after:h-0.5 after:w-0 after:-translate-x-1/2 after:bg-white after:transition-all after:duration-300 after:content-[&quot;&quot;]" aria-expanded="false" aria-haspopup="dialog" aria-label="文章菜单"><i class="mr-1.5 text-sm fa-solid fa-pen-nib" aria-hidden="true"></i>文章<i class="fa-solid fa-caret-down absolute -right-1.5 text-xl transition-transform duration-300" aria-hidden="true"></i></button><a href="/blog/friends" aria-label="友链" class="inline-flex items-center justify-center whitespace-nowrap rounded-md ring-offset-background transition-colors focus-visible:outline-hidden focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 h-10 px-4 py-2 relative text-base tracking-wider after:absolute after:bottom-1 after:left-1/2 after:block after:h-0.5 after:w-0 after:-translate-x-1/2 after:transition-all after:duration-300 hover:after:w-9/12"><i class="mr-1.5 fa-solid fa-link" aria-hidden="true"></i>友链</a><a href="/blog/about" aria-label="关于" class="inline-flex items-center justify-center whitespace-nowrap rounded-md ring-offset-background transition-colors focus-visible:outline-hidden focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 h-10 px-4 py-2 relative text-base tracking-wider after:absolute after:bottom-1 after:left-1/2 after:block after:h-0.5 after:w-0 after:-translate-x-1/2 after:transition-all after:duration-300 hover:after:w-9/12"><i class="mr-1.5 fa-regular fa-circle-user" aria-hidden="true"></i>关于</a></div><div class="ml-auto flex items-center gap-2"><button id="search-trigger" class="group cursor-pointer transition duration-300 hover:scale-125" aria-label="搜索" title="搜索 (⌘K)"><i class="fa-solid fa-magnifying-glass text-2xl" aria-hidden="true"></i></button><div id="search-component-portal" style="display:none;position:absolute;pointer-events:none;visibility:hidden"><div id="search-for-dialog" class="pagefind-ui" data-pagefind-ui="true"></div></div><style>
        .scroll-feather-mask {
          container-type: scroll-state;
        }
        @container scroll-state(scrollable: bottom) {
          .scroll-feather-mask::before {
            content: '';
            background: linear-gradient(
              to bottom,
              transparent 0%,
              var(--gradient-bg-start) var(--scroll-mask-middle, 70%),
              var(--gradient-bg-start) var(--scroll-mask-end, 100%)
            );
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 10;
            display: block;
            height: var(--scroll-mask-height, 5rem);
          }
        }
      </style><button class="theme-toggle text-2xl cursor-pointer bg-transparent border-0 p-0 transition-transform duration-300 hover:scale-110" id="theme-toggle-btn" type="button" aria-label="toggle theme" aria-pressed="false"><i class="fa-solid fa-sun text-2xl light-icon transition-all duration-300" style="opacity:1;transform:rotate(0deg) scale(1)"></i><i class="fa-solid fa-moon text-2xl dark-icon transition-all duration-300" style="opacity:0;transform:rotate(-180deg) scale(0)"></i></button><style>
        .theme-toggle {
          position: relative;
          z-index: 10;
          width: 36px;
          height: 36px;
          display: flex;
          align-items: center;
          justify-content: center;
        }

        .theme-toggle i {
          position: absolute;
          text-shadow: none;
          filter: none;
        }
      </style></div></div></div></div><!--astro:end--></astro-island> <main class="relative flex grow flex-col gap-4">   <div class="flex flex-col"> <div class="relative flex h-[60dvh] max-h-200 overflow-hidden"> <div class="absolute inset-0 h-full bg-black/40"></div> <div class="absolute inset-0 bottom-[8dvh] flex flex-col items-center justify-center px-5 text-white">  <h1 class="shadow-text word-break text-4.5xl text-center font-bold md:text-2xl max-w-7xl flex flex-wrap items-center justify-center gap-3"> Electron 热更新后启动性能优化：V8 缓存与代码拆包实战  </h1> <p class="mt-3 flex items-center justify-center gap-4 md:text-xs"> <span class="flex items-center gap-1"> <i class="fa-regular fa-calendar-days" aria-hidden="true"></i>
发表于 2025-11-18 </span> <span class="flex items-center gap-1"> <i class="fa-solid fa-pen-nib" aria-hidden="true"></i> 3089 字
</span> <span class="flex items-center gap-1"> <i class="fa-regular fa-clock" aria-hidden="true"></i> 16 min read </span> </p> </div> <div class="relative -z-10 h-full min-h-60 w-full" data-astro-transition-persist="page-cover-banner" id="banner-box" style="background-image:linear-gradient(135deg, #f6eae2 0%, #ddc8c8 50%, #bbb1bb 100%)"> <img src="/img/backgrounds/3088f24fa2ad95399511f6af3f456dbe.webp" alt="cover" class="h-full w-full object-cover" sizes="50vw"> </div> <div class="wave-wrap"><svg class="wave" xmlns="http://www.w3.org/2000/svg" viewBox="0 24 150 28" preserveAspectRatio="none"><defs><path id="gentle-wave" d="m -160,44.4 c 30,0 58,-18 87.7,-18 30.3,0 58.3,18 87.3,18 30,0 58,-18 88,-18 30,0 58,18 88,18 l 0,34.5 -351,0 z"></path></defs><g class="parallax"><use xlink:href="#gentle-wave" x="50" y="0" fill="rgba(255, 255, 255, 0.48)"></use><use xlink:href="#gentle-wave" x="50" y="3" fill="rgba(255, 255, 255, 0.78)"></use><use xlink:href="#gentle-wave" x="50" y="6" fill="rgba(255, 255, 255, 0.8)"></use></g></svg></div> </div> <div class="mx-auto md:mx-0 flex w-full items-start justify-center md:w-full max-w-7xl"> <div class="page-home-sider shadow-home-sider sticky top-0 self-start flex min-w-64 max-w-64 flex-col tablet:hidden overflow-hidden h-screen min-h-0 items-center px-2" transition:name="page-home-sider"> <script>(()=>{var n=(a,t)=>{let i=async()=>{await(await a())()};if(t.value){let e=matchMedia(t.value);e.matches?i():e.addEventListener("change",i,{once:!0})}};(self.Astro||(self.Astro={})).media=n;window.dispatchEvent(new Event("astro:media"));})();</script><astro-island uid="1cL5VY" prefix="r10" component-url="/_astro/HomeSiderPanel.Cf8zkySA.js" component-export="default" renderer-url="/_astro/client.lBR8ML2S.js" props="{&quot;type&quot;:[0,&quot;post&quot;],&quot;defaultSegmentType&quot;:[0,&quot;directory&quot;],&quot;homeInfo&quot;:[0,{&quot;avatar&quot;:[0,&quot;/img/724d7fb480c8ac0db472ca5c7e36d239.jpg&quot;],&quot;name&quot;:[0,&quot;snow&quot;],&quot;description&quot;:[0,&quot;ACG / 养猫人 / 菜逼 / 前端什锦&quot;],&quot;postCount&quot;:[0,45],&quot;categoryCount&quot;:[0,8],&quot;tagCount&quot;:[0,76],&quot;routes&quot;:[1,[[0,{&quot;name&quot;:[0,&quot;首页&quot;],&quot;path&quot;:[0,&quot;/blog&quot;],&quot;icon&quot;:[0,&quot;fa-solid fa-house-chimney&quot;]}],[0,{&quot;name&quot;:[0,&quot;文章&quot;],&quot;icon&quot;:[0,&quot;fa-solid fa-pen-nib&quot;],&quot;children&quot;:[1,[[0,{&quot;name&quot;:[0,&quot;分类&quot;],&quot;path&quot;:[0,&quot;/blog/categories&quot;],&quot;icon&quot;:[0,&quot;fa-solid fa-layer-group&quot;]}],[0,{&quot;name&quot;:[0,&quot;标签&quot;],&quot;path&quot;:[0,&quot;/blog/tags&quot;],&quot;icon&quot;:[0,&quot;fa-solid fa-tags&quot;]}],[0,{&quot;name&quot;:[0,&quot;周刊&quot;],&quot;path&quot;:[0,&quot;/blog/weekly&quot;],&quot;icon&quot;:[0,&quot;fa-regular fa-newspaper&quot;]}]]]}],[0,{&quot;name&quot;:[0,&quot;友链&quot;],&quot;path&quot;:[0,&quot;/blog/friends&quot;],&quot;icon&quot;:[0,&quot;fa-solid fa-link&quot;]}],[0,{&quot;name&quot;:[0,&quot;关于&quot;],&quot;path&quot;:[0,&quot;/blog/about&quot;],&quot;icon&quot;:[0,&quot;fa-regular fa-circle-user&quot;]}]]],&quot;currentPath&quot;:[0,&quot;/blog/post/33/&quot;]}],&quot;tocHeadings&quot;:[1,[[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;前言&quot;],&quot;text&quot;:[0,&quot;前言&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;性能数据对比&quot;],&quot;text&quot;:[0,&quot;性能数据对比&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;核心优化策略&quot;],&quot;text&quot;:[0,&quot;核心优化策略&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;1-启用-v8-代码缓存&quot;],&quot;text&quot;:[0,&quot;1. 启用 V8 代码缓存&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;实现方式&quot;],&quot;text&quot;:[0,&quot;实现方式&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;验证缓存效果&quot;],&quot;text&quot;:[0,&quot;验证缓存效果&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;工作原理&quot;],&quot;text&quot;:[0,&quot;工作原理&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;2-模块拆包code-splitting-核心优化&quot;],&quot;text&quot;:[0,&quot;2. 模块拆包（Code Splitting）—— 核心优化&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;问题背景为什么需要拆包&quot;],&quot;text&quot;:[0,&quot;问题背景：为什么需要拆包？&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;vite-配置方案&quot;],&quot;text&quot;:[0,&quot;Vite 配置方案&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;拆包效果对比&quot;],&quot;text&quot;:[0,&quot;拆包效果对比&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;拆包如何降低-jit-热点编译压力&quot;],&quot;text&quot;:[0,&quot;拆包如何降低 JIT 热点编译压力？&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;实际性能提升&quot;],&quot;text&quot;:[0,&quot;实际性能提升&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;注意事项&quot;],&quot;text&quot;:[0,&quot;注意事项&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;日志中的证据&quot;],&quot;text&quot;:[0,&quot;日志中的证据&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;3-按需导入依赖tree-shaking&quot;],&quot;text&quot;:[0,&quot;3. 按需导入依赖（Tree Shaking）&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;优化前&quot;],&quot;text&quot;:[0,&quot;优化前&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;优化后&quot;],&quot;text&quot;:[0,&quot;优化后&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;效果分析&quot;],&quot;text&quot;:[0,&quot;效果分析&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;4-延迟加载非关键模块&quot;],&quot;text&quot;:[0,&quot;4. 延迟加载非关键模块&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;实现方案&quot;],&quot;text&quot;:[0,&quot;实现方案&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;关键技术点&quot;],&quot;text&quot;:[0,&quot;关键技术点&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;5-性能监控埋点&quot;],&quot;text&quot;:[0,&quot;5. 性能监控埋点&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;常见问题&quot;],&quot;text&quot;:[0,&quot;常见问题&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;q1-v8-缓存文件会无限增长吗&quot;],&quot;text&quot;:[0,&quot;Q1: V8 缓存文件会无限增长吗？&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;q2-代码拆包会影响运行时性能吗&quot;],&quot;text&quot;:[0,&quot;Q2: 代码拆包会影响运行时性能吗？&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;q3-动态-import-会导致功能延迟吗&quot;],&quot;text&quot;:[0,&quot;Q3: 动态 import 会导致功能延迟吗？&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;总结&quot;],&quot;text&quot;:[0,&quot;总结&quot;]}]]],&quot;tocNumbering&quot;:[0,true],&quot;seriesPostItems&quot;:[1,[[0,{&quot;post&quot;:[0,{&quot;id&quot;:[0,&quot;rk3528开发板部署openclaw-telegram-bot全记录&quot;],&quot;data&quot;:[0,{&quot;title&quot;:[0,&quot;在 RK3528 ARM 开发板上部署 OpenClaw + Telegram Bot 全记录&quot;],&quot;date&quot;:[3,&quot;2026-02-07T10:30:00.000Z&quot;],&quot;tags&quot;:[1,[[0,&quot;OpenClaw&quot;],[0,&quot;Telegram Bot&quot;],[0,&quot;RK3528&quot;],[0,&quot;Armbian&quot;],[0,&quot;AI Agent&quot;]]],&quot;categories&quot;:[0,&quot;技术教程&quot;]}],&quot;body&quot;:[0,&quot;&gt; **TL;DR**：在一块 4GB 内存的 RK3528 ARM 板子（Armbian）上，从零搭建了 Telegram Bot，接入 Gemini / GPT-5 / Claude 多模型，支持 AI 聊天、图片生成和系统代理操作。本文完整复盘部署步骤与核心踩坑。\n\n## 一、硬件与系统环境\n\n| 项目    | 配置                                       |\n| ------- | ------------------------------------------ |\n| SoC     | Rockchip RK3528（四核 ARM Cortex-A53）     |\n| 内存    | 4GB DDR4                                   |\n| 存储    | 64GB eMMC                                  |\n| 系统    | Armbian 25.11.0-trunk (Ubuntu 24.04 Noble) |\n| 内核    | Linux 6.1.115-vendor-rk35xx aarch64        |\n| Python  | 3.12.3                                     |\n| Node.js | v24.11.1（通过 nvm）                       |\n| 网络    | Clash TUN 模式全局代理                     |\n\n这块板子原本用于轻量服务。实测下来，4GB 内存跑这种“网络请求驱动型”AI Bot 完全够用，瓶颈主要不在算力，而在网络质量和 API 稳定性。\n\n## 二、架构总览\n\n最终部署架构：\n\n```text\nTelegram 用户\n    │\n    ▼ (Long Polling)\n┌──────────────────────────┐\n│  telegram-adapter.py     │ ← systemd 托管\n│  (Python 3.12)           │\n│                          │\n│  ┌─ /chat 聊天模式 ─────┐│\n│  │  Gemini 3 Flash/Pro  ││\n│  │  GPT-5.2 / 5-Mini    ││\n│  │  Claude Code (本地)   ││\n│  └──────────────────────┘│\n│  ┌─ /agent 代理模式 ────┐│\n│  │  Gemini Function Call -&gt; model think -&gt; openClaw do ││\n│  │  → shell / file / web ││\n│  └──────────────────────┘│\n│  ┌─ 图片生成 ───────────┐│\n│  │  Gemini 2.5 Flash    ││\n│  │  Image（自动检测）    ││\n│  └──────────────────────┘│\n└──────────────────────────┘\n    │                  │\n    ▼                  ▼\n SQLite DB        审计日志\n (状态/历史/Key)   /var/log/openclaw-agent/\n```\n\n核心设计决策：\n\n- 使用 **Long Polling**：无需公网 IP、无需 HTTPS 证书，部署成本最低。\n- 支持 **多模型热切换**：`/model gpt-5.2` 直接切换，无需重启。\n- 支持 **图片生成自动路由**：识别“生成图片 / 画一张”类指令自动走图像模型。\n- 代理模式使用 **Function Calling**：AI 自主规划工具调用。\n- 使用 **SQLite 统一存储**：聊天历史、状态、API Key、任务审计集中管理。\n\n## 三、部署步骤\n\n### 3.1 目录结构\n\n```bash\nmkdir -p /opt/openclaw/{scripts,config,work}\nmkdir -p /var/log/openclaw-agent\n```\n\n```text\n/opt/openclaw/\n├── config/\n│   └── .env\n├── scripts/\n│   └── telegram-adapter.py\n└── work/\n```\n\n### 3.2 创建 Telegram Bot\n\n1. 在 Telegram 搜索 `@BotFather`，发送 `/newbot`。\n2. 按提示创建 Bot，拿到 `Bot Token`。\n3. 通过 `@userinfobot` 获取自己的 `User ID`。\n4. 将 Token 和 User ID 写入环境变量。\n\n### 3.3 环境变量配置\n\n```bash\ncat &gt; /opt/openclaw/config/.env &lt;&lt; &#39;EOF&#39;\nTELEGRAM_BOT_TOKEN=你的Bot_Token\nTELEGRAM_ADMIN_USER_ID=你的User_ID\nGEMINI_API_KEY=你的Gemini_Key\nOPENCLAW_WORK_DIR=/opt/openclaw/work\nOPENCLAW_LOG_DIR=/var/log/openclaw-agent\nEOF\n\nchmod 600 /opt/openclaw/config/.env\n```\n\n### 3.4 安装 Python 依赖\n\n```bash\npip3 install --break-system-packages requests google-genai\n```\n\n&gt; Ubuntu 24.04 + Python 3.12 默认受 PEP 668 约束。要么使用 venv，要么加 `--break-system-packages` 做系统级安装。\n\n### 3.5 部署主程序\n\n```bash\nchmod +x /opt/openclaw/scripts/telegram-adapter.py\n```\n\n脚本首行为 `#!/usr/bin/env python3`，可直接执行。\n\n### 3.6 systemd 服务\n\n```bash\ncat &gt; /etc/systemd/system/openclaw-telegram.service &lt;&lt; &#39;EOF&#39;\n[Unit]\nDescription=OpenClaw Telegram Agent\nAfter=network-online.target\nWants=network-online.target\nStartLimitIntervalSec=60\nStartLimitBurst=3\n\n[Service]\nType=simple\nUser=root\nWorkingDirectory=/opt/openclaw/work\nEnvironmentFile=/opt/openclaw/config/.env\nExecStart=/opt/openclaw/scripts/telegram-adapter.py\nRestart=on-failure\nRestartSec=10\nStandardOutput=journal\nStandardError=journal\nSyslogIdentifier=openclaw-telegram\n\nMemoryMax=500M\nCPUQuota=50%\n\nPrivateTmp=yes\nNoNewPrivileges=true\nProtectSystem=strict\nProtectHome=yes\nReadWritePaths=/opt/openclaw/work /var/log/openclaw-agent\n\n[Install]\nWantedBy=multi-user.target\nEOF\n\nsystemctl daemon-reload\nsystemctl enable openclaw-telegram\nsystemctl start openclaw-telegram\n```\n\n### 3.7 验证\n\n```bash\nsystemctl status openclaw-telegram\njournalctl -u openclaw-telegram -f\n```\n\n在 Telegram 发送 `/ping`，应收到 `pong + 主机名 + 时间`。\n\n## 四、踩坑全记录（重点）\n\n从“能跑”到“稳定可用”，这 6 个坑最关键。\n\n### 坑 1：`google-generativeai` 已废弃，必须换 `google-genai`\n\n现象：启动后出现 `FutureWarning`，提示旧 SDK 停止维护。  \n结论：直接切换到新 SDK，避免后续兼容问题。\n\n```bash\npip3 install --break-system-packages google-genai\n```\n\n```python\nimport google.genai as genai\nfrom google.genai import types\n\nclient = genai.Client(api_key=api_key)\n```\n\n### 坑 2：新 SDK 没有 `genai.configure()`\n\n现象：调用 `genai.configure(api_key=...)` 报 `AttributeError`。  \n原因：这是旧 SDK 写法。  \n修复：初始化时直接传 API Key。\n\n```python\n# 错误（旧写法）\ngenai.configure(api_key=api_key)\nclient = genai.Client()\n\n# 正确（新写法）\nclient = genai.Client(api_key=api_key)\n```\n\n### 坑 3：Gemini API 地理位置限制（数据中心出口 IP）\n\n现象：Key 正确、代码正确，仍报 `User location is not supported for the API use.`  \n原因：出口 IP 不在可用策略范围内。  \n修复：通过 Cloudflare Worker 做中转，再在 SDK 指定 `base_url`。\n\n```javascript\nexport default {\n  async fetch(request) {\n    const url = new URL(request.url);\n    url.hostname = &#39;generativelanguage.googleapis.com&#39;;\n    return fetch(new Request(url, request));\n  },\n};\n```\n\n```python\nclient = genai.Client(\n    api_key=api_key,\n    http_options=types.HttpOptions(\n        base_url=&#39;https://your-worker.your-domain.workers.dev&#39;\n    )\n)\n```\n\n### 坑 4：Telegram Markdown 解析炸裂\n\n现象：AI 返回里只要含不规范 Markdown（如 `*`、`_`、`` ` ``、`[` 未闭合），Telegram 直接 400。  \n风险：业务代码以为“已发送”，用户却收不到消息。  \n修复：发送失败后自动降级纯文本重试。\n\n```python\ndef send_message(chat_id, text, reply_markup=None):\n    data = {\n        &#39;chat_id&#39;: chat_id,\n        &#39;text&#39;: text,\n        &#39;parse_mode&#39;: &#39;Markdown&#39;\n    }\n    resp = requests.post(url, json=data, timeout=10)\n    if resp.status_code == 400:\n        logger.warning(&#39;Markdown parse failed, retrying as plain text&#39;)\n        data.pop(&#39;parse_mode&#39;, None)\n        resp = requests.post(url, json=data, timeout=10)\n```\n\n同样逻辑也要覆盖 `send_photo` 的 caption。\n\n### 坑 5：Gemini 图片生成 `temperature` 必须为 `1.0`\n\n现象：复用聊天参数（如 `temperature=0.7`）会导致图片接口异常或空响应。  \n修复：图像模式固定 `temperature=1.0`，并声明 `response_modalities`。\n\n```python\nconfig = types.GenerateContentConfig(\n    temperature=1.0,\n    max_output_tokens=2048,\n    response_modalities=[&#39;TEXT&#39;, &#39;IMAGE&#39;],\n)\n```\n\n### 坑 6：GPT-5 系列参数兼容变更\n\n现象：`max_tokens` 不生效。  \n修复：改用 `max_completion_tokens`。\n\n```python\nresponse = requests.post(\n    &#39;https://api.openai.com/v1/chat/completions&#39;,\n    json={\n        &#39;model&#39;: &#39;gpt-5-mini-2025-08-07&#39;,\n        &#39;messages&#39;: messages,\n        &#39;max_completion_tokens&#39;: 2048,\n    },\n    headers={&#39;Authorization&#39;: f&#39;Bearer {api_key}&#39;},\n)\n```\n\n## 五、最终能力与安全策略\n\n### 基础命令\n\n| 命令                   | 功能                                |\n| ---------------------- | ----------------------------------- |\n| `/ping`                | 返回 pong + 主机名 + 时间           |\n| `/chat`                | 进入 AI 聊天模式                    |\n| `/agent`               | 进入代理模式（AI 操作系统OpenClaw） |\n| `/model`               | 查看/切换模型                       |\n| `/setkey gemini &lt;key&gt;` | 设置 API Key                        |\n| `/clear`               | 清空对话历史                        |\n| `/help`                | 显示帮助                            |\n\n### 主要能力\n\n- 多轮对话与上下文记忆\n- 多模型热切换（Gemini / GPT-5 / Claude）\n- 图片生成与继续编辑\n- 代理模式下的 shell / file / web 工具调用\n- 危险命令拦截与审计日志记录\n\n### 安全机制\n\n- **用户白名单**：仅允许配置的管理员 User ID 操作。\n- **命令黑名单**：默认拦截 `rm -rf`、`dd`、`mkfs` 等高危命令。\n- **审计追踪**：SQLite + 文件日志双轨记录。\n- **资源限制**：`MemoryMax=500M`、`CPUQuota=50%`。\n- **最小权限运行**：`ProtectSystem=strict`、`ProtectHome=yes`、`NoNewPrivileges=true`。\n\n## 六、经验总结\n\n给准备在 ARM 板上跑 AI Bot 的同学几个建议：\n\n1. **ARM 兼容性不是问题**：真正的问题是网络、API 和异常处理。\n2. **Long Polling 是边缘部署最优解**：简单、稳定、低成本。\n3. **先做失败兜底，再做功能扩展**：特别是 Telegram Markdown fallback。\n4. **尽早切到新 SDK**：别在废弃 SDK 上继续堆逻辑。\n5. **资源限制必须上**：边缘设备内存和 CPU 都是硬约束。\n\n## 七、踩坑速查表\n\n| 问题                 | 症状                             | 解决                       |\n| -------------------- | -------------------------------- | -------------------------- |\n| 旧 SDK 废弃          | `google.generativeai has ended`  | 切换 `google-genai`        |\n| `configure()` 不存在 | `AttributeError`                 | `Client(api_key=key)`      |\n| 地理限制             | `User location is not supported` | Cloudflare Worker 中转     |\n| Markdown 失败        | Telegram 400                     | 降级纯文本重试             |\n| 图片参数异常         | 空响应或报错                     | 固定 `temperature=1.0`     |\n| GPT-5 参数不兼容     | `max_tokens` 无效                | 改 `max_completion_tokens` |\n\n## 八、结语\n\n个人感觉, openClaw 还是挺好用的。\n如果你能忽略它以下几个缺点\n\n- 不能开箱即用(指写完配置就能跑)\n- 费钱, 帮我改了个很小的需求，烧了我的gemini 3刀....\n\n感觉当当玩具还是不错的.\n最后放上使用截图啦！\n![部署完成](/img/img_11.png)\n![开始使用](/img/img_12.png)&quot;],&quot;filePath&quot;:[0,&quot;source/posts/RK3528开发板部署OpenClaw-Telegram-Bot全记录.md&quot;],&quot;digest&quot;:[0,&quot;c1f2e3d1b77ff5c1&quot;],&quot;rendered&quot;:[0,{&quot;html&quot;:[0,&quot;&lt;blockquote&gt;\n&lt;p&gt;&lt;strong&gt;TL;DR&lt;/strong&gt;：在一块 4GB 内存的 RK3528 ARM 板子（Armbian）上，从零搭建了 Telegram Bot，接入 Gemini / GPT-5 / Claude 多模型，支持 AI 聊天、图片生成和系统代理操作。本文完整复盘部署步骤与核心踩坑。&lt;/p&gt;\n&lt;/blockquote&gt;\n&lt;h2 id=\&quot;一硬件与系统环境\&quot;&gt;一、硬件与系统环境&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#一硬件与系统环境\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;项目&lt;/th&gt;&lt;th&gt;配置&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;SoC&lt;/td&gt;&lt;td&gt;Rockchip RK3528（四核 ARM Cortex-A53）&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;内存&lt;/td&gt;&lt;td&gt;4GB DDR4&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;存储&lt;/td&gt;&lt;td&gt;64GB eMMC&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;系统&lt;/td&gt;&lt;td&gt;Armbian 25.11.0-trunk (Ubuntu 24.04 Noble)&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;内核&lt;/td&gt;&lt;td&gt;Linux 6.1.115-vendor-rk35xx aarch64&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;Python&lt;/td&gt;&lt;td&gt;3.12.3&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;Node.js&lt;/td&gt;&lt;td&gt;v24.11.1（通过 nvm）&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;网络&lt;/td&gt;&lt;td&gt;Clash TUN 模式全局代理&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;\n&lt;p&gt;这块板子原本用于轻量服务。实测下来，4GB 内存跑这种“网络请求驱动型”AI Bot 完全够用，瓶颈主要不在算力，而在网络质量和 API 稳定性。&lt;/p&gt;\n&lt;h2 id=\&quot;二架构总览\&quot;&gt;二、架构总览&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#二架构总览\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;最终部署架构：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;text\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;Telegram 用户&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;    │&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;    ▼ (Long Polling)&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;┌──────────────────────────┐&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;│  telegram-adapter.py     │ ← systemd 托管&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;│  (Python 3.12)           │&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;│                          │&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;│  ┌─ /chat 聊天模式 ─────┐│&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;│  │  Gemini 3 Flash/Pro  ││&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;│  │  GPT-5.2 / 5-Mini    ││&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;│  │  Claude Code (本地)   ││&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;│  └──────────────────────┘│&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;│  ┌─ /agent 代理模式 ────┐│&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;│  │  Gemini Function Call -&gt; model think -&gt; openClaw do ││&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;│  │  → shell / file / web ││&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;│  └──────────────────────┘│&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;│  ┌─ 图片生成 ───────────┐│&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;│  │  Gemini 2.5 Flash    ││&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;│  │  Image（自动检测）    ││&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;│  └──────────────────────┘│&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;└──────────────────────────┘&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;    │                  │&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;    ▼                  ▼&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt; SQLite DB        审计日志&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt; (状态/历史/Key)   /var/log/openclaw-agent/&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;核心设计决策：&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;使用 &lt;strong&gt;Long Polling&lt;/strong&gt;：无需公网 IP、无需 HTTPS 证书，部署成本最低。&lt;/li&gt;\n&lt;li&gt;支持 &lt;strong&gt;多模型热切换&lt;/strong&gt;：&lt;code&gt;/model gpt-5.2&lt;/code&gt; 直接切换，无需重启。&lt;/li&gt;\n&lt;li&gt;支持 &lt;strong&gt;图片生成自动路由&lt;/strong&gt;：识别“生成图片 / 画一张”类指令自动走图像模型。&lt;/li&gt;\n&lt;li&gt;代理模式使用 &lt;strong&gt;Function Calling&lt;/strong&gt;：AI 自主规划工具调用。&lt;/li&gt;\n&lt;li&gt;使用 &lt;strong&gt;SQLite 统一存储&lt;/strong&gt;：聊天历史、状态、API Key、任务审计集中管理。&lt;/li&gt;\n&lt;/ul&gt;\n&lt;h2 id=\&quot;三部署步骤\&quot;&gt;三、部署步骤&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#三部署步骤\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;h3 id=\&quot;31-目录结构\&quot;&gt;3.1 目录结构&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#31-目录结构\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;bash\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;mkdir&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; -p&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; /opt/openclaw/{scripts,config,work}&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;mkdir&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; -p&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; /var/log/openclaw-agent&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;text\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;/opt/openclaw/&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;├── config/&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;│   └── .env&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;├── scripts/&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;│   └── telegram-adapter.py&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;└── work/&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h3 id=\&quot;32-创建-telegram-bot\&quot;&gt;3.2 创建 Telegram Bot&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#32-创建-telegram-bot\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;ol&gt;\n&lt;li&gt;在 Telegram 搜索 &lt;code&gt;@BotFather&lt;/code&gt;，发送 &lt;code&gt;/newbot&lt;/code&gt;。&lt;/li&gt;\n&lt;li&gt;按提示创建 Bot，拿到 &lt;code&gt;Bot Token&lt;/code&gt;。&lt;/li&gt;\n&lt;li&gt;通过 &lt;code&gt;@userinfobot&lt;/code&gt; 获取自己的 &lt;code&gt;User ID&lt;/code&gt;。&lt;/li&gt;\n&lt;li&gt;将 Token 和 User ID 写入环境变量。&lt;/li&gt;\n&lt;/ol&gt;\n&lt;h3 id=\&quot;33-环境变量配置\&quot;&gt;3.3 环境变量配置&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#33-环境变量配置\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;bash\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;cat&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; &gt;&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; /opt/openclaw/config/.env&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; &amp;#x3C;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; &#39;EOF&#39;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;TELEGRAM_BOT_TOKEN=你的Bot_Token&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;TELEGRAM_ADMIN_USER_ID=你的User_ID&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;GEMINI_API_KEY=你的Gemini_Key&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;OPENCLAW_WORK_DIR=/opt/openclaw/work&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;OPENCLAW_LOG_DIR=/var/log/openclaw-agent&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;EOF&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;chmod&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; 600&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; /opt/openclaw/config/.env&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h3 id=\&quot;34-安装-python-依赖\&quot;&gt;3.4 安装 Python 依赖&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#34-安装-python-依赖\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;bash\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;pip3&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; install&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; --break-system-packages&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; requests&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; google-genai&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;blockquote&gt;\n&lt;p&gt;Ubuntu 24.04 + Python 3.12 默认受 PEP 668 约束。要么使用 venv，要么加 &lt;code&gt;--break-system-packages&lt;/code&gt; 做系统级安装。&lt;/p&gt;\n&lt;/blockquote&gt;\n&lt;h3 id=\&quot;35-部署主程序\&quot;&gt;3.5 部署主程序&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#35-部署主程序\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;bash\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;chmod&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; +x&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; /opt/openclaw/scripts/telegram-adapter.py&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;脚本首行为 &lt;code&gt;#!/usr/bin/env python3&lt;/code&gt;，可直接执行。&lt;/p&gt;\n&lt;h3 id=\&quot;36-systemd-服务\&quot;&gt;3.6 systemd 服务&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#36-systemd-服务\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;bash\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;cat&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; &gt;&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; /etc/systemd/system/openclaw-telegram.service&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; &amp;#x3C;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; &#39;EOF&#39;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;[Unit]&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;Description=OpenClaw Telegram Agent&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;After=network-online.target&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;Wants=network-online.target&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;StartLimitIntervalSec=60&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;StartLimitBurst=3&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;[Service]&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;Type=simple&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;User=root&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;WorkingDirectory=/opt/openclaw/work&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;EnvironmentFile=/opt/openclaw/config/.env&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;ExecStart=/opt/openclaw/scripts/telegram-adapter.py&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;Restart=on-failure&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;RestartSec=10&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;StandardOutput=journal&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;StandardError=journal&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;SyslogIdentifier=openclaw-telegram&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;MemoryMax=500M&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;CPUQuota=50%&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;PrivateTmp=yes&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;NoNewPrivileges=true&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;ProtectSystem=strict&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;ProtectHome=yes&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;ReadWritePaths=/opt/openclaw/work /var/log/openclaw-agent&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;[Install]&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;WantedBy=multi-user.target&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;EOF&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;systemctl&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; daemon-reload&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;systemctl&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; enable&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; openclaw-telegram&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;systemctl&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; start&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; openclaw-telegram&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h3 id=\&quot;37-验证\&quot;&gt;3.7 验证&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#37-验证\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;bash\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;systemctl&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; status&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; openclaw-telegram&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;journalctl&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; -u&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; openclaw-telegram&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; -f&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;在 Telegram 发送 &lt;code&gt;/ping&lt;/code&gt;，应收到 &lt;code&gt;pong + 主机名 + 时间&lt;/code&gt;。&lt;/p&gt;\n&lt;h2 id=\&quot;四踩坑全记录重点\&quot;&gt;四、踩坑全记录（重点）&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#四踩坑全记录重点\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;从“能跑”到“稳定可用”，这 6 个坑最关键。&lt;/p&gt;\n&lt;h3 id=\&quot;坑-1google-generativeai-已废弃必须换-google-genai\&quot;&gt;坑 1：&lt;code&gt;google-generativeai&lt;/code&gt; 已废弃，必须换 &lt;code&gt;google-genai&lt;/code&gt;&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#坑-1google-generativeai-已废弃必须换-google-genai\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;现象：启动后出现 &lt;code&gt;FutureWarning&lt;/code&gt;，提示旧 SDK 停止维护。&lt;br&gt;\n结论：直接切换到新 SDK，避免后续兼容问题。&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;bash\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;pip3&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; install&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; --break-system-packages&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; google-genai&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;python\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;import&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; google.genai &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;as&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; genai&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;from&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; google.genai &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;import&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; types&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;client &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; genai.Client(&lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;api_key&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;api_key)&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h3 id=\&quot;坑-2新-sdk-没有-genaiconfigure\&quot;&gt;坑 2：新 SDK 没有 &lt;code&gt;genai.configure()&lt;/code&gt;&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#坑-2新-sdk-没有-genaiconfigure\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;现象：调用 &lt;code&gt;genai.configure(api_key=...)&lt;/code&gt; 报 &lt;code&gt;AttributeError&lt;/code&gt;。&lt;br&gt;\n原因：这是旧 SDK 写法。&lt;br&gt;\n修复：初始化时直接传 API Key。&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;python\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;# 错误（旧写法）&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;genai.configure(&lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;api_key&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;api_key)&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;client &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; genai.Client()&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;# 正确（新写法）&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;client &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; genai.Client(&lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;api_key&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;api_key)&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h3 id=\&quot;坑-3gemini-api-地理位置限制数据中心出口-ip\&quot;&gt;坑 3：Gemini API 地理位置限制（数据中心出口 IP）&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#坑-3gemini-api-地理位置限制数据中心出口-ip\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;现象：Key 正确、代码正确，仍报 &lt;code&gt;User location is not supported for the API use.&lt;/code&gt;&lt;br&gt;\n原因：出口 IP 不在可用策略范围内。&lt;br&gt;\n修复：通过 Cloudflare Worker 做中转，再在 SDK 指定 &lt;code&gt;base_url&lt;/code&gt;。&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;javascript\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;export&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; default&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  async&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; fetch&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;request&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; url&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; new&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; URL&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(request.url);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    url.hostname &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; &#39;generativelanguage.googleapis.com&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    return&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; fetch&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;new&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Request&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(url, request));&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  },&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;};&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;python\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;client &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; genai.Client(&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;    api_key&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;api_key,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;    http_options&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;types.HttpOptions(&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;        base_url&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;https://your-worker.your-domain.workers.dev&#39;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    )&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h3 id=\&quot;坑-4telegram-markdown-解析炸裂\&quot;&gt;坑 4：Telegram Markdown 解析炸裂&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#坑-4telegram-markdown-解析炸裂\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;现象：AI 返回里只要含不规范 Markdown（如 &lt;code&gt;*&lt;/code&gt;、&lt;code&gt;_&lt;/code&gt;、&lt;code&gt;`&lt;/code&gt;、&lt;code&gt;[&lt;/code&gt; 未闭合），Telegram 直接 400。&lt;br&gt;\n风险：业务代码以为“已发送”，用户却收不到消息。&lt;br&gt;\n修复：发送失败后自动降级纯文本重试。&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;python\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;def&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; send_message&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(chat_id, text, reply_markup&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;None&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;):&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    data &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;        &#39;chat_id&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: chat_id,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;        &#39;text&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: text,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;        &#39;parse_mode&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;Markdown&#39;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    resp &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; requests.post(url, &lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;json&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;data, &lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;timeout&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;10&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;)&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    if&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; resp.status_code &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;==&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; 400&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;:&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;        logger.warning(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;Markdown parse failed, retrying as plain text&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;)&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;        data.pop(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;parse_mode&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;None&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;)&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;        resp &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; requests.post(url, &lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;json&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;data, &lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;timeout&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;10&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;同样逻辑也要覆盖 &lt;code&gt;send_photo&lt;/code&gt; 的 caption。&lt;/p&gt;\n&lt;h3 id=\&quot;坑-5gemini-图片生成-temperature-必须为-10\&quot;&gt;坑 5：Gemini 图片生成 &lt;code&gt;temperature&lt;/code&gt; 必须为 &lt;code&gt;1.0&lt;/code&gt;&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#坑-5gemini-图片生成-temperature-必须为-10\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;现象：复用聊天参数（如 &lt;code&gt;temperature=0.7&lt;/code&gt;）会导致图片接口异常或空响应。&lt;br&gt;\n修复：图像模式固定 &lt;code&gt;temperature=1.0&lt;/code&gt;，并声明 &lt;code&gt;response_modalities&lt;/code&gt;。&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;python\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;config &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; types.GenerateContentConfig(&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;    temperature&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;1.0&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;    max_output_tokens&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;2048&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;    response_modalities&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;[&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;TEXT&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;IMAGE&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;],&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h3 id=\&quot;坑-6gpt-5-系列参数兼容变更\&quot;&gt;坑 6：GPT-5 系列参数兼容变更&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#坑-6gpt-5-系列参数兼容变更\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;现象：&lt;code&gt;max_tokens&lt;/code&gt; 不生效。&lt;br&gt;\n修复：改用 &lt;code&gt;max_completion_tokens&lt;/code&gt;。&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;python\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;response &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; requests.post(&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;    &#39;https://api.openai.com/v1/chat/completions&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;    json&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;{&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;        &#39;model&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;gpt-5-mini-2025-08-07&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;        &#39;messages&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: messages,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;        &#39;max_completion_tokens&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;2048&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    },&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;    headers&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;{&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;Authorization&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;f&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;Bearer &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;{&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;api_key&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;}&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;},&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h2 id=\&quot;五最终能力与安全策略\&quot;&gt;五、最终能力与安全策略&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#五最终能力与安全策略\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;h3 id=\&quot;基础命令\&quot;&gt;基础命令&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#基础命令\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;命令&lt;/th&gt;&lt;th&gt;功能&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;&lt;code&gt;/ping&lt;/code&gt;&lt;/td&gt;&lt;td&gt;返回 pong + 主机名 + 时间&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;code&gt;/chat&lt;/code&gt;&lt;/td&gt;&lt;td&gt;进入 AI 聊天模式&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;code&gt;/agent&lt;/code&gt;&lt;/td&gt;&lt;td&gt;进入代理模式（AI 操作系统OpenClaw）&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;code&gt;/model&lt;/code&gt;&lt;/td&gt;&lt;td&gt;查看/切换模型&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;code&gt;/setkey gemini &amp;#x3C;key&gt;&lt;/code&gt;&lt;/td&gt;&lt;td&gt;设置 API Key&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;code&gt;/clear&lt;/code&gt;&lt;/td&gt;&lt;td&gt;清空对话历史&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;code&gt;/help&lt;/code&gt;&lt;/td&gt;&lt;td&gt;显示帮助&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;\n&lt;h3 id=\&quot;主要能力\&quot;&gt;主要能力&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#主要能力\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;ul&gt;\n&lt;li&gt;多轮对话与上下文记忆&lt;/li&gt;\n&lt;li&gt;多模型热切换（Gemini / GPT-5 / Claude）&lt;/li&gt;\n&lt;li&gt;图片生成与继续编辑&lt;/li&gt;\n&lt;li&gt;代理模式下的 shell / file / web 工具调用&lt;/li&gt;\n&lt;li&gt;危险命令拦截与审计日志记录&lt;/li&gt;\n&lt;/ul&gt;\n&lt;h3 id=\&quot;安全机制\&quot;&gt;安全机制&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#安全机制\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;strong&gt;用户白名单&lt;/strong&gt;：仅允许配置的管理员 User ID 操作。&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;命令黑名单&lt;/strong&gt;：默认拦截 &lt;code&gt;rm -rf&lt;/code&gt;、&lt;code&gt;dd&lt;/code&gt;、&lt;code&gt;mkfs&lt;/code&gt; 等高危命令。&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;审计追踪&lt;/strong&gt;：SQLite + 文件日志双轨记录。&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;资源限制&lt;/strong&gt;：&lt;code&gt;MemoryMax=500M&lt;/code&gt;、&lt;code&gt;CPUQuota=50%&lt;/code&gt;。&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;最小权限运行&lt;/strong&gt;：&lt;code&gt;ProtectSystem=strict&lt;/code&gt;、&lt;code&gt;ProtectHome=yes&lt;/code&gt;、&lt;code&gt;NoNewPrivileges=true&lt;/code&gt;。&lt;/li&gt;\n&lt;/ul&gt;\n&lt;h2 id=\&quot;六经验总结\&quot;&gt;六、经验总结&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#六经验总结\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;给准备在 ARM 板上跑 AI Bot 的同学几个建议：&lt;/p&gt;\n&lt;ol&gt;\n&lt;li&gt;&lt;strong&gt;ARM 兼容性不是问题&lt;/strong&gt;：真正的问题是网络、API 和异常处理。&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;Long Polling 是边缘部署最优解&lt;/strong&gt;：简单、稳定、低成本。&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;先做失败兜底，再做功能扩展&lt;/strong&gt;：特别是 Telegram Markdown fallback。&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;尽早切到新 SDK&lt;/strong&gt;：别在废弃 SDK 上继续堆逻辑。&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;资源限制必须上&lt;/strong&gt;：边缘设备内存和 CPU 都是硬约束。&lt;/li&gt;\n&lt;/ol&gt;\n&lt;h2 id=\&quot;七踩坑速查表\&quot;&gt;七、踩坑速查表&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#七踩坑速查表\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;问题&lt;/th&gt;&lt;th&gt;症状&lt;/th&gt;&lt;th&gt;解决&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;旧 SDK 废弃&lt;/td&gt;&lt;td&gt;&lt;code&gt;google.generativeai has ended&lt;/code&gt;&lt;/td&gt;&lt;td&gt;切换 &lt;code&gt;google-genai&lt;/code&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;code&gt;configure()&lt;/code&gt; 不存在&lt;/td&gt;&lt;td&gt;&lt;code&gt;AttributeError&lt;/code&gt;&lt;/td&gt;&lt;td&gt;&lt;code&gt;Client(api_key=key)&lt;/code&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;地理限制&lt;/td&gt;&lt;td&gt;&lt;code&gt;User location is not supported&lt;/code&gt;&lt;/td&gt;&lt;td&gt;Cloudflare Worker 中转&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;Markdown 失败&lt;/td&gt;&lt;td&gt;Telegram 400&lt;/td&gt;&lt;td&gt;降级纯文本重试&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;图片参数异常&lt;/td&gt;&lt;td&gt;空响应或报错&lt;/td&gt;&lt;td&gt;固定 &lt;code&gt;temperature=1.0&lt;/code&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;GPT-5 参数不兼容&lt;/td&gt;&lt;td&gt;&lt;code&gt;max_tokens&lt;/code&gt; 无效&lt;/td&gt;&lt;td&gt;改 &lt;code&gt;max_completion_tokens&lt;/code&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;\n&lt;h2 id=\&quot;八结语\&quot;&gt;八、结语&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#八结语\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;个人感觉, openClaw 还是挺好用的。\n如果你能忽略它以下几个缺点&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;不能开箱即用(指写完配置就能跑)&lt;/li&gt;\n&lt;li&gt;费钱, 帮我改了个很小的需求，烧了我的gemini 3刀…&lt;/li&gt;\n&lt;/ul&gt;\n&lt;p&gt;感觉当当玩具还是不错的.\n最后放上使用截图啦！\n&lt;/p&gt;&lt;figure class=\&quot;markdown-image-wrapper\&quot;&gt;&lt;img src=\&quot;/img/img_11.png\&quot; alt=\&quot;部署完成\&quot; loading=\&quot;lazy\&quot; decoding=\&quot;async\&quot; class=\&quot;markdown-image\&quot;&gt;&lt;/figure&gt;\n&lt;figure class=\&quot;markdown-image-wrapper\&quot;&gt;&lt;img src=\&quot;/img/img_12.png\&quot; alt=\&quot;开始使用\&quot; loading=\&quot;lazy\&quot; decoding=\&quot;async\&quot; class=\&quot;markdown-image\&quot;&gt;&lt;/figure&gt;&lt;p&gt;&lt;/p&gt;&quot;],&quot;metadata&quot;:[0,{&quot;headings&quot;:[1,[[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;一硬件与系统环境&quot;],&quot;text&quot;:[0,&quot;一、硬件与系统环境&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;二架构总览&quot;],&quot;text&quot;:[0,&quot;二、架构总览&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;三部署步骤&quot;],&quot;text&quot;:[0,&quot;三、部署步骤&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;31-目录结构&quot;],&quot;text&quot;:[0,&quot;3.1 目录结构&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;32-创建-telegram-bot&quot;],&quot;text&quot;:[0,&quot;3.2 创建 Telegram Bot&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;33-环境变量配置&quot;],&quot;text&quot;:[0,&quot;3.3 环境变量配置&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;34-安装-python-依赖&quot;],&quot;text&quot;:[0,&quot;3.4 安装 Python 依赖&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;35-部署主程序&quot;],&quot;text&quot;:[0,&quot;3.5 部署主程序&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;36-systemd-服务&quot;],&quot;text&quot;:[0,&quot;3.6 systemd 服务&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;37-验证&quot;],&quot;text&quot;:[0,&quot;3.7 验证&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;四踩坑全记录重点&quot;],&quot;text&quot;:[0,&quot;四、踩坑全记录（重点）&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;坑-1google-generativeai-已废弃必须换-google-genai&quot;],&quot;text&quot;:[0,&quot;坑 1：google-generativeai 已废弃，必须换 google-genai&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;坑-2新-sdk-没有-genaiconfigure&quot;],&quot;text&quot;:[0,&quot;坑 2：新 SDK 没有 genai.configure()&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;坑-3gemini-api-地理位置限制数据中心出口-ip&quot;],&quot;text&quot;:[0,&quot;坑 3：Gemini API 地理位置限制（数据中心出口 IP）&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;坑-4telegram-markdown-解析炸裂&quot;],&quot;text&quot;:[0,&quot;坑 4：Telegram Markdown 解析炸裂&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;坑-5gemini-图片生成-temperature-必须为-10&quot;],&quot;text&quot;:[0,&quot;坑 5：Gemini 图片生成 temperature 必须为 1.0&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;坑-6gpt-5-系列参数兼容变更&quot;],&quot;text&quot;:[0,&quot;坑 6：GPT-5 系列参数兼容变更&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;五最终能力与安全策略&quot;],&quot;text&quot;:[0,&quot;五、最终能力与安全策略&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;基础命令&quot;],&quot;text&quot;:[0,&quot;基础命令&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;主要能力&quot;],&quot;text&quot;:[0,&quot;主要能力&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;安全机制&quot;],&quot;text&quot;:[0,&quot;安全机制&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;六经验总结&quot;],&quot;text&quot;:[0,&quot;六、经验总结&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;七踩坑速查表&quot;],&quot;text&quot;:[0,&quot;七、踩坑速查表&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;八结语&quot;],&quot;text&quot;:[0,&quot;八、结语&quot;]}]]],&quot;localImagePaths&quot;:[1,[]],&quot;remoteImagePaths&quot;:[1,[]],&quot;frontmatter&quot;:[0,{&quot;title&quot;:[0,&quot;在 RK3528 ARM 开发板上部署 OpenClaw + Telegram Bot 全记录&quot;],&quot;date&quot;:[3,&quot;2026-02-07T10:30:00.000Z&quot;],&quot;tags&quot;:[1,[[0,&quot;OpenClaw&quot;],[0,&quot;Telegram Bot&quot;],[0,&quot;RK3528&quot;],[0,&quot;Armbian&quot;],[0,&quot;AI Agent&quot;]]],&quot;categories&quot;:[0,&quot;技术教程&quot;]}],&quot;imagePaths&quot;:[1,[]]}]}],&quot;collection&quot;:[0,&quot;blog&quot;]}],&quot;href&quot;:[0,&quot;/blog/post/45&quot;]}],[0,{&quot;post&quot;:[0,{&quot;id&quot;:[0,&quot;rust-树结构中-rc-与-weak-的配合使用&quot;],&quot;data&quot;:[0,{&quot;title&quot;:[0,&quot;Rust 树结构中 Rc 与 Weak 的配合使用&quot;],&quot;description&quot;:[0,&quot;深入探讨在 Rust 中构建树结构时，如何通过 Rc 和 Weak 智能指针的配合使用来避免循环引用导致的内存泄漏。本文详细讲解父子节点之间的引用关系设计原则，以及为什么父节点用 Rc 指向子节点，而子节点用 Weak 指向父节点。&quot;],&quot;date&quot;:[3,&quot;2025-12-06T00:00:00.000Z&quot;],&quot;tags&quot;:[1,[[0,&quot;Rust&quot;],[0,&quot;Rc&quot;],[0,&quot;Weak&quot;],[0,&quot;Smart Pointers&quot;],[0,&quot;Data Structures&quot;]]]}],&quot;body&quot;:[0,&quot;在 Rust 中构建树形数据结构时，我们经常需要处理父子节点之间的双向引用关系。如果处理不当，会导致循环引用（circular reference）和内存泄漏。本文将详细介绍如何通过 `Rc` 和 `Weak` 智能指针的配合使用来优雅地解决这个问题。\n\n## 核心原则\n\n在树结构中，节点之间的引用遵循以下原则：\n\n**父节点指向子节点：使用 `Rc&lt;T&gt;`**\n**子节点指向父节点：使用 `Weak&lt;T&gt;`**\n\n这个设计模式是避免循环引用的关键。\n\n## 为什么需要 Weak？\n\n### 循环引用问题\n\n如果我们同时使用 `Rc` 来表示父子双向引用，会产生循环引用：\n\n```rust\nuse std::rc::Rc;\nuse std::cell::RefCell;\n\n// ❌ 错误示例：会导致循环引用\nstruct Node {\n    value: i32,\n    parent: Option&lt;Rc&lt;RefCell&lt;Node&gt;&gt;&gt;,    // 使用 Rc 指向父节点\n    children: Vec&lt;Rc&lt;RefCell&lt;Node&gt;&gt;&gt;,     // 使用 Rc 指向子节点\n}\n```\n\n在这种设计下：\n\n- 父节点持有子节点的 `Rc`，引用计数 +1\n- 子节点持有父节点的 `Rc`，引用计数 +1\n- 当树结构离开作用域时，父子节点互相持有对方的强引用，引用计数永远不会降为 0\n- 结果：内存泄漏\n\n### 使用 Weak 打破循环\n\n`Weak&lt;T&gt;` 是一种不影响引用计数的\&quot;弱引用\&quot;。它可以观察 `Rc&lt;T&gt;` 指向的数据，但不会阻止数据被释放。\n\n```rust\nuse std::rc::{Rc, Weak};\nuse std::cell::RefCell;\n\n// ✅ 正确示例：使用 Weak 打破循环引用\nstruct Node {\n    value: i32,\n    parent: Option&lt;Weak&lt;RefCell&lt;Node&gt;&gt;&gt;,  // 使用 Weak 指向父节点\n    children: Vec&lt;Rc&lt;RefCell&lt;Node&gt;&gt;&gt;,     // 使用 Rc 指向子节点\n}\n\nimpl Node {\n    fn new(value: i32) -&gt; Rc&lt;RefCell&lt;Node&gt;&gt; {\n        Rc::new(RefCell::new(Node {\n            value,\n            parent: None,\n            children: Vec::new(),\n        }))\n    }\n}\n```\n\n## 所有权关系分析\n\n### 所有权流向\n\n在树结构中，所有权的流向是从上到下的：\n\n1. **父节点拥有子节点**：父节点通过 `Rc&lt;RefCell&lt;Node&gt;&gt;` 持有子节点的所有权\n2. **子节点不拥有父节点**：子节点通过 `Weak&lt;RefCell&lt;Node&gt;&gt;` 观察父节点，但不持有所有权\n3. **释放顺序**：当根节点被释放时，子节点的引用计数会递减，最终整棵树被正确释放\n\n### 为什么是这个方向？\n\n这个设计符合树结构的自然语义：\n\n- **父节点控制子节点的生命周期**：父节点存在，子节点才有意义\n- **子节点不应该延长父节点的生命**：子节点被某处引用时，不应该阻止父节点（乃至整棵树）被释放\n- **访问父节点需要检查有效性**：通过 `Weak::upgrade()` 访问父节点时，会得到 `Option&lt;Rc&lt;T&gt;&gt;`，自动处理父节点已被释放的情况\n\n## 实际使用示例\n\n```rust\nuse std::rc::{Rc, Weak};\nuse std::cell::RefCell;\n\nstruct Node {\n    value: i32,\n    parent: Option&lt;Weak&lt;RefCell&lt;Node&gt;&gt;&gt;,\n    children: Vec&lt;Rc&lt;RefCell&lt;Node&gt;&gt;&gt;,\n}\n\nimpl Node {\n    fn new(value: i32) -&gt; Rc&lt;RefCell&lt;Node&gt;&gt; {\n        Rc::new(RefCell::new(Node {\n            value,\n            parent: None,\n            children: Vec::new(),\n        }))\n    }\n\n    fn add_child(parent: &amp;Rc&lt;RefCell&lt;Node&gt;&gt;, child_value: i32) -&gt; Rc&lt;RefCell&lt;Node&gt;&gt; {\n        let child = Node::new(child_value);\n\n        // 子节点设置父节点的弱引用\n        child.borrow_mut().parent = Some(Rc::downgrade(parent));\n\n        // 父节点添加子节点的强引用\n        parent.borrow_mut().children.push(Rc::clone(&amp;child));\n\n        child\n    }\n\n    fn get_parent_value(node: &amp;Rc&lt;RefCell&lt;Node&gt;&gt;) -&gt; Option&lt;i32&gt; {\n        node.borrow()\n            .parent\n            .as_ref()\n            .and_then(|weak_parent| weak_parent.upgrade()) // 尝试升级为强引用\n            .map(|parent| parent.borrow().value)\n    }\n}\n\nfn main() {\n    // 创建根节点\n    let root = Node::new(1);\n\n    // 添加子节点\n    let child1 = Node::add_child(&amp;root, 2);\n    let child2 = Node::add_child(&amp;root, 3);\n\n    // 为子节点添加子节点\n    let grandchild = Node::add_child(&amp;child1, 4);\n\n    // 访问父节点\n    println!(\&quot;Grandchild&#39;s parent: {:?}\&quot;, Node::get_parent_value(&amp;grandchild)); // Some(2)\n    println!(\&quot;Child1&#39;s parent: {:?}\&quot;, Node::get_parent_value(&amp;child1));         // Some(1)\n\n    // 当 root 离开作用域时，整棵树会被正确释放\n}\n```\n\n## RefCell 的作用\n\n你可能注意到我们使用了 `Rc&lt;RefCell&lt;Node&gt;&gt;` 而不是 `Rc&lt;Node&gt;`。这是因为：\n\n- `Rc&lt;T&gt;` 提供共享所有权，但只允许不可变借用\n- `RefCell&lt;T&gt;` 提供内部可变性，允许在运行时进行可变借用检查\n- 组合使用可以实现\&quot;多个所有者可以修改数据\&quot;的需求\n\n在树结构中，我们需要从父节点修改子节点（添加子节点），也需要从子节点设置父节点引用，因此需要 `RefCell` 提供的内部可变性。\n\n## 关键要点总结\n\n1. **父 → 子：`Rc`**，表示强引用和所有权\n2. **子 → 父：`Weak`**，表示弱引用和观察关系\n3. **访问 Weak 引用**：使用 `upgrade()` 方法尝试获取 `Rc`，返回 `Option&lt;Rc&lt;T&gt;&gt;`\n4. **创建 Weak 引用**：使用 `Rc::downgrade()` 从 `Rc` 创建 `Weak`\n5. **避免循环引用**：Weak 不增加引用计数，打破循环\n6. **配合 RefCell**：实现共享可变性\n\n通过这种设计模式，我们可以在 Rust 中安全地构建复杂的树形数据结构，既满足所有权规则，又避免内存泄漏。&quot;],&quot;filePath&quot;:[0,&quot;source/posts/Rust-树结构中-Rc-与-Weak-的配合使用.md&quot;],&quot;digest&quot;:[0,&quot;95fd25134235bb5b&quot;],&quot;rendered&quot;:[0,{&quot;html&quot;:[0,&quot;&lt;p&gt;在 Rust 中构建树形数据结构时，我们经常需要处理父子节点之间的双向引用关系。如果处理不当，会导致循环引用（circular reference）和内存泄漏。本文将详细介绍如何通过 &lt;code&gt;Rc&lt;/code&gt; 和 &lt;code&gt;Weak&lt;/code&gt; 智能指针的配合使用来优雅地解决这个问题。&lt;/p&gt;\n&lt;h2 id=\&quot;核心原则\&quot;&gt;核心原则&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#核心原则\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;在树结构中，节点之间的引用遵循以下原则：&lt;/p&gt;\n&lt;p&gt;&lt;strong&gt;父节点指向子节点：使用 &lt;code&gt;Rc&amp;#x3C;T&gt;&lt;/code&gt;&lt;/strong&gt;\n&lt;strong&gt;子节点指向父节点：使用 &lt;code&gt;Weak&amp;#x3C;T&gt;&lt;/code&gt;&lt;/strong&gt;&lt;/p&gt;\n&lt;p&gt;这个设计模式是避免循环引用的关键。&lt;/p&gt;\n&lt;h2 id=\&quot;为什么需要-weak\&quot;&gt;为什么需要 Weak？&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#为什么需要-weak\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;h3 id=\&quot;循环引用问题\&quot;&gt;循环引用问题&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#循环引用问题\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;如果我们同时使用 &lt;code&gt;Rc&lt;/code&gt; 来表示父子双向引用，会产生循环引用：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;rust\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;use&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; std&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;rc&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Rc&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;use&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; std&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;cell&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;RefCell&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// ❌ 错误示例：会导致循环引用&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;struct&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Node&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    value&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;:&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; i32&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    parent&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;:&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Option&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Rc&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;RefCell&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Node&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&gt;&gt;&gt;,    &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 使用 Rc 指向父节点&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    children&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;:&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Vec&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Rc&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;RefCell&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Node&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&gt;&gt;&gt;,     &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 使用 Rc 指向子节点&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;在这种设计下：&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;父节点持有子节点的 &lt;code&gt;Rc&lt;/code&gt;，引用计数 +1&lt;/li&gt;\n&lt;li&gt;子节点持有父节点的 &lt;code&gt;Rc&lt;/code&gt;，引用计数 +1&lt;/li&gt;\n&lt;li&gt;当树结构离开作用域时，父子节点互相持有对方的强引用，引用计数永远不会降为 0&lt;/li&gt;\n&lt;li&gt;结果：内存泄漏&lt;/li&gt;\n&lt;/ul&gt;\n&lt;h3 id=\&quot;使用-weak-打破循环\&quot;&gt;使用 Weak 打破循环&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#使用-weak-打破循环\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;&lt;code&gt;Weak&amp;#x3C;T&gt;&lt;/code&gt; 是一种不影响引用计数的”弱引用”。它可以观察 &lt;code&gt;Rc&amp;#x3C;T&gt;&lt;/code&gt; 指向的数据，但不会阻止数据被释放。&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;rust\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;use&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; std&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;rc&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;{&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Rc&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Weak&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;};&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;use&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; std&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;cell&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;RefCell&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// ✅ 正确示例：使用 Weak 打破循环引用&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;struct&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Node&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    value&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;:&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; i32&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    parent&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;:&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Option&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Weak&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;RefCell&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Node&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&gt;&gt;&gt;,  &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 使用 Weak 指向父节点&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    children&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;:&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Vec&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Rc&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;RefCell&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Node&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&gt;&gt;&gt;,     &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 使用 Rc 指向子节点&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;impl&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Node&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    fn&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; new&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(value&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;:&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; i32&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;) &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;-&gt;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Rc&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;RefCell&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Node&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&gt;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;        Rc&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;new&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;RefCell&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;new&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Node&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;            value,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;            parent&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;:&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; None&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;            children&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;:&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Vec&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;new&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(),&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;        }))&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h2 id=\&quot;所有权关系分析\&quot;&gt;所有权关系分析&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#所有权关系分析\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;h3 id=\&quot;所有权流向\&quot;&gt;所有权流向&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#所有权流向\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;在树结构中，所有权的流向是从上到下的：&lt;/p&gt;\n&lt;ol&gt;\n&lt;li&gt;&lt;strong&gt;父节点拥有子节点&lt;/strong&gt;：父节点通过 &lt;code&gt;Rc&amp;#x3C;RefCell&amp;#x3C;Node&gt;&gt;&lt;/code&gt; 持有子节点的所有权&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;子节点不拥有父节点&lt;/strong&gt;：子节点通过 &lt;code&gt;Weak&amp;#x3C;RefCell&amp;#x3C;Node&gt;&gt;&lt;/code&gt; 观察父节点，但不持有所有权&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;释放顺序&lt;/strong&gt;：当根节点被释放时，子节点的引用计数会递减，最终整棵树被正确释放&lt;/li&gt;\n&lt;/ol&gt;\n&lt;h3 id=\&quot;为什么是这个方向\&quot;&gt;为什么是这个方向？&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#为什么是这个方向\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;这个设计符合树结构的自然语义：&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;strong&gt;父节点控制子节点的生命周期&lt;/strong&gt;：父节点存在，子节点才有意义&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;子节点不应该延长父节点的生命&lt;/strong&gt;：子节点被某处引用时，不应该阻止父节点（乃至整棵树）被释放&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;访问父节点需要检查有效性&lt;/strong&gt;：通过 &lt;code&gt;Weak::upgrade()&lt;/code&gt; 访问父节点时，会得到 &lt;code&gt;Option&amp;#x3C;Rc&amp;#x3C;T&gt;&gt;&lt;/code&gt;，自动处理父节点已被释放的情况&lt;/li&gt;\n&lt;/ul&gt;\n&lt;h2 id=\&quot;实际使用示例\&quot;&gt;实际使用示例&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#实际使用示例\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;rust\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;use&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; std&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;rc&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;{&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Rc&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Weak&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;};&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;use&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; std&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;cell&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;RefCell&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;struct&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Node&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    value&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;:&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; i32&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    parent&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;:&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Option&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Weak&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;RefCell&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Node&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&gt;&gt;&gt;,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    children&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;:&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Vec&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Rc&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;RefCell&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Node&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&gt;&gt;&gt;,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;impl&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Node&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    fn&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; new&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(value&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;:&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; i32&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;) &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;-&gt;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Rc&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;RefCell&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Node&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&gt;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;        Rc&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;new&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;RefCell&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;new&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Node&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;            value,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;            parent&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;:&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; None&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;            children&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;:&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Vec&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;new&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(),&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;        }))&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    fn&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; add_child&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(parent&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;:&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; &amp;#x26;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Rc&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;RefCell&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Node&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&gt;&gt;, child_value&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;:&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; i32&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;) &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;-&gt;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Rc&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;RefCell&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Node&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&gt;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;        let&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; child &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Node&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;new&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(child_value);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;        // 子节点设置父节点的弱引用&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;        child&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;borrow_mut&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;()&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;.&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;parent &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Some&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Rc&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;downgrade&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(parent));&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;        // 父节点添加子节点的强引用&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;        parent&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;borrow_mut&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;()&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;.&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;children&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;push&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Rc&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;clone&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;&amp;#x26;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;child));&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;        child&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    fn&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; get_parent_value&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(node&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;:&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; &amp;#x26;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Rc&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;RefCell&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Node&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&gt;&gt;) &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;-&gt;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Option&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;i32&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;        node&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;borrow&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;()&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;            .&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;parent&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;            .&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;as_ref&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;()&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;            .&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;and_then&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;|&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;weak_parent&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;|&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; weak_parent&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;upgrade&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;()) &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 尝试升级为强引用&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;            .&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;map&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;|&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;parent&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;|&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; parent&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;borrow&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;()&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;.&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;value)&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;fn&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; main&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;() {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;    // 创建根节点&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    let&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; root &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Node&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;new&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;1&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;    // 添加子节点&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    let&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; child1 &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Node&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;add_child&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;&amp;#x26;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;root, &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;2&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    let&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; child2 &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Node&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;add_child&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;&amp;#x26;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;root, &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;3&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;    // 为子节点添加子节点&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    let&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; grandchild &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Node&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;add_child&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;&amp;#x26;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;child1, &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;4&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;    // 访问父节点&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;    println!&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;\&quot;Grandchild&#39;s parent: {:?}\&quot;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Node&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;get_parent_value&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;&amp;#x26;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;grandchild)); &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// Some(2)&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;    println!&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;\&quot;Child1&#39;s parent: {:?}\&quot;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Node&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;get_parent_value&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;&amp;#x26;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;child1));         &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// Some(1)&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;    // 当 root 离开作用域时，整棵树会被正确释放&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h2 id=\&quot;refcell-的作用\&quot;&gt;RefCell 的作用&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#refcell-的作用\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;你可能注意到我们使用了 &lt;code&gt;Rc&amp;#x3C;RefCell&amp;#x3C;Node&gt;&gt;&lt;/code&gt; 而不是 &lt;code&gt;Rc&amp;#x3C;Node&gt;&lt;/code&gt;。这是因为：&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;code&gt;Rc&amp;#x3C;T&gt;&lt;/code&gt; 提供共享所有权，但只允许不可变借用&lt;/li&gt;\n&lt;li&gt;&lt;code&gt;RefCell&amp;#x3C;T&gt;&lt;/code&gt; 提供内部可变性，允许在运行时进行可变借用检查&lt;/li&gt;\n&lt;li&gt;组合使用可以实现”多个所有者可以修改数据”的需求&lt;/li&gt;\n&lt;/ul&gt;\n&lt;p&gt;在树结构中，我们需要从父节点修改子节点（添加子节点），也需要从子节点设置父节点引用，因此需要 &lt;code&gt;RefCell&lt;/code&gt; 提供的内部可变性。&lt;/p&gt;\n&lt;h2 id=\&quot;关键要点总结\&quot;&gt;关键要点总结&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#关键要点总结\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;ol&gt;\n&lt;li&gt;&lt;strong&gt;父 → 子：&lt;code&gt;Rc&lt;/code&gt;&lt;/strong&gt;，表示强引用和所有权&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;子 → 父：&lt;code&gt;Weak&lt;/code&gt;&lt;/strong&gt;，表示弱引用和观察关系&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;访问 Weak 引用&lt;/strong&gt;：使用 &lt;code&gt;upgrade()&lt;/code&gt; 方法尝试获取 &lt;code&gt;Rc&lt;/code&gt;，返回 &lt;code&gt;Option&amp;#x3C;Rc&amp;#x3C;T&gt;&gt;&lt;/code&gt;&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;创建 Weak 引用&lt;/strong&gt;：使用 &lt;code&gt;Rc::downgrade()&lt;/code&gt; 从 &lt;code&gt;Rc&lt;/code&gt; 创建 &lt;code&gt;Weak&lt;/code&gt;&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;避免循环引用&lt;/strong&gt;：Weak 不增加引用计数，打破循环&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;配合 RefCell&lt;/strong&gt;：实现共享可变性&lt;/li&gt;\n&lt;/ol&gt;\n&lt;p&gt;通过这种设计模式，我们可以在 Rust 中安全地构建复杂的树形数据结构，既满足所有权规则，又避免内存泄漏。&lt;/p&gt;&quot;],&quot;metadata&quot;:[0,{&quot;headings&quot;:[1,[[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;核心原则&quot;],&quot;text&quot;:[0,&quot;核心原则&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;为什么需要-weak&quot;],&quot;text&quot;:[0,&quot;为什么需要 Weak？&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;循环引用问题&quot;],&quot;text&quot;:[0,&quot;循环引用问题&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;使用-weak-打破循环&quot;],&quot;text&quot;:[0,&quot;使用 Weak 打破循环&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;所有权关系分析&quot;],&quot;text&quot;:[0,&quot;所有权关系分析&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;所有权流向&quot;],&quot;text&quot;:[0,&quot;所有权流向&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;为什么是这个方向&quot;],&quot;text&quot;:[0,&quot;为什么是这个方向？&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;实际使用示例&quot;],&quot;text&quot;:[0,&quot;实际使用示例&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;refcell-的作用&quot;],&quot;text&quot;:[0,&quot;RefCell 的作用&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;关键要点总结&quot;],&quot;text&quot;:[0,&quot;关键要点总结&quot;]}]]],&quot;localImagePaths&quot;:[1,[]],&quot;remoteImagePaths&quot;:[1,[]],&quot;frontmatter&quot;:[0,{&quot;title&quot;:[0,&quot;Rust 树结构中 Rc 与 Weak 的配合使用&quot;],&quot;date&quot;:[3,&quot;2025-12-06T00:00:00.000Z&quot;],&quot;tags&quot;:[1,[[0,&quot;Rust&quot;],[0,&quot;Rc&quot;],[0,&quot;Weak&quot;],[0,&quot;Smart Pointers&quot;],[0,&quot;Data Structures&quot;]]],&quot;description&quot;:[0,&quot;深入探讨在 Rust 中构建树结构时，如何通过 Rc 和 Weak 智能指针的配合使用来避免循环引用导致的内存泄漏。本文详细讲解父子节点之间的引用关系设计原则，以及为什么父节点用 Rc 指向子节点，而子节点用 Weak 指向父节点。&quot;]}],&quot;imagePaths&quot;:[1,[]]}]}],&quot;collection&quot;:[0,&quot;blog&quot;]}],&quot;href&quot;:[0,&quot;/blog/post/38&quot;]}],[0,{&quot;post&quot;:[0,{&quot;id&quot;:[0,&quot;rust-cow-learning-notes&quot;],&quot;data&quot;:[0,{&quot;title&quot;:[0,&quot;Rust Cow（Clone-On-Write）学习笔记：理解 Borrowed 状态&quot;],&quot;description&quot;:[0,&quot;本文通过一个具体的测试案例，深入探讨了 Rust 中 Cow（Clone-On-Write）智能指针的 Borrowed 状态。我们将理解在何种情况下 Cow 会保持借用，以及它何时会克隆数据变为所有。&quot;],&quot;date&quot;:[3,&quot;2025-12-05T00:00:00.000Z&quot;],&quot;tags&quot;:[1,[[0,&quot;Rust&quot;],[0,&quot;Cow&quot;],[0,&quot;Smart Pointers&quot;],[0,&quot;Borrowing&quot;]]]}],&quot;body&quot;:[0,&quot;在 Rust 的智能指针中，`Cow` (Clone-On-Write) 提供了一种灵活的数据处理方式，它可以在需要时才进行数据克隆，从而优化性能。本文将通过一个具体的案例，来深入理解 `Cow` 的 `Borrowed` 状态。\n\n### `Cow::Borrowed` 是什么？\n\n在 Rust 中，`Cow` 类型有两种主要的状态：\n\n- `Cow::Borrowed&lt;&#39;a, T&gt;`：表示 `Cow` 只是“借用”了原始数据，它持有一个对类型 `T` 的不可变引用 `&amp;&#39;a T`。在这种状态下，`Cow` 不拥有数据的所有权，也不会对原始数据进行任何修改。\n- `Cow::Owned&lt;T&gt;`：表示 `Cow` 拥有了一份数据的副本。当需要修改数据，且 `Cow` 当前处于 `Borrowed` 状态时，它会自动克隆一份数据，并转换为 `Owned` 状态，从而允许进行修改。\n\n### 案例分析：`reference_no_mutation` 测试\n\n我们来看一个在 `rustlings` 练习中常见的测试案例，它帮助我们理解 `Cow` 的行为：\n\n```rust\n// 假设有如下的 abs_all 函数\nfn abs_all&lt;&#39;a, T&gt;(input: Cow&lt;&#39;a, [T]&gt;) -&gt; Cow&lt;&#39;a, [T]&gt;\nwhere\n    T: Clone + Copy + PartialOrd + std::ops::Neg&lt;Output = T&gt;,\n{\n    input\n        .into_iter()\n        .map(|&amp;x| if x &lt; T::from(0) { -x } else { x })\n        .collect::&lt;Vec&lt;T&gt;&gt;()\n        .into()\n}\n\n// 在 reference_no_mutation 测试中\nlet input_vec = vec![0, 1, 2];\nlet mut input = Cow::from(&amp;input_vec); // 通过 Cow::from(&amp;vec) 创建，此时 input 是 Borrowed 状态\nlet result = abs_all(input.clone()); // 传入 abs_all 函数\n\nassert!(matches!(input, Cow::Borrowed(_))); // 这个断言会成功\n```\n\n**分析过程：**\n\n1.  **创建 `Cow`：** 在 `reference_no_mutation` 测试中，`input` 是通过 `Cow::from(&amp;input_vec)` 创建的。这意味着 `input` 最初是对 `input_vec` 的一个借用 (`Cow::Borrowed`)，它不拥有数据的所有权。\n\n2.  **`abs_all` 函数的行为：** `abs_all` 函数的目的是将切片中的所有负数变为正数（取绝对值）。它通过 `into_iter().map(...)` 遍历元素。关键在于 `map` 内部的逻辑：`if x &lt; T::from(0) { -x } else { x }`。只有当元素 `x` 小于 0 时，才会进行操作 `-x`。\n\n3.  **无修改发生：** 在这个特定的测试中，`input_vec` 的内容是 `[0, 1, 2]`，所有元素都是非负数。因此，在 `abs_all` 函数内部，条件 `x &lt; T::from(0)` **从未**满足。这意味着 `input`（或者其内部数据）并没有被实际修改。\n\n4.  **`to_mut()` 未被调用：** `Cow` 只有在需要修改借用的数据时，才会调用 `to_mut()` 方法来克隆数据并转换为 `Owned` 状态。由于上述原因，没有任何元素需要修改，所以 `to_mut()` 从未被调用。\n\n5.  **结果：保持 `Borrowed` 状态：** 因为 `input` 在 `abs_all` 函数的整个执行过程中都没有被修改，也因此没有触发数据克隆，`input` 仍然保持着对原始数据 `input_vec` 的借用状态。\n\n### 结论\n\n因此，`assert!(matches!(input, Cow::Borrowed(_)))` 断言成立。这个例子清晰地展示了 `Cow` 的“Copy-On-Write”机制：只有在实际需要写入（修改）时，才会发生数据的克隆和所有权的转移。如果数据仅仅被读取，`Cow` 会高效地保持 `Borrowed` 状态，避免不必要的内存分配和数据复制。理解这一点对于编写高效的 Rust 代码至关重要。&quot;],&quot;filePath&quot;:[0,&quot;source/posts/rust-cow-learning-notes.md&quot;],&quot;digest&quot;:[0,&quot;dbda7a0aedd34573&quot;],&quot;rendered&quot;:[0,{&quot;html&quot;:[0,&quot;&lt;p&gt;在 Rust 的智能指针中，&lt;code&gt;Cow&lt;/code&gt; (Clone-On-Write) 提供了一种灵活的数据处理方式，它可以在需要时才进行数据克隆，从而优化性能。本文将通过一个具体的案例，来深入理解 &lt;code&gt;Cow&lt;/code&gt; 的 &lt;code&gt;Borrowed&lt;/code&gt; 状态。&lt;/p&gt;\n&lt;h3 id=\&quot;cowborrowed-是什么\&quot;&gt;&lt;code&gt;Cow::Borrowed&lt;/code&gt; 是什么？&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#cowborrowed-是什么\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;在 Rust 中，&lt;code&gt;Cow&lt;/code&gt; 类型有两种主要的状态：&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;code&gt;Cow::Borrowed&amp;#x3C;&#39;a, T&gt;&lt;/code&gt;：表示 &lt;code&gt;Cow&lt;/code&gt; 只是“借用”了原始数据，它持有一个对类型 &lt;code&gt;T&lt;/code&gt; 的不可变引用 &lt;code&gt;&amp;#x26;&#39;a T&lt;/code&gt;。在这种状态下，&lt;code&gt;Cow&lt;/code&gt; 不拥有数据的所有权，也不会对原始数据进行任何修改。&lt;/li&gt;\n&lt;li&gt;&lt;code&gt;Cow::Owned&amp;#x3C;T&gt;&lt;/code&gt;：表示 &lt;code&gt;Cow&lt;/code&gt; 拥有了一份数据的副本。当需要修改数据，且 &lt;code&gt;Cow&lt;/code&gt; 当前处于 &lt;code&gt;Borrowed&lt;/code&gt; 状态时，它会自动克隆一份数据，并转换为 &lt;code&gt;Owned&lt;/code&gt; 状态，从而允许进行修改。&lt;/li&gt;\n&lt;/ul&gt;\n&lt;h3 id=\&quot;案例分析reference_no_mutation-测试\&quot;&gt;案例分析：&lt;code&gt;reference_no_mutation&lt;/code&gt; 测试&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#案例分析reference_no_mutation-测试\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;我们来看一个在 &lt;code&gt;rustlings&lt;/code&gt; 练习中常见的测试案例，它帮助我们理解 &lt;code&gt;Cow&lt;/code&gt; 的行为：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;rust\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 假设有如下的 abs_all 函数&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;fn&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; abs_all&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&#39;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;a&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;T&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&gt;(input&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;:&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Cow&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&#39;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;a&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, [&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;T&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;]&gt;) &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;-&gt;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Cow&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&#39;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;a&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, [&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;T&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;]&gt;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;where&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;    T&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;:&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Clone&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; +&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Copy&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; +&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; PartialOrd&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; +&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; std&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;ops&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Neg&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Output&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; T&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&gt;,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;{&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    input&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;        .&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;into_iter&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;()&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;        .&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;map&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;|&amp;#x26;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;x&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;|&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; if&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; x &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; T&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;from&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;0&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;) { &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;-&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;x } &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;else&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; { x })&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;        .&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;collect&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Vec&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;T&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&gt;&gt;()&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;        .&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;into&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;()&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 在 reference_no_mutation 测试中&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;let&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; input_vec &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; vec!&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;[&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;0&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;1&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;2&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;];&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;let&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; mut&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; input &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Cow&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;from&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;&amp;#x26;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;input_vec); &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 通过 Cow::from(&amp;#x26;vec) 创建，此时 input 是 Borrowed 状态&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;let&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; result &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; abs_all&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(input&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;clone&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;()); &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 传入 abs_all 函数&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;assert!&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;matches!&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(input, &lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Cow&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Borrowed&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(_))); &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 这个断言会成功&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;&lt;strong&gt;分析过程：&lt;/strong&gt;&lt;/p&gt;\n&lt;ol&gt;\n&lt;li&gt;\n&lt;p&gt;&lt;strong&gt;创建 &lt;code&gt;Cow&lt;/code&gt;：&lt;/strong&gt; 在 &lt;code&gt;reference_no_mutation&lt;/code&gt; 测试中，&lt;code&gt;input&lt;/code&gt; 是通过 &lt;code&gt;Cow::from(&amp;#x26;input_vec)&lt;/code&gt; 创建的。这意味着 &lt;code&gt;input&lt;/code&gt; 最初是对 &lt;code&gt;input_vec&lt;/code&gt; 的一个借用 (&lt;code&gt;Cow::Borrowed&lt;/code&gt;)，它不拥有数据的所有权。&lt;/p&gt;\n&lt;/li&gt;\n&lt;li&gt;\n&lt;p&gt;&lt;strong&gt;&lt;code&gt;abs_all&lt;/code&gt; 函数的行为：&lt;/strong&gt; &lt;code&gt;abs_all&lt;/code&gt; 函数的目的是将切片中的所有负数变为正数（取绝对值）。它通过 &lt;code&gt;into_iter().map(...)&lt;/code&gt; 遍历元素。关键在于 &lt;code&gt;map&lt;/code&gt; 内部的逻辑：&lt;code&gt;if x &amp;#x3C; T::from(0) { -x } else { x }&lt;/code&gt;。只有当元素 &lt;code&gt;x&lt;/code&gt; 小于 0 时，才会进行操作 &lt;code&gt;-x&lt;/code&gt;。&lt;/p&gt;\n&lt;/li&gt;\n&lt;li&gt;\n&lt;p&gt;&lt;strong&gt;无修改发生：&lt;/strong&gt; 在这个特定的测试中，&lt;code&gt;input_vec&lt;/code&gt; 的内容是 &lt;code&gt;[0, 1, 2]&lt;/code&gt;，所有元素都是非负数。因此，在 &lt;code&gt;abs_all&lt;/code&gt; 函数内部，条件 &lt;code&gt;x &amp;#x3C; T::from(0)&lt;/code&gt; &lt;strong&gt;从未&lt;/strong&gt;满足。这意味着 &lt;code&gt;input&lt;/code&gt;（或者其内部数据）并没有被实际修改。&lt;/p&gt;\n&lt;/li&gt;\n&lt;li&gt;\n&lt;p&gt;&lt;strong&gt;&lt;code&gt;to_mut()&lt;/code&gt; 未被调用：&lt;/strong&gt; &lt;code&gt;Cow&lt;/code&gt; 只有在需要修改借用的数据时，才会调用 &lt;code&gt;to_mut()&lt;/code&gt; 方法来克隆数据并转换为 &lt;code&gt;Owned&lt;/code&gt; 状态。由于上述原因，没有任何元素需要修改，所以 &lt;code&gt;to_mut()&lt;/code&gt; 从未被调用。&lt;/p&gt;\n&lt;/li&gt;\n&lt;li&gt;\n&lt;p&gt;&lt;strong&gt;结果：保持 &lt;code&gt;Borrowed&lt;/code&gt; 状态：&lt;/strong&gt; 因为 &lt;code&gt;input&lt;/code&gt; 在 &lt;code&gt;abs_all&lt;/code&gt; 函数的整个执行过程中都没有被修改，也因此没有触发数据克隆，&lt;code&gt;input&lt;/code&gt; 仍然保持着对原始数据 &lt;code&gt;input_vec&lt;/code&gt; 的借用状态。&lt;/p&gt;\n&lt;/li&gt;\n&lt;/ol&gt;\n&lt;h3 id=\&quot;结论\&quot;&gt;结论&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#结论\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;因此，&lt;code&gt;assert!(matches!(input, Cow::Borrowed(_)))&lt;/code&gt; 断言成立。这个例子清晰地展示了 &lt;code&gt;Cow&lt;/code&gt; 的“Copy-On-Write”机制：只有在实际需要写入（修改）时，才会发生数据的克隆和所有权的转移。如果数据仅仅被读取，&lt;code&gt;Cow&lt;/code&gt; 会高效地保持 &lt;code&gt;Borrowed&lt;/code&gt; 状态，避免不必要的内存分配和数据复制。理解这一点对于编写高效的 Rust 代码至关重要。&lt;/p&gt;&quot;],&quot;metadata&quot;:[0,{&quot;headings&quot;:[1,[[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;cowborrowed-是什么&quot;],&quot;text&quot;:[0,&quot;Cow::Borrowed 是什么？&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;案例分析reference_no_mutation-测试&quot;],&quot;text&quot;:[0,&quot;案例分析：reference_no_mutation 测试&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;结论&quot;],&quot;text&quot;:[0,&quot;结论&quot;]}]]],&quot;localImagePaths&quot;:[1,[]],&quot;remoteImagePaths&quot;:[1,[]],&quot;frontmatter&quot;:[0,{&quot;title&quot;:[0,&quot;Rust Cow（Clone-On-Write）学习笔记：理解 Borrowed 状态&quot;],&quot;date&quot;:[3,&quot;2025-12-05T00:00:00.000Z&quot;],&quot;tags&quot;:[1,[[0,&quot;Rust&quot;],[0,&quot;Cow&quot;],[0,&quot;Smart Pointers&quot;],[0,&quot;Borrowing&quot;]]],&quot;description&quot;:[0,&quot;本文通过一个具体的测试案例，深入探讨了 Rust 中 Cow（Clone-On-Write）智能指针的 Borrowed 状态。我们将理解在何种情况下 Cow 会保持借用，以及它何时会克隆数据变为所有。&quot;]}],&quot;imagePaths&quot;:[1,[]]}]}],&quot;collection&quot;:[0,&quot;blog&quot;]}],&quot;href&quot;:[0,&quot;/blog/post/37&quot;]}],[0,{&quot;post&quot;:[0,{&quot;id&quot;:[0,&quot;electron热更新后启动性能优化-v8缓存与代码拆包实战&quot;],&quot;data&quot;:[0,{&quot;title&quot;:[0,&quot;Electron 热更新后启动性能优化：V8 缓存与代码拆包实战&quot;],&quot;description&quot;:[0,&quot;深入实战 Electron 应用性能优化，通过启用 V8 代码缓存、Vite 模块拆包、按需导入和延迟加载等手段，将主进程启动时间从 1619ms 优化到 311ms，性能提升 80%。详解 V8 JIT 编译原理、manualChunks 拆包策略及实际优化效果对比。&quot;],&quot;date&quot;:[3,&quot;2025-11-18T18:00:00.000Z&quot;],&quot;tags&quot;:[1,[[0,&quot;Electron&quot;],[0,&quot;性能优化&quot;],[0,&quot;V8&quot;],[0,&quot;Vite&quot;],[0,&quot;热更新&quot;]]],&quot;categories&quot;:[0,&quot;技术教程&quot;]}],&quot;body&quot;:[0,&quot;## 前言\n\n在 Electron 应用开发中，热更新后的首次启动速度直接影响用户体验。将主进程启动时间从 1619ms 优化到 311ms 的完整实践过程。\n\n## 性能数据对比\n\n通过以下优化手段，我们实现了显著的性能提升：\n\n| 指标                   | 优化前    | 优化后   | 提升幅度    |\n| ---------------------- | --------- | -------- | ----------- |\n| **主进程启动总耗时**   | 1619.32ms | 311.88ms | **80.7% ↓** |\n| **app.whenReady 耗时** | 833.46ms  | 126.61ms | **84.8% ↓** |\n| **窗口创建耗时**       | 536.34ms  | 140.59ms | **73.8% ↓** |\n| **V8 缓存文件数量**    | 9543 个   | 9043 个  | 优化后稳定  |\n\n从实际日志数据来看：\n\n```log\n# 优化前（2025-11-18 16:37:59）\n[info] ⏱️ 主进程启动开始\n[info] ⏱️ app.whenReady 触发，耗时: 833.46ms\n[info] 📦 V8 代码缓存文件数量: 9543\n[info] ⏱️ 窗口创建耗时: 536.34ms\n[info] ⏱️ ✅ 主进程启动完成，总耗时: 1619.32ms\n\n# 优化后（2025-11-18 17:10:30）\n[info] ⏱️ 主进程启动开始\n[info] ⏱️ app.whenReady 触发，耗时: 126.61ms\n[info] 📦 V8 代码缓存文件数量: 9043\n[info] ⏱️ 窗口创建耗时: 140.59ms\n[info] ⏱️ ✅ 主进程启动完成，总耗时: 311.88ms\n```\n\n## 核心优化策略\n\n### 1. 启用 V8 代码缓存\n\nV8 代码缓存（Code Cache）是 Chrome 和 Node.js 中用于加速 JavaScript 代码执行的重要机制。通过缓存编译后的字节码，可以避免重复的解析和编译过程。\n\n#### 实现方式\n\n在 Electron 主进程启动时添加命令行开关：\n\n```typescript\n// src/main/index.ts\n\n// 启用 V8 代码缓存优化，加速冷启动\napp.commandLine.appendSwitch(&#39;enable-features&#39;, &#39;V8CodeCache&#39;);\napp.commandLine.appendSwitch(&#39;v8-cache-options&#39;, &#39;code&#39;);\n```\n\n#### 验证缓存效果\n\n在 `app.whenReady()` 中添加监控代码：\n\n```typescript\napp.whenReady().then(async () =&gt; {\n  const readyTime = performance.now();\n  log.info(\n    `⏱️ app.whenReady 触发，耗时: ${(readyTime - startupTime).toFixed(2)}ms`,\n  );\n\n  // 验证 V8 代码缓存\n  const cacheDir = join(app.getPath(&#39;userData&#39;), &#39;Code Cache&#39;, &#39;js&#39;);\n  try {\n    const fs = await import(&#39;fs&#39;);\n    if (fs.existsSync(cacheDir)) {\n      const cacheFiles = fs.readdirSync(cacheDir);\n      log.info(`📦 V8 代码缓存文件数量: ${cacheFiles.length}`);\n    } else {\n      log.info(&#39;📦 V8 代码缓存目录不存在（首次启动会自动创建）&#39;);\n    }\n  } catch (error) {\n    log.warn(&#39;无法检查 V8 缓存目录:&#39;, error);\n  }\n});\n```\n\n#### 工作原理\n\nV8 引擎在执行 JavaScript 时的流程：\n\n1. **解析（Parsing）**：将源代码转换为抽象语法树（AST）\n2. **编译（Compilation）**：将 AST 编译为字节码\n3. **执行（Execution）**：V8 解释器执行字节码\n\n启用代码缓存后：\n\n- **首次运行**：V8 生成字节码并缓存到磁盘\n- **后续运行**：直接加载缓存的字节码，跳过解析和编译阶段\n\n### 2. 模块拆包（Code Splitting）—— 核心优化\n\n这是本次优化中最关键的一步。**通过 Vite 配置将单一的 `main.js` 拆分为多个独立的 `utils/*.js` 文件，显著降低 V8 的 JIT 编译压力。**\n\n#### 问题背景：为什么需要拆包？\n\n在优化前，项目使用 `src/main/utils/index.ts` 统一导出所有工具函数：\n\n```typescript\n// src/main/utils/index.ts（优化前）\nexport * from &#39;./aesEncode&#39;;\nexport * from &#39;./notifi&#39;;\nexport * from &#39;./tray&#39;;\nexport * from &#39;./latex2Docx&#39;;\nexport * from &#39;./pathUtils&#39;;\n// ... 导出几十个工具模块\n```\n\nVite 打包后，所有工具代码会被 Tree Shaking 和 Rollup 合并到**单一的 `main.js` 文件**中。这会导致：\n\n1. **巨型 JS 文件**：main.js 可能超过几 MB，包含所有工具函数代码\n2. **JIT 热点集中**：V8 引擎在启动时需要：\n   - 解析整个大文件的 AST（抽象语法树）\n   - 为所有函数生成字节码\n   - 识别热点函数并进行 JIT 优化编译\n3. **缓存粒度粗**：任何一个工具函数的修改都会导致整个 main.js 的 V8 缓存失效\n\n#### Vite 配置方案\n\n通过 `manualChunks` 配置，我们将每个 utils 模块拆分为独立的 chunk：\n\n```typescript\n// src/main/vite.config.ts\n\nexport default defineConfig({\n  build: {\n    rollupOptions: {\n      external: [\n        &#39;electron&#39;,\n        &#39;node-screenshots&#39;,\n        ...builtinModules,\n        ...Object.keys(pkg.dependencies || {}),\n        ...Object.keys(pkg.devDependencies || {}),\n      ],\n      output: {\n        // 🔥 关键配置：将 utils 模块拆分为独立 chunk\n        manualChunks(id) {\n          // 为每个 utils 模块创建独立的 chunk\n          if (id.includes(&#39;src/main/utils/&#39;) &amp;&amp; !id.includes(&#39;index.ts&#39;)) {\n            // 提取模块名称\n            // 例如：src/main/utils/aesEncode.ts -&gt; utils/aesEncode\n            const match = id.match(/utils\\/([^/]+)\\.(ts|js)/);\n            if (match) {\n              return `utils/${match[1]}`;\n            }\n          }\n          return undefined; // 其他模块使用默认分包策略\n        },\n      },\n    },\n  },\n});\n```\n\n#### 拆包效果对比\n\n**优化前的打包结构：**\n\n```\ndist/main/\n├── main.js          ← 单一巨型文件（包含所有代码）\n└── main.js.map\n```\n\n**优化后的打包结构：**\n\n```\ndist/main/\n├── main.js                    ← 主入口文件（精简）\n├── utils/\n│   ├── aesEncode.js          ← 独立工具模块\n│   ├── notifi.js\n│   ├── tray.js\n│   ├── latex2Docx.js\n│   ├── pathUtils.js\n│   ├── renderLocalStrongHandle.js\n│   ├── rustScreenshotWindow.js\n│   ├── updateRender.js\n│   └── ... 其他工具模块\n└── *.js.map\n```\n\n#### 拆包如何降低 JIT 热点编译压力？\n\n**1. 减少单次解析负担**\n\nV8 的解析器（Parser）是单线程的，巨型文件会阻塞启动流程：\n\n```\n优化前：解析 5MB 的 main.js（耗时 ~800ms）\n优化后：解析 500KB 的 main.js + 按需加载小模块（耗时 ~120ms）\n```\n\n**2. 按需 JIT 编译**\n\nV8 的 JIT 编译器（TurboFan）会识别热点函数并进行优化编译。拆包后：\n\n- **冷启动时**：只有主入口 `main.js` 中的代码被立即编译\n- **运行时**：当调用 `utils/notifi.js` 时，才加载并编译该模块\n- **避免过度优化**：非热点代码不会浪费 CPU 时间进行无谓的优化\n\n**3. 更细粒度的 V8 缓存**\n\n从日志可以看到，优化后 V8 缓存文件数量从 9543 个降到 9043 个，但性能反而提升了：\n\n```log\n优化前：📦 V8 代码缓存文件数量: 9543  ← 大量小缓存 + 巨型 main.js 缓存\n优化后：📦 V8 代码缓存文件数量: 9043  ← 精简且高效的缓存结构\n```\n\n这是因为：\n\n- 每个 utils 模块的缓存是独立的\n- 修改 `utils/notifi.js` 时，只需重新生成该文件的缓存\n- `main.js`、`utils/tray.js` 等其他模块的缓存继续有效\n\n**4. 降低内存压力**\n\n巨型文件会导致更多的内存占用：\n\n- **优化前**：5MB 的 main.js 在解析阶段会生成大量临时 AST 节点对象\n- **优化后**：小文件的 AST 更快被垃圾回收，降低内存峰值\n\n#### 实际性能提升\n\n结合日志数据分析，拆包带来的直接效果：\n\n| 指标               | 优化前   | 优化后   | 说明                                       |\n| ------------------ | -------- | -------- | ------------------------------------------ |\n| app.whenReady 耗时 | 833.46ms | 126.61ms | **减少 84.8%**，主要归功于拆包减少解析时间 |\n| 窗口创建耗时       | 536.34ms | 140.59ms | **减少 73.8%**，主流程代码更精简           |\n\n#### 注意事项\n\n1. **不要拆分过细**：每个文件应有一定体积（建议 &gt;10KB），否则模块加载开销会抵消拆包收益\n2. **排除 index.ts**：`utils/index.ts` 只是导出聚合文件，不应单独成为 chunk\n3. **外部化原生模块**：如 `electron` 必须标记为 external，避免打包失败\n\n#### 日志中的证据\n\n对比日志可以看到拆包优化的关键时间点：\n\n```log\n# 优化前：巨型文件导致启动缓慢\n[2025-11-18 16:38:00.298] ⏱️ app.whenReady 触发，耗时: 833.46ms  ← 解析耗时长\n[2025-11-18 16:38:00.951] unzipper模块加载成功                    ← 延迟加载\n\n# 优化后：拆包后模块提前加载，启动迅速\n[2025-11-18 17:10:30.749] unzipper模块加载成功                    ← 立即加载\n[2025-11-18 17:10:30.810] ⏱️ app.whenReady 触发，耗时: 166.22ms  ← 解析耗时大幅降低\n```\n\n拆包后，原本需要延迟加载的模块（如 `unzipper`）可以更快加载，因为它们不再被打包到巨型 `main.js` 中。\n\n**关键优化：原生模块提前加载**\n\n从日志时间戳可以看到一个有趣的现象：\n\n```log\n# 优化前：原生模块在 app.whenReady 之后才加载\n[16:37:59.464] 主进程启动开始\n[16:38:00.298] app.whenReady 触发，耗时: 833.46ms\n[16:38:00.951] unzipper模块加载成功                          ← +1470ms（严重延迟）\n\n# 优化后：原生模块立即加载\n[17:10:30.776] 主进程启动开始\n[17:10:30.851] unzipper模块加载成功                          ← +75ms（几乎同时）\n[17:10:30.903] app.whenReady 触发，耗时: 126.61ms\n```\n\n**为什么会这样？**\n\n这是因为优化前 `unzipper` 模块被打包到 `main.js` 的深层依赖中，只有在整个巨型文件解析完成后才能执行它们的初始化代码。拆包后：\n\n1. 这些模块成为独立的 chunk\n2. ESM 的并行加载机制可以更早地加载它们\n3. 不再被 main.js 的解析阻塞\n\n这进一步验证了**拆包对启动流程的巨大优化作用**。\n\n### 3. 按需导入依赖（Tree Shaking）\n\n大型库的全量导入会引入大量未使用的代码，增加启动开销。\n\n#### 优化前\n\n```typescript\nimport * as lodash from &#39;lodash-es&#39;;\n\n// 使用时\nwin.on(\n  &#39;moved&#39;,\n  lodash.throttle(() =&gt; {\n    /* ... */\n  }, 500),\n);\n```\n\n#### 优化后\n\n```typescript\n// 只导入需要的函数\nimport { throttle, debounce } from &#39;lodash-es&#39;;\n\nwin.on(\n  &#39;moved&#39;,\n  throttle(() =&gt; {\n    /* ... */\n  }, 500),\n);\n```\n\n#### 效果分析\n\n- 减少 bundle 体积\n- 降低 V8 解析负担\n- 提升 Tree Shaking 效率\n\n### 4. 延迟加载非关键模块\n\n将非启动必需的功能（如划词翻译）延迟到主窗口创建完成后再初始化。\n\n#### 实现方案\n\n```typescript\n// 优化前：同步导入，阻塞启动\nimport &#39;./utils/selectionWord/ipcListener&#39;;\nimport {\n  cleanupTranslation,\n  initTranslationShortcut,\n} from &#39;./utils/selectionWord/init&#39;;\n\napp.whenReady().then(async () =&gt; {\n  // ...创建主窗口\n  mainWin = await createWindow();\n\n  initTranslationShortcut(); // 阻塞启动流程\n});\n```\n\n```typescript\n// 优化后：异步动态导入，不阻塞启动\napp.whenReady().then(async () =&gt; {\n  // ...创建主窗口\n  mainWin = await createWindow();\n\n  // 延迟初始化划词翻译，避免阻塞主窗口启动\n  setImmediate(async () =&gt; {\n    const translationStart = performance.now();\n    try {\n      // 动态导入模块\n      await import(&#39;./utils/selectionWord/ipcListener&#39;);\n      const { initTranslationShortcut } =\n        await import(&#39;./utils/selectionWord/init&#39;);\n      initTranslationShortcut();\n\n      const translationEnd = performance.now();\n      log.info(\n        `⏱️ 划词翻译功能已初始化，耗时: ${(translationEnd - translationStart).toFixed(2)}ms`,\n      );\n    } catch (error) {\n      log.error(&#39;初始化划词翻译失败:&#39;, error);\n    }\n  });\n\n  const totalTime = performance.now();\n  log.info(\n    `⏱️ ✅ 主进程启动完成，总耗时: ${(totalTime - startupTime).toFixed(2)}ms`,\n  );\n});\n```\n\n#### 关键技术点\n\n1. **使用 `setImmediate`**：确保主窗口完全初始化后再加载\n2. **动态 `import()`**：按需加载模块，不影响主流程\n3. **错误隔离**：避免非核心功能的失败影响主程序\n\n日志输出显示划词翻译初始化耗时约 70-123ms，通过延迟加载完全不影响主窗口启动：\n\n```log\n[info] ⏱️ ✅ 主进程启动完成，总耗时: 311.88ms\n[info] ⏱️ 划词翻译功能已初始化，耗时: 59.88ms\n```\n\n### 5. 性能监控埋点\n\n在关键路径添加时间戳记录，便于定位性能瓶颈。\n\n```typescript\n// 启动开始\nconst startupTime = performance.now();\nlog.info(&#39;⏱️ 主进程启动开始&#39;);\n\n// app.whenReady 触发\napp.whenReady().then(async () =&gt; {\n  const readyTime = performance.now();\n  log.info(\n    `⏱️ app.whenReady 触发，耗时: ${(readyTime - startupTime).toFixed(2)}ms`,\n  );\n\n  // 窗口创建\n  const createWindowStart = performance.now();\n  mainWin = await createWindow();\n  const createWindowEnd = performance.now();\n  log.info(\n    `⏱️ 窗口创建耗时: ${(createWindowEnd - createWindowStart).toFixed(2)}ms`,\n  );\n\n  // 总耗时\n  const totalTime = performance.now();\n  log.info(\n    `⏱️ ✅ 主进程启动完成，总耗时: ${(totalTime - startupTime).toFixed(2)}ms`,\n  );\n});\n```\n\n## 常见问题\n\n### Q1: V8 缓存文件会无限增长吗？\n\nA: 不会。Electron 会自动管理缓存大小，定期清理过期文件。通常缓存目录大小在几十 MB 左右。\n\n### Q2: 代码拆包会影响运行时性能吗？\n\nA: 影响极小。模块拆分后，V8 的模块加载机制（ESM）可以高效处理多文件依赖，且拆包后的缓存粒度更细，整体性能反而更优。\n\n### Q3: 动态 import 会导致功能延迟吗？\n\nA: 对用户几乎无感知。以划词翻译为例，从主窗口启动到用户实际使用该功能有足够的时间差，异步加载完全可以在用户操作前完成。\n\n## 总结\n\n通过本次优化，我们实现了：\n\n1. **启动速度提升 80%+**：从 1.6s 降至 0.3s\n2. **用户体验改善**：热更新后几乎无感知\n3. **可维护性提升**：性能监控埋点便于后续定位问题\n\n关键要点：\n\n- **模块拆包是核心**：将单一 `main.js` 拆分为多个 `utils/*.js` 文件，显著降低 V8 的 JIT 热点编译压力（app.whenReady 耗时从 833ms 降至 126ms）\n- **V8 缓存是基础**：启用代码缓存跳过重复的解析和编译过程\n- **延迟加载优化关键路径**：非关键功能异步加载，不阻塞主窗口启动\n- **性能监控提供数据支撑**：埋点日志帮助定位瓶颈\n\n**最重要的启示：**\n\n在 Electron 应用中，**打包产物的结构比打包体积更重要**。一个 5MB 的巨型 `main.js` 文件对 V8 引擎来说是灾难，即使它的总代码量并不大。通过 Vite 的 `manualChunks` 配置，将代码拆分为合理的模块结构，让 V8 能够按需解析和编译，这才是启动性能优化的关键。\n\nElectron 性能优化是一个持续的过程，建议定期检查启动日志，针对性地优化瓶颈环节。\n\n---&quot;],&quot;filePath&quot;:[0,&quot;source/posts/Electron热更新后启动性能优化-V8缓存与代码拆包实战.md&quot;],&quot;digest&quot;:[0,&quot;01a3ecd10b29cfc0&quot;],&quot;rendered&quot;:[0,{&quot;html&quot;:[0,&quot;&lt;h2 id=\&quot;前言\&quot;&gt;前言&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#前言\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;在 Electron 应用开发中，热更新后的首次启动速度直接影响用户体验。将主进程启动时间从 1619ms 优化到 311ms 的完整实践过程。&lt;/p&gt;\n&lt;h2 id=\&quot;性能数据对比\&quot;&gt;性能数据对比&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#性能数据对比\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;通过以下优化手段，我们实现了显著的性能提升：&lt;/p&gt;\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;指标&lt;/th&gt;&lt;th&gt;优化前&lt;/th&gt;&lt;th&gt;优化后&lt;/th&gt;&lt;th&gt;提升幅度&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;&lt;strong&gt;主进程启动总耗时&lt;/strong&gt;&lt;/td&gt;&lt;td&gt;1619.32ms&lt;/td&gt;&lt;td&gt;311.88ms&lt;/td&gt;&lt;td&gt;&lt;strong&gt;80.7% ↓&lt;/strong&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;strong&gt;app.whenReady 耗时&lt;/strong&gt;&lt;/td&gt;&lt;td&gt;833.46ms&lt;/td&gt;&lt;td&gt;126.61ms&lt;/td&gt;&lt;td&gt;&lt;strong&gt;84.8% ↓&lt;/strong&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;strong&gt;窗口创建耗时&lt;/strong&gt;&lt;/td&gt;&lt;td&gt;536.34ms&lt;/td&gt;&lt;td&gt;140.59ms&lt;/td&gt;&lt;td&gt;&lt;strong&gt;73.8% ↓&lt;/strong&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;strong&gt;V8 缓存文件数量&lt;/strong&gt;&lt;/td&gt;&lt;td&gt;9543 个&lt;/td&gt;&lt;td&gt;9043 个&lt;/td&gt;&lt;td&gt;优化后稳定&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;\n&lt;p&gt;从实际日志数据来看：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;log\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;# 优化前（&lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;2025-11-18&lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt; 16:37:59&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;）&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;[info]&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; ⏱️ 主进程启动开始&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;[info]&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; ⏱️ &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;app.whenReady&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; 触发，耗时: &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;833&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;.46ms&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;[info]&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; 📦 V8 代码缓存文件数量: &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;9543&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;[info]&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; ⏱️ 窗口创建耗时: &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;536&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;.34ms&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;[info]&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; ⏱️ ✅ 主进程启动完成，总耗时: &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;1619&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;.32ms&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;# 优化后（&lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;2025-11-18&lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt; 17:10:30&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;）&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;[info]&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; ⏱️ 主进程启动开始&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;[info]&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; ⏱️ &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;app.whenReady&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; 触发，耗时: &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;126&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;.61ms&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;[info]&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; 📦 V8 代码缓存文件数量: &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;9043&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;[info]&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; ⏱️ 窗口创建耗时: &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;140&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;.59ms&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;[info]&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; ⏱️ ✅ 主进程启动完成，总耗时: &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;311&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;.88ms&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h2 id=\&quot;核心优化策略\&quot;&gt;核心优化策略&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#核心优化策略\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;h3 id=\&quot;1-启用-v8-代码缓存\&quot;&gt;1. 启用 V8 代码缓存&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#1-启用-v8-代码缓存\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;V8 代码缓存（Code Cache）是 Chrome 和 Node.js 中用于加速 JavaScript 代码执行的重要机制。通过缓存编译后的字节码，可以避免重复的解析和编译过程。&lt;/p&gt;\n&lt;h4 id=\&quot;实现方式\&quot;&gt;实现方式&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#实现方式\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h4&gt;\n&lt;p&gt;在 Electron 主进程启动时添加命令行开关：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;typescript\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// src/main/index.ts&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 启用 V8 代码缓存优化，加速冷启动&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;app.commandLine.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;appendSwitch&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;enable-features&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;V8CodeCache&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;app.commandLine.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;appendSwitch&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;v8-cache-options&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;code&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h4 id=\&quot;验证缓存效果\&quot;&gt;验证缓存效果&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#验证缓存效果\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h4&gt;\n&lt;p&gt;在 &lt;code&gt;app.whenReady()&lt;/code&gt; 中添加监控代码：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;typescript\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;app.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;whenReady&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;().&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;then&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;async&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; () &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; readyTime&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; performance.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;now&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;();&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  log.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;info&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;    `⏱️ app.whenReady 触发，耗时: ${&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;readyTime&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; -&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; startupTime&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;).&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;toFixed&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;2&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;)&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;}ms`&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  );&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;  // 验证 V8 代码缓存&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; cacheDir&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; join&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(app.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;getPath&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;userData&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;), &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;Code Cache&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;js&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  try&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; fs&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; await&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; import&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;fs&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    if&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; (fs.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;existsSync&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(cacheDir)) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;      const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; cacheFiles&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; fs.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;readdirSync&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(cacheDir);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      log.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;info&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;`📦 V8 代码缓存文件数量: ${&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;cacheFiles&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;.&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;length&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;}`&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    } &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;else&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      log.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;info&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;📦 V8 代码缓存目录不存在（首次启动会自动创建）&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  } &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;catch&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; (error) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    log.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;warn&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;无法检查 V8 缓存目录:&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, error);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;});&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h4 id=\&quot;工作原理\&quot;&gt;工作原理&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#工作原理\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h4&gt;\n&lt;p&gt;V8 引擎在执行 JavaScript 时的流程：&lt;/p&gt;\n&lt;ol&gt;\n&lt;li&gt;&lt;strong&gt;解析（Parsing）&lt;/strong&gt;：将源代码转换为抽象语法树（AST）&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;编译（Compilation）&lt;/strong&gt;：将 AST 编译为字节码&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;执行（Execution）&lt;/strong&gt;：V8 解释器执行字节码&lt;/li&gt;\n&lt;/ol&gt;\n&lt;p&gt;启用代码缓存后：&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;strong&gt;首次运行&lt;/strong&gt;：V8 生成字节码并缓存到磁盘&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;后续运行&lt;/strong&gt;：直接加载缓存的字节码，跳过解析和编译阶段&lt;/li&gt;\n&lt;/ul&gt;\n&lt;h3 id=\&quot;2-模块拆包code-splitting-核心优化\&quot;&gt;2. 模块拆包（Code Splitting）—— 核心优化&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#2-模块拆包code-splitting-核心优化\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;这是本次优化中最关键的一步。&lt;strong&gt;通过 Vite 配置将单一的 &lt;code&gt;main.js&lt;/code&gt; 拆分为多个独立的 &lt;code&gt;utils/*.js&lt;/code&gt; 文件，显著降低 V8 的 JIT 编译压力。&lt;/strong&gt;&lt;/p&gt;\n&lt;h4 id=\&quot;问题背景为什么需要拆包\&quot;&gt;问题背景：为什么需要拆包？&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#问题背景为什么需要拆包\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h4&gt;\n&lt;p&gt;在优化前，项目使用 &lt;code&gt;src/main/utils/index.ts&lt;/code&gt; 统一导出所有工具函数：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;typescript\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// src/main/utils/index.ts（优化前）&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;export&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; *&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; from&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; &#39;./aesEncode&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;export&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; *&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; from&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; &#39;./notifi&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;export&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; *&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; from&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; &#39;./tray&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;export&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; *&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; from&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; &#39;./latex2Docx&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;export&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; *&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; from&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; &#39;./pathUtils&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// ... 导出几十个工具模块&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;Vite 打包后，所有工具代码会被 Tree Shaking 和 Rollup 合并到&lt;strong&gt;单一的 &lt;code&gt;main.js&lt;/code&gt; 文件&lt;/strong&gt;中。这会导致：&lt;/p&gt;\n&lt;ol&gt;\n&lt;li&gt;&lt;strong&gt;巨型 JS 文件&lt;/strong&gt;：main.js 可能超过几 MB，包含所有工具函数代码&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;JIT 热点集中&lt;/strong&gt;：V8 引擎在启动时需要：\n&lt;ul&gt;\n&lt;li&gt;解析整个大文件的 AST（抽象语法树）&lt;/li&gt;\n&lt;li&gt;为所有函数生成字节码&lt;/li&gt;\n&lt;li&gt;识别热点函数并进行 JIT 优化编译&lt;/li&gt;\n&lt;/ul&gt;\n&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;缓存粒度粗&lt;/strong&gt;：任何一个工具函数的修改都会导致整个 main.js 的 V8 缓存失效&lt;/li&gt;\n&lt;/ol&gt;\n&lt;h4 id=\&quot;vite-配置方案\&quot;&gt;Vite 配置方案&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#vite-配置方案\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h4&gt;\n&lt;p&gt;通过 &lt;code&gt;manualChunks&lt;/code&gt; 配置，我们将每个 utils 模块拆分为独立的 chunk：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;typescript\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// src/main/vite.config.ts&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;export&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; default&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; defineConfig&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;({&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  build: {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    rollupOptions: {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      external: [&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;        &#39;electron&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;        &#39;node-screenshots&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;        ...&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;builtinModules,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;        ...&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;Object.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;keys&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(pkg.dependencies &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;||&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {}),&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;        ...&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;Object.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;keys&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(pkg.devDependencies &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;||&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {}),&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      ],&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      output: {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;        // 🔥 关键配置：将 utils 模块拆分为独立 chunk&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;        manualChunks&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;id&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;          // 为每个 utils 模块创建独立的 chunk&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;          if&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; (id.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;includes&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;src/main/utils/&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;) &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;&amp;#x26;&amp;#x26;&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; !&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;id.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;includes&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;index.ts&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;)) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;            // 提取模块名称&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;            // 例如：src/main/utils/aesEncode.ts -&gt; utils/aesEncode&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;            const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; match&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; id.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;match&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;/&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#DBEDFF\&quot;&gt;utils&lt;/span&gt;&lt;span style=\&quot;color:#22863A;--shiki-light-font-weight:bold;--shiki-dark:#85E89D;--shiki-dark-font-weight:bold\&quot;&gt;\\/&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#DBEDFF\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;[&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;^&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;/]&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;+&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#DBEDFF\&quot;&gt;)&lt;/span&gt;&lt;span style=\&quot;color:#22863A;--shiki-light-font-weight:bold;--shiki-dark:#85E89D;--shiki-dark-font-weight:bold\&quot;&gt;\\.&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#DBEDFF\&quot;&gt;(ts&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;|&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#DBEDFF\&quot;&gt;js)&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;/&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;            if&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; (match) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;              return&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; `utils/${&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;match&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;[&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;1&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;]&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;}`&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;            }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;          }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;          return&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; undefined&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;; &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 其他模块使用默认分包策略&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;        },&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      },&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    },&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  },&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;});&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h4 id=\&quot;拆包效果对比\&quot;&gt;拆包效果对比&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#拆包效果对比\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h4&gt;\n&lt;p&gt;&lt;strong&gt;优化前的打包结构：&lt;/strong&gt;&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;plaintext\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;dist/main/&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;├── main.js          ← 单一巨型文件（包含所有代码）&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;└── main.js.map&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;&lt;strong&gt;优化后的打包结构：&lt;/strong&gt;&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;plaintext\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;dist/main/&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;├── main.js                    ← 主入口文件（精简）&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;├── utils/&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;│   ├── aesEncode.js          ← 独立工具模块&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;│   ├── notifi.js&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;│   ├── tray.js&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;│   ├── latex2Docx.js&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;│   ├── pathUtils.js&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;│   ├── renderLocalStrongHandle.js&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;│   ├── rustScreenshotWindow.js&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;│   ├── updateRender.js&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;│   └── ... 其他工具模块&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;└── *.js.map&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h4 id=\&quot;拆包如何降低-jit-热点编译压力\&quot;&gt;拆包如何降低 JIT 热点编译压力？&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#拆包如何降低-jit-热点编译压力\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h4&gt;\n&lt;p&gt;&lt;strong&gt;1. 减少单次解析负担&lt;/strong&gt;&lt;/p&gt;\n&lt;p&gt;V8 的解析器（Parser）是单线程的，巨型文件会阻塞启动流程：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;plaintext\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;优化前：解析 5MB 的 main.js（耗时 ~800ms）&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;优化后：解析 500KB 的 main.js + 按需加载小模块（耗时 ~120ms）&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;&lt;strong&gt;2. 按需 JIT 编译&lt;/strong&gt;&lt;/p&gt;\n&lt;p&gt;V8 的 JIT 编译器（TurboFan）会识别热点函数并进行优化编译。拆包后：&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;strong&gt;冷启动时&lt;/strong&gt;：只有主入口 &lt;code&gt;main.js&lt;/code&gt; 中的代码被立即编译&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;运行时&lt;/strong&gt;：当调用 &lt;code&gt;utils/notifi.js&lt;/code&gt; 时，才加载并编译该模块&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;避免过度优化&lt;/strong&gt;：非热点代码不会浪费 CPU 时间进行无谓的优化&lt;/li&gt;\n&lt;/ul&gt;\n&lt;p&gt;&lt;strong&gt;3. 更细粒度的 V8 缓存&lt;/strong&gt;&lt;/p&gt;\n&lt;p&gt;从日志可以看到，优化后 V8 缓存文件数量从 9543 个降到 9043 个，但性能反而提升了：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;log\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;优化前：📦 V8 代码缓存文件数量: &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;9543&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  ← 大量小缓存 + 巨型 &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;main.js&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; 缓存&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;优化后：📦 V8 代码缓存文件数量: &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;9043&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  ← 精简且高效的缓存结构&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;这是因为：&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;每个 utils 模块的缓存是独立的&lt;/li&gt;\n&lt;li&gt;修改 &lt;code&gt;utils/notifi.js&lt;/code&gt; 时，只需重新生成该文件的缓存&lt;/li&gt;\n&lt;li&gt;&lt;code&gt;main.js&lt;/code&gt;、&lt;code&gt;utils/tray.js&lt;/code&gt; 等其他模块的缓存继续有效&lt;/li&gt;\n&lt;/ul&gt;\n&lt;p&gt;&lt;strong&gt;4. 降低内存压力&lt;/strong&gt;&lt;/p&gt;\n&lt;p&gt;巨型文件会导致更多的内存占用：&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;strong&gt;优化前&lt;/strong&gt;：5MB 的 main.js 在解析阶段会生成大量临时 AST 节点对象&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;优化后&lt;/strong&gt;：小文件的 AST 更快被垃圾回收，降低内存峰值&lt;/li&gt;\n&lt;/ul&gt;\n&lt;h4 id=\&quot;实际性能提升\&quot;&gt;实际性能提升&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#实际性能提升\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h4&gt;\n&lt;p&gt;结合日志数据分析，拆包带来的直接效果：&lt;/p&gt;\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;指标&lt;/th&gt;&lt;th&gt;优化前&lt;/th&gt;&lt;th&gt;优化后&lt;/th&gt;&lt;th&gt;说明&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;app.whenReady 耗时&lt;/td&gt;&lt;td&gt;833.46ms&lt;/td&gt;&lt;td&gt;126.61ms&lt;/td&gt;&lt;td&gt;&lt;strong&gt;减少 84.8%&lt;/strong&gt;，主要归功于拆包减少解析时间&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;窗口创建耗时&lt;/td&gt;&lt;td&gt;536.34ms&lt;/td&gt;&lt;td&gt;140.59ms&lt;/td&gt;&lt;td&gt;&lt;strong&gt;减少 73.8%&lt;/strong&gt;，主流程代码更精简&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;\n&lt;h4 id=\&quot;注意事项\&quot;&gt;注意事项&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#注意事项\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h4&gt;\n&lt;ol&gt;\n&lt;li&gt;&lt;strong&gt;不要拆分过细&lt;/strong&gt;：每个文件应有一定体积（建议 &gt;10KB），否则模块加载开销会抵消拆包收益&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;排除 index.ts&lt;/strong&gt;：&lt;code&gt;utils/index.ts&lt;/code&gt; 只是导出聚合文件，不应单独成为 chunk&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;外部化原生模块&lt;/strong&gt;：如 &lt;code&gt;electron&lt;/code&gt; 必须标记为 external，避免打包失败&lt;/li&gt;\n&lt;/ol&gt;\n&lt;h4 id=\&quot;日志中的证据\&quot;&gt;日志中的证据&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#日志中的证据\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h4&gt;\n&lt;p&gt;对比日志可以看到拆包优化的关键时间点：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;log\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;# 优化前：巨型文件导致启动缓慢&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;[&lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;2025-11-18&lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt; 16:38:00.298&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;] ⏱️ &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;app.whenReady&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; 触发，耗时: &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;833&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;.46ms  ← 解析耗时长&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;[&lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;2025-11-18&lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt; 16:38:00.951&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;] unzipper模块加载成功                    ← 延迟加载&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;# 优化后：拆包后模块提前加载，启动迅速&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;[&lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;2025-11-18&lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt; 17:10:30.749&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;] unzipper模块加载成功                    ← 立即加载&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;[&lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;2025-11-18&lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt; 17:10:30.810&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;] ⏱️ &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;app.whenReady&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; 触发，耗时: &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;166&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;.22ms  ← 解析耗时大幅降低&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;拆包后，原本需要延迟加载的模块（如 &lt;code&gt;unzipper&lt;/code&gt;）可以更快加载，因为它们不再被打包到巨型 &lt;code&gt;main.js&lt;/code&gt; 中。&lt;/p&gt;\n&lt;p&gt;&lt;strong&gt;关键优化：原生模块提前加载&lt;/strong&gt;&lt;/p&gt;\n&lt;p&gt;从日志时间戳可以看到一个有趣的现象：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;log\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;# 优化前：原生模块在 &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;app.whenReady&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; 之后才加载&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;[&lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;16:37:59.464&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;] 主进程启动开始&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;[&lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;16:38:00.298&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;] &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;app.whenReady&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; 触发，耗时: &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;833&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;.46ms&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;[&lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;16:38:00.951&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;] unzipper模块加载成功                          ← +1470ms（严重延迟）&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;# 优化后：原生模块立即加载&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;[&lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;17:10:30.776&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;] 主进程启动开始&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;[&lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;17:10:30.851&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;] unzipper模块加载成功                          ← +75ms（几乎同时）&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;[&lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;17:10:30.903&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;] &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;app.whenReady&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; 触发，耗时: &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;126&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;.61ms&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;&lt;strong&gt;为什么会这样？&lt;/strong&gt;&lt;/p&gt;\n&lt;p&gt;这是因为优化前 &lt;code&gt;unzipper&lt;/code&gt; 模块被打包到 &lt;code&gt;main.js&lt;/code&gt; 的深层依赖中，只有在整个巨型文件解析完成后才能执行它们的初始化代码。拆包后：&lt;/p&gt;\n&lt;ol&gt;\n&lt;li&gt;这些模块成为独立的 chunk&lt;/li&gt;\n&lt;li&gt;ESM 的并行加载机制可以更早地加载它们&lt;/li&gt;\n&lt;li&gt;不再被 main.js 的解析阻塞&lt;/li&gt;\n&lt;/ol&gt;\n&lt;p&gt;这进一步验证了&lt;strong&gt;拆包对启动流程的巨大优化作用&lt;/strong&gt;。&lt;/p&gt;\n&lt;h3 id=\&quot;3-按需导入依赖tree-shaking\&quot;&gt;3. 按需导入依赖（Tree Shaking）&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#3-按需导入依赖tree-shaking\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;大型库的全量导入会引入大量未使用的代码，增加启动开销。&lt;/p&gt;\n&lt;h4 id=\&quot;优化前\&quot;&gt;优化前&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#优化前\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h4&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;typescript\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;import&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; *&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; as&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; lodash &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;from&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; &#39;lodash-es&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 使用时&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;win.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;on&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;  &#39;moved&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  lodash.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;throttle&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(() &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;    /* ... */&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  }, &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;500&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;),&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h4 id=\&quot;优化后\&quot;&gt;优化后&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#优化后\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h4&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;typescript\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 只导入需要的函数&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;import&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; { throttle, debounce } &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;from&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; &#39;lodash-es&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;win.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;on&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;  &#39;moved&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;  throttle&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(() &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;    /* ... */&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  }, &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;500&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;),&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h4 id=\&quot;效果分析\&quot;&gt;效果分析&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#效果分析\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h4&gt;\n&lt;ul&gt;\n&lt;li&gt;减少 bundle 体积&lt;/li&gt;\n&lt;li&gt;降低 V8 解析负担&lt;/li&gt;\n&lt;li&gt;提升 Tree Shaking 效率&lt;/li&gt;\n&lt;/ul&gt;\n&lt;h3 id=\&quot;4-延迟加载非关键模块\&quot;&gt;4. 延迟加载非关键模块&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#4-延迟加载非关键模块\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;将非启动必需的功能（如划词翻译）延迟到主窗口创建完成后再初始化。&lt;/p&gt;\n&lt;h4 id=\&quot;实现方案\&quot;&gt;实现方案&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#实现方案\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h4&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;typescript\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 优化前：同步导入，阻塞启动&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;import&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; &#39;./utils/selectionWord/ipcListener&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;import&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  cleanupTranslation,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  initTranslationShortcut,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;} &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;from&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; &#39;./utils/selectionWord/init&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;app.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;whenReady&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;().&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;then&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;async&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; () &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;  // ...创建主窗口&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  mainWin &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; await&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; createWindow&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;();&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;  initTranslationShortcut&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(); &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 阻塞启动流程&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;});&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;typescript\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 优化后：异步动态导入，不阻塞启动&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;app.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;whenReady&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;().&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;then&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;async&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; () &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;  // ...创建主窗口&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  mainWin &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; await&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; createWindow&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;();&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;  // 延迟初始化划词翻译，避免阻塞主窗口启动&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;  setImmediate&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;async&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; () &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; translationStart&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; performance.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;now&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;();&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    try&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;      // 动态导入模块&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;      await&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; import&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;./utils/selectionWord/ipcListener&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;      const&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; { &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;initTranslationShortcut&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; } &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;        await&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; import&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;./utils/selectionWord/init&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;      initTranslationShortcut&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;();&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;      const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; translationEnd&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; performance.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;now&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;();&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      log.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;info&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;        `⏱️ 划词翻译功能已初始化，耗时: ${&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;translationEnd&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; -&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; translationStart&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;).&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;toFixed&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;2&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;)&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;}ms`&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      );&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    } &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;catch&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; (error) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      log.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;error&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;初始化划词翻译失败:&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, error);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  });&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; totalTime&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; performance.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;now&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;();&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  log.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;info&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;    `⏱️ ✅ 主进程启动完成，总耗时: ${&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;totalTime&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; -&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; startupTime&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;).&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;toFixed&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;2&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;)&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;}ms`&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  );&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;});&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h4 id=\&quot;关键技术点\&quot;&gt;关键技术点&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#关键技术点\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h4&gt;\n&lt;ol&gt;\n&lt;li&gt;&lt;strong&gt;使用 &lt;code&gt;setImmediate&lt;/code&gt;&lt;/strong&gt;：确保主窗口完全初始化后再加载&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;动态 &lt;code&gt;import()&lt;/code&gt;&lt;/strong&gt;：按需加载模块，不影响主流程&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;错误隔离&lt;/strong&gt;：避免非核心功能的失败影响主程序&lt;/li&gt;\n&lt;/ol&gt;\n&lt;p&gt;日志输出显示划词翻译初始化耗时约 70-123ms，通过延迟加载完全不影响主窗口启动：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;log\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;[info]&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; ⏱️ ✅ 主进程启动完成，总耗时: &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;311&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;.88ms&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;[info]&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; ⏱️ 划词翻译功能已初始化，耗时: &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;59&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;.88ms&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h3 id=\&quot;5-性能监控埋点\&quot;&gt;5. 性能监控埋点&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#5-性能监控埋点\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;在关键路径添加时间戳记录，便于定位性能瓶颈。&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;typescript\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 启动开始&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; startupTime&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; performance.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;now&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;();&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;log.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;info&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;⏱️ 主进程启动开始&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// app.whenReady 触发&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;app.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;whenReady&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;().&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;then&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;async&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; () &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; readyTime&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; performance.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;now&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;();&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  log.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;info&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;    `⏱️ app.whenReady 触发，耗时: ${&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;readyTime&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; -&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; startupTime&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;).&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;toFixed&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;2&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;)&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;}ms`&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  );&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;  // 窗口创建&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; createWindowStart&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; performance.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;now&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;();&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  mainWin &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; await&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; createWindow&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;();&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; createWindowEnd&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; performance.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;now&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;();&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  log.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;info&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;    `⏱️ 窗口创建耗时: ${&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;createWindowEnd&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; -&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; createWindowStart&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;).&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;toFixed&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;2&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;)&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;}ms`&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  );&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;  // 总耗时&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; totalTime&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; performance.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;now&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;();&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  log.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;info&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;    `⏱️ ✅ 主进程启动完成，总耗时: ${&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;totalTime&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; -&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; startupTime&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;).&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;toFixed&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;2&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;)&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;}ms`&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  );&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;});&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h2 id=\&quot;常见问题\&quot;&gt;常见问题&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#常见问题\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;h3 id=\&quot;q1-v8-缓存文件会无限增长吗\&quot;&gt;Q1: V8 缓存文件会无限增长吗？&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#q1-v8-缓存文件会无限增长吗\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;A: 不会。Electron 会自动管理缓存大小，定期清理过期文件。通常缓存目录大小在几十 MB 左右。&lt;/p&gt;\n&lt;h3 id=\&quot;q2-代码拆包会影响运行时性能吗\&quot;&gt;Q2: 代码拆包会影响运行时性能吗？&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#q2-代码拆包会影响运行时性能吗\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;A: 影响极小。模块拆分后，V8 的模块加载机制（ESM）可以高效处理多文件依赖，且拆包后的缓存粒度更细，整体性能反而更优。&lt;/p&gt;\n&lt;h3 id=\&quot;q3-动态-import-会导致功能延迟吗\&quot;&gt;Q3: 动态 import 会导致功能延迟吗？&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#q3-动态-import-会导致功能延迟吗\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;A: 对用户几乎无感知。以划词翻译为例，从主窗口启动到用户实际使用该功能有足够的时间差，异步加载完全可以在用户操作前完成。&lt;/p&gt;\n&lt;h2 id=\&quot;总结\&quot;&gt;总结&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#总结\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;通过本次优化，我们实现了：&lt;/p&gt;\n&lt;ol&gt;\n&lt;li&gt;&lt;strong&gt;启动速度提升 80%+&lt;/strong&gt;：从 1.6s 降至 0.3s&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;用户体验改善&lt;/strong&gt;：热更新后几乎无感知&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;可维护性提升&lt;/strong&gt;：性能监控埋点便于后续定位问题&lt;/li&gt;\n&lt;/ol&gt;\n&lt;p&gt;关键要点：&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;strong&gt;模块拆包是核心&lt;/strong&gt;：将单一 &lt;code&gt;main.js&lt;/code&gt; 拆分为多个 &lt;code&gt;utils/*.js&lt;/code&gt; 文件，显著降低 V8 的 JIT 热点编译压力（app.whenReady 耗时从 833ms 降至 126ms）&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;V8 缓存是基础&lt;/strong&gt;：启用代码缓存跳过重复的解析和编译过程&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;延迟加载优化关键路径&lt;/strong&gt;：非关键功能异步加载，不阻塞主窗口启动&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;性能监控提供数据支撑&lt;/strong&gt;：埋点日志帮助定位瓶颈&lt;/li&gt;\n&lt;/ul&gt;\n&lt;p&gt;&lt;strong&gt;最重要的启示：&lt;/strong&gt;&lt;/p&gt;\n&lt;p&gt;在 Electron 应用中，&lt;strong&gt;打包产物的结构比打包体积更重要&lt;/strong&gt;。一个 5MB 的巨型 &lt;code&gt;main.js&lt;/code&gt; 文件对 V8 引擎来说是灾难，即使它的总代码量并不大。通过 Vite 的 &lt;code&gt;manualChunks&lt;/code&gt; 配置，将代码拆分为合理的模块结构，让 V8 能够按需解析和编译，这才是启动性能优化的关键。&lt;/p&gt;\n&lt;p&gt;Electron 性能优化是一个持续的过程，建议定期检查启动日志，针对性地优化瓶颈环节。&lt;/p&gt;\n&lt;hr&gt;&quot;],&quot;metadata&quot;:[0,{&quot;headings&quot;:[1,[[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;前言&quot;],&quot;text&quot;:[0,&quot;前言&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;性能数据对比&quot;],&quot;text&quot;:[0,&quot;性能数据对比&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;核心优化策略&quot;],&quot;text&quot;:[0,&quot;核心优化策略&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;1-启用-v8-代码缓存&quot;],&quot;text&quot;:[0,&quot;1. 启用 V8 代码缓存&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;实现方式&quot;],&quot;text&quot;:[0,&quot;实现方式&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;验证缓存效果&quot;],&quot;text&quot;:[0,&quot;验证缓存效果&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;工作原理&quot;],&quot;text&quot;:[0,&quot;工作原理&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;2-模块拆包code-splitting-核心优化&quot;],&quot;text&quot;:[0,&quot;2. 模块拆包（Code Splitting）—— 核心优化&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;问题背景为什么需要拆包&quot;],&quot;text&quot;:[0,&quot;问题背景：为什么需要拆包？&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;vite-配置方案&quot;],&quot;text&quot;:[0,&quot;Vite 配置方案&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;拆包效果对比&quot;],&quot;text&quot;:[0,&quot;拆包效果对比&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;拆包如何降低-jit-热点编译压力&quot;],&quot;text&quot;:[0,&quot;拆包如何降低 JIT 热点编译压力？&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;实际性能提升&quot;],&quot;text&quot;:[0,&quot;实际性能提升&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;注意事项&quot;],&quot;text&quot;:[0,&quot;注意事项&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;日志中的证据&quot;],&quot;text&quot;:[0,&quot;日志中的证据&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;3-按需导入依赖tree-shaking&quot;],&quot;text&quot;:[0,&quot;3. 按需导入依赖（Tree Shaking）&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;优化前&quot;],&quot;text&quot;:[0,&quot;优化前&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;优化后&quot;],&quot;text&quot;:[0,&quot;优化后&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;效果分析&quot;],&quot;text&quot;:[0,&quot;效果分析&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;4-延迟加载非关键模块&quot;],&quot;text&quot;:[0,&quot;4. 延迟加载非关键模块&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;实现方案&quot;],&quot;text&quot;:[0,&quot;实现方案&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;关键技术点&quot;],&quot;text&quot;:[0,&quot;关键技术点&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;5-性能监控埋点&quot;],&quot;text&quot;:[0,&quot;5. 性能监控埋点&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;常见问题&quot;],&quot;text&quot;:[0,&quot;常见问题&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;q1-v8-缓存文件会无限增长吗&quot;],&quot;text&quot;:[0,&quot;Q1: V8 缓存文件会无限增长吗？&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;q2-代码拆包会影响运行时性能吗&quot;],&quot;text&quot;:[0,&quot;Q2: 代码拆包会影响运行时性能吗？&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;q3-动态-import-会导致功能延迟吗&quot;],&quot;text&quot;:[0,&quot;Q3: 动态 import 会导致功能延迟吗？&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;总结&quot;],&quot;text&quot;:[0,&quot;总结&quot;]}]]],&quot;localImagePaths&quot;:[1,[]],&quot;remoteImagePaths&quot;:[1,[]],&quot;frontmatter&quot;:[0,{&quot;title&quot;:[0,&quot;Electron 热更新后启动性能优化：V8 缓存与代码拆包实战&quot;],&quot;date&quot;:[3,&quot;2025-11-18T18:00:00.000Z&quot;],&quot;tags&quot;:[1,[[0,&quot;Electron&quot;],[0,&quot;性能优化&quot;],[0,&quot;V8&quot;],[0,&quot;Vite&quot;],[0,&quot;热更新&quot;]]],&quot;categories&quot;:[0,&quot;技术教程&quot;],&quot;description&quot;:[0,&quot;深入实战 Electron 应用性能优化，通过启用 V8 代码缓存、Vite 模块拆包、按需导入和延迟加载等手段，将主进程启动时间从 1619ms 优化到 311ms，性能提升 80%。详解 V8 JIT 编译原理、manualChunks 拆包策略及实际优化效果对比。&quot;]}],&quot;imagePaths&quot;:[1,[]]}]}],&quot;collection&quot;:[0,&quot;blog&quot;]}],&quot;href&quot;:[0,&quot;/blog/post/33&quot;]}],[0,{&quot;post&quot;:[0,{&quot;id&quot;:[0,&quot;配置-codex-自定义三方api&quot;],&quot;data&quot;:[0,{&quot;title&quot;:[0,&quot;配置 Codex 自定义三方API&quot;],&quot;date&quot;:[3,&quot;2025-10-22T10:00:00.000Z&quot;],&quot;tags&quot;:[1,[[0,&quot;CodeX&quot;],[0,&quot;AI&quot;],[0,&quot;配置&quot;]]],&quot;categories&quot;:[0,&quot;技术教程&quot;]}],&quot;body&quot;:[0,&quot;最近在用 Claude Code,换了成本更低的Codex,记录一下配置过程。方便以后查看，快速配置。\n\n## 配置路径\n\n配置文件位置:\n\n- **macOS/Linux**: `~/.codex/config.toml`\n- **Windows**: `C:\\Users\\你的用户名\\.codex\\config.toml`\n\n## 配置文件\n\n直接上配置:\n\n```toml\nmodel_provider = \&quot;codex\&quot;\nmodel = \&quot;gpt-4.1-mini\&quot;\nmodel_reasoning_effort = \&quot;medium\&quot;\ndisable_response_storage = true\nwindows_wsl_setup_acknowledged = true\n\n[model_providers.codex]\nname = \&quot;codex\&quot;\nbase_url=\&quot;https://api.burn.hair/v1\&quot; #使用官方或第三方的\nwire_api = \&quot;responses\&quot;\nenv_key = \&quot;K_CODEX\&quot; #不要改成自己的密钥,在系统环境变量中设置\n```\n\n## 参数说明\n\n几个关键配置:\n\n- `model_provider`: 设置成 `\&quot;codex\&quot;` 就行\n- `model`: 用的模型,这里是 `gpt-4.1-mini`\n- `model_reasoning_effort`: 推理强度,`low`/`medium`/`high` 三档,medium 够用\n- `disable_response_storage`: 不保存历史记录,开启更安全\n- `base_url`: API 地址,换成你自己的\n- `env_key`: 环境变量名,**密钥别直接写配置文件里**\n\n## 设置步骤\n\n### 1. 修改配置文件\n\n找到配置文件,把上面的配置复制进去,改一下 `base_url` 和 `model`。\n\n### 2. 设置环境变量\n\n**macOS/Linux** 在 `~/.zshrc` 或 `~/.bashrc` 加一行:\n\n```bash\nexport K_CODEX=\&quot;your-api-key-here\&quot;\n```\n\n然后 `source ~/.zshrc` 生效。\n\n**Windows** PowerShell 执行:\n\n```powershell\n[System.Environment]::SetEnvironmentVariable(&#39;K_CODEX&#39;, &#39;your-api-key-here&#39;, &#39;User&#39;)\n```\n\n### 3. 重启终端\n\n重启终端就能用了。&quot;],&quot;filePath&quot;:[0,&quot;source/posts/配置 Codex 自定义三方API.md&quot;],&quot;digest&quot;:[0,&quot;b4fa279e184dff34&quot;],&quot;rendered&quot;:[0,{&quot;html&quot;:[0,&quot;&lt;p&gt;最近在用 Claude Code,换了成本更低的Codex,记录一下配置过程。方便以后查看，快速配置。&lt;/p&gt;\n&lt;h2 id=\&quot;配置路径\&quot;&gt;配置路径&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#配置路径\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;配置文件位置:&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;strong&gt;macOS/Linux&lt;/strong&gt;: &lt;code&gt;~/.codex/config.toml&lt;/code&gt;&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;Windows&lt;/strong&gt;: &lt;code&gt;C:\\Users\\你的用户名\\.codex\\config.toml&lt;/code&gt;&lt;/li&gt;\n&lt;/ul&gt;\n&lt;h2 id=\&quot;配置文件\&quot;&gt;配置文件&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#配置文件\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;直接上配置:&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;toml\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;model_provider = &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;\&quot;codex\&quot;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;model = &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;\&quot;gpt-4.1-mini\&quot;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;model_reasoning_effort = &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;\&quot;medium\&quot;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;disable_response_storage = &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;true&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;windows_wsl_setup_acknowledged = &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;true&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;[&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;model_providers&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;codex&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;]&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;name = &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;\&quot;codex\&quot;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;base_url=&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;\&quot;https://api.burn.hair/v1\&quot;&lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt; #使用官方或第三方的&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;wire_api = &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;\&quot;responses\&quot;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;env_key = &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;\&quot;K_CODEX\&quot;&lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt; #不要改成自己的密钥,在系统环境变量中设置&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h2 id=\&quot;参数说明\&quot;&gt;参数说明&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#参数说明\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;几个关键配置:&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;code&gt;model_provider&lt;/code&gt;: 设置成 &lt;code&gt;\&quot;codex\&quot;&lt;/code&gt; 就行&lt;/li&gt;\n&lt;li&gt;&lt;code&gt;model&lt;/code&gt;: 用的模型,这里是 &lt;code&gt;gpt-4.1-mini&lt;/code&gt;&lt;/li&gt;\n&lt;li&gt;&lt;code&gt;model_reasoning_effort&lt;/code&gt;: 推理强度,&lt;code&gt;low&lt;/code&gt;/&lt;code&gt;medium&lt;/code&gt;/&lt;code&gt;high&lt;/code&gt; 三档,medium 够用&lt;/li&gt;\n&lt;li&gt;&lt;code&gt;disable_response_storage&lt;/code&gt;: 不保存历史记录,开启更安全&lt;/li&gt;\n&lt;li&gt;&lt;code&gt;base_url&lt;/code&gt;: API 地址,换成你自己的&lt;/li&gt;\n&lt;li&gt;&lt;code&gt;env_key&lt;/code&gt;: 环境变量名,&lt;strong&gt;密钥别直接写配置文件里&lt;/strong&gt;&lt;/li&gt;\n&lt;/ul&gt;\n&lt;h2 id=\&quot;设置步骤\&quot;&gt;设置步骤&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#设置步骤\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;h3 id=\&quot;1-修改配置文件\&quot;&gt;1. 修改配置文件&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#1-修改配置文件\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;找到配置文件,把上面的配置复制进去,改一下 &lt;code&gt;base_url&lt;/code&gt; 和 &lt;code&gt;model&lt;/code&gt;。&lt;/p&gt;\n&lt;h3 id=\&quot;2-设置环境变量\&quot;&gt;2. 设置环境变量&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#2-设置环境变量\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;&lt;strong&gt;macOS/Linux&lt;/strong&gt; 在 &lt;code&gt;~/.zshrc&lt;/code&gt; 或 &lt;code&gt;~/.bashrc&lt;/code&gt; 加一行:&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;bash\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;export&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; K_CODEX&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;\&quot;your-api-key-here\&quot;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;然后 &lt;code&gt;source ~/.zshrc&lt;/code&gt; 生效。&lt;/p&gt;\n&lt;p&gt;&lt;strong&gt;Windows&lt;/strong&gt; PowerShell 执行:&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;powershell\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;[&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;System.Environment&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;]::SetEnvironmentVariable(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;K_CODEX&#39;&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;,&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; &#39;your-api-key-here&#39;&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;,&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; &#39;User&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h3 id=\&quot;3-重启终端\&quot;&gt;3. 重启终端&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#3-重启终端\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;重启终端就能用了。&lt;/p&gt;&quot;],&quot;metadata&quot;:[0,{&quot;headings&quot;:[1,[[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;配置路径&quot;],&quot;text&quot;:[0,&quot;配置路径&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;配置文件&quot;],&quot;text&quot;:[0,&quot;配置文件&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;参数说明&quot;],&quot;text&quot;:[0,&quot;参数说明&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;设置步骤&quot;],&quot;text&quot;:[0,&quot;设置步骤&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;1-修改配置文件&quot;],&quot;text&quot;:[0,&quot;1. 修改配置文件&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;2-设置环境变量&quot;],&quot;text&quot;:[0,&quot;2. 设置环境变量&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;3-重启终端&quot;],&quot;text&quot;:[0,&quot;3. 重启终端&quot;]}]]],&quot;localImagePaths&quot;:[1,[]],&quot;remoteImagePaths&quot;:[1,[]],&quot;frontmatter&quot;:[0,{&quot;title&quot;:[0,&quot;配置 Codex 自定义三方API&quot;],&quot;date&quot;:[3,&quot;2025-10-22T10:00:00.000Z&quot;],&quot;tags&quot;:[1,[[0,&quot;CodeX&quot;],[0,&quot;AI&quot;],[0,&quot;配置&quot;]]],&quot;categories&quot;:[0,&quot;技术教程&quot;]}],&quot;imagePaths&quot;:[1,[]]}]}],&quot;collection&quot;:[0,&quot;blog&quot;]}],&quot;href&quot;:[0,&quot;/blog/post/31&quot;]}],[0,{&quot;post&quot;:[0,{&quot;id&quot;:[0,&quot;react-effect依赖优化最佳实践与源码解析&quot;],&quot;data&quot;:[0,{&quot;title&quot;:[0,&quot;React Effect 依赖优化最佳实践&quot;],&quot;date&quot;:[3,&quot;2025-10-21T21:00:34.000Z&quot;],&quot;tags&quot;:[1,[[0,&quot;React&quot;],[0,&quot;Hooks&quot;],[0,&quot;性能优化&quot;],[0,&quot;源码解析&quot;]]],&quot;categories&quot;:[0,&quot;技术教程&quot;]}],&quot;body&quot;:[0,&quot;## 前言\n\n在使用 React Hooks 开发时，`useEffect` 的依赖数组管理是一个常见的痛点。很多开发者遇到过这样的困扰：依赖项过多导致 Effect 频繁执行，或者为了图方便直接禁用 ESLint 规则，最终引发难以调试的 bug。\n\n本文将从 React 官方文档和源码层面深入探讨如何正确管理 Effect 依赖，帮助你写出更高效、更可维护的 React 代码。\n\n## 核心原则：依赖必须与代码匹配\n\nReact 官方文档明确指出：**依赖应该与代码匹配**。这意味着 Effect 中使用的每一个响应式值（props、state）都必须出现在依赖数组中。\n\nReact 的 ESLint 插件 `eslint-plugin-react-hooks` 会自动检查这一规则，确保你的依赖声明是完整的。\n\n### ⚠️ 关键警告\n\n**永远不要用注释禁用依赖检查：**\n\n```javascript\n// ❌ 危险做法\nuseEffect(() =&gt; {\n  // ...\n  // eslint-disable-next-line react-hooks/exhaustive-deps\n}, []);\n```\n\nReact 文档强调：**应该把依赖检查错误当作编译错误来对待**。忽略它会导致微妙且难以诊断的 bug。\n\n## 六大策略移除不必要的依赖\n\n### 1. 将逻辑移至事件处理器\n\n如果某段代码应该响应特定的用户交互而非响应式变化，应该放在事件处理器中：\n\n```javascript\n// ❌ 不好的做法\nfunction ChatRoom({ roomId }) {\n  const [message, setMessage] = useState(&#39;&#39;);\n\n  useEffect(() =&gt; {\n    if (message) {\n      logVisit(roomId, message);\n    }\n  }, [roomId, message]); // message 变化会重复记录\n\n  return &lt;input value={message} onChange={(e) =&gt; setMessage(e.target.value)} /&gt;;\n}\n\n// ✅ 好的做法\nfunction ChatRoom({ roomId }) {\n  const [message, setMessage] = useState(&#39;&#39;);\n\n  const handleSend = () =&gt; {\n    logVisit(roomId, message); // 只在发送时记录\n  };\n\n  return (\n    &lt;&gt;\n      &lt;input value={message} onChange={(e) =&gt; setMessage(e.target.value)} /&gt;\n      &lt;button onClick={handleSend}&gt;发送&lt;/button&gt;\n    &lt;/&gt;\n  );\n}\n```\n\n### 2. 拆分多目的 Effect\n\n当一个 Effect 同步多个不相关的过程时,应该拆分成多个 Effect：\n\n```javascript\n// ❌ 不好的做法\nuseEffect(() =&gt; {\n  connectToChat(roomId);\n  trackPageView(page);\n}, [roomId, page]); // roomId 变化会触发不必要的页面追踪\n\n// ✅ 好的做法\nuseEffect(() =&gt; {\n  connectToChat(roomId);\n}, [roomId]);\n\nuseEffect(() =&gt; {\n  trackPageView(page);\n}, [page]);\n```\n\n### 3. 使用状态更新函数\n\n通过传递更新函数而非直接读取 state，可以移除状态依赖：\n\n```javascript\n// ❌ 不好的做法\nfunction Counter() {\n  const [count, setCount] = useState(0);\n\n  useEffect(() =&gt; {\n    const timer = setInterval(() =&gt; {\n      setCount(count + 1); // 依赖 count\n    }, 1000);\n    return () =&gt; clearInterval(timer);\n  }, [count]); // 每次 count 变化都会重置定时器\n\n  return &lt;div&gt;{count}&lt;/div&gt;;\n}\n\n// ✅ 好的做法\nfunction Counter() {\n  const [count, setCount] = useState(0);\n\n  useEffect(() =&gt; {\n    const timer = setInterval(() =&gt; {\n      setCount((c) =&gt; c + 1); // 使用更新函数,不依赖 count\n    }, 1000);\n    return () =&gt; clearInterval(timer);\n  }, []); // 空依赖数组,定时器不会重置\n\n  return &lt;div&gt;{count}&lt;/div&gt;;\n}\n```\n\n### 4. 使用 Effect Event（实验性）\n\n`useEffectEvent` 允许你提取非响应式逻辑，读取最新值而不触发重新同步：\n\n```javascript\n// ✅ 使用 Effect Event\nfunction ChatRoom({ roomId, theme }) {\n  const onConnected = useEffectEvent(() =&gt; {\n    showNotification(&#39;已连接&#39;, theme); // 读取最新的 theme\n  });\n\n  useEffect(() =&gt; {\n    const connection = connectToChat(roomId);\n    connection.on(&#39;connected&#39;, onConnected);\n    return () =&gt; connection.disconnect();\n  }, [roomId]); // theme 变化不会重新连接\n}\n```\n\n**注意：** `useEffectEvent` 目前仍是实验性 API，尚未包含在稳定版 React 中。\n\n### 5. 避免对象和函数依赖\n\n对象和函数在每次渲染时都是新的引用，会导致不必要的重新执行：\n\n```javascript\n// ❌ 不好的做法\nfunction SearchResults({ query }) {\n  const options = {\n    // 每次渲染都是新对象\n    includeArchived: true,\n  };\n\n  useEffect(() =&gt; {\n    fetchResults(query, options);\n  }, [query, options]); // options 每次都会触发\n}\n\n// ✅ 解决方案 1: 移到 Effect 内部\nfunction SearchResults({ query }) {\n  useEffect(() =&gt; {\n    const options = { includeArchived: true };\n    fetchResults(query, options);\n  }, [query]);\n}\n\n// ✅ 解决方案 2: 移到组件外部\nconst OPTIONS = { includeArchived: true };\n\nfunction SearchResults({ query }) {\n  useEffect(() =&gt; {\n    fetchResults(query, OPTIONS);\n  }, [query]);\n}\n\n// ✅ 解决方案 3: 使用 useMemo\nfunction SearchResults({ query, includeArchived }) {\n  const options = useMemo(\n    () =&gt; ({\n      includeArchived,\n    }),\n    [includeArchived],\n  );\n\n  useEffect(() =&gt; {\n    fetchResults(query, options);\n  }, [query, options]);\n}\n```\n\n### 6. 提取原始值\n\n当接收对象 props 时，解构出原始值作为依赖：\n\n```javascript\n// ❌ 不好的做法\nfunction ChatRoom({ options }) {\n  useEffect(() =&gt; {\n    connectToChat(options.roomId);\n  }, [options]); // options 对象每次渲染都是新的\n}\n\n// ✅ 好的做法\nfunction ChatRoom({ options }) {\n  const { roomId } = options;\n\n  useEffect(() =&gt; {\n    connectToChat(roomId);\n  }, [roomId]); // 只依赖原始值\n}\n```\n\n## 源码解析：React 如何初始化 State\n\n让我们深入 React 源码，看看 `useState` 背后的实现机制。以下代码来自 React v19.1.1 的 `ReactFiberHooks.js`：\n\n```javascript\nfunction mountStateImpl&lt;S&gt;(initialState: (() =&gt; S) | S): Hook {\n  const hook = mountWorkInProgressHook();\n  if (typeof initialState === &#39;function&#39;) {\n    const initialStateInitializer = initialState;\n    // 执行初始化函数获取初始值\n    initialState = initialStateInitializer();\n    if (shouldDoubleInvokeUserFnsInHooksDEV) {\n      setIsStrictModeForDevtools(true);\n      try {\n        // 严格模式下会执行两次,检测副作用\n        initialStateInitializer();\n      } finally {\n        setIsStrictModeForDevtools(false);\n      }\n    }\n  }\n  hook.memoizedState = hook.baseState = initialState;\n  // ...\n}\n```\n\n### 源码要点解读\n\n1. **惰性初始化支持**：当 `initialState` 是函数时，React 会执行它来获取初始值。这就是为什么我们可以写 `useState(() =&gt; expensiveComputation())`。\n\n2. **严格模式双重调用**：在开发模式的严格模式下，初始化函数会被调用两次。这是 React 的一个特性，用于帮助检测不纯的初始化函数中的副作用。\n\n3. **状态存储**：初始值会同时存储在 `memoizedState`（当前状态）和 `baseState`（基础状态）中。这是 React 实现状态更新和并发渲染的基础。\n\n### 与 Effect 依赖的关联\n\n理解 `useState` 的实现有助于我们更好地管理 Effect 依赖：\n\n```javascript\n// 为什么惰性初始化不需要依赖\nfunction Component() {\n  // ✅ 初始化函数只在首次渲染时执行一次\n  const [data] = useState(() =&gt; {\n    return expensiveComputation(); // 不会重复执行\n  });\n\n  useEffect(() =&gt; {\n    // data 来自 state,是响应式的,需要作为依赖\n    processData(data);\n  }, [data]);\n}\n```\n\n## 实战案例：聊天室连接管理\n\n让我们通过一个完整的例子整合这些最佳实践：\n\n```javascript\nfunction ChatRoom({ roomId, theme, currentUser }) {\n  const [messages, setMessages] = useState([]);\n  const [isConnected, setIsConnected] = useState(false);\n\n  // ✅ 使用 Effect Event 处理非响应式逻辑\n  const onMessage = useEffectEvent((message) =&gt; {\n    setMessages((msgs) =&gt; [...msgs, message]); // 使用更新函数\n    showNotification(message, theme); // 读取最新 theme,但不触发重连\n  });\n\n  const onConnectionChange = useEffectEvent((connected) =&gt; {\n    setIsConnected(connected);\n    if (connected) {\n      logUserActivity(currentUser.id); // 读取最新 user,但不触发重连\n    }\n  });\n\n  // ✅ 只在 roomId 变化时重新连接\n  useEffect(() =&gt; {\n    const connection = createConnection(roomId);\n\n    connection.on(&#39;message&#39;, onMessage);\n    connection.on(&#39;connection&#39;, onConnectionChange);\n    connection.connect();\n\n    return () =&gt; {\n      connection.disconnect();\n    };\n  }, [roomId]); // 只依赖 roomId\n\n  return (\n    &lt;div className={theme}&gt;\n      &lt;ConnectionStatus isConnected={isConnected} /&gt;\n      &lt;MessageList messages={messages} /&gt;\n    &lt;/div&gt;\n  );\n}\n```\n\n### 这个例子的优点\n\n1. **最小化依赖**：Effect 只依赖 `roomId`，只在切换房间时重新连接\n2. **避免不必要的重连**：`theme` 和 `currentUser` 变化不会导致重新连接\n3. **使用更新函数**：`setMessages(msgs =&gt; [...msgs, message])` 避免依赖 `messages`\n4. **清晰的职责分离**：连接逻辑、消息处理、通知展示各司其职\n\n## 调试技巧\n\n### 1. 使用 React DevTools\n\nReact DevTools 的 Profiler 可以帮你识别哪些组件因为 Effect 重新渲染：\n\n- 记录渲染原因\n- 查看 Hook 的依赖变化\n- 识别性能瓶颈\n\n### 2. 添加日志\n\n在开发环境添加日志帮助理解 Effect 执行时机：\n\n```javascript\nuseEffect(() =&gt; {\n  console.log(&#39;Effect 执行:&#39;, { roomId, theme });\n  // ...\n  return () =&gt; {\n    console.log(&#39;Effect 清理:&#39;, { roomId, theme });\n  };\n}, [roomId, theme]);\n```\n\n### 3. 使用 eslint-plugin-react-hooks\n\n确保在项目中启用并配置该插件：\n\n```json\n{\n  \&quot;plugins\&quot;: [\&quot;react-hooks\&quot;],\n  \&quot;rules\&quot;: {\n    \&quot;react-hooks/rules-of-hooks\&quot;: \&quot;error\&quot;,\n    \&quot;react-hooks/exhaustive-deps\&quot;: \&quot;warn\&quot;\n  }\n}\n```\n\n## 常见误区\n\n### 误区 1：空依赖数组万能\n\n```javascript\n// ❌ 错误理解\nuseEffect(() =&gt; {\n  setCount(count + 1); // count 永远是初始值\n}, []); // 缺少 count 依赖\n```\n\n### 误区 2：依赖越少越好\n\n依赖少不是目标，**准确的依赖**才是目标。不要为了减少依赖而牺牲正确性。\n\n### 误区 3：随意禁用 ESLint 规则\n\n```javascript\n// ❌ 这是技术债务\nuseEffect(() =&gt; {\n  // ...\n  // eslint-disable-next-line react-hooks/exhaustive-deps\n}, []);\n```\n\n这会在未来引发难以追踪的 bug，绝对不要这样做。\n\n## 性能优化建议\n\n1. **优先使用事件处理器**：能用事件处理器就不用 Effect\n2. **拆分细粒度 Effect**：每个 Effect 只负责一件事\n3. **合理使用 useMemo/useCallback**：对复杂对象和函数进行缓存\n4. **避免过度优化**：先保证正确性，再优化性能\n\n## 总结\n\nEffect 依赖管理是 React Hooks 开发中的重要技能。关键要点：\n\n1. **依赖必须与代码匹配** - 这是不可妥协的原则\n2. **永远不要禁用 ESLint 规则** - 把依赖警告当作编译错误对待\n3. **优先使用事件处理器** - 不是所有逻辑都需要 Effect\n4. **使用更新函数** - 减少对 state 的依赖\n5. **避免对象和函数依赖** - 它们每次渲染都是新的\n6. **理解源码实现** - 帮助我们更好地使用 API\n\n通过遵循这些最佳实践，你可以写出更高效、更易维护的 React 代码，避免常见的 Effect 依赖陷阱。\n\n## 参考资料\n\n- [React 官方文档 - Removing Effect Dependencies](https://react.dev/learn/removing-effect-dependencies#removing-unnecessary-dependencies)\n- [React 源码 - ReactFiberHooks.js](https://github.com/facebook/react/blob/v19.1.1/packages/react-reconciler/src/ReactFiberHooks.js#L2927-L2942)\n- [eslint-plugin-react-hooks](https://www.npmjs.com/package/eslint-plugin-react-hooks)&quot;],&quot;filePath&quot;:[0,&quot;source/posts/React-Effect依赖优化最佳实践与源码解析.md&quot;],&quot;digest&quot;:[0,&quot;f4463f21344080fc&quot;],&quot;rendered&quot;:[0,{&quot;html&quot;:[0,&quot;&lt;h2 id=\&quot;前言\&quot;&gt;前言&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#前言\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;在使用 React Hooks 开发时，&lt;code&gt;useEffect&lt;/code&gt; 的依赖数组管理是一个常见的痛点。很多开发者遇到过这样的困扰：依赖项过多导致 Effect 频繁执行，或者为了图方便直接禁用 ESLint 规则，最终引发难以调试的 bug。&lt;/p&gt;\n&lt;p&gt;本文将从 React 官方文档和源码层面深入探讨如何正确管理 Effect 依赖，帮助你写出更高效、更可维护的 React 代码。&lt;/p&gt;\n&lt;h2 id=\&quot;核心原则依赖必须与代码匹配\&quot;&gt;核心原则：依赖必须与代码匹配&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#核心原则依赖必须与代码匹配\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;React 官方文档明确指出：&lt;strong&gt;依赖应该与代码匹配&lt;/strong&gt;。这意味着 Effect 中使用的每一个响应式值（props、state）都必须出现在依赖数组中。&lt;/p&gt;\n&lt;p&gt;React 的 ESLint 插件 &lt;code&gt;eslint-plugin-react-hooks&lt;/code&gt; 会自动检查这一规则，确保你的依赖声明是完整的。&lt;/p&gt;\n&lt;h3 id=\&quot;️-关键警告\&quot;&gt;⚠️ 关键警告&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#️-关键警告\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;&lt;strong&gt;永远不要用注释禁用依赖检查：&lt;/strong&gt;&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;javascript\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// ❌ 危险做法&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;useEffect&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(() &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;  // ...&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;  // eslint-disable-next-line react-hooks/exhaustive-deps&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}, []);&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;React 文档强调：&lt;strong&gt;应该把依赖检查错误当作编译错误来对待&lt;/strong&gt;。忽略它会导致微妙且难以诊断的 bug。&lt;/p&gt;\n&lt;h2 id=\&quot;六大策略移除不必要的依赖\&quot;&gt;六大策略移除不必要的依赖&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#六大策略移除不必要的依赖\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;h3 id=\&quot;1-将逻辑移至事件处理器\&quot;&gt;1. 将逻辑移至事件处理器&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#1-将逻辑移至事件处理器\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;如果某段代码应该响应特定的用户交互而非响应式变化，应该放在事件处理器中：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;javascript\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// ❌ 不好的做法&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;function&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; ChatRoom&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;({ &lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;roomId&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; }) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  const&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; [&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;message&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;setMessage&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;] &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; useState&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;  useEffect&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(() &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    if&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; (message) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;      logVisit&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(roomId, message);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  }, [roomId, message]); &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// message 变化会重复记录&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  return&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; &amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;input&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; value&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;{message} &lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;onChange&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;{(&lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;e&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;) &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; setMessage&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(e.target.value)} /&gt;;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// ✅ 好的做法&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;function&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; ChatRoom&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;({ &lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;roomId&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; }) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  const&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; [&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;message&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;setMessage&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;] &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; useState&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  const&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; handleSend&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; () &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;    logVisit&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(roomId, message); &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 只在发送时记录&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  };&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  return&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; (&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    &amp;#x3C;&gt;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      &amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;input&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; value&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;{message} &lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;onChange&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;{(&lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;e&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;) &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; setMessage&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(e.target.value)} /&gt;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      &amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;button&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; onClick&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;{handleSend}&gt;发送&amp;#x3C;/&lt;/span&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;button&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    &amp;#x3C;/&gt;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  );&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h3 id=\&quot;2-拆分多目的-effect\&quot;&gt;2. 拆分多目的 Effect&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#2-拆分多目的-effect\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;当一个 Effect 同步多个不相关的过程时,应该拆分成多个 Effect：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;javascript\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// ❌ 不好的做法&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;useEffect&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(() &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;  connectToChat&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(roomId);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;  trackPageView&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(page);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}, [roomId, page]); &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// roomId 变化会触发不必要的页面追踪&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// ✅ 好的做法&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;useEffect&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(() &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;  connectToChat&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(roomId);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}, [roomId]);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;useEffect&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(() &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;  trackPageView&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(page);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}, [page]);&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h3 id=\&quot;3-使用状态更新函数\&quot;&gt;3. 使用状态更新函数&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#3-使用状态更新函数\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;通过传递更新函数而非直接读取 state，可以移除状态依赖：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;javascript\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// ❌ 不好的做法&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;function&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Counter&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;() {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  const&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; [&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;count&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;setCount&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;] &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; useState&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;0&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;  useEffect&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(() &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; timer&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; setInterval&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(() &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;      setCount&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(count &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;+&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; 1&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;); &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 依赖 count&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    }, &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;1000&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    return&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; () &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; clearInterval&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(timer);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  }, [count]); &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 每次 count 变化都会重置定时器&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  return&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; &amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;div&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&gt;{count}&amp;#x3C;/&lt;/span&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;div&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&gt;;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// ✅ 好的做法&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;function&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Counter&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;() {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  const&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; [&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;count&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;setCount&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;] &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; useState&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;0&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;  useEffect&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(() &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; timer&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; setInterval&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(() &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;      setCount&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;((&lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;c&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;) &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; c &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;+&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; 1&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;); &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 使用更新函数,不依赖 count&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    }, &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;1000&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    return&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; () &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; clearInterval&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(timer);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  }, []); &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 空依赖数组,定时器不会重置&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  return&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; &amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;div&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&gt;{count}&amp;#x3C;/&lt;/span&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;div&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&gt;;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h3 id=\&quot;4-使用-effect-event实验性\&quot;&gt;4. 使用 Effect Event（实验性）&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#4-使用-effect-event实验性\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;&lt;code&gt;useEffectEvent&lt;/code&gt; 允许你提取非响应式逻辑，读取最新值而不触发重新同步：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;javascript\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// ✅ 使用 Effect Event&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;function&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; ChatRoom&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;({ &lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;roomId&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;theme&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; }) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; onConnected&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; useEffectEvent&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(() &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;    showNotification&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;已连接&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, theme); &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 读取最新的 theme&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  });&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;  useEffect&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(() &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; connection&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; connectToChat&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(roomId);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    connection.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;on&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;connected&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, onConnected);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    return&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; () &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; connection.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;disconnect&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;();&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  }, [roomId]); &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// theme 变化不会重新连接&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;&lt;strong&gt;注意：&lt;/strong&gt; &lt;code&gt;useEffectEvent&lt;/code&gt; 目前仍是实验性 API，尚未包含在稳定版 React 中。&lt;/p&gt;\n&lt;h3 id=\&quot;5-避免对象和函数依赖\&quot;&gt;5. 避免对象和函数依赖&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#5-避免对象和函数依赖\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;对象和函数在每次渲染时都是新的引用，会导致不必要的重新执行：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;javascript\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// ❌ 不好的做法&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;function&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; SearchResults&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;({ &lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;query&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; }) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; options&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;    // 每次渲染都是新对象&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    includeArchived: &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;true&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  };&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;  useEffect&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(() &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;    fetchResults&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(query, options);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  }, [query, options]); &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// options 每次都会触发&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// ✅ 解决方案 1: 移到 Effect 内部&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;function&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; SearchResults&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;({ &lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;query&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; }) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;  useEffect&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(() &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; options&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; { includeArchived: &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;true&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; };&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;    fetchResults&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(query, options);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  }, [query]);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// ✅ 解决方案 2: 移到组件外部&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; OPTIONS&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; { includeArchived: &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;true&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; };&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;function&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; SearchResults&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;({ &lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;query&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; }) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;  useEffect&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(() &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;    fetchResults&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(query, &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;OPTIONS&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  }, [query]);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// ✅ 解决方案 3: 使用 useMemo&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;function&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; SearchResults&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;({ &lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;query&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;includeArchived&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; }) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; options&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; useMemo&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    () &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; ({&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      includeArchived,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    }),&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    [includeArchived],&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  );&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;  useEffect&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(() &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;    fetchResults&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(query, options);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  }, [query, options]);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h3 id=\&quot;6-提取原始值\&quot;&gt;6. 提取原始值&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#6-提取原始值\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;当接收对象 props 时，解构出原始值作为依赖：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;javascript\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// ❌ 不好的做法&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;function&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; ChatRoom&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;({ &lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;options&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; }) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;  useEffect&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(() &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;    connectToChat&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(options.roomId);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  }, [options]); &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// options 对象每次渲染都是新的&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// ✅ 好的做法&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;function&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; ChatRoom&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;({ &lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;options&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; }) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  const&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; { &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;roomId&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; } &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; options;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;  useEffect&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(() &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;    connectToChat&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(roomId);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  }, [roomId]); &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 只依赖原始值&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h2 id=\&quot;源码解析react-如何初始化-state\&quot;&gt;源码解析：React 如何初始化 State&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#源码解析react-如何初始化-state\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;让我们深入 React 源码，看看 &lt;code&gt;useState&lt;/code&gt; 背后的实现机制。以下代码来自 React v19.1.1 的 &lt;code&gt;ReactFiberHooks.js&lt;/code&gt;：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;javascript\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;function&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; mountStateImpl&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;S&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;initialState&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;:&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; (() &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; S&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;) &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;|&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; S&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;)&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;:&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Hook&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; hook&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; mountWorkInProgressHook&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;();&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  if&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; (&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;typeof&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; initialState &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;===&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; &#39;function&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; initialStateInitializer&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; initialState;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;    // 执行初始化函数获取初始值&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    initialState &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; initialStateInitializer&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;();&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    if&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; (shouldDoubleInvokeUserFnsInHooksDEV) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;      setIsStrictModeForDevtools&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;true&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;      try&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;        // 严格模式下会执行两次,检测副作用&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;        initialStateInitializer&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;();&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      } &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;finally&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;        setIsStrictModeForDevtools&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;false&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  hook.memoizedState &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; hook.baseState &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; initialState;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;  // ...&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h3 id=\&quot;源码要点解读\&quot;&gt;源码要点解读&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#源码要点解读\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;ol&gt;\n&lt;li&gt;\n&lt;p&gt;&lt;strong&gt;惰性初始化支持&lt;/strong&gt;：当 &lt;code&gt;initialState&lt;/code&gt; 是函数时，React 会执行它来获取初始值。这就是为什么我们可以写 &lt;code&gt;useState(() =&gt; expensiveComputation())&lt;/code&gt;。&lt;/p&gt;\n&lt;/li&gt;\n&lt;li&gt;\n&lt;p&gt;&lt;strong&gt;严格模式双重调用&lt;/strong&gt;：在开发模式的严格模式下，初始化函数会被调用两次。这是 React 的一个特性，用于帮助检测不纯的初始化函数中的副作用。&lt;/p&gt;\n&lt;/li&gt;\n&lt;li&gt;\n&lt;p&gt;&lt;strong&gt;状态存储&lt;/strong&gt;：初始值会同时存储在 &lt;code&gt;memoizedState&lt;/code&gt;（当前状态）和 &lt;code&gt;baseState&lt;/code&gt;（基础状态）中。这是 React 实现状态更新和并发渲染的基础。&lt;/p&gt;\n&lt;/li&gt;\n&lt;/ol&gt;\n&lt;h3 id=\&quot;与-effect-依赖的关联\&quot;&gt;与 Effect 依赖的关联&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#与-effect-依赖的关联\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;理解 &lt;code&gt;useState&lt;/code&gt; 的实现有助于我们更好地管理 Effect 依赖：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;javascript\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 为什么惰性初始化不需要依赖&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;function&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Component&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;() {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;  // ✅ 初始化函数只在首次渲染时执行一次&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  const&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; [&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;data&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;] &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; useState&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(() &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    return&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; expensiveComputation&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(); &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 不会重复执行&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  });&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;  useEffect&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(() &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;    // data 来自 state,是响应式的,需要作为依赖&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;    processData&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(data);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  }, [data]);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h2 id=\&quot;实战案例聊天室连接管理\&quot;&gt;实战案例：聊天室连接管理&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#实战案例聊天室连接管理\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;让我们通过一个完整的例子整合这些最佳实践：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;javascript\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;function&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; ChatRoom&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;({ &lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;roomId&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;theme&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;currentUser&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; }) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  const&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; [&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;messages&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;setMessages&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;] &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; useState&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;([]);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  const&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; [&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;isConnected&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;setIsConnected&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;] &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; useState&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;false&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;  // ✅ 使用 Effect Event 处理非响应式逻辑&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; onMessage&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; useEffectEvent&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;((&lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;message&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;) &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;    setMessages&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;((&lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;msgs&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;) &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; [&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;...&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;msgs, message]); &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 使用更新函数&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;    showNotification&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(message, theme); &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 读取最新 theme,但不触发重连&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  });&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; onConnectionChange&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; useEffectEvent&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;((&lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;connected&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;) &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;    setIsConnected&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(connected);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    if&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; (connected) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;      logUserActivity&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(currentUser.id); &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 读取最新 user,但不触发重连&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  });&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;  // ✅ 只在 roomId 变化时重新连接&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;  useEffect&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(() &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; connection&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; createConnection&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(roomId);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    connection.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;on&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;message&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, onMessage);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    connection.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;on&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;connection&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, onConnectionChange);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    connection.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;connect&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;();&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    return&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; () &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      connection.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;disconnect&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;();&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    };&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  }, [roomId]); &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 只依赖 roomId&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  return&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; (&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    &amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;div&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; className&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;{theme}&gt;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      &amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;ConnectionStatus&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; isConnected&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;{isConnected} /&gt;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      &amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;MessageList&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; messages&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;{messages} /&gt;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    &amp;#x3C;/&lt;/span&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;div&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  );&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h3 id=\&quot;这个例子的优点\&quot;&gt;这个例子的优点&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#这个例子的优点\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;ol&gt;\n&lt;li&gt;&lt;strong&gt;最小化依赖&lt;/strong&gt;：Effect 只依赖 &lt;code&gt;roomId&lt;/code&gt;，只在切换房间时重新连接&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;避免不必要的重连&lt;/strong&gt;：&lt;code&gt;theme&lt;/code&gt; 和 &lt;code&gt;currentUser&lt;/code&gt; 变化不会导致重新连接&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;使用更新函数&lt;/strong&gt;：&lt;code&gt;setMessages(msgs =&gt; [...msgs, message])&lt;/code&gt; 避免依赖 &lt;code&gt;messages&lt;/code&gt;&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;清晰的职责分离&lt;/strong&gt;：连接逻辑、消息处理、通知展示各司其职&lt;/li&gt;\n&lt;/ol&gt;\n&lt;h2 id=\&quot;调试技巧\&quot;&gt;调试技巧&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#调试技巧\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;h3 id=\&quot;1-使用-react-devtools\&quot;&gt;1. 使用 React DevTools&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#1-使用-react-devtools\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;React DevTools 的 Profiler 可以帮你识别哪些组件因为 Effect 重新渲染：&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;记录渲染原因&lt;/li&gt;\n&lt;li&gt;查看 Hook 的依赖变化&lt;/li&gt;\n&lt;li&gt;识别性能瓶颈&lt;/li&gt;\n&lt;/ul&gt;\n&lt;h3 id=\&quot;2-添加日志\&quot;&gt;2. 添加日志&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#2-添加日志\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;在开发环境添加日志帮助理解 Effect 执行时机：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;javascript\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;useEffect&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(() &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  console.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;log&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;Effect 执行:&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, { roomId, theme });&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;  // ...&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  return&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; () &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    console.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;log&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;Effect 清理:&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, { roomId, theme });&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  };&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}, [roomId, theme]);&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h3 id=\&quot;3-使用-eslint-plugin-react-hooks\&quot;&gt;3. 使用 eslint-plugin-react-hooks&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#3-使用-eslint-plugin-react-hooks\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;确保在项目中启用并配置该插件：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;json\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;{&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;  \&quot;plugins\&quot;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: [&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;\&quot;react-hooks\&quot;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;],&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;  \&quot;rules\&quot;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;    \&quot;react-hooks/rules-of-hooks\&quot;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;\&quot;error\&quot;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;    \&quot;react-hooks/exhaustive-deps\&quot;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;\&quot;warn\&quot;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h2 id=\&quot;常见误区\&quot;&gt;常见误区&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#常见误区\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;h3 id=\&quot;误区-1空依赖数组万能\&quot;&gt;误区 1：空依赖数组万能&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#误区-1空依赖数组万能\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;javascript\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// ❌ 错误理解&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;useEffect&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(() &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;  setCount&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(count &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;+&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; 1&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;); &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// count 永远是初始值&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}, []); &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 缺少 count 依赖&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h3 id=\&quot;误区-2依赖越少越好\&quot;&gt;误区 2：依赖越少越好&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#误区-2依赖越少越好\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;依赖少不是目标，&lt;strong&gt;准确的依赖&lt;/strong&gt;才是目标。不要为了减少依赖而牺牲正确性。&lt;/p&gt;\n&lt;h3 id=\&quot;误区-3随意禁用-eslint-规则\&quot;&gt;误区 3：随意禁用 ESLint 规则&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#误区-3随意禁用-eslint-规则\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;javascript\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// ❌ 这是技术债务&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;useEffect&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(() &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;  // ...&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;  // eslint-disable-next-line react-hooks/exhaustive-deps&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}, []);&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;这会在未来引发难以追踪的 bug，绝对不要这样做。&lt;/p&gt;\n&lt;h2 id=\&quot;性能优化建议\&quot;&gt;性能优化建议&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#性能优化建议\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;ol&gt;\n&lt;li&gt;&lt;strong&gt;优先使用事件处理器&lt;/strong&gt;：能用事件处理器就不用 Effect&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;拆分细粒度 Effect&lt;/strong&gt;：每个 Effect 只负责一件事&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;合理使用 useMemo/useCallback&lt;/strong&gt;：对复杂对象和函数进行缓存&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;避免过度优化&lt;/strong&gt;：先保证正确性，再优化性能&lt;/li&gt;\n&lt;/ol&gt;\n&lt;h2 id=\&quot;总结\&quot;&gt;总结&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#总结\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;Effect 依赖管理是 React Hooks 开发中的重要技能。关键要点：&lt;/p&gt;\n&lt;ol&gt;\n&lt;li&gt;&lt;strong&gt;依赖必须与代码匹配&lt;/strong&gt; - 这是不可妥协的原则&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;永远不要禁用 ESLint 规则&lt;/strong&gt; - 把依赖警告当作编译错误对待&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;优先使用事件处理器&lt;/strong&gt; - 不是所有逻辑都需要 Effect&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;使用更新函数&lt;/strong&gt; - 减少对 state 的依赖&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;避免对象和函数依赖&lt;/strong&gt; - 它们每次渲染都是新的&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;理解源码实现&lt;/strong&gt; - 帮助我们更好地使用 API&lt;/li&gt;\n&lt;/ol&gt;\n&lt;p&gt;通过遵循这些最佳实践，你可以写出更高效、更易维护的 React 代码，避免常见的 Effect 依赖陷阱。&lt;/p&gt;\n&lt;h2 id=\&quot;参考资料\&quot;&gt;参考资料&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#参考资料\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;a href=\&quot;https://react.dev/learn/removing-effect-dependencies#removing-unnecessary-dependencies\&quot;&gt;React 官方文档 - Removing Effect Dependencies&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&quot;https://github.com/facebook/react/blob/v19.1.1/packages/react-reconciler/src/ReactFiberHooks.js#L2927-L2942\&quot;&gt;React 源码 - ReactFiberHooks.js&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;\n&lt;div class=\&quot;link-preview-block not-prose\&quot; data-state=\&quot;error\&quot;&gt;\n  &lt;a href=\&quot;https://www.npmjs.com/package/eslint-plugin-react-hooks\&quot; target=\&quot;_blank\&quot; class=\&quot;hover:border-primary/50 group block rounded-lg border bg-card p-4 transition-all hover:shadow-md\&quot; aria-label=\&quot;https://www.npmjs.com/package/eslint-plugin-react-hooks\&quot;&gt;\n    &lt;div class=\&quot;flex items-center justify-between gap-3\&quot;&gt;\n      &lt;div class=\&quot;flex items-center gap-3 min-w-0 flex-1\&quot;&gt;\n        &lt;div class=\&quot;bg-primary/10 text-primary flex h-10 w-10 shrink-0 items-center justify-center rounded-lg\&quot;&gt;\n          &lt;svg class=\&quot;h-5 w-5\&quot; viewBox=\&quot;0 0 24 24\&quot; aria-hidden=\&quot;true\&quot;&gt;&lt;path fill=\&quot;none\&quot; stroke=\&quot;currentColor\&quot; stroke-dasharray=\&quot;28\&quot; stroke-dashoffset=\&quot;28\&quot; stroke-linecap=\&quot;round\&quot; stroke-linejoin=\&quot;round\&quot; stroke-width=\&quot;2\&quot; d=\&quot;M13 6l2 -2c1 -1 3 -1 4 0l1 1c1 1 1 3 0 4l-5 5c-1 1 -3 1 -4 0M11 18l-2 2c-1 1 -3 1 -4 0l-1 -1c-1 -1 -1 -3 0 -4l5 -5c1 -1 3 -1 4 0\&quot;&gt;&lt;animate fill=\&quot;freeze\&quot; attributeName=\&quot;stroke-dashoffset\&quot; dur=\&quot;0.6s\&quot; values=\&quot;28;0\&quot;&gt;&lt;/animate&gt;&lt;/path&gt;&lt;/svg&gt;\n        &lt;/div&gt;\n        &lt;div class=\&quot;min-w-0 flex-1\&quot;&gt;\n          &lt;div class=\&quot;text-foreground font-medium truncate\&quot;&gt;https://www.npmjs.com/package/eslint-plugin-react-hooks&lt;/div&gt;\n          &lt;div class=\&quot;text-muted-foreground text-xs truncate mt-0.5\&quot;&gt;npmjs.com&lt;/div&gt;\n        &lt;/div&gt;\n      &lt;/div&gt;\n      &lt;svg class=\&quot;text-primary h-5 w-5 shrink-0 transition-transform group-hover:translate-x-1\&quot; fill=\&quot;none\&quot; stroke=\&quot;currentColor\&quot; viewBox=\&quot;0 0 24 24\&quot;&gt;\n        &lt;path stroke-linecap=\&quot;round\&quot; stroke-linejoin=\&quot;round\&quot; stroke-width=\&quot;2\&quot; d=\&quot;M14 5l7 7m0 0l-7 7m7-7H3\&quot;&gt;&lt;/path&gt;\n      &lt;/svg&gt;\n    &lt;/div&gt;\n  &lt;/a&gt;\n&lt;/div&gt;\n&lt;/li&gt;\n&lt;/ul&gt;&quot;],&quot;metadata&quot;:[0,{&quot;headings&quot;:[1,[[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;前言&quot;],&quot;text&quot;:[0,&quot;前言&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;核心原则依赖必须与代码匹配&quot;],&quot;text&quot;:[0,&quot;核心原则：依赖必须与代码匹配&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;️-关键警告&quot;],&quot;text&quot;:[0,&quot;⚠️ 关键警告&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;六大策略移除不必要的依赖&quot;],&quot;text&quot;:[0,&quot;六大策略移除不必要的依赖&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;1-将逻辑移至事件处理器&quot;],&quot;text&quot;:[0,&quot;1. 将逻辑移至事件处理器&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;2-拆分多目的-effect&quot;],&quot;text&quot;:[0,&quot;2. 拆分多目的 Effect&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;3-使用状态更新函数&quot;],&quot;text&quot;:[0,&quot;3. 使用状态更新函数&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;4-使用-effect-event实验性&quot;],&quot;text&quot;:[0,&quot;4. 使用 Effect Event（实验性）&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;5-避免对象和函数依赖&quot;],&quot;text&quot;:[0,&quot;5. 避免对象和函数依赖&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;6-提取原始值&quot;],&quot;text&quot;:[0,&quot;6. 提取原始值&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;源码解析react-如何初始化-state&quot;],&quot;text&quot;:[0,&quot;源码解析：React 如何初始化 State&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;源码要点解读&quot;],&quot;text&quot;:[0,&quot;源码要点解读&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;与-effect-依赖的关联&quot;],&quot;text&quot;:[0,&quot;与 Effect 依赖的关联&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;实战案例聊天室连接管理&quot;],&quot;text&quot;:[0,&quot;实战案例：聊天室连接管理&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;这个例子的优点&quot;],&quot;text&quot;:[0,&quot;这个例子的优点&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;调试技巧&quot;],&quot;text&quot;:[0,&quot;调试技巧&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;1-使用-react-devtools&quot;],&quot;text&quot;:[0,&quot;1. 使用 React DevTools&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;2-添加日志&quot;],&quot;text&quot;:[0,&quot;2. 添加日志&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;3-使用-eslint-plugin-react-hooks&quot;],&quot;text&quot;:[0,&quot;3. 使用 eslint-plugin-react-hooks&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;常见误区&quot;],&quot;text&quot;:[0,&quot;常见误区&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;误区-1空依赖数组万能&quot;],&quot;text&quot;:[0,&quot;误区 1：空依赖数组万能&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;误区-2依赖越少越好&quot;],&quot;text&quot;:[0,&quot;误区 2：依赖越少越好&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;误区-3随意禁用-eslint-规则&quot;],&quot;text&quot;:[0,&quot;误区 3：随意禁用 ESLint 规则&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;性能优化建议&quot;],&quot;text&quot;:[0,&quot;性能优化建议&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;总结&quot;],&quot;text&quot;:[0,&quot;总结&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;参考资料&quot;],&quot;text&quot;:[0,&quot;参考资料&quot;]}]]],&quot;localImagePaths&quot;:[1,[]],&quot;remoteImagePaths&quot;:[1,[]],&quot;frontmatter&quot;:[0,{&quot;title&quot;:[0,&quot;React Effect 依赖优化最佳实践&quot;],&quot;date&quot;:[3,&quot;2025-10-21T21:00:34.000Z&quot;],&quot;tags&quot;:[1,[[0,&quot;React&quot;],[0,&quot;Hooks&quot;],[0,&quot;性能优化&quot;],[0,&quot;源码解析&quot;]]],&quot;categories&quot;:[0,&quot;技术教程&quot;]}],&quot;imagePaths&quot;:[1,[]]}]}],&quot;collection&quot;:[0,&quot;blog&quot;]}],&quot;href&quot;:[0,&quot;/blog/post/30&quot;]}],[0,{&quot;post&quot;:[0,{&quot;id&quot;:[0,&quot;hexo博客github-actions自动部署配置&quot;],&quot;data&quot;:[0,{&quot;title&quot;:[0,&quot;Hexo博客GitHub Actions自动部署配置&quot;],&quot;date&quot;:[3,&quot;2025-10-18T04:00:00.000Z&quot;],&quot;tags&quot;:[1,[[0,&quot;Hexo&quot;],[0,&quot;CI/CD&quot;],[0,&quot;GitHub Actions&quot;],[0,&quot;自动化部署&quot;]]],&quot;categories&quot;:[0,&quot;技术教程&quot;]}],&quot;body&quot;:[0,&quot;## 前言\n\n作为一个使用 Hexo 搭建博客的开发者，每次写完文章都要手动执行\n\n```bash\nhexo clean &amp;&amp; hexo generate &amp;&amp; hexo deploy\n```\n\n这一系列命令是不是很麻烦？今天就教大家如何使用 GitHub Actions 实现 Hexo 博客的自动化部署。\n\n## 什么是 GitHub Actions\n\nGitHub Actions 是 GitHub 提供的持续集成和持续部署（CI/CD）服务。它可以在代码仓库发生特定事件时自动执行预定义的工作流程，比如代码提交、PR 创建等。\n\n## 自动部署方案\n\n我们的方案是：\n\n1. 源代码仓库：存放 Hexo 源文件（Markdown 文章、配置文件等）\n2. GitHub Pages 仓库：存放编译后的静态网站文件\n3. GitHub Actions：自动构建并部署到 GitHub Pages 仓库\n\n## 配置步骤\n\n### 1. 创建 GitHub Actions 工作流\n\n在 Hexo 博客源码仓库根目录下创建 `.github/workflows/deploy.yml` 文件：\n\n```yaml\nname: Deploy Hexo to GitHub Pages\n\non:\n  push:\n    branches:\n      - main\n    paths:\n      - &#39;source/_posts/**&#39;\n      - &#39;source/**&#39;\n      - &#39;themes/**&#39;\n      - &#39;_config*.yml&#39;\n      - &#39;package.json&#39;\n  workflow_dispatch:\n\njobs:\n  deploy:\n    runs-on: ubuntu-latest\n\n    steps:\n      - name: Checkout source\n        uses: actions/checkout@v4\n        with:\n          submodules: true\n          fetch-depth: 0\n\n      - name: Setup Node.js\n        uses: actions/setup-node@v4\n        with:\n          node-version: &#39;18&#39;\n          cache: &#39;npm&#39;\n\n      - name: Install dependencies\n        run: npm ci\n\n      - name: Clean and generate static files\n        run: |\n          npm run clean\n          npm run build\n\n      - name: Deploy to GitHub Pages\n        uses: peaceiris/actions-gh-pages@v3\n        with:\n          personal_token: ${{ secrets.DEPLOY_TOKEN }}\n          external_repository: 你的用户名/你的用户名.github.io\n          publish_branch: main\n          publish_dir: ./public\n          user_name: &#39;github-actions[bot]&#39;\n          user_email: &#39;github-actions[bot]@users.noreply.github.com&#39;\n          commit_message: ${{ github.event.head_commit.message }}\n```\n\n### 2. 配置触发条件\n\n在上述配置中，工作流会在以下情况触发：\n\n- 推送到 `main` 分支\n- 修改了 `source/_posts/**`、`source/**`、`themes/**` 目录下的文件\n- 修改了配置文件 `_config*.yml` 或 `package.json`\n- 手动触发（`workflow_dispatch`）\n\n### 3. 创建 GitHub Personal Access Token\n\n1. 访问 GitHub 设置页面：https://github.com/settings/tokens\n2. 点击 \&quot;Generate new token\&quot; → \&quot;Generate new token (classic)\&quot;\n3. 填写以下信息：\n   - **Note**: `Hexo Blog Deploy`（或其他描述）\n   - **Expiration**: 选择过期时间（建议 1 year 或 No expiration）\n   - **Select scopes**: 勾选 **repo**（完整的仓库权限）\n4. 点击 \&quot;Generate token\&quot;\n5. **立即复制生成的 token**（只会显示一次，关闭页面后无法再次查看）\n\n### 4. 添加 Secret 到源码仓库\n\n1. 进入你的 Hexo 源码仓库\n2. 点击 `Settings` → `Secrets and variables` → `Actions`\n3. 点击 \&quot;New repository secret\&quot;\n4. 填写：\n   - **Name**: `DEPLOY_TOKEN`\n   - **Secret**: 粘贴刚才复制的 token\n5. 点击 \&quot;Add secret\&quot;\n\n### 5. 修改配置中的仓库名\n\n将 `deploy.yml` 中的 `external_repository` 改为你的 GitHub Pages 仓库名：\n\n```yaml\nexternal_repository: 你的用户名/你的用户名.github.io\n```\n\n## 使用流程\n\n配置完成后，使用流程变得非常简单：\n\n1. 在 `source/_posts` 目录下创建或修改 Markdown 文章\n2. 提交代码到 Git 仓库：\n   ```bash\n   git add .\n   git commit -m \&quot;新增文章：Hexo 自动部署配置\&quot;\n   git push origin main\n   ```\n3. GitHub Actions 自动触发，构建并部署\n4. 几分钟后，访问你的 GitHub Pages 网站即可看到更新\n\n## 查看部署状态\n\n1. 进入源码仓库的 `Actions` 页面\n2. 查看最新的工作流运行状态\n3. 点击查看详细日志，排查问题\n\n## 优势总结\n\n使用 GitHub Actions 自动部署有以下优势：\n\n1. **省时省力**: 不需要手动执行构建和部署命令\n2. **环境一致**: 在云端统一的环境中构建，避免本地环境问题\n3. **随时随地**: 只要能提交代码就能发布文章，甚至可以在 GitHub 网页端直接编辑\n4. **版本管理**: 源文件和部署文件分离，源码有完整的 Git 历史记录\n5. **免费使用**: GitHub Actions 对公开仓库完全免费\n\n## 常见问题\n\n### Q: 部署失败怎么办？\n\nA: 查看 Actions 页面的详细日志，常见问题包括：\n\n- Token 权限不足或过期\n- 仓库名配置错误\n- 依赖安装失败\n\n### Q: 能否部署到自定义域名？\n\nA: 可以，在 `source` 目录下添加 `CNAME` 文件，内容为你的域名即可。\n\n### Q: 构建时间太长怎么办？\n\nA: 可以使用 `npm ci` 代替 `npm install`，并启用 npm 缓存（配置中已包含）。\n\n## 总结\n\n通过 GitHub Actions，我们实现了 Hexo 博客的全自动部署。从此以后，写博客只需要专注于内容创作，提交代码后坐等自动部署完成即可。&quot;],&quot;filePath&quot;:[0,&quot;source/posts/Hexo博客GitHub-Actions自动部署配置.md&quot;],&quot;digest&quot;:[0,&quot;b64229b338859a65&quot;],&quot;rendered&quot;:[0,{&quot;html&quot;:[0,&quot;&lt;h2 id=\&quot;前言\&quot;&gt;前言&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#前言\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;作为一个使用 Hexo 搭建博客的开发者，每次写完文章都要手动执行&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;bash\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;hexo&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; clean&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; &amp;#x26;&amp;#x26; &lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;hexo&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; generate&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; &amp;#x26;&amp;#x26; &lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;hexo&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; deploy&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;这一系列命令是不是很麻烦？今天就教大家如何使用 GitHub Actions 实现 Hexo 博客的自动化部署。&lt;/p&gt;\n&lt;h2 id=\&quot;什么是-github-actions\&quot;&gt;什么是 GitHub Actions&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#什么是-github-actions\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;GitHub Actions 是 GitHub 提供的持续集成和持续部署（CI/CD）服务。它可以在代码仓库发生特定事件时自动执行预定义的工作流程，比如代码提交、PR 创建等。&lt;/p&gt;\n&lt;h2 id=\&quot;自动部署方案\&quot;&gt;自动部署方案&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#自动部署方案\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;我们的方案是：&lt;/p&gt;\n&lt;ol&gt;\n&lt;li&gt;源代码仓库：存放 Hexo 源文件（Markdown 文章、配置文件等）&lt;/li&gt;\n&lt;li&gt;GitHub Pages 仓库：存放编译后的静态网站文件&lt;/li&gt;\n&lt;li&gt;GitHub Actions：自动构建并部署到 GitHub Pages 仓库&lt;/li&gt;\n&lt;/ol&gt;\n&lt;h2 id=\&quot;配置步骤\&quot;&gt;配置步骤&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#配置步骤\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;h3 id=\&quot;1-创建-github-actions-工作流\&quot;&gt;1. 创建 GitHub Actions 工作流&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#1-创建-github-actions-工作流\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;在 Hexo 博客源码仓库根目录下创建 &lt;code&gt;.github/workflows/deploy.yml&lt;/code&gt; 文件：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;yaml\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;name&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;Deploy Hexo to GitHub Pages&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;on&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;:&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;  push&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;:&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;    branches&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;:&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      - &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;main&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;    paths&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;:&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      - &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;source/_posts/**&#39;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      - &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;source/**&#39;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      - &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;themes/**&#39;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      - &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;_config*.yml&#39;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      - &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;package.json&#39;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;  workflow_dispatch&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;:&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;jobs&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;:&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;  deploy&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;:&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;    runs-on&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;ubuntu-latest&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;    steps&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;:&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      - &lt;/span&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;name&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;Checkout source&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;        uses&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;actions/checkout@v4&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;        with&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;:&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;          submodules&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;true&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;          fetch-depth&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;0&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      - &lt;/span&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;name&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;Setup Node.js&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;        uses&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;actions/setup-node@v4&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;        with&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;:&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;          node-version&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;18&#39;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;          cache&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;npm&#39;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      - &lt;/span&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;name&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;Install dependencies&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;        run&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;npm ci&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      - &lt;/span&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;name&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;Clean and generate static files&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;        run&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;|&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;          npm run clean&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;          npm run build&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      - &lt;/span&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;name&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;Deploy to GitHub Pages&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;        uses&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;peaceiris/actions-gh-pages@v3&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;        with&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;:&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;          personal_token&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;${{ secrets.DEPLOY_TOKEN }}&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;          external_repository&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;你的用户名/你的用户名.github.io&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;          publish_branch&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;main&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;          publish_dir&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;./public&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;          user_name&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;github-actions[bot]&#39;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;          user_email&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;github-actions[bot]@users.noreply.github.com&#39;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;          commit_message&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;${{ github.event.head_commit.message }}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h3 id=\&quot;2-配置触发条件\&quot;&gt;2. 配置触发条件&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#2-配置触发条件\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;在上述配置中，工作流会在以下情况触发：&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;推送到 &lt;code&gt;main&lt;/code&gt; 分支&lt;/li&gt;\n&lt;li&gt;修改了 &lt;code&gt;source/_posts/**&lt;/code&gt;、&lt;code&gt;source/**&lt;/code&gt;、&lt;code&gt;themes/**&lt;/code&gt; 目录下的文件&lt;/li&gt;\n&lt;li&gt;修改了配置文件 &lt;code&gt;_config*.yml&lt;/code&gt; 或 &lt;code&gt;package.json&lt;/code&gt;&lt;/li&gt;\n&lt;li&gt;手动触发（&lt;code&gt;workflow_dispatch&lt;/code&gt;）&lt;/li&gt;\n&lt;/ul&gt;\n&lt;h3 id=\&quot;3-创建-github-personal-access-token\&quot;&gt;3. 创建 GitHub Personal Access Token&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#3-创建-github-personal-access-token\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;ol&gt;\n&lt;li&gt;访问 GitHub 设置页面：&lt;a href=\&quot;https://github.com/settings/tokens\&quot;&gt;https://github.com/settings/tokens&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;点击 “Generate new token” → “Generate new token (classic)”&lt;/li&gt;\n&lt;li&gt;填写以下信息：\n&lt;ul&gt;\n&lt;li&gt;&lt;strong&gt;Note&lt;/strong&gt;: &lt;code&gt;Hexo Blog Deploy&lt;/code&gt;（或其他描述）&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;Expiration&lt;/strong&gt;: 选择过期时间（建议 1 year 或 No expiration）&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;Select scopes&lt;/strong&gt;: 勾选 &lt;strong&gt;repo&lt;/strong&gt;（完整的仓库权限）&lt;/li&gt;\n&lt;/ul&gt;\n&lt;/li&gt;\n&lt;li&gt;点击 “Generate token”&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;立即复制生成的 token&lt;/strong&gt;（只会显示一次，关闭页面后无法再次查看）&lt;/li&gt;\n&lt;/ol&gt;\n&lt;h3 id=\&quot;4-添加-secret-到源码仓库\&quot;&gt;4. 添加 Secret 到源码仓库&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#4-添加-secret-到源码仓库\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;ol&gt;\n&lt;li&gt;进入你的 Hexo 源码仓库&lt;/li&gt;\n&lt;li&gt;点击 &lt;code&gt;Settings&lt;/code&gt; → &lt;code&gt;Secrets and variables&lt;/code&gt; → &lt;code&gt;Actions&lt;/code&gt;&lt;/li&gt;\n&lt;li&gt;点击 “New repository secret”&lt;/li&gt;\n&lt;li&gt;填写：\n&lt;ul&gt;\n&lt;li&gt;&lt;strong&gt;Name&lt;/strong&gt;: &lt;code&gt;DEPLOY_TOKEN&lt;/code&gt;&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;Secret&lt;/strong&gt;: 粘贴刚才复制的 token&lt;/li&gt;\n&lt;/ul&gt;\n&lt;/li&gt;\n&lt;li&gt;点击 “Add secret”&lt;/li&gt;\n&lt;/ol&gt;\n&lt;h3 id=\&quot;5-修改配置中的仓库名\&quot;&gt;5. 修改配置中的仓库名&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#5-修改配置中的仓库名\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;将 &lt;code&gt;deploy.yml&lt;/code&gt; 中的 &lt;code&gt;external_repository&lt;/code&gt; 改为你的 GitHub Pages 仓库名：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;yaml\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;external_repository&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;你的用户名/你的用户名.github.io&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h2 id=\&quot;使用流程\&quot;&gt;使用流程&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#使用流程\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;配置完成后，使用流程变得非常简单：&lt;/p&gt;\n&lt;ol&gt;\n&lt;li&gt;在 &lt;code&gt;source/_posts&lt;/code&gt; 目录下创建或修改 Markdown 文章&lt;/li&gt;\n&lt;li&gt;提交代码到 Git 仓库：\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;bash\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;git&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; add&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; .&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;git&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; commit&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; -m&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; \&quot;新增文章：Hexo 自动部署配置\&quot;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;git&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; push&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; origin&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; main&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;/li&gt;\n&lt;li&gt;GitHub Actions 自动触发，构建并部署&lt;/li&gt;\n&lt;li&gt;几分钟后，访问你的 GitHub Pages 网站即可看到更新&lt;/li&gt;\n&lt;/ol&gt;\n&lt;h2 id=\&quot;查看部署状态\&quot;&gt;查看部署状态&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#查看部署状态\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;ol&gt;\n&lt;li&gt;进入源码仓库的 &lt;code&gt;Actions&lt;/code&gt; 页面&lt;/li&gt;\n&lt;li&gt;查看最新的工作流运行状态&lt;/li&gt;\n&lt;li&gt;点击查看详细日志，排查问题&lt;/li&gt;\n&lt;/ol&gt;\n&lt;h2 id=\&quot;优势总结\&quot;&gt;优势总结&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#优势总结\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;使用 GitHub Actions 自动部署有以下优势：&lt;/p&gt;\n&lt;ol&gt;\n&lt;li&gt;&lt;strong&gt;省时省力&lt;/strong&gt;: 不需要手动执行构建和部署命令&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;环境一致&lt;/strong&gt;: 在云端统一的环境中构建，避免本地环境问题&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;随时随地&lt;/strong&gt;: 只要能提交代码就能发布文章，甚至可以在 GitHub 网页端直接编辑&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;版本管理&lt;/strong&gt;: 源文件和部署文件分离，源码有完整的 Git 历史记录&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;免费使用&lt;/strong&gt;: GitHub Actions 对公开仓库完全免费&lt;/li&gt;\n&lt;/ol&gt;\n&lt;h2 id=\&quot;常见问题\&quot;&gt;常见问题&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#常见问题\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;h3 id=\&quot;q-部署失败怎么办\&quot;&gt;Q: 部署失败怎么办？&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#q-部署失败怎么办\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;A: 查看 Actions 页面的详细日志，常见问题包括：&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;Token 权限不足或过期&lt;/li&gt;\n&lt;li&gt;仓库名配置错误&lt;/li&gt;\n&lt;li&gt;依赖安装失败&lt;/li&gt;\n&lt;/ul&gt;\n&lt;h3 id=\&quot;q-能否部署到自定义域名\&quot;&gt;Q: 能否部署到自定义域名？&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#q-能否部署到自定义域名\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;A: 可以，在 &lt;code&gt;source&lt;/code&gt; 目录下添加 &lt;code&gt;CNAME&lt;/code&gt; 文件，内容为你的域名即可。&lt;/p&gt;\n&lt;h3 id=\&quot;q-构建时间太长怎么办\&quot;&gt;Q: 构建时间太长怎么办？&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#q-构建时间太长怎么办\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;A: 可以使用 &lt;code&gt;npm ci&lt;/code&gt; 代替 &lt;code&gt;npm install&lt;/code&gt;，并启用 npm 缓存（配置中已包含）。&lt;/p&gt;\n&lt;h2 id=\&quot;总结\&quot;&gt;总结&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#总结\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;通过 GitHub Actions，我们实现了 Hexo 博客的全自动部署。从此以后，写博客只需要专注于内容创作，提交代码后坐等自动部署完成即可。&lt;/p&gt;&quot;],&quot;metadata&quot;:[0,{&quot;headings&quot;:[1,[[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;前言&quot;],&quot;text&quot;:[0,&quot;前言&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;什么是-github-actions&quot;],&quot;text&quot;:[0,&quot;什么是 GitHub Actions&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;自动部署方案&quot;],&quot;text&quot;:[0,&quot;自动部署方案&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;配置步骤&quot;],&quot;text&quot;:[0,&quot;配置步骤&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;1-创建-github-actions-工作流&quot;],&quot;text&quot;:[0,&quot;1. 创建 GitHub Actions 工作流&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;2-配置触发条件&quot;],&quot;text&quot;:[0,&quot;2. 配置触发条件&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;3-创建-github-personal-access-token&quot;],&quot;text&quot;:[0,&quot;3. 创建 GitHub Personal Access Token&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;4-添加-secret-到源码仓库&quot;],&quot;text&quot;:[0,&quot;4. 添加 Secret 到源码仓库&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;5-修改配置中的仓库名&quot;],&quot;text&quot;:[0,&quot;5. 修改配置中的仓库名&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;使用流程&quot;],&quot;text&quot;:[0,&quot;使用流程&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;查看部署状态&quot;],&quot;text&quot;:[0,&quot;查看部署状态&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;优势总结&quot;],&quot;text&quot;:[0,&quot;优势总结&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;常见问题&quot;],&quot;text&quot;:[0,&quot;常见问题&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;q-部署失败怎么办&quot;],&quot;text&quot;:[0,&quot;Q: 部署失败怎么办？&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;q-能否部署到自定义域名&quot;],&quot;text&quot;:[0,&quot;Q: 能否部署到自定义域名？&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;q-构建时间太长怎么办&quot;],&quot;text&quot;:[0,&quot;Q: 构建时间太长怎么办？&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;总结&quot;],&quot;text&quot;:[0,&quot;总结&quot;]}]]],&quot;localImagePaths&quot;:[1,[]],&quot;remoteImagePaths&quot;:[1,[]],&quot;frontmatter&quot;:[0,{&quot;title&quot;:[0,&quot;Hexo博客GitHub Actions自动部署配置&quot;],&quot;date&quot;:[3,&quot;2025-10-18T04:00:00.000Z&quot;],&quot;tags&quot;:[1,[[0,&quot;Hexo&quot;],[0,&quot;CI/CD&quot;],[0,&quot;GitHub Actions&quot;],[0,&quot;自动化部署&quot;]]],&quot;categories&quot;:[0,&quot;技术教程&quot;]}],&quot;imagePaths&quot;:[1,[]]}]}],&quot;collection&quot;:[0,&quot;blog&quot;]}],&quot;href&quot;:[0,&quot;/blog/post/28&quot;]}],[0,{&quot;post&quot;:[0,{&quot;id&quot;:[0,&quot;nestjs关于循环依赖&quot;],&quot;data&quot;:[0,{&quot;title&quot;:[0,&quot;NestJs关于循环依赖&quot;],&quot;date&quot;:[3,&quot;2023-11-15T21:21:35.000Z&quot;],&quot;tags&quot;:[0,&quot;技术分享&quot;]}],&quot;body&quot;:[0,&quot;## 有感而发\n\nNestJS循环依赖问题：角色依赖了权限，权限依赖了角色模块。使用了循环依赖导入。\n\n但是，在角色模块的服务里使用权限模块里的service方法时，就会提示导入的权限模块不正确。\n\n但是，把角色里调用权限模块的方法逻辑删了，就正常了。\n\n但是这段逻辑放角色控制器里调用并不会报错。\n\n就很奇妙，所以，**还是得避免使用循环依赖**。我查阅了文档后才得知官网不推荐这么做。\n\n## 总结\n\nNestJS开发者们，希望不要和我一样。**尽量避免循环依赖吧**！\n\n## 相关截图\n\n![img.png](../img/img_8.png)\n![img_1.png](../img/img_9.png)\n![img_2.png](../img/img_10.png)&quot;],&quot;filePath&quot;:[0,&quot;source/posts/NestJs关于循环依赖.md&quot;],&quot;assetImports&quot;:[1,[[0,&quot;../img/img_8.png&quot;],[0,&quot;../img/img_9.png&quot;],[0,&quot;../img/img_10.png&quot;]]],&quot;digest&quot;:[0,&quot;0db331e629a639de&quot;],&quot;rendered&quot;:[0,{&quot;html&quot;:[0,&quot;&lt;h2 id=\&quot;有感而发\&quot;&gt;有感而发&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#有感而发\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;NestJS循环依赖问题：角色依赖了权限，权限依赖了角色模块。使用了循环依赖导入。&lt;/p&gt;\n&lt;p&gt;但是，在角色模块的服务里使用权限模块里的service方法时，就会提示导入的权限模块不正确。&lt;/p&gt;\n&lt;p&gt;但是，把角色里调用权限模块的方法逻辑删了，就正常了。&lt;/p&gt;\n&lt;p&gt;但是这段逻辑放角色控制器里调用并不会报错。&lt;/p&gt;\n&lt;p&gt;就很奇妙，所以，&lt;strong&gt;还是得避免使用循环依赖&lt;/strong&gt;。我查阅了文档后才得知官网不推荐这么做。&lt;/p&gt;\n&lt;h2 id=\&quot;总结\&quot;&gt;总结&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#总结\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;NestJS开发者们，希望不要和我一样。&lt;strong&gt;尽量避免循环依赖吧&lt;/strong&gt;！&lt;/p&gt;\n&lt;h2 id=\&quot;相关截图\&quot;&gt;相关截图&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#相关截图\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;&lt;/p&gt;&lt;figure class=\&quot;markdown-image-wrapper\&quot;&gt;&lt;img __ASTRO_IMAGE_=\&quot;{&amp;#x22;src&amp;#x22;:&amp;#x22;../img/img_8.png&amp;#x22;,&amp;#x22;alt&amp;#x22;:&amp;#x22;img.png&amp;#x22;,&amp;#x22;loading&amp;#x22;:&amp;#x22;lazy&amp;#x22;,&amp;#x22;decoding&amp;#x22;:&amp;#x22;async&amp;#x22;,&amp;#x22;class&amp;#x22;:&amp;#x22;markdown-image&amp;#x22;,&amp;#x22;index&amp;#x22;:0}\&quot;&gt;&lt;/figure&gt;\n&lt;figure class=\&quot;markdown-image-wrapper\&quot;&gt;&lt;img __ASTRO_IMAGE_=\&quot;{&amp;#x22;src&amp;#x22;:&amp;#x22;../img/img_9.png&amp;#x22;,&amp;#x22;alt&amp;#x22;:&amp;#x22;img_1.png&amp;#x22;,&amp;#x22;loading&amp;#x22;:&amp;#x22;lazy&amp;#x22;,&amp;#x22;decoding&amp;#x22;:&amp;#x22;async&amp;#x22;,&amp;#x22;class&amp;#x22;:&amp;#x22;markdown-image&amp;#x22;,&amp;#x22;index&amp;#x22;:0}\&quot;&gt;&lt;/figure&gt;\n&lt;figure class=\&quot;markdown-image-wrapper\&quot;&gt;&lt;img __ASTRO_IMAGE_=\&quot;{&amp;#x22;src&amp;#x22;:&amp;#x22;../img/img_10.png&amp;#x22;,&amp;#x22;alt&amp;#x22;:&amp;#x22;img_2.png&amp;#x22;,&amp;#x22;loading&amp;#x22;:&amp;#x22;lazy&amp;#x22;,&amp;#x22;decoding&amp;#x22;:&amp;#x22;async&amp;#x22;,&amp;#x22;class&amp;#x22;:&amp;#x22;markdown-image&amp;#x22;,&amp;#x22;index&amp;#x22;:0}\&quot;&gt;&lt;/figure&gt;&lt;p&gt;&lt;/p&gt;&quot;],&quot;metadata&quot;:[0,{&quot;headings&quot;:[1,[[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;有感而发&quot;],&quot;text&quot;:[0,&quot;有感而发&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;总结&quot;],&quot;text&quot;:[0,&quot;总结&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;相关截图&quot;],&quot;text&quot;:[0,&quot;相关截图&quot;]}]]],&quot;localImagePaths&quot;:[1,[[0,&quot;../img/img_8.png&quot;],[0,&quot;../img/img_9.png&quot;],[0,&quot;../img/img_10.png&quot;]]],&quot;remoteImagePaths&quot;:[1,[]],&quot;frontmatter&quot;:[0,{&quot;title&quot;:[0,&quot;NestJs关于循环依赖&quot;],&quot;date&quot;:[3,&quot;2023-11-15T21:21:35.000Z&quot;],&quot;tags&quot;:[0,&quot;技术分享&quot;]}],&quot;imagePaths&quot;:[1,[[0,&quot;../img/img_8.png&quot;],[0,&quot;../img/img_9.png&quot;],[0,&quot;../img/img_10.png&quot;]]]}]}],&quot;collection&quot;:[0,&quot;blog&quot;]}],&quot;href&quot;:[0,&quot;/blog/post/27&quot;]}],[0,{&quot;post&quot;:[0,{&quot;id&quot;:[0,&quot;关于vue3如何判断父组件给子组件传了插槽&quot;],&quot;data&quot;:[0,{&quot;title&quot;:[0,&quot;关于Vue3如何判断父组件给子组件传了插槽&quot;],&quot;date&quot;:[3,&quot;2023-08-03T15:20:21.000Z&quot;],&quot;tags&quot;:[0,&quot;技术分享&quot;]}],&quot;body&quot;:[0,&quot;## 问题背景\n\n首先看下面这段代码。\n\n![img.png](../img/img_5.png)\n\n遇见了一个需求，需要在部门选择的时候，名称前面加上一级部门。\n\n但是，很多地方都用到了这个封装的组件。如何让这个地方优雅的处理掉，又不影响到别的地方呢?\n\n## 解决思路\n\n我想到了一个点子。子组件判断父组件有没有传递插槽。如果传了的话，就给elOption传递处理选择显示的插槽。\n\n经过我一番查阅文档和百度，发现setup语法糖没法实现。只能改成setup加return那种。\n\nsetup函数里第二个参数中去接收slot插槽。然后利用jsx的灵活性就能够优雅地实现需求了。\n\n## 为什么使用JSX\n\n为啥要用jsx?因为template中给Eloption传递插槽没法用对象的方式，只要对应上了插槽名Eloption就会渲染。\n\n## 代码实现\n\n代码见下图：\n\n![img.png](../img/img_6.png)\n![img.png](../img/img_7.png)\n\n[代码详情](https://github.com/XueHua-s/personUntil/blob/main/Vue3Components/requesetEnumSearchSelect.vue)&quot;],&quot;filePath&quot;:[0,&quot;source/posts/关于Vue3如何判断父组件给子组件传了插槽.md&quot;],&quot;assetImports&quot;:[1,[[0,&quot;../img/img_5.png&quot;],[0,&quot;../img/img_6.png&quot;],[0,&quot;../img/img_7.png&quot;]]],&quot;digest&quot;:[0,&quot;92e3abb9744dc4e4&quot;],&quot;rendered&quot;:[0,{&quot;html&quot;:[0,&quot;&lt;h2 id=\&quot;问题背景\&quot;&gt;问题背景&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#问题背景\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;首先看下面这段代码。&lt;/p&gt;\n&lt;p&gt;&lt;/p&gt;&lt;figure class=\&quot;markdown-image-wrapper\&quot;&gt;&lt;img __ASTRO_IMAGE_=\&quot;{&amp;#x22;src&amp;#x22;:&amp;#x22;../img/img_5.png&amp;#x22;,&amp;#x22;alt&amp;#x22;:&amp;#x22;img.png&amp;#x22;,&amp;#x22;loading&amp;#x22;:&amp;#x22;lazy&amp;#x22;,&amp;#x22;decoding&amp;#x22;:&amp;#x22;async&amp;#x22;,&amp;#x22;class&amp;#x22;:&amp;#x22;markdown-image&amp;#x22;,&amp;#x22;index&amp;#x22;:0}\&quot;&gt;&lt;/figure&gt;&lt;p&gt;&lt;/p&gt;\n&lt;p&gt;遇见了一个需求，需要在部门选择的时候，名称前面加上一级部门。&lt;/p&gt;\n&lt;p&gt;但是，很多地方都用到了这个封装的组件。如何让这个地方优雅的处理掉，又不影响到别的地方呢?&lt;/p&gt;\n&lt;h2 id=\&quot;解决思路\&quot;&gt;解决思路&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#解决思路\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;我想到了一个点子。子组件判断父组件有没有传递插槽。如果传了的话，就给elOption传递处理选择显示的插槽。&lt;/p&gt;\n&lt;p&gt;经过我一番查阅文档和百度，发现setup语法糖没法实现。只能改成setup加return那种。&lt;/p&gt;\n&lt;p&gt;setup函数里第二个参数中去接收slot插槽。然后利用jsx的灵活性就能够优雅地实现需求了。&lt;/p&gt;\n&lt;h2 id=\&quot;为什么使用jsx\&quot;&gt;为什么使用JSX&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#为什么使用jsx\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;为啥要用jsx?因为template中给Eloption传递插槽没法用对象的方式，只要对应上了插槽名Eloption就会渲染。&lt;/p&gt;\n&lt;h2 id=\&quot;代码实现\&quot;&gt;代码实现&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#代码实现\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;代码见下图：&lt;/p&gt;\n&lt;p&gt;&lt;/p&gt;&lt;figure class=\&quot;markdown-image-wrapper\&quot;&gt;&lt;img __ASTRO_IMAGE_=\&quot;{&amp;#x22;src&amp;#x22;:&amp;#x22;../img/img_6.png&amp;#x22;,&amp;#x22;alt&amp;#x22;:&amp;#x22;img.png&amp;#x22;,&amp;#x22;loading&amp;#x22;:&amp;#x22;lazy&amp;#x22;,&amp;#x22;decoding&amp;#x22;:&amp;#x22;async&amp;#x22;,&amp;#x22;class&amp;#x22;:&amp;#x22;markdown-image&amp;#x22;,&amp;#x22;index&amp;#x22;:0}\&quot;&gt;&lt;/figure&gt;\n&lt;figure class=\&quot;markdown-image-wrapper\&quot;&gt;&lt;img __ASTRO_IMAGE_=\&quot;{&amp;#x22;src&amp;#x22;:&amp;#x22;../img/img_7.png&amp;#x22;,&amp;#x22;alt&amp;#x22;:&amp;#x22;img.png&amp;#x22;,&amp;#x22;loading&amp;#x22;:&amp;#x22;lazy&amp;#x22;,&amp;#x22;decoding&amp;#x22;:&amp;#x22;async&amp;#x22;,&amp;#x22;class&amp;#x22;:&amp;#x22;markdown-image&amp;#x22;,&amp;#x22;index&amp;#x22;:0}\&quot;&gt;&lt;/figure&gt;&lt;p&gt;&lt;/p&gt;\n&lt;p&gt;&lt;a href=\&quot;https://github.com/XueHua-s/personUntil/blob/main/Vue3Components/requesetEnumSearchSelect.vue\&quot;&gt;代码详情&lt;/a&gt;&lt;/p&gt;&quot;],&quot;metadata&quot;:[0,{&quot;headings&quot;:[1,[[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;问题背景&quot;],&quot;text&quot;:[0,&quot;问题背景&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;解决思路&quot;],&quot;text&quot;:[0,&quot;解决思路&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;为什么使用jsx&quot;],&quot;text&quot;:[0,&quot;为什么使用JSX&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;代码实现&quot;],&quot;text&quot;:[0,&quot;代码实现&quot;]}]]],&quot;localImagePaths&quot;:[1,[[0,&quot;../img/img_5.png&quot;],[0,&quot;../img/img_6.png&quot;],[0,&quot;../img/img_7.png&quot;]]],&quot;remoteImagePaths&quot;:[1,[]],&quot;frontmatter&quot;:[0,{&quot;title&quot;:[0,&quot;关于Vue3如何判断父组件给子组件传了插槽&quot;],&quot;date&quot;:[3,&quot;2023-08-03T15:20:21.000Z&quot;],&quot;tags&quot;:[0,&quot;技术分享&quot;]}],&quot;imagePaths&quot;:[1,[[0,&quot;../img/img_5.png&quot;],[0,&quot;../img/img_6.png&quot;],[0,&quot;../img/img_7.png&quot;]]]}]}],&quot;collection&quot;:[0,&quot;blog&quot;]}],&quot;href&quot;:[0,&quot;/blog/post/26&quot;]}],[0,{&quot;post&quot;:[0,{&quot;id&quot;:[0,&quot;element-plus表格隐藏行数功能&quot;],&quot;data&quot;:[0,{&quot;title&quot;:[0,&quot;element-plus表格隐藏行数功能&quot;],&quot;date&quot;:[3,&quot;2023-07-27T15:42:08.000Z&quot;],&quot;tags&quot;:[0,&quot;技术分享&quot;]}],&quot;body&quot;:[0,&quot;![emj](../img/img_1.png)\n\n## 需求背景\n\n如图所示，element-plus中所带的，这些折叠屏折叠行、这些功能可能并不是我们想要的。\n\n最近有一个需求，就是表格如果超出了某行，遍将多余的行数给进行折叠。\n\n那么,有什么办法能够给element-plus添加易于维护的拓展代码吗?\n\n我也自行百度过一番，但是百度上的答案，很明显并不是我想要的。\n\n经过我一番思索，想到了css的序号选择器。序号选择器专门写一个子元素超过3隐藏的类型名。\n\n## CSS样式实现\n\n样式如下：\n\n```css\n.el-folding &gt; tr:nth-child(n + 4) {\n  display: none;\n}\n.el-folding-line {\n  transition-duration: 200ms;\n  cursor: pointer;\n  border-bottom: 1px solid var(--el-table-border-color);\n}\n.el-folding-line:active {\n  background-color: #f5f6fb;\n}\n.el-folding-extends {\n  /*cursor: pointer;*/\n  transition-duration: 400ms;\n}\n.el-folding-extends.rotate {\n  cursor: pointer;\n  transform: rotate(180deg);\n}\n```\n\n## Vue自定义指令实现\n\n如何让这个功能易于使用和维护，我这里想到了使用vue的自定义指令：\n\n```javascript\n// element-table折叠指令\napp.directive(&#39;elfold&#39;, (el, binding) =&gt; {\n  const elBody = el.querySelector(&#39;.el-table__body&gt;tbody&#39;);\n  const elBodyC = elBody.children;\n  if (elBodyC.length &gt; 3) {\n    // 给表格添加只展示三行的类名\n    if (el.querySelector(&#39;.rotate&#39;)) {\n      elBody.classList.remove(&#39;el-folding&#39;);\n    } else {\n      elBody.classList.add(&#39;el-folding&#39;);\n    }\n    // 判断有没有创建过面板\n    const foldingLine = el.querySelector(&#39;.el-folding-line&#39;);\n    if (foldingLine) {\n      if (el?.removeElement) {\n        el.removeElement(foldingLine);\n      }\n    }\n    if (!foldingLine) {\n      // 创建折叠面板元素\n      const extendsTop = document.createElement(&#39;div&#39;);\n      extendsTop.className = &#39;flex-ct p5 el-folding-line&#39;;\n      const extendsTopButton = document.createElement(&#39;i&#39;);\n      extendsTopButton.className = &#39;fa fa-angle-down el-folding-extends&#39;;\n      extendsTopButton.style.fontSize = &#39;30px&#39;;\n      extendsTop.append(extendsTopButton);\n      el.append(extendsTop);\n      // 控制变量\n      let controller = true;\n      extendsTop.addEventListener(&#39;click&#39;, () =&gt; {\n        if (controller) {\n          extendsTopButton.classList.add(&#39;rotate&#39;);\n          elBody.classList.remove(&#39;el-folding&#39;);\n        } else {\n          extendsTopButton.classList.remove(&#39;rotate&#39;);\n          elBody.classList.add(&#39;el-folding&#39;);\n        }\n        controller = !controller;\n      });\n    }\n  } else {\n    elBody.classList.remove(&#39;el-folding&#39;);\n  }\n});\n```\n\n## 效果展示\n\n诺，最后的效果就如图所示了。\n\n![emj](../img/img_2.png)\n![emj](../img/img_3.png)\n![emj](../img/img_4.png)&quot;],&quot;filePath&quot;:[0,&quot;source/posts/element-plus表格隐藏行数功能.md&quot;],&quot;assetImports&quot;:[1,[[0,&quot;../img/img_1.png&quot;],[0,&quot;../img/img_2.png&quot;],[0,&quot;../img/img_3.png&quot;],[0,&quot;../img/img_4.png&quot;]]],&quot;digest&quot;:[0,&quot;eabe7313c3e9a3c4&quot;],&quot;rendered&quot;:[0,{&quot;html&quot;:[0,&quot;&lt;p&gt;&lt;/p&gt;&lt;figure class=\&quot;markdown-image-wrapper\&quot;&gt;&lt;img __ASTRO_IMAGE_=\&quot;{&amp;#x22;src&amp;#x22;:&amp;#x22;../img/img_1.png&amp;#x22;,&amp;#x22;alt&amp;#x22;:&amp;#x22;emj&amp;#x22;,&amp;#x22;loading&amp;#x22;:&amp;#x22;lazy&amp;#x22;,&amp;#x22;decoding&amp;#x22;:&amp;#x22;async&amp;#x22;,&amp;#x22;class&amp;#x22;:&amp;#x22;markdown-image&amp;#x22;,&amp;#x22;index&amp;#x22;:0}\&quot;&gt;&lt;/figure&gt;&lt;p&gt;&lt;/p&gt;\n&lt;h2 id=\&quot;需求背景\&quot;&gt;需求背景&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#需求背景\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;如图所示，element-plus中所带的，这些折叠屏折叠行、这些功能可能并不是我们想要的。&lt;/p&gt;\n&lt;p&gt;最近有一个需求，就是表格如果超出了某行，遍将多余的行数给进行折叠。&lt;/p&gt;\n&lt;p&gt;那么,有什么办法能够给element-plus添加易于维护的拓展代码吗?&lt;/p&gt;\n&lt;p&gt;我也自行百度过一番，但是百度上的答案，很明显并不是我想要的。&lt;/p&gt;\n&lt;p&gt;经过我一番思索，想到了css的序号选择器。序号选择器专门写一个子元素超过3隐藏的类型名。&lt;/p&gt;\n&lt;h2 id=\&quot;css样式实现\&quot;&gt;CSS样式实现&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#css样式实现\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;样式如下：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;css\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;.el-folding&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; &gt;&lt;/span&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt; tr&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;:nth-child&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;n + 4&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;  display&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;none&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;.el-folding-line&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;  transition-duration&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;200&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;ms&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;  cursor&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;pointer&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;  border-bottom&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;1&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;px&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; solid&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; var&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;--el-table-border-color&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;.el-folding-line:active&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;  background-color&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;#f5f6fb&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;.el-folding-extends&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;  /*cursor: pointer;*/&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;  transition-duration&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;400&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;ms&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;.el-folding-extends.rotate&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;  cursor&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;pointer&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;  transform&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;rotate&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;180&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;deg&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h2 id=\&quot;vue自定义指令实现\&quot;&gt;Vue自定义指令实现&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#vue自定义指令实现\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;如何让这个功能易于使用和维护，我这里想到了使用vue的自定义指令：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;javascript\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// element-table折叠指令&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;app.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;directive&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;elfold&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, (&lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;el&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;binding&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;) &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; elBody&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; el.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;querySelector&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;.el-table__body&gt;tbody&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; elBodyC&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; elBody.children;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  if&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; (elBodyC.&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;length&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; &gt;&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; 3&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;    // 给表格添加只展示三行的类名&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    if&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; (el.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;querySelector&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;.rotate&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;)) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      elBody.classList.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;remove&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;el-folding&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    } &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;else&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      elBody.classList.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;add&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;el-folding&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;    // 判断有没有创建过面板&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; foldingLine&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; el.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;querySelector&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;.el-folding-line&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    if&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; (foldingLine) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;      if&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; (el?.removeElement) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;        el.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;removeElement&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(foldingLine);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    if&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; (&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;!&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;foldingLine) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;      // 创建折叠面板元素&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;      const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; extendsTop&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; document.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;createElement&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;div&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      extendsTop.className &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; &#39;flex-ct p5 el-folding-line&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;      const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; extendsTopButton&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; document.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;createElement&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;i&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      extendsTopButton.className &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; &#39;fa fa-angle-down el-folding-extends&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      extendsTopButton.style.fontSize &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; &#39;30px&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      extendsTop.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;append&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(extendsTopButton);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      el.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;append&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(extendsTop);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;      // 控制变量&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;      let&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; controller &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; true&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      extendsTop.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;addEventListener&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;click&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, () &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;        if&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; (controller) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;          extendsTopButton.classList.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;add&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;rotate&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;          elBody.classList.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;remove&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;el-folding&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;        } &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;else&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;          extendsTopButton.classList.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;remove&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;rotate&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;          elBody.classList.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;add&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;el-folding&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;        }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;        controller &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; !&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;controller;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      });&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  } &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;else&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    elBody.classList.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;remove&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;el-folding&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;});&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h2 id=\&quot;效果展示\&quot;&gt;效果展示&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#效果展示\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;诺，最后的效果就如图所示了。&lt;/p&gt;\n&lt;p&gt;&lt;/p&gt;&lt;figure class=\&quot;markdown-image-wrapper\&quot;&gt;&lt;img __ASTRO_IMAGE_=\&quot;{&amp;#x22;src&amp;#x22;:&amp;#x22;../img/img_2.png&amp;#x22;,&amp;#x22;alt&amp;#x22;:&amp;#x22;emj&amp;#x22;,&amp;#x22;loading&amp;#x22;:&amp;#x22;lazy&amp;#x22;,&amp;#x22;decoding&amp;#x22;:&amp;#x22;async&amp;#x22;,&amp;#x22;class&amp;#x22;:&amp;#x22;markdown-image&amp;#x22;,&amp;#x22;index&amp;#x22;:0}\&quot;&gt;&lt;/figure&gt;\n&lt;figure class=\&quot;markdown-image-wrapper\&quot;&gt;&lt;img __ASTRO_IMAGE_=\&quot;{&amp;#x22;src&amp;#x22;:&amp;#x22;../img/img_3.png&amp;#x22;,&amp;#x22;alt&amp;#x22;:&amp;#x22;emj&amp;#x22;,&amp;#x22;loading&amp;#x22;:&amp;#x22;lazy&amp;#x22;,&amp;#x22;decoding&amp;#x22;:&amp;#x22;async&amp;#x22;,&amp;#x22;class&amp;#x22;:&amp;#x22;markdown-image&amp;#x22;,&amp;#x22;index&amp;#x22;:0}\&quot;&gt;&lt;/figure&gt;\n&lt;figure class=\&quot;markdown-image-wrapper\&quot;&gt;&lt;img __ASTRO_IMAGE_=\&quot;{&amp;#x22;src&amp;#x22;:&amp;#x22;../img/img_4.png&amp;#x22;,&amp;#x22;alt&amp;#x22;:&amp;#x22;emj&amp;#x22;,&amp;#x22;loading&amp;#x22;:&amp;#x22;lazy&amp;#x22;,&amp;#x22;decoding&amp;#x22;:&amp;#x22;async&amp;#x22;,&amp;#x22;class&amp;#x22;:&amp;#x22;markdown-image&amp;#x22;,&amp;#x22;index&amp;#x22;:0}\&quot;&gt;&lt;/figure&gt;&lt;p&gt;&lt;/p&gt;&quot;],&quot;metadata&quot;:[0,{&quot;headings&quot;:[1,[[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;需求背景&quot;],&quot;text&quot;:[0,&quot;需求背景&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;css样式实现&quot;],&quot;text&quot;:[0,&quot;CSS样式实现&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;vue自定义指令实现&quot;],&quot;text&quot;:[0,&quot;Vue自定义指令实现&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;效果展示&quot;],&quot;text&quot;:[0,&quot;效果展示&quot;]}]]],&quot;localImagePaths&quot;:[1,[[0,&quot;../img/img_1.png&quot;],[0,&quot;../img/img_2.png&quot;],[0,&quot;../img/img_3.png&quot;],[0,&quot;../img/img_4.png&quot;]]],&quot;remoteImagePaths&quot;:[1,[]],&quot;frontmatter&quot;:[0,{&quot;title&quot;:[0,&quot;element-plus表格隐藏行数功能&quot;],&quot;date&quot;:[3,&quot;2023-07-27T15:42:08.000Z&quot;],&quot;tags&quot;:[0,&quot;技术分享&quot;]}],&quot;imagePaths&quot;:[1,[[0,&quot;../img/img_1.png&quot;],[0,&quot;../img/img_2.png&quot;],[0,&quot;../img/img_3.png&quot;],[0,&quot;../img/img_4.png&quot;]]]}]}],&quot;collection&quot;:[0,&quot;blog&quot;]}],&quot;href&quot;:[0,&quot;/blog/post/25&quot;]}],[0,{&quot;post&quot;:[0,{&quot;id&quot;:[0,&quot;前端链表运用场景&quot;],&quot;data&quot;:[0,{&quot;title&quot;:[0,&quot;前端链表运用场景&quot;],&quot;date&quot;:[3,&quot;2023-06-24T13:55:42.000Z&quot;],&quot;tags&quot;:[0,&quot;技术分享&quot;]}],&quot;body&quot;:[0,&quot;## 数组操作的性能问题\n\n看下面这段代码：\n\n```javascript\nconst arr = [1, 2, 3, 4, 5];\narr.unshift(0);\n```\n\n比如像上面那两行代码, 大家都知道数组是有下标的。\n\n如果往输入前面插入一个元素，那么后面的所有元素下标整体都是会往后移动的。这个数组的下标移动，一旦数据量过多的话，就会造成很严重的性能损耗。\n\n## 实际应用场景\n\n### 场景一：物联网项目\n\n例如: 物联网项目，一个设备的模板，数据量大的可能有几千个参数。如果把第一个删除删除了，后面恐怖的数据量的下标前移，会给页面造成大概一秒钟的卡顿感。\n\n### 场景二：滑动加载页面\n\n再比如一些滑动加载的页面，那个页面还具有，自己的文章能右滑删除的功能。\n\n如果存放文章的数据到达了一定数量，用户再删除文章，如果我们重新请求接口，加载列表。这样显然，用户的体验是更不好的。一般在接口请求删除成功后，对本地的那个文章在进行删除。但是，显然有时候也会造成不好的体验。\n\n## 解决方案\n\n这个时候链表这种数据结构, 再配合上es6的迭代器就很合适了。\n\n代码见以下链接：\n\n[双端循环链表](https://github.com/XueHua-s/adt-customer/blob/main/link.js)&quot;],&quot;filePath&quot;:[0,&quot;source/posts/前端链表运用场景.md&quot;],&quot;digest&quot;:[0,&quot;2e281fb9ffa9bc09&quot;],&quot;rendered&quot;:[0,{&quot;html&quot;:[0,&quot;&lt;h2 id=\&quot;数组操作的性能问题\&quot;&gt;数组操作的性能问题&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#数组操作的性能问题\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;看下面这段代码：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;javascript\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; arr&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; [&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;1&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;2&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;3&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;4&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;5&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;];&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;arr.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;unshift&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;0&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;比如像上面那两行代码, 大家都知道数组是有下标的。&lt;/p&gt;\n&lt;p&gt;如果往输入前面插入一个元素，那么后面的所有元素下标整体都是会往后移动的。这个数组的下标移动，一旦数据量过多的话，就会造成很严重的性能损耗。&lt;/p&gt;\n&lt;h2 id=\&quot;实际应用场景\&quot;&gt;实际应用场景&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#实际应用场景\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;h3 id=\&quot;场景一物联网项目\&quot;&gt;场景一：物联网项目&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#场景一物联网项目\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;例如: 物联网项目，一个设备的模板，数据量大的可能有几千个参数。如果把第一个删除删除了，后面恐怖的数据量的下标前移，会给页面造成大概一秒钟的卡顿感。&lt;/p&gt;\n&lt;h3 id=\&quot;场景二滑动加载页面\&quot;&gt;场景二：滑动加载页面&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#场景二滑动加载页面\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;再比如一些滑动加载的页面，那个页面还具有，自己的文章能右滑删除的功能。&lt;/p&gt;\n&lt;p&gt;如果存放文章的数据到达了一定数量，用户再删除文章，如果我们重新请求接口，加载列表。这样显然，用户的体验是更不好的。一般在接口请求删除成功后，对本地的那个文章在进行删除。但是，显然有时候也会造成不好的体验。&lt;/p&gt;\n&lt;h2 id=\&quot;解决方案\&quot;&gt;解决方案&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#解决方案\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;这个时候链表这种数据结构, 再配合上es6的迭代器就很合适了。&lt;/p&gt;\n&lt;p&gt;代码见以下链接：&lt;/p&gt;\n&lt;p&gt;&lt;a href=\&quot;https://github.com/XueHua-s/adt-customer/blob/main/link.js\&quot;&gt;双端循环链表&lt;/a&gt;&lt;/p&gt;&quot;],&quot;metadata&quot;:[0,{&quot;headings&quot;:[1,[[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;数组操作的性能问题&quot;],&quot;text&quot;:[0,&quot;数组操作的性能问题&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;实际应用场景&quot;],&quot;text&quot;:[0,&quot;实际应用场景&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;场景一物联网项目&quot;],&quot;text&quot;:[0,&quot;场景一：物联网项目&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;场景二滑动加载页面&quot;],&quot;text&quot;:[0,&quot;场景二：滑动加载页面&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;解决方案&quot;],&quot;text&quot;:[0,&quot;解决方案&quot;]}]]],&quot;localImagePaths&quot;:[1,[]],&quot;remoteImagePaths&quot;:[1,[]],&quot;frontmatter&quot;:[0,{&quot;title&quot;:[0,&quot;前端链表运用场景&quot;],&quot;date&quot;:[3,&quot;2023-06-24T13:55:42.000Z&quot;],&quot;tags&quot;:[0,&quot;技术分享&quot;]}],&quot;imagePaths&quot;:[1,[]]}]}],&quot;collection&quot;:[0,&quot;blog&quot;]}],&quot;href&quot;:[0,&quot;/blog/post/23&quot;]}],[0,{&quot;post&quot;:[0,{&quot;id&quot;:[0,&quot;关于前端数据库indexdb&quot;],&quot;data&quot;:[0,{&quot;title&quot;:[0,&quot;关于前端数据库indexDB&quot;],&quot;date&quot;:[3,&quot;2023-06-23T14:25:11.000Z&quot;],&quot;tags&quot;:[0,&quot;技术分享&quot;]}],&quot;body&quot;:[0,&quot;## 为什么需要IndexDB\n\n前端加载某些过大的静态文件，而且还是无法被浏览器缓存的资源时。每次都要浪费很多时间。\n\n比如three.js需要使用的建模文件。如果只有几十kb，几MB的话倒还好。如果模型文件十多M，甚至是几百多M的话。每次关闭网页再重新打开，就又重新加载一遍。长时间的重复等待实在是倒人胃口。\n\n这个时候就可以用indexDB将这些大型文件存起来。避免重复加载这些资源，而倒人胃口。\n\n## 使用体验\n\n关于这个问题，我自己钻研了一下，并且封装了一个操作IndexDB的方法(详情见文章下链接)。\n\n有一说一，这个东西比MongoDB难用。不能够直接新建表，必须每次在升级数据版本的时候，触发的周期里才能去新建。实在是，太难受了。\n\n![emj](../img/src=http___img.nga.178.com_attachments_mon_202206_26_i2Q2q-8ns4Z1vT3cSwi-wi.jpg&amp;refer=http___img.nga.178.webp)\n\n## 相关资源\n\n[IndexDB使用方法](https://github.com/XueHua-s/personUntil/blob/main/indexDB.js)&quot;],&quot;filePath&quot;:[0,&quot;source/posts/关于前端数据库indexDB.md&quot;],&quot;assetImports&quot;:[1,[[0,&quot;../img/src=http___img.nga.178.com_attachments_mon_202206_26_i2Q2q-8ns4Z1vT3cSwi-wi.jpg&amp;refer=http___img.nga.178.webp&quot;]]],&quot;digest&quot;:[0,&quot;71fd74995e3a8bc9&quot;],&quot;rendered&quot;:[0,{&quot;html&quot;:[0,&quot;&lt;h2 id=\&quot;为什么需要indexdb\&quot;&gt;为什么需要IndexDB&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#为什么需要indexdb\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;前端加载某些过大的静态文件，而且还是无法被浏览器缓存的资源时。每次都要浪费很多时间。&lt;/p&gt;\n&lt;p&gt;比如three.js需要使用的建模文件。如果只有几十kb，几MB的话倒还好。如果模型文件十多M，甚至是几百多M的话。每次关闭网页再重新打开，就又重新加载一遍。长时间的重复等待实在是倒人胃口。&lt;/p&gt;\n&lt;p&gt;这个时候就可以用indexDB将这些大型文件存起来。避免重复加载这些资源，而倒人胃口。&lt;/p&gt;\n&lt;h2 id=\&quot;使用体验\&quot;&gt;使用体验&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#使用体验\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;关于这个问题，我自己钻研了一下，并且封装了一个操作IndexDB的方法(详情见文章下链接)。&lt;/p&gt;\n&lt;p&gt;有一说一，这个东西比MongoDB难用。不能够直接新建表，必须每次在升级数据版本的时候，触发的周期里才能去新建。实在是，太难受了。&lt;/p&gt;\n&lt;p&gt;&lt;/p&gt;&lt;figure class=\&quot;markdown-image-wrapper\&quot;&gt;&lt;img __ASTRO_IMAGE_=\&quot;{&amp;#x22;src&amp;#x22;:&amp;#x22;../img/src=http___img.nga.178.com_attachments_mon_202206_26_i2Q2q-8ns4Z1vT3cSwi-wi.jpg&amp;#x26;refer=http___img.nga.178.webp&amp;#x22;,&amp;#x22;alt&amp;#x22;:&amp;#x22;emj&amp;#x22;,&amp;#x22;loading&amp;#x22;:&amp;#x22;lazy&amp;#x22;,&amp;#x22;decoding&amp;#x22;:&amp;#x22;async&amp;#x22;,&amp;#x22;class&amp;#x22;:&amp;#x22;markdown-image&amp;#x22;,&amp;#x22;index&amp;#x22;:0}\&quot;&gt;&lt;/figure&gt;&lt;p&gt;&lt;/p&gt;\n&lt;h2 id=\&quot;相关资源\&quot;&gt;相关资源&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#相关资源\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;&lt;a href=\&quot;https://github.com/XueHua-s/personUntil/blob/main/indexDB.js\&quot;&gt;IndexDB使用方法&lt;/a&gt;&lt;/p&gt;&quot;],&quot;metadata&quot;:[0,{&quot;headings&quot;:[1,[[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;为什么需要indexdb&quot;],&quot;text&quot;:[0,&quot;为什么需要IndexDB&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;使用体验&quot;],&quot;text&quot;:[0,&quot;使用体验&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;相关资源&quot;],&quot;text&quot;:[0,&quot;相关资源&quot;]}]]],&quot;localImagePaths&quot;:[1,[[0,&quot;../img/src=http___img.nga.178.com_attachments_mon_202206_26_i2Q2q-8ns4Z1vT3cSwi-wi.jpg&amp;refer=http___img.nga.178.webp&quot;]]],&quot;remoteImagePaths&quot;:[1,[]],&quot;frontmatter&quot;:[0,{&quot;title&quot;:[0,&quot;关于前端数据库indexDB&quot;],&quot;date&quot;:[3,&quot;2023-06-23T14:25:11.000Z&quot;],&quot;tags&quot;:[0,&quot;技术分享&quot;]}],&quot;imagePaths&quot;:[1,[[0,&quot;../img/src=http___img.nga.178.com_attachments_mon_202206_26_i2Q2q-8ns4Z1vT3cSwi-wi.jpg&amp;refer=http___img.nga.178.webp&quot;]]]}]}],&quot;collection&quot;:[0,&quot;blog&quot;]}],&quot;href&quot;:[0,&quot;/blog/post/22&quot;]}],[0,{&quot;post&quot;:[0,{&quot;id&quot;:[0,&quot;表格拖拽方法手写&quot;],&quot;data&quot;:[0,{&quot;title&quot;:[0,&quot;表格拖拽方法手写&quot;],&quot;date&quot;:[3,&quot;2023-06-22T21:31:40.000Z&quot;],&quot;tags&quot;:[0,&quot;技术分享&quot;]}],&quot;body&quot;:[0,&quot;## 项目需求\n\n这几天公司做一个项目，遇见了一个需要拖拽表格顺序的项目。\n\n但是UI用的又是element。是没有这个功能的，所以自己就手写了一个插件。\n\n发在了github上面。如果有需要用到的朋友可以移步下面。\n\n## 代码地址\n\n&lt;a href=\&quot;https://github.com/XueHua-s/personUntil/blob/main/elementTableDrap.js\&quot; target=\&quot;_blank\&quot;&gt;\n打开github链接\n&lt;/a&gt;&quot;],&quot;filePath&quot;:[0,&quot;source/posts/表格拖拽方法手写.md&quot;],&quot;digest&quot;:[0,&quot;187f30350c33ca9b&quot;],&quot;rendered&quot;:[0,{&quot;html&quot;:[0,&quot;&lt;h2 id=\&quot;项目需求\&quot;&gt;项目需求&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#项目需求\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;这几天公司做一个项目，遇见了一个需要拖拽表格顺序的项目。&lt;/p&gt;\n&lt;p&gt;但是UI用的又是element。是没有这个功能的，所以自己就手写了一个插件。&lt;/p&gt;\n&lt;p&gt;发在了github上面。如果有需要用到的朋友可以移步下面。&lt;/p&gt;\n&lt;h2 id=\&quot;代码地址\&quot;&gt;代码地址&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#代码地址\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;a href=\&quot;https://github.com/XueHua-s/personUntil/blob/main/elementTableDrap.js\&quot; target=\&quot;_blank\&quot;&gt;\n打开github链接\n&lt;/a&gt;&quot;],&quot;metadata&quot;:[0,{&quot;headings&quot;:[1,[[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;项目需求&quot;],&quot;text&quot;:[0,&quot;项目需求&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;代码地址&quot;],&quot;text&quot;:[0,&quot;代码地址&quot;]}]]],&quot;localImagePaths&quot;:[1,[]],&quot;remoteImagePaths&quot;:[1,[]],&quot;frontmatter&quot;:[0,{&quot;layout&quot;:[0,&quot;element&quot;],&quot;title&quot;:[0,&quot;表格拖拽方法手写&quot;],&quot;date&quot;:[3,&quot;2023-06-22T21:31:40.000Z&quot;],&quot;tags&quot;:[0,&quot;技术分享&quot;]}],&quot;imagePaths&quot;:[1,[]]}]}],&quot;collection&quot;:[0,&quot;blog&quot;]}],&quot;href&quot;:[0,&quot;/blog/post/21&quot;]}],[0,{&quot;post&quot;:[0,{&quot;id&quot;:[0,&quot;js循环依赖对象深拷贝&quot;],&quot;data&quot;:[0,{&quot;title&quot;:[0,&quot;js循环依赖对象深拷贝&quot;],&quot;date&quot;:[3,&quot;2023-03-07T13:37:26.000Z&quot;],&quot;tags&quot;:[0,&quot;技术分享&quot;]}],&quot;body&quot;:[0,&quot;## 循环依赖示例\n\n```javascript\nlet a = {};\nlet b = { a };\na.b = b;\n```\n\n## 经验分享\n\n这样的循环依赖的对象，需要每次递归的时候保留上一次递归的层级。\n并判断这次递归的内容中，有没有上一次的内容。\n如果有的话，就直接返回上一次的内容就行了。中断了递归。\n\n## 代码实现\n\n```javascript\n/**\n * @param { object } obj\n * @returns { object }\n */\nconst deepCopy = (obj, stack = []) =&gt; {\n  let target = null;\n  if (typeof obj === &#39;object&#39;) {\n    if (stack.includes(obj)) {\n      return obj;\n    } else {\n      stack.push(obj);\n    }\n    if (Array.isArray(obj)) {\n      target = [];\n      obj.forEach((item) =&gt; {\n        target.push(deepCopy(item, stack));\n      });\n    } else if (obj) {\n      target = {};\n      for (const [key, value] of Object.entries(obj)) {\n        target[key] = deepCopy(obj[key], stack);\n      }\n    } else {\n      target = obj;\n    }\n  } else {\n    target = obj;\n  }\n  return target;\n};\nexport default deepCopy;\n```&quot;],&quot;filePath&quot;:[0,&quot;source/posts/js循环依赖对象深拷贝.md&quot;],&quot;digest&quot;:[0,&quot;6a6b263660444ebe&quot;],&quot;rendered&quot;:[0,{&quot;html&quot;:[0,&quot;&lt;h2 id=\&quot;循环依赖示例\&quot;&gt;循环依赖示例&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#循环依赖示例\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;javascript\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;let&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; a &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {};&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;let&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; b &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; { a };&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;a.b &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; b;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h2 id=\&quot;经验分享\&quot;&gt;经验分享&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#经验分享\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;这样的循环依赖的对象，需要每次递归的时候保留上一次递归的层级。\n并判断这次递归的内容中，有没有上一次的内容。\n如果有的话，就直接返回上一次的内容就行了。中断了递归。&lt;/p&gt;\n&lt;h2 id=\&quot;代码实现\&quot;&gt;代码实现&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#代码实现\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;javascript\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;/**&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt; * &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;@param&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; { object }&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; obj&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt; * &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;@returns&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; { object }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt; */&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;const&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; deepCopy&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; (&lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;obj&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;stack&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; []) &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  let&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; target &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; null&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  if&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; (&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;typeof&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; obj &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;===&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; &#39;object&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    if&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; (stack.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;includes&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(obj)) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;      return&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; obj;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    } &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;else&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      stack.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;push&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(obj);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    if&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; (Array.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;isArray&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(obj)) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      target &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; [];&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      obj.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;forEach&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;((&lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;item&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;) &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;        target.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;push&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;deepCopy&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(item, stack));&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      });&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    } &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;else&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; if&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; (obj) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      target &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {};&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;      for&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; (&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;const&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; [&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;key&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;value&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;] &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;of&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; Object.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;entries&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(obj)) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;        target[key] &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; deepCopy&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(obj[key], stack);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    } &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;else&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      target &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; obj;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  } &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;else&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    target &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; obj;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  return&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; target;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;};&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;export&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; default&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; deepCopy;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&quot;],&quot;metadata&quot;:[0,{&quot;headings&quot;:[1,[[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;循环依赖示例&quot;],&quot;text&quot;:[0,&quot;循环依赖示例&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;经验分享&quot;],&quot;text&quot;:[0,&quot;经验分享&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;代码实现&quot;],&quot;text&quot;:[0,&quot;代码实现&quot;]}]]],&quot;localImagePaths&quot;:[1,[]],&quot;remoteImagePaths&quot;:[1,[]],&quot;frontmatter&quot;:[0,{&quot;title&quot;:[0,&quot;js循环依赖对象深拷贝&quot;],&quot;date&quot;:[3,&quot;2023-03-07T13:37:26.000Z&quot;],&quot;tags&quot;:[0,&quot;技术分享&quot;]}],&quot;imagePaths&quot;:[1,[]]}]}],&quot;collection&quot;:[0,&quot;blog&quot;]}],&quot;href&quot;:[0,&quot;/blog/post/20&quot;]}],[0,{&quot;post&quot;:[0,{&quot;id&quot;:[0,&quot;js对象数组深拷贝&quot;],&quot;data&quot;:[0,{&quot;title&quot;:[0,&quot;JS对象数组深拷贝&quot;],&quot;date&quot;:[3,&quot;2023-02-08T21:52:20.000Z&quot;],&quot;tags&quot;:[0,&quot;技术分享&quot;]}],&quot;body&quot;:[0,&quot;```javascript\n/**\n * @param { object } obj\n * @returns { object }\n */\nconst deepCopy = (obj) =&gt; {\n  let target = null;\n  if (typeof obj === &#39;object&#39;) {\n    if (Array.isArray(obj)) {\n      target = [];\n      obj.forEach((item) =&gt; {\n        target.push(deepCopy(item));\n      });\n    } else if (obj) {\n      target = {};\n      for (const [key, value] of Object.entries(obj)) {\n        target[key] = deepCopy(obj[key]);\n      }\n    } else {\n      target = obj;\n    }\n  } else {\n    target = obj;\n  }\n  return target;\n};\n```&quot;],&quot;filePath&quot;:[0,&quot;source/posts/JS对象数组深拷贝.md&quot;],&quot;digest&quot;:[0,&quot;3d14c4354250b19b&quot;],&quot;rendered&quot;:[0,{&quot;html&quot;:[0,&quot;&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;javascript\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;/**&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt; * &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;@param&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; { object }&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; obj&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt; * &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;@returns&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; { object }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt; */&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;const&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; deepCopy&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; (&lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;obj&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;) &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  let&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; target &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; null&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  if&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; (&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;typeof&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; obj &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;===&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; &#39;object&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    if&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; (Array.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;isArray&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(obj)) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      target &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; [];&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      obj.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;forEach&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;((&lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;item&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;) &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;        target.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;push&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;deepCopy&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(item));&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      });&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    } &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;else&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; if&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; (obj) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      target &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {};&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;      for&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; (&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;const&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; [&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;key&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;value&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;] &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;of&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; Object.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;entries&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(obj)) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;        target[key] &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; deepCopy&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(obj[key]);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    } &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;else&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      target &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; obj;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  } &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;else&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    target &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; obj;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  return&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; target;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;};&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&quot;],&quot;metadata&quot;:[0,{&quot;headings&quot;:[1,[]],&quot;localImagePaths&quot;:[1,[]],&quot;remoteImagePaths&quot;:[1,[]],&quot;frontmatter&quot;:[0,{&quot;title&quot;:[0,&quot;JS对象数组深拷贝&quot;],&quot;date&quot;:[3,&quot;2023-02-08T21:52:20.000Z&quot;],&quot;tags&quot;:[0,&quot;技术分享&quot;]}],&quot;imagePaths&quot;:[1,[]]}]}],&quot;collection&quot;:[0,&quot;blog&quot;]}],&quot;href&quot;:[0,&quot;/blog/post/19&quot;]}],[0,{&quot;post&quot;:[0,{&quot;id&quot;:[0,&quot;cenos-7-6搭建pptp服务&quot;],&quot;data&quot;:[0,{&quot;title&quot;:[0,&quot;CenOS-7.6搭建pptp服务&quot;],&quot;date&quot;:[3,&quot;2023-02-05T10:36:58.000Z&quot;],&quot;tags&quot;:[0,&quot;技术分享&quot;]}],&quot;body&quot;:[0,&quot;## 参考教程\n\n&lt;a href=\&quot;https://help.aliyun.com/document_detail/41345.html\&quot; target=\&quot;_blank\&quot;&gt;见阿里云教程&lt;/a&gt;\n\n## 防火墙配置问题\n\n按照阿里云步骤走完，如果提醒远程连接计算机端口已关闭的话。可能是没开放端口。\n\n需要更改防火墙的策略。\n\n```bash\n# 查看防火墙当前配置\niptables -L -n\n\n# 允许所有请求\niptables -P INPUT ACCEPT\n\n# 清空默认所有规则\niptables -F\n\n# 清空自定义所有规则\niptables -X\n\n# 计数器置0\niptables -Z\n\n# 允许127.0.0.1访问本地服务\niptables -A INPUT -i lo -j ACCEPT\n\n# 允许访问外部服务\niptables -A INPUT -m state --state ESTABLISHED -j ACCEPT\n\n# 允许 ping\niptables -A INPUT -p icmp -m icmp --icmp-type 8 -j ACCEPT\n\n# 开启 ssh 端口\niptables -A INPUT -p tcp --dport 22 -j ACCEPT\n\n# 开启 pptpd 端口\niptables -A INPUT -p tcp --dport 1723 -j ACCEPT\n```\n\n## 注意事项\n\n哎嘿,昨天我搞了半天连不上。后来看了很多教程。才知道是我防火墙未放行。\n\n很多网上的教程并未提及防火墙放行这一步步骤。\n\n### 补充说明\n\n每次如果更改了DNS和ip段配置后。都要运行这个命令来生效哦：\n\n```bash\nsysctl -p              # 生效配置\nservice iptables save  # 保存防火墙配置\nservice iptables restart  # 重启防火墙\n```\n\n如果更改，或添加pptpd账号。也是需要重启pptp的。\n\n```bash\nservice pptpd restart  # 重启pptp\n```&quot;],&quot;filePath&quot;:[0,&quot;source/posts/CenOS-7-6搭建pptp服务.md&quot;],&quot;digest&quot;:[0,&quot;a05f5af800f47570&quot;],&quot;rendered&quot;:[0,{&quot;html&quot;:[0,&quot;&lt;h2 id=\&quot;参考教程\&quot;&gt;参考教程&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#参考教程\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;&lt;a href=\&quot;https://help.aliyun.com/document_detail/41345.html\&quot; target=\&quot;_blank\&quot;&gt;见阿里云教程&lt;/a&gt;&lt;/p&gt;\n&lt;h2 id=\&quot;防火墙配置问题\&quot;&gt;防火墙配置问题&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#防火墙配置问题\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;按照阿里云步骤走完，如果提醒远程连接计算机端口已关闭的话。可能是没开放端口。&lt;/p&gt;\n&lt;p&gt;需要更改防火墙的策略。&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;bash\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;# 查看防火墙当前配置&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;iptables&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; -L&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; -n&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;# 允许所有请求&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;iptables&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; -P&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; INPUT&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; ACCEPT&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;# 清空默认所有规则&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;iptables&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; -F&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;# 清空自定义所有规则&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;iptables&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; -X&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;# 计数器置0&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;iptables&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; -Z&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;# 允许127.0.0.1访问本地服务&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;iptables&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; -A&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; INPUT&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; -i&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; lo&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; -j&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; ACCEPT&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;# 允许访问外部服务&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;iptables&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; -A&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; INPUT&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; -m&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; state&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; --state&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; ESTABLISHED&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; -j&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; ACCEPT&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;# 允许 ping&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;iptables&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; -A&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; INPUT&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; -p&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; icmp&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; -m&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; icmp&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; --icmp-type&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; 8&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; -j&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; ACCEPT&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;# 开启 ssh 端口&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;iptables&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; -A&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; INPUT&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; -p&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; tcp&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; --dport&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; 22&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; -j&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; ACCEPT&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;# 开启 pptpd 端口&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;iptables&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; -A&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; INPUT&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; -p&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; tcp&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; --dport&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; 1723&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; -j&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; ACCEPT&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h2 id=\&quot;注意事项\&quot;&gt;注意事项&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#注意事项\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;哎嘿,昨天我搞了半天连不上。后来看了很多教程。才知道是我防火墙未放行。&lt;/p&gt;\n&lt;p&gt;很多网上的教程并未提及防火墙放行这一步步骤。&lt;/p&gt;\n&lt;h3 id=\&quot;补充说明\&quot;&gt;补充说明&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#补充说明\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;每次如果更改了DNS和ip段配置后。都要运行这个命令来生效哦：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;bash\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;sysctl&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; -p&lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;              # 生效配置&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;service&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; iptables&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; save&lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;  # 保存防火墙配置&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;service&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; iptables&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; restart&lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;  # 重启防火墙&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;如果更改，或添加pptpd账号。也是需要重启pptp的。&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;bash\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;service&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; pptpd&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; restart&lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;  # 重启pptp&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&quot;],&quot;metadata&quot;:[0,{&quot;headings&quot;:[1,[[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;参考教程&quot;],&quot;text&quot;:[0,&quot;参考教程&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;防火墙配置问题&quot;],&quot;text&quot;:[0,&quot;防火墙配置问题&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;注意事项&quot;],&quot;text&quot;:[0,&quot;注意事项&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;补充说明&quot;],&quot;text&quot;:[0,&quot;补充说明&quot;]}]]],&quot;localImagePaths&quot;:[1,[]],&quot;remoteImagePaths&quot;:[1,[]],&quot;frontmatter&quot;:[0,{&quot;title&quot;:[0,&quot;CenOS-7.6搭建pptp服务&quot;],&quot;date&quot;:[3,&quot;2023-02-05T10:36:58.000Z&quot;],&quot;tags&quot;:[0,&quot;技术分享&quot;]}],&quot;imagePaths&quot;:[1,[]]}]}],&quot;collection&quot;:[0,&quot;blog&quot;]}],&quot;href&quot;:[0,&quot;/blog/post/18&quot;]}],[0,{&quot;post&quot;:[0,{&quot;id&quot;:[0,&quot;不到半个月就要变猫了&quot;],&quot;data&quot;:[0,{&quot;title&quot;:[0,&quot;不到半个月就要变猫了&quot;],&quot;date&quot;:[3,&quot;2023-02-04T21:09:52.000Z&quot;],&quot;tags&quot;:[0,&quot;碎碎念&quot;]}],&quot;body&quot;:[0,&quot;&lt;p&gt;距离SRS还有12天大概的样子吧。如果不出意外的话。&lt;/p&gt;\n&lt;p&gt;说实话个人感觉挺慌的&lt;/p&gt;\n&lt;p&gt;术前紧张。肯定有的。害!!&lt;/p&gt;\n&lt;p&gt;但愿未来能够一切顺利吧&lt;/p&gt;\n\n![emj](../img/QQ图片20230204211241.jpg)&quot;],&quot;filePath&quot;:[0,&quot;source/posts/不到半个月就要变猫了.md&quot;],&quot;assetImports&quot;:[1,[[0,&quot;../img/QQ图片20230204211241.jpg&quot;]]],&quot;digest&quot;:[0,&quot;0e7d9a998d535192&quot;],&quot;rendered&quot;:[0,{&quot;html&quot;:[0,&quot;&lt;p&gt;距离SRS还有12天大概的样子吧。如果不出意外的话。&lt;/p&gt;\n&lt;p&gt;说实话个人感觉挺慌的&lt;/p&gt;\n&lt;p&gt;术前紧张。肯定有的。害!!&lt;/p&gt;\n&lt;p&gt;但愿未来能够一切顺利吧&lt;/p&gt;\n&lt;p&gt;&lt;/p&gt;&lt;figure class=\&quot;markdown-image-wrapper\&quot;&gt;&lt;img __ASTRO_IMAGE_=\&quot;{&amp;#x22;src&amp;#x22;:&amp;#x22;../img/QQ图片20230204211241.jpg&amp;#x22;,&amp;#x22;alt&amp;#x22;:&amp;#x22;emj&amp;#x22;,&amp;#x22;loading&amp;#x22;:&amp;#x22;lazy&amp;#x22;,&amp;#x22;decoding&amp;#x22;:&amp;#x22;async&amp;#x22;,&amp;#x22;class&amp;#x22;:&amp;#x22;markdown-image&amp;#x22;,&amp;#x22;index&amp;#x22;:0}\&quot;&gt;&lt;/figure&gt;&lt;p&gt;&lt;/p&gt;&quot;],&quot;metadata&quot;:[0,{&quot;headings&quot;:[1,[]],&quot;localImagePaths&quot;:[1,[[0,&quot;../img/QQ图片20230204211241.jpg&quot;]]],&quot;remoteImagePaths&quot;:[1,[]],&quot;frontmatter&quot;:[0,{&quot;title&quot;:[0,&quot;不到半个月就要变猫了&quot;],&quot;date&quot;:[3,&quot;2023-02-04T21:09:52.000Z&quot;],&quot;tags&quot;:[0,&quot;碎碎念&quot;]}],&quot;imagePaths&quot;:[1,[[0,&quot;../img/QQ图片20230204211241.jpg&quot;]]]}]}],&quot;collection&quot;:[0,&quot;blog&quot;]}],&quot;href&quot;:[0,&quot;/blog/post/17&quot;]}],[0,{&quot;post&quot;:[0,{&quot;id&quot;:[0,&quot;不知道怎么过年&quot;],&quot;data&quot;:[0,{&quot;title&quot;:[0,&quot;不知道怎么过年&quot;],&quot;date&quot;:[3,&quot;2023-01-18T00:06:04.000Z&quot;],&quot;tags&quot;:[0,&quot;碎碎念&quot;]}],&quot;body&quot;:[0,&quot;&lt;p&gt;\n 没车票，黄牛票太贵。不太想回去过年。而且，最近的烦心事真的是好多。今年三月、四月可能要进行SRS🍥，要向公司请一个月假，就非常地头疼。\n&lt;/p&gt;\n\n![emj](../img/u=3523309784,1268457401&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=JPEG.webp)&quot;],&quot;filePath&quot;:[0,&quot;source/posts/不知道怎么过年.md&quot;],&quot;assetImports&quot;:[1,[[0,&quot;../img/u=3523309784,1268457401&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=JPEG.webp&quot;]]],&quot;digest&quot;:[0,&quot;ce96061b5405f056&quot;],&quot;rendered&quot;:[0,{&quot;html&quot;:[0,&quot;&lt;p&gt;\n 没车票，黄牛票太贵。不太想回去过年。而且，最近的烦心事真的是好多。今年三月、四月可能要进行SRS🍥，要向公司请一个月假，就非常地头疼。\n&lt;/p&gt;\n&lt;p&gt;&lt;/p&gt;&lt;figure class=\&quot;markdown-image-wrapper\&quot;&gt;&lt;img __ASTRO_IMAGE_=\&quot;{&amp;#x22;src&amp;#x22;:&amp;#x22;../img/u=3523309784,1268457401&amp;#x26;fm=253&amp;#x26;fmt=auto&amp;#x26;app=138&amp;#x26;f=JPEG.webp&amp;#x22;,&amp;#x22;alt&amp;#x22;:&amp;#x22;emj&amp;#x22;,&amp;#x22;loading&amp;#x22;:&amp;#x22;lazy&amp;#x22;,&amp;#x22;decoding&amp;#x22;:&amp;#x22;async&amp;#x22;,&amp;#x22;class&amp;#x22;:&amp;#x22;markdown-image&amp;#x22;,&amp;#x22;index&amp;#x22;:0}\&quot;&gt;&lt;/figure&gt;&lt;p&gt;&lt;/p&gt;&quot;],&quot;metadata&quot;:[0,{&quot;headings&quot;:[1,[]],&quot;localImagePaths&quot;:[1,[[0,&quot;../img/u=3523309784,1268457401&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=JPEG.webp&quot;]]],&quot;remoteImagePaths&quot;:[1,[]],&quot;frontmatter&quot;:[0,{&quot;title&quot;:[0,&quot;不知道怎么过年&quot;],&quot;date&quot;:[3,&quot;2023-01-18T00:06:04.000Z&quot;],&quot;tags&quot;:[0,&quot;碎碎念&quot;]}],&quot;imagePaths&quot;:[1,[[0,&quot;../img/u=3523309784,1268457401&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=JPEG.webp&quot;]]]}]}],&quot;collection&quot;:[0,&quot;blog&quot;]}],&quot;href&quot;:[0,&quot;/blog/post/16&quot;]}]]],&quot;currentPostSlug&quot;:[0,&quot;electron热更新后启动性能优化-v8缓存与代码拆包实战&quot;],&quot;prevPostItem&quot;:[0,{&quot;post&quot;:[0,{&quot;id&quot;:[0,&quot;rust-cow-learning-notes&quot;],&quot;data&quot;:[0,{&quot;title&quot;:[0,&quot;Rust Cow（Clone-On-Write）学习笔记：理解 Borrowed 状态&quot;],&quot;description&quot;:[0,&quot;本文通过一个具体的测试案例，深入探讨了 Rust 中 Cow（Clone-On-Write）智能指针的 Borrowed 状态。我们将理解在何种情况下 Cow 会保持借用，以及它何时会克隆数据变为所有。&quot;],&quot;date&quot;:[3,&quot;2025-12-05T00:00:00.000Z&quot;],&quot;tags&quot;:[1,[[0,&quot;Rust&quot;],[0,&quot;Cow&quot;],[0,&quot;Smart Pointers&quot;],[0,&quot;Borrowing&quot;]]]}],&quot;body&quot;:[0,&quot;在 Rust 的智能指针中，`Cow` (Clone-On-Write) 提供了一种灵活的数据处理方式，它可以在需要时才进行数据克隆，从而优化性能。本文将通过一个具体的案例，来深入理解 `Cow` 的 `Borrowed` 状态。\n\n### `Cow::Borrowed` 是什么？\n\n在 Rust 中，`Cow` 类型有两种主要的状态：\n\n- `Cow::Borrowed&lt;&#39;a, T&gt;`：表示 `Cow` 只是“借用”了原始数据，它持有一个对类型 `T` 的不可变引用 `&amp;&#39;a T`。在这种状态下，`Cow` 不拥有数据的所有权，也不会对原始数据进行任何修改。\n- `Cow::Owned&lt;T&gt;`：表示 `Cow` 拥有了一份数据的副本。当需要修改数据，且 `Cow` 当前处于 `Borrowed` 状态时，它会自动克隆一份数据，并转换为 `Owned` 状态，从而允许进行修改。\n\n### 案例分析：`reference_no_mutation` 测试\n\n我们来看一个在 `rustlings` 练习中常见的测试案例，它帮助我们理解 `Cow` 的行为：\n\n```rust\n// 假设有如下的 abs_all 函数\nfn abs_all&lt;&#39;a, T&gt;(input: Cow&lt;&#39;a, [T]&gt;) -&gt; Cow&lt;&#39;a, [T]&gt;\nwhere\n    T: Clone + Copy + PartialOrd + std::ops::Neg&lt;Output = T&gt;,\n{\n    input\n        .into_iter()\n        .map(|&amp;x| if x &lt; T::from(0) { -x } else { x })\n        .collect::&lt;Vec&lt;T&gt;&gt;()\n        .into()\n}\n\n// 在 reference_no_mutation 测试中\nlet input_vec = vec![0, 1, 2];\nlet mut input = Cow::from(&amp;input_vec); // 通过 Cow::from(&amp;vec) 创建，此时 input 是 Borrowed 状态\nlet result = abs_all(input.clone()); // 传入 abs_all 函数\n\nassert!(matches!(input, Cow::Borrowed(_))); // 这个断言会成功\n```\n\n**分析过程：**\n\n1.  **创建 `Cow`：** 在 `reference_no_mutation` 测试中，`input` 是通过 `Cow::from(&amp;input_vec)` 创建的。这意味着 `input` 最初是对 `input_vec` 的一个借用 (`Cow::Borrowed`)，它不拥有数据的所有权。\n\n2.  **`abs_all` 函数的行为：** `abs_all` 函数的目的是将切片中的所有负数变为正数（取绝对值）。它通过 `into_iter().map(...)` 遍历元素。关键在于 `map` 内部的逻辑：`if x &lt; T::from(0) { -x } else { x }`。只有当元素 `x` 小于 0 时，才会进行操作 `-x`。\n\n3.  **无修改发生：** 在这个特定的测试中，`input_vec` 的内容是 `[0, 1, 2]`，所有元素都是非负数。因此，在 `abs_all` 函数内部，条件 `x &lt; T::from(0)` **从未**满足。这意味着 `input`（或者其内部数据）并没有被实际修改。\n\n4.  **`to_mut()` 未被调用：** `Cow` 只有在需要修改借用的数据时，才会调用 `to_mut()` 方法来克隆数据并转换为 `Owned` 状态。由于上述原因，没有任何元素需要修改，所以 `to_mut()` 从未被调用。\n\n5.  **结果：保持 `Borrowed` 状态：** 因为 `input` 在 `abs_all` 函数的整个执行过程中都没有被修改，也因此没有触发数据克隆，`input` 仍然保持着对原始数据 `input_vec` 的借用状态。\n\n### 结论\n\n因此，`assert!(matches!(input, Cow::Borrowed(_)))` 断言成立。这个例子清晰地展示了 `Cow` 的“Copy-On-Write”机制：只有在实际需要写入（修改）时，才会发生数据的克隆和所有权的转移。如果数据仅仅被读取，`Cow` 会高效地保持 `Borrowed` 状态，避免不必要的内存分配和数据复制。理解这一点对于编写高效的 Rust 代码至关重要。&quot;],&quot;filePath&quot;:[0,&quot;source/posts/rust-cow-learning-notes.md&quot;],&quot;digest&quot;:[0,&quot;dbda7a0aedd34573&quot;],&quot;rendered&quot;:[0,{&quot;html&quot;:[0,&quot;&lt;p&gt;在 Rust 的智能指针中，&lt;code&gt;Cow&lt;/code&gt; (Clone-On-Write) 提供了一种灵活的数据处理方式，它可以在需要时才进行数据克隆，从而优化性能。本文将通过一个具体的案例，来深入理解 &lt;code&gt;Cow&lt;/code&gt; 的 &lt;code&gt;Borrowed&lt;/code&gt; 状态。&lt;/p&gt;\n&lt;h3 id=\&quot;cowborrowed-是什么\&quot;&gt;&lt;code&gt;Cow::Borrowed&lt;/code&gt; 是什么？&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#cowborrowed-是什么\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;在 Rust 中，&lt;code&gt;Cow&lt;/code&gt; 类型有两种主要的状态：&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;code&gt;Cow::Borrowed&amp;#x3C;&#39;a, T&gt;&lt;/code&gt;：表示 &lt;code&gt;Cow&lt;/code&gt; 只是“借用”了原始数据，它持有一个对类型 &lt;code&gt;T&lt;/code&gt; 的不可变引用 &lt;code&gt;&amp;#x26;&#39;a T&lt;/code&gt;。在这种状态下，&lt;code&gt;Cow&lt;/code&gt; 不拥有数据的所有权，也不会对原始数据进行任何修改。&lt;/li&gt;\n&lt;li&gt;&lt;code&gt;Cow::Owned&amp;#x3C;T&gt;&lt;/code&gt;：表示 &lt;code&gt;Cow&lt;/code&gt; 拥有了一份数据的副本。当需要修改数据，且 &lt;code&gt;Cow&lt;/code&gt; 当前处于 &lt;code&gt;Borrowed&lt;/code&gt; 状态时，它会自动克隆一份数据，并转换为 &lt;code&gt;Owned&lt;/code&gt; 状态，从而允许进行修改。&lt;/li&gt;\n&lt;/ul&gt;\n&lt;h3 id=\&quot;案例分析reference_no_mutation-测试\&quot;&gt;案例分析：&lt;code&gt;reference_no_mutation&lt;/code&gt; 测试&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#案例分析reference_no_mutation-测试\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;我们来看一个在 &lt;code&gt;rustlings&lt;/code&gt; 练习中常见的测试案例，它帮助我们理解 &lt;code&gt;Cow&lt;/code&gt; 的行为：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;rust\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 假设有如下的 abs_all 函数&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;fn&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; abs_all&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&#39;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;a&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;T&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&gt;(input&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;:&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Cow&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&#39;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;a&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, [&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;T&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;]&gt;) &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;-&gt;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Cow&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&#39;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;a&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, [&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;T&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;]&gt;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;where&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;    T&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;:&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Clone&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; +&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Copy&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; +&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; PartialOrd&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; +&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; std&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;ops&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Neg&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Output&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; T&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&gt;,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;{&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    input&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;        .&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;into_iter&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;()&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;        .&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;map&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;|&amp;#x26;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;x&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;|&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; if&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; x &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; T&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;from&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;0&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;) { &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;-&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;x } &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;else&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; { x })&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;        .&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;collect&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Vec&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;T&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&gt;&gt;()&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;        .&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;into&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;()&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 在 reference_no_mutation 测试中&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;let&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; input_vec &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; vec!&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;[&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;0&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;1&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;2&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;];&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;let&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; mut&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; input &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Cow&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;from&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;&amp;#x26;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;input_vec); &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 通过 Cow::from(&amp;#x26;vec) 创建，此时 input 是 Borrowed 状态&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;let&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; result &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; abs_all&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(input&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;clone&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;()); &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 传入 abs_all 函数&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;assert!&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;matches!&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(input, &lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Cow&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Borrowed&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(_))); &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 这个断言会成功&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;&lt;strong&gt;分析过程：&lt;/strong&gt;&lt;/p&gt;\n&lt;ol&gt;\n&lt;li&gt;\n&lt;p&gt;&lt;strong&gt;创建 &lt;code&gt;Cow&lt;/code&gt;：&lt;/strong&gt; 在 &lt;code&gt;reference_no_mutation&lt;/code&gt; 测试中，&lt;code&gt;input&lt;/code&gt; 是通过 &lt;code&gt;Cow::from(&amp;#x26;input_vec)&lt;/code&gt; 创建的。这意味着 &lt;code&gt;input&lt;/code&gt; 最初是对 &lt;code&gt;input_vec&lt;/code&gt; 的一个借用 (&lt;code&gt;Cow::Borrowed&lt;/code&gt;)，它不拥有数据的所有权。&lt;/p&gt;\n&lt;/li&gt;\n&lt;li&gt;\n&lt;p&gt;&lt;strong&gt;&lt;code&gt;abs_all&lt;/code&gt; 函数的行为：&lt;/strong&gt; &lt;code&gt;abs_all&lt;/code&gt; 函数的目的是将切片中的所有负数变为正数（取绝对值）。它通过 &lt;code&gt;into_iter().map(...)&lt;/code&gt; 遍历元素。关键在于 &lt;code&gt;map&lt;/code&gt; 内部的逻辑：&lt;code&gt;if x &amp;#x3C; T::from(0) { -x } else { x }&lt;/code&gt;。只有当元素 &lt;code&gt;x&lt;/code&gt; 小于 0 时，才会进行操作 &lt;code&gt;-x&lt;/code&gt;。&lt;/p&gt;\n&lt;/li&gt;\n&lt;li&gt;\n&lt;p&gt;&lt;strong&gt;无修改发生：&lt;/strong&gt; 在这个特定的测试中，&lt;code&gt;input_vec&lt;/code&gt; 的内容是 &lt;code&gt;[0, 1, 2]&lt;/code&gt;，所有元素都是非负数。因此，在 &lt;code&gt;abs_all&lt;/code&gt; 函数内部，条件 &lt;code&gt;x &amp;#x3C; T::from(0)&lt;/code&gt; &lt;strong&gt;从未&lt;/strong&gt;满足。这意味着 &lt;code&gt;input&lt;/code&gt;（或者其内部数据）并没有被实际修改。&lt;/p&gt;\n&lt;/li&gt;\n&lt;li&gt;\n&lt;p&gt;&lt;strong&gt;&lt;code&gt;to_mut()&lt;/code&gt; 未被调用：&lt;/strong&gt; &lt;code&gt;Cow&lt;/code&gt; 只有在需要修改借用的数据时，才会调用 &lt;code&gt;to_mut()&lt;/code&gt; 方法来克隆数据并转换为 &lt;code&gt;Owned&lt;/code&gt; 状态。由于上述原因，没有任何元素需要修改，所以 &lt;code&gt;to_mut()&lt;/code&gt; 从未被调用。&lt;/p&gt;\n&lt;/li&gt;\n&lt;li&gt;\n&lt;p&gt;&lt;strong&gt;结果：保持 &lt;code&gt;Borrowed&lt;/code&gt; 状态：&lt;/strong&gt; 因为 &lt;code&gt;input&lt;/code&gt; 在 &lt;code&gt;abs_all&lt;/code&gt; 函数的整个执行过程中都没有被修改，也因此没有触发数据克隆，&lt;code&gt;input&lt;/code&gt; 仍然保持着对原始数据 &lt;code&gt;input_vec&lt;/code&gt; 的借用状态。&lt;/p&gt;\n&lt;/li&gt;\n&lt;/ol&gt;\n&lt;h3 id=\&quot;结论\&quot;&gt;结论&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#结论\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;因此，&lt;code&gt;assert!(matches!(input, Cow::Borrowed(_)))&lt;/code&gt; 断言成立。这个例子清晰地展示了 &lt;code&gt;Cow&lt;/code&gt; 的“Copy-On-Write”机制：只有在实际需要写入（修改）时，才会发生数据的克隆和所有权的转移。如果数据仅仅被读取，&lt;code&gt;Cow&lt;/code&gt; 会高效地保持 &lt;code&gt;Borrowed&lt;/code&gt; 状态，避免不必要的内存分配和数据复制。理解这一点对于编写高效的 Rust 代码至关重要。&lt;/p&gt;&quot;],&quot;metadata&quot;:[0,{&quot;headings&quot;:[1,[[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;cowborrowed-是什么&quot;],&quot;text&quot;:[0,&quot;Cow::Borrowed 是什么？&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;案例分析reference_no_mutation-测试&quot;],&quot;text&quot;:[0,&quot;案例分析：reference_no_mutation 测试&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;结论&quot;],&quot;text&quot;:[0,&quot;结论&quot;]}]]],&quot;localImagePaths&quot;:[1,[]],&quot;remoteImagePaths&quot;:[1,[]],&quot;frontmatter&quot;:[0,{&quot;title&quot;:[0,&quot;Rust Cow（Clone-On-Write）学习笔记：理解 Borrowed 状态&quot;],&quot;date&quot;:[3,&quot;2025-12-05T00:00:00.000Z&quot;],&quot;tags&quot;:[1,[[0,&quot;Rust&quot;],[0,&quot;Cow&quot;],[0,&quot;Smart Pointers&quot;],[0,&quot;Borrowing&quot;]]],&quot;description&quot;:[0,&quot;本文通过一个具体的测试案例，深入探讨了 Rust 中 Cow（Clone-On-Write）智能指针的 Borrowed 状态。我们将理解在何种情况下 Cow 会保持借用，以及它何时会克隆数据变为所有。&quot;]}],&quot;imagePaths&quot;:[1,[]]}]}],&quot;collection&quot;:[0,&quot;blog&quot;]}],&quot;href&quot;:[0,&quot;/blog/post/37&quot;]}],&quot;nextPostItem&quot;:[0,{&quot;post&quot;:[0,{&quot;id&quot;:[0,&quot;配置-codex-自定义三方api&quot;],&quot;data&quot;:[0,{&quot;title&quot;:[0,&quot;配置 Codex 自定义三方API&quot;],&quot;date&quot;:[3,&quot;2025-10-22T10:00:00.000Z&quot;],&quot;tags&quot;:[1,[[0,&quot;CodeX&quot;],[0,&quot;AI&quot;],[0,&quot;配置&quot;]]],&quot;categories&quot;:[0,&quot;技术教程&quot;]}],&quot;body&quot;:[0,&quot;最近在用 Claude Code,换了成本更低的Codex,记录一下配置过程。方便以后查看，快速配置。\n\n## 配置路径\n\n配置文件位置:\n\n- **macOS/Linux**: `~/.codex/config.toml`\n- **Windows**: `C:\\Users\\你的用户名\\.codex\\config.toml`\n\n## 配置文件\n\n直接上配置:\n\n```toml\nmodel_provider = \&quot;codex\&quot;\nmodel = \&quot;gpt-4.1-mini\&quot;\nmodel_reasoning_effort = \&quot;medium\&quot;\ndisable_response_storage = true\nwindows_wsl_setup_acknowledged = true\n\n[model_providers.codex]\nname = \&quot;codex\&quot;\nbase_url=\&quot;https://api.burn.hair/v1\&quot; #使用官方或第三方的\nwire_api = \&quot;responses\&quot;\nenv_key = \&quot;K_CODEX\&quot; #不要改成自己的密钥,在系统环境变量中设置\n```\n\n## 参数说明\n\n几个关键配置:\n\n- `model_provider`: 设置成 `\&quot;codex\&quot;` 就行\n- `model`: 用的模型,这里是 `gpt-4.1-mini`\n- `model_reasoning_effort`: 推理强度,`low`/`medium`/`high` 三档,medium 够用\n- `disable_response_storage`: 不保存历史记录,开启更安全\n- `base_url`: API 地址,换成你自己的\n- `env_key`: 环境变量名,**密钥别直接写配置文件里**\n\n## 设置步骤\n\n### 1. 修改配置文件\n\n找到配置文件,把上面的配置复制进去,改一下 `base_url` 和 `model`。\n\n### 2. 设置环境变量\n\n**macOS/Linux** 在 `~/.zshrc` 或 `~/.bashrc` 加一行:\n\n```bash\nexport K_CODEX=\&quot;your-api-key-here\&quot;\n```\n\n然后 `source ~/.zshrc` 生效。\n\n**Windows** PowerShell 执行:\n\n```powershell\n[System.Environment]::SetEnvironmentVariable(&#39;K_CODEX&#39;, &#39;your-api-key-here&#39;, &#39;User&#39;)\n```\n\n### 3. 重启终端\n\n重启终端就能用了。&quot;],&quot;filePath&quot;:[0,&quot;source/posts/配置 Codex 自定义三方API.md&quot;],&quot;digest&quot;:[0,&quot;b4fa279e184dff34&quot;],&quot;rendered&quot;:[0,{&quot;html&quot;:[0,&quot;&lt;p&gt;最近在用 Claude Code,换了成本更低的Codex,记录一下配置过程。方便以后查看，快速配置。&lt;/p&gt;\n&lt;h2 id=\&quot;配置路径\&quot;&gt;配置路径&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#配置路径\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;配置文件位置:&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;strong&gt;macOS/Linux&lt;/strong&gt;: &lt;code&gt;~/.codex/config.toml&lt;/code&gt;&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;Windows&lt;/strong&gt;: &lt;code&gt;C:\\Users\\你的用户名\\.codex\\config.toml&lt;/code&gt;&lt;/li&gt;\n&lt;/ul&gt;\n&lt;h2 id=\&quot;配置文件\&quot;&gt;配置文件&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#配置文件\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;直接上配置:&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;toml\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;model_provider = &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;\&quot;codex\&quot;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;model = &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;\&quot;gpt-4.1-mini\&quot;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;model_reasoning_effort = &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;\&quot;medium\&quot;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;disable_response_storage = &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;true&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;windows_wsl_setup_acknowledged = &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;true&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;[&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;model_providers&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;codex&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;]&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;name = &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;\&quot;codex\&quot;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;base_url=&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;\&quot;https://api.burn.hair/v1\&quot;&lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt; #使用官方或第三方的&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;wire_api = &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;\&quot;responses\&quot;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;env_key = &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;\&quot;K_CODEX\&quot;&lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt; #不要改成自己的密钥,在系统环境变量中设置&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h2 id=\&quot;参数说明\&quot;&gt;参数说明&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#参数说明\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;几个关键配置:&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;code&gt;model_provider&lt;/code&gt;: 设置成 &lt;code&gt;\&quot;codex\&quot;&lt;/code&gt; 就行&lt;/li&gt;\n&lt;li&gt;&lt;code&gt;model&lt;/code&gt;: 用的模型,这里是 &lt;code&gt;gpt-4.1-mini&lt;/code&gt;&lt;/li&gt;\n&lt;li&gt;&lt;code&gt;model_reasoning_effort&lt;/code&gt;: 推理强度,&lt;code&gt;low&lt;/code&gt;/&lt;code&gt;medium&lt;/code&gt;/&lt;code&gt;high&lt;/code&gt; 三档,medium 够用&lt;/li&gt;\n&lt;li&gt;&lt;code&gt;disable_response_storage&lt;/code&gt;: 不保存历史记录,开启更安全&lt;/li&gt;\n&lt;li&gt;&lt;code&gt;base_url&lt;/code&gt;: API 地址,换成你自己的&lt;/li&gt;\n&lt;li&gt;&lt;code&gt;env_key&lt;/code&gt;: 环境变量名,&lt;strong&gt;密钥别直接写配置文件里&lt;/strong&gt;&lt;/li&gt;\n&lt;/ul&gt;\n&lt;h2 id=\&quot;设置步骤\&quot;&gt;设置步骤&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#设置步骤\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;h3 id=\&quot;1-修改配置文件\&quot;&gt;1. 修改配置文件&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#1-修改配置文件\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;找到配置文件,把上面的配置复制进去,改一下 &lt;code&gt;base_url&lt;/code&gt; 和 &lt;code&gt;model&lt;/code&gt;。&lt;/p&gt;\n&lt;h3 id=\&quot;2-设置环境变量\&quot;&gt;2. 设置环境变量&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#2-设置环境变量\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;&lt;strong&gt;macOS/Linux&lt;/strong&gt; 在 &lt;code&gt;~/.zshrc&lt;/code&gt; 或 &lt;code&gt;~/.bashrc&lt;/code&gt; 加一行:&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;bash\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;export&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; K_CODEX&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;\&quot;your-api-key-here\&quot;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;然后 &lt;code&gt;source ~/.zshrc&lt;/code&gt; 生效。&lt;/p&gt;\n&lt;p&gt;&lt;strong&gt;Windows&lt;/strong&gt; PowerShell 执行:&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;powershell\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;[&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;System.Environment&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;]::SetEnvironmentVariable(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;K_CODEX&#39;&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;,&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; &#39;your-api-key-here&#39;&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;,&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; &#39;User&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h3 id=\&quot;3-重启终端\&quot;&gt;3. 重启终端&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#3-重启终端\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;重启终端就能用了。&lt;/p&gt;&quot;],&quot;metadata&quot;:[0,{&quot;headings&quot;:[1,[[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;配置路径&quot;],&quot;text&quot;:[0,&quot;配置路径&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;配置文件&quot;],&quot;text&quot;:[0,&quot;配置文件&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;参数说明&quot;],&quot;text&quot;:[0,&quot;参数说明&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;设置步骤&quot;],&quot;text&quot;:[0,&quot;设置步骤&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;1-修改配置文件&quot;],&quot;text&quot;:[0,&quot;1. 修改配置文件&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;2-设置环境变量&quot;],&quot;text&quot;:[0,&quot;2. 设置环境变量&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;3-重启终端&quot;],&quot;text&quot;:[0,&quot;3. 重启终端&quot;]}]]],&quot;localImagePaths&quot;:[1,[]],&quot;remoteImagePaths&quot;:[1,[]],&quot;frontmatter&quot;:[0,{&quot;title&quot;:[0,&quot;配置 Codex 自定义三方API&quot;],&quot;date&quot;:[3,&quot;2025-10-22T10:00:00.000Z&quot;],&quot;tags&quot;:[1,[[0,&quot;CodeX&quot;],[0,&quot;AI&quot;],[0,&quot;配置&quot;]]],&quot;categories&quot;:[0,&quot;技术教程&quot;]}],&quot;imagePaths&quot;:[1,[]]}]}],&quot;collection&quot;:[0,&quot;blog&quot;]}],&quot;href&quot;:[0,&quot;/blog/post/31&quot;]}]}" ssr client="media" opts="{&quot;name&quot;:&quot;HomeSiderPanel&quot;,&quot;value&quot;:&quot;(min-width: 993px)&quot;}" await-children><link rel="preload" as="image" href="/img/724d7fb480c8ac0db472ca5c7e36d239.jpg" fetchPriority="high"/><div class="cursor-pointer rounded-sm bg-black/8 p-1 font-semibold backdrop-blur-lg select-none my-4 flex w-full justify-between text-sm/6"><div class="flex-center relative cursor-pointer gap-1.5 px-3 py-1 first:rounded-l-xs last:rounded-r-xs opacity-50 grow"><span class="flex-center shrink-0"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" class="w-4 h-4" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2ZM12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM15.8329 7.33748C16.0697 7.17128 16.3916 7.19926 16.5962 7.40381C16.8002 7.60784 16.8267 7.92955 16.6587 8.16418C14.479 11.2095 13.2796 12.8417 13.0607 13.0607C12.4749 13.6464 11.5251 13.6464 10.9393 13.0607C10.3536 12.4749 10.3536 11.5251 10.9393 10.9393C11.3126 10.5661 12.9438 9.36549 15.8329 7.33748ZM17.5 11C18.0523 11 18.5 11.4477 18.5 12C18.5 12.5523 18.0523 13 17.5 13C16.9477 13 16.5 12.5523 16.5 12C16.5 11.4477 16.9477 11 17.5 11ZM6.5 11C7.05228 11 7.5 11.4477 7.5 12C7.5 12.5523 7.05228 13 6.5 13C5.94772 13 5.5 12.5523 5.5 12C5.5 11.4477 5.94772 11 6.5 11ZM8.81802 7.40381C9.20854 7.79433 9.20854 8.4275 8.81802 8.81802C8.4275 9.20854 7.79433 9.20854 7.40381 8.81802C7.01328 8.4275 7.01328 7.79433 7.40381 7.40381C7.79433 7.01328 8.4275 7.01328 8.81802 7.40381ZM12 5.5C12.5523 5.5 13 5.94772 13 6.5C13 7.05228 12.5523 7.5 12 7.5C11.4477 7.5 11 7.05228 11 6.5C11 5.94772 11.4477 5.5 12 5.5Z"></path></svg></span></div><div class="flex-center relative cursor-pointer gap-1.5 px-3 py-1 first:rounded-l-xs last:rounded-r-xs text-primary-foreground grow"><span class="flex-center shrink-0"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" class="w-4 h-4" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M5.75024 3.5H4.71733L3.25 3.89317V5.44582L4.25002 5.17782L4.25018 8.5H3V10H7V8.5H5.75024V3.5ZM10 4H21V6H10V4ZM10 11H21V13H10V11ZM10 18H21V20H10V18ZM2.875 15.625C2.875 14.4514 3.82639 13.5 5 13.5C6.17361 13.5 7.125 14.4514 7.125 15.625C7.125 16.1106 6.96183 16.5587 6.68747 16.9167L6.68271 16.9229L5.31587 18.5H7V20H3.00012L2.99959 18.8786L5.4717 16.035C5.5673 15.9252 5.625 15.7821 5.625 15.625C5.625 15.2798 5.34518 15 5 15C4.67378 15 4.40573 15.2501 4.37747 15.5688L4.3651 15.875H2.875V15.625Z"></path></svg></span><span class="overflow-hidden whitespace-nowrap" style="width:auto;opacity:1">文章目录</span><div class="bg-gradient-shoka-button absolute inset-0 -z-10 rounded-sm" style="will-change:transform"></div></div><div class="flex-center relative cursor-pointer gap-1.5 px-3 py-1 first:rounded-l-xs last:rounded-r-xs opacity-50 grow"><span class="flex-center shrink-0"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" class="w-4 h-4" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M20 22H4C3.44772 22 3 21.5523 3 21V3C3 2.44772 3.44772 2 4 2H20C20.5523 2 21 2.44772 21 3V21C21 21.5523 20.5523 22 20 22ZM19 20V4H5V20H19ZM7 6H11V10H7V6ZM7 12H17V14H7V12ZM7 16H17V18H7V16ZM13 7H17V9H13V7Z"></path></svg></span></div></div><div class="vertical-scrollbar pt-10 scroll-gutter-stable relative block w-full flex-1 min-h-0 overflow-x-hidden overflow-y-auto md:pt-4 md:pl-3" data-type="post" data-default-type="directory"><div class="sider-slot" data-slot-type="info"><div class="flex flex-col items-center"><div class="h-40 w-40 rounded-full" style="background-image:linear-gradient(135deg, #d78f6f 0%, #d3a691 50%, #dd9378 100%)"><img class="shadow-card-darker hover:animate-shake h-full w-full rounded-full transition" src="/img/724d7fb480c8ac0db472ca5c7e36d239.jpg" alt="snow avatar" loading="eager" fetchPriority="high"/></div><p class="mt-2">snow</p><p class="text-muted-foreground mt-3 text-center">ACG / 养猫人 / 菜逼 / 前端什锦</p><div class="mt-2 grid grid-cols-3 gap-2"><div><a class="social-link flex-center group relative overflow-hidden rounded-xl px-1.5 py-1 transition-all duration-300 group-hover:scale-105" style="--link-color:#191717" data-platform="github" href="https://github.com/XueHua-s" title="GitHub" data-tooltip-interactive="false" data-tooltip-placement="top" aria-label="GitHub"><i class="fa-brands fa-github social-icon" aria-hidden="true"></i><span class="absolute inset-0 -z-10 -translate-x-full translate-y-full rounded-xl transition-transform duration-300 group-hover:translate-x-0 group-hover:translate-y-0"></span></a></div><div><a class="social-link flex-center group relative overflow-hidden rounded-xl px-1.5 py-1 transition-all duration-300 group-hover:scale-105" style="--link-color:#4b9ae4" data-platform="x" href="https://x.com/xiaoxueljx?s=21" title="X (推特)" data-tooltip-interactive="false" data-tooltip-placement="top" aria-label="X (推特)"><i class="fa-brands fa-x-twitter social-icon" aria-hidden="true"></i><span class="absolute inset-0 -z-10 -translate-x-full translate-y-full rounded-xl transition-transform duration-300 group-hover:translate-x-0 group-hover:translate-y-0"></span></a></div><div><a class="social-link flex-center group relative overflow-hidden rounded-xl px-1.5 py-1 transition-all duration-300 group-hover:scale-105" style="--link-color:#55acd5" data-platform="email" href="mailto:xuehualjx@gmail.com" title="Email" data-tooltip-interactive="false" data-tooltip-placement="top" aria-label="Email"><i class="fa-regular fa-envelope social-icon" aria-hidden="true"></i><span class="absolute inset-0 -z-10 -translate-x-full translate-y-full rounded-xl transition-transform duration-300 group-hover:translate-x-0 group-hover:translate-y-0"></span></a></div><div><a class="social-link flex-center group relative overflow-hidden rounded-xl px-1.5 py-1 transition-all duration-300 group-hover:scale-105" style="--link-color:#229ed9" data-platform="telegram" href="https://t.me/litleSnow" title="Telegram" data-tooltip-interactive="false" data-tooltip-placement="top" aria-label="Telegram"><i class="fa-brands fa-telegram social-icon" aria-hidden="true"></i><span class="absolute inset-0 -z-10 -translate-x-full translate-y-full rounded-xl transition-transform duration-300 group-hover:translate-x-0 group-hover:translate-y-0"></span></a></div><div><a class="social-link flex-center group relative overflow-hidden rounded-xl px-1.5 py-1 transition-all duration-300 group-hover:scale-105" style="--link-color:#00a1d6" data-platform="bilibili" href="https://space.bilibili.com/158525031" title="哔哩哔哩" data-tooltip-interactive="false" data-tooltip-placement="top" aria-label="哔哩哔哩"><i class="fa-brands fa-bilibili social-icon" aria-hidden="true"></i><span class="absolute inset-0 -z-10 -translate-x-full translate-y-full rounded-xl transition-transform duration-300 group-hover:translate-x-0 group-hover:translate-y-0"></span></a></div></div><div class="text-muted-foreground mt-3 flex justify-center text-center text-sm/4 whitespace-nowrap select-none dark:text-white/80"><a href="/blog" class="hover:text-blue flex cursor-pointer flex-col gap-2 p-1 transition"><span class="text-lg/5 font-bold">45</span>文章</a><div class="bg-muted-foreground mx-3 w-px"></div><a href="/blog/categories" aria-label="分类" class="hover:text-blue"><p class="flex cursor-pointer flex-col gap-2 p-1 transition"><span class="text-lg/5 font-bold">8</span>分类</p></a><div class="bg-muted-foreground mx-3 w-px"></div><a href="/blog/tags" class="hover:text-blue flex cursor-pointer flex-col gap-2 p-1 transition"><span class="text-lg/5 font-bold">76</span>标签</a></div><div class="mt-6 flex w-full flex-col items-center gap-2.5"><a href="/blog" aria-label="首页" class="inline-flex items-center justify-center whitespace-nowrap ring-offset-background focus-visible:outline-hidden focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-gradient-shoka-button px-4 py-2 shoka-button-shadow h-12 w-40 rounded-xl text-base tracking-wider opacity-75 transition-all duration-300 hover:opacity-100 text-muted-foreground/80 hover:bg-muted-foreground/10 bg-none shadow-none hover:shadow-none"><i class="mr-1.5 fa-solid fa-house-chimney" aria-hidden="true"></i>首页</a><div class="bg-foreground/10 flex w-40 flex-col rounded-xl opacity-75 transition-all duration-300 hover:opacity-100" data-collapsible="true"><button class="flex-center hover:bg-foreground/5 h-12 w-full cursor-pointer rounded-xl transition-colors" aria-expanded="false" aria-controls="_r10R_a_-collapse-1" aria-label="文章菜单" type="button"><i class="mr-1.5 fa-solid fa-pen-nib" aria-hidden="true"></i>文章<i class="fa-solid fa-caret-down ml-2 text-base transition-transform duration-300" aria-hidden="true"></i></button><div id="_r10R_a_-collapse-1" class="collapse-content collapse-hidden" data-collapse-content="true"><div class="flex flex-col items-center"><a href="/blog/categories" aria-label="分类" class="inline-flex items-center justify-center whitespace-nowrap ring-offset-background transition-colors focus-visible:outline-hidden focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-gradient-shoka-button px-4 py-2 shoka-button-shadow h-12 w-40 rounded-xl text-base tracking-wider text-muted-foreground/80 hover:bg-muted-foreground/10 bg-none shadow-none hover:shadow-none"><i class="mr-1.5 fa-solid fa-layer-group" aria-hidden="true"></i>分类</a><a href="/blog/tags" aria-label="标签" class="inline-flex items-center justify-center whitespace-nowrap ring-offset-background transition-colors focus-visible:outline-hidden focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-gradient-shoka-button px-4 py-2 shoka-button-shadow h-12 w-40 rounded-xl text-base tracking-wider text-muted-foreground/80 hover:bg-muted-foreground/10 bg-none shadow-none hover:shadow-none"><i class="mr-1.5 fa-solid fa-tags" aria-hidden="true"></i>标签</a><a href="/blog/weekly" aria-label="周刊" class="inline-flex items-center justify-center whitespace-nowrap ring-offset-background transition-colors focus-visible:outline-hidden focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-gradient-shoka-button px-4 py-2 shoka-button-shadow h-12 w-40 rounded-xl text-base tracking-wider text-muted-foreground/80 hover:bg-muted-foreground/10 bg-none shadow-none hover:shadow-none"><i class="mr-1.5 fa-regular fa-newspaper" aria-hidden="true"></i>周刊</a></div></div></div><a href="/blog/friends" aria-label="友链" class="inline-flex items-center justify-center whitespace-nowrap ring-offset-background focus-visible:outline-hidden focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-gradient-shoka-button px-4 py-2 shoka-button-shadow h-12 w-40 rounded-xl text-base tracking-wider opacity-75 transition-all duration-300 hover:opacity-100 text-muted-foreground/80 hover:bg-muted-foreground/10 bg-none shadow-none hover:shadow-none"><i class="mr-1.5 fa-solid fa-link" aria-hidden="true"></i>友链</a><a href="/blog/about" aria-label="关于" class="inline-flex items-center justify-center whitespace-nowrap ring-offset-background focus-visible:outline-hidden focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-gradient-shoka-button px-4 py-2 shoka-button-shadow h-12 w-40 rounded-xl text-base tracking-wider opacity-75 transition-all duration-300 hover:opacity-100 text-muted-foreground/80 hover:bg-muted-foreground/10 bg-none shadow-none hover:shadow-none"><i class="mr-1.5 fa-regular fa-circle-user" aria-hidden="true"></i>关于</a></div></div></div><div class="sider-slot hidden" data-slot-type="directory"><nav class="toc-container " aria-label="文章目录"><div class="space-y-1 pr-2"><div class="heading-tree-item relative"><a href="#前言" class="heading-link group hover:bg-foreground/5 relative flex items-center rounded-md py-2 text-sm transition-all duration-200 hover:border-l-2" style="padding-left:0.75rem;padding-right:0.75rem" data-level="2" aria-label="前言"><span class="heading-text block flex-1 truncate leading-relaxed">前言</span></a></div><div class="heading-tree-item relative"><a href="#性能数据对比" class="heading-link group hover:bg-foreground/5 relative flex items-center rounded-md py-2 text-sm transition-all duration-200 hover:border-l-2" style="padding-left:0.75rem;padding-right:0.75rem" data-level="2" aria-label="性能数据对比"><span class="heading-text block flex-1 truncate leading-relaxed">性能数据对比</span></a></div><div class="heading-tree-item relative"><a href="#核心优化策略" class="heading-link group hover:bg-foreground/5 relative flex items-center rounded-md py-2 text-sm transition-all duration-200 hover:border-l-2" style="padding-left:0.75rem;padding-right:0.5rem" data-level="2" aria-label="核心优化策略"><span class="heading-text block flex-1 truncate leading-relaxed">核心优化策略</span></a></div><div class="heading-tree-item relative"><a href="#常见问题" class="heading-link group hover:bg-foreground/5 relative flex items-center rounded-md py-2 text-sm transition-all duration-200 hover:border-l-2" style="padding-left:0.75rem;padding-right:0.5rem" data-level="2" aria-label="常见问题"><span class="heading-text block flex-1 truncate leading-relaxed">常见问题</span></a></div><div class="heading-tree-item relative"><a href="#总结" class="heading-link group hover:bg-foreground/5 relative flex items-center rounded-md py-2 text-sm transition-all duration-200 hover:border-l-2" style="padding-left:0.75rem;padding-right:0.75rem" data-level="2" aria-label="总结"><span class="heading-text block flex-1 truncate leading-relaxed">总结</span></a></div></div></nav></div><div class="sider-slot hidden" data-slot-type="series"><div class="flex flex-col gap-1"><a href="/blog/post/45" class="group relative flex items-start gap-3 rounded-md px-1 py-2 transition-colors hover:bg-accent/50"><span class="mt-2 h-2 w-2 shrink-0 rounded-full transition-colors bg-muted-foreground/40 group-hover:bg-muted-foreground/60"></span><span class="line-clamp-2 flex-1 text-sm leading-relaxed transition-colors text-foreground group-hover:text-primary">在 RK3528 ARM 开发板上部署 OpenClaw + Telegram Bot 全记录</span></a><a href="/blog/post/38" class="group relative flex items-start gap-3 rounded-md px-1 py-2 transition-colors hover:bg-accent/50"><span class="mt-2 h-2 w-2 shrink-0 rounded-full transition-colors bg-muted-foreground/40 group-hover:bg-muted-foreground/60"></span><span class="line-clamp-2 flex-1 text-sm leading-relaxed transition-colors text-foreground group-hover:text-primary">Rust 树结构中 Rc 与 Weak 的配合使用</span></a><a href="/blog/post/37" class="group relative flex items-start gap-3 rounded-md px-1 py-2 transition-colors hover:bg-accent/50"><span class="mt-2 h-2 w-2 shrink-0 rounded-full transition-colors bg-muted-foreground/40 group-hover:bg-muted-foreground/60"></span><span class="line-clamp-2 flex-1 text-sm leading-relaxed transition-colors text-foreground group-hover:text-primary">Rust Cow（Clone-On-Write）学习笔记：理解 Borrowed 状态</span></a><a href="/blog/post/33" class="group relative flex items-start gap-3 rounded-md px-1 py-2 transition-colors hover:bg-accent/50 text-primary font-medium"><span class="mt-2 h-2 w-2 shrink-0 rounded-full transition-colors bg-primary"></span><span class="line-clamp-2 flex-1 text-sm leading-relaxed transition-colors text-primary">Electron 热更新后启动性能优化：V8 缓存与代码拆包实战</span></a><a href="/blog/post/31" class="group relative flex items-start gap-3 rounded-md px-1 py-2 transition-colors hover:bg-accent/50"><span class="mt-2 h-2 w-2 shrink-0 rounded-full transition-colors bg-muted-foreground/40 group-hover:bg-muted-foreground/60"></span><span class="line-clamp-2 flex-1 text-sm leading-relaxed transition-colors text-foreground group-hover:text-primary">配置 Codex 自定义三方API</span></a><a href="/blog/post/30" class="group relative flex items-start gap-3 rounded-md px-1 py-2 transition-colors hover:bg-accent/50"><span class="mt-2 h-2 w-2 shrink-0 rounded-full transition-colors bg-muted-foreground/40 group-hover:bg-muted-foreground/60"></span><span class="line-clamp-2 flex-1 text-sm leading-relaxed transition-colors text-foreground group-hover:text-primary">React Effect 依赖优化最佳实践</span></a><a href="/blog/post/28" class="group relative flex items-start gap-3 rounded-md px-1 py-2 transition-colors hover:bg-accent/50"><span class="mt-2 h-2 w-2 shrink-0 rounded-full transition-colors bg-muted-foreground/40 group-hover:bg-muted-foreground/60"></span><span class="line-clamp-2 flex-1 text-sm leading-relaxed transition-colors text-foreground group-hover:text-primary">Hexo博客GitHub Actions自动部署配置</span></a><a href="/blog/post/27" class="group relative flex items-start gap-3 rounded-md px-1 py-2 transition-colors hover:bg-accent/50"><span class="mt-2 h-2 w-2 shrink-0 rounded-full transition-colors bg-muted-foreground/40 group-hover:bg-muted-foreground/60"></span><span class="line-clamp-2 flex-1 text-sm leading-relaxed transition-colors text-foreground group-hover:text-primary">NestJs关于循环依赖</span></a><a href="/blog/post/26" class="group relative flex items-start gap-3 rounded-md px-1 py-2 transition-colors hover:bg-accent/50"><span class="mt-2 h-2 w-2 shrink-0 rounded-full transition-colors bg-muted-foreground/40 group-hover:bg-muted-foreground/60"></span><span class="line-clamp-2 flex-1 text-sm leading-relaxed transition-colors text-foreground group-hover:text-primary">关于Vue3如何判断父组件给子组件传了插槽</span></a><a href="/blog/post/25" class="group relative flex items-start gap-3 rounded-md px-1 py-2 transition-colors hover:bg-accent/50"><span class="mt-2 h-2 w-2 shrink-0 rounded-full transition-colors bg-muted-foreground/40 group-hover:bg-muted-foreground/60"></span><span class="line-clamp-2 flex-1 text-sm leading-relaxed transition-colors text-foreground group-hover:text-primary">element-plus表格隐藏行数功能</span></a><a href="/blog/post/23" class="group relative flex items-start gap-3 rounded-md px-1 py-2 transition-colors hover:bg-accent/50"><span class="mt-2 h-2 w-2 shrink-0 rounded-full transition-colors bg-muted-foreground/40 group-hover:bg-muted-foreground/60"></span><span class="line-clamp-2 flex-1 text-sm leading-relaxed transition-colors text-foreground group-hover:text-primary">前端链表运用场景</span></a><a href="/blog/post/22" class="group relative flex items-start gap-3 rounded-md px-1 py-2 transition-colors hover:bg-accent/50"><span class="mt-2 h-2 w-2 shrink-0 rounded-full transition-colors bg-muted-foreground/40 group-hover:bg-muted-foreground/60"></span><span class="line-clamp-2 flex-1 text-sm leading-relaxed transition-colors text-foreground group-hover:text-primary">关于前端数据库indexDB</span></a><a href="/blog/post/21" class="group relative flex items-start gap-3 rounded-md px-1 py-2 transition-colors hover:bg-accent/50"><span class="mt-2 h-2 w-2 shrink-0 rounded-full transition-colors bg-muted-foreground/40 group-hover:bg-muted-foreground/60"></span><span class="line-clamp-2 flex-1 text-sm leading-relaxed transition-colors text-foreground group-hover:text-primary">表格拖拽方法手写</span></a><a href="/blog/post/20" class="group relative flex items-start gap-3 rounded-md px-1 py-2 transition-colors hover:bg-accent/50"><span class="mt-2 h-2 w-2 shrink-0 rounded-full transition-colors bg-muted-foreground/40 group-hover:bg-muted-foreground/60"></span><span class="line-clamp-2 flex-1 text-sm leading-relaxed transition-colors text-foreground group-hover:text-primary">js循环依赖对象深拷贝</span></a><a href="/blog/post/19" class="group relative flex items-start gap-3 rounded-md px-1 py-2 transition-colors hover:bg-accent/50"><span class="mt-2 h-2 w-2 shrink-0 rounded-full transition-colors bg-muted-foreground/40 group-hover:bg-muted-foreground/60"></span><span class="line-clamp-2 flex-1 text-sm leading-relaxed transition-colors text-foreground group-hover:text-primary">JS对象数组深拷贝</span></a><a href="/blog/post/18" class="group relative flex items-start gap-3 rounded-md px-1 py-2 transition-colors hover:bg-accent/50"><span class="mt-2 h-2 w-2 shrink-0 rounded-full transition-colors bg-muted-foreground/40 group-hover:bg-muted-foreground/60"></span><span class="line-clamp-2 flex-1 text-sm leading-relaxed transition-colors text-foreground group-hover:text-primary">CenOS-7.6搭建pptp服务</span></a><a href="/blog/post/17" class="group relative flex items-start gap-3 rounded-md px-1 py-2 transition-colors hover:bg-accent/50"><span class="mt-2 h-2 w-2 shrink-0 rounded-full transition-colors bg-muted-foreground/40 group-hover:bg-muted-foreground/60"></span><span class="line-clamp-2 flex-1 text-sm leading-relaxed transition-colors text-foreground group-hover:text-primary">不到半个月就要变猫了</span></a><a href="/blog/post/16" class="group relative flex items-start gap-3 rounded-md px-1 py-2 transition-colors hover:bg-accent/50"><span class="mt-2 h-2 w-2 shrink-0 rounded-full transition-colors bg-muted-foreground/40 group-hover:bg-muted-foreground/60"></span><span class="line-clamp-2 flex-1 text-sm leading-relaxed transition-colors text-foreground group-hover:text-primary">不知道怎么过年</span></a></div></div></div><div class="border-border mt-4 flex flex-col gap-3 border-t pt-4 md:mt-0 md:pt-2 w-full px-2"><div class="flex items-center justify-between gap-2"><a href="/blog/post/37" class="group flex items-center gap-1.5 rounded-md px-2 py-1.5 transition-colors hover:bg-accent text-muted-foreground hover:text-primary max-w-[45%] min-w-0 flex-1" title="Rust Cow（Clone-On-Write）学习笔记：理解 Borrowed 状态"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" class="h-4 w-4 shrink-0" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M10.8284 12.0007L15.7782 16.9504L14.364 18.3646L8 12.0007L14.364 5.63672L15.7782 7.05093L10.8284 12.0007Z"></path></svg><span class="truncate text-xs">Rust Cow（Clone-On-Write）学习笔记：理解 Borrowed 状态</span></a><a href="/blog/post/31" class="group flex items-center gap-1.5 rounded-md px-2 py-1.5 transition-colors hover:bg-accent text-muted-foreground hover:text-primary max-w-[45%] min-w-0 flex-1 justify-end text-right" title="配置 Codex 自定义三方API"><span class="truncate text-xs">配置 Codex 自定义三方API</span><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" class="h-4 w-4 shrink-0" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M13.1717 12.0007L8.22192 7.05093L9.63614 5.63672L16.0001 12.0007L9.63614 18.3646L8.22192 16.9504L13.1717 12.0007Z"></path></svg></a></div><div class="flex justify-center gap-2"><button class="flex items-center justify-center gap-1.5 rounded-md px-3 py-1.5 transition-colors hover:bg-accent text-muted-foreground hover:text-primary text-xs" title="回到顶部" aria-label="回到顶部"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" class="h-4 w-4" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M11.9999 10.8284L7.0502 15.7782L5.63599 14.364L11.9999 8L18.3639 14.364L16.9497 15.7782L11.9999 10.8284Z"></path></svg>回到顶部</button><button class="flex items-center justify-center gap-1.5 rounded-md px-3 py-1.5 transition-colors hover:bg-accent text-muted-foreground hover:text-primary text-xs" title="滚到底部" aria-label="滚到底部"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" class="h-4 w-4" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M11.9999 13.1714L16.9497 8.22168L18.3639 9.63589L11.9999 15.9999L5.63599 9.63589L7.0502 8.22168L11.9999 13.1714Z"></path></svg>滚到底部</button></div></div><div class="mt-auto w-full rounded-full pt-4 sticky bottom-0"><div class="bg-primary h-1 origin-left rounded-full scale-x-0"></div></div><!--astro:end--></astro-island> </div> <div class="flex min-w-0 grow flex-col gap-8 md:w-full">     <div class="shadow-box bg-gradient-start flex flex-col gap-2 px-10 py-8 tablet:px-6 tablet:pt-6 tablet:pb-2"> <!-- Breadcrumb Navigation --> <nav class="text-muted-foreground flex items-center gap-2 text-sm"> <div class="flex items-center gap-1"> <!-- Home Icon and Link --> <i class="fa-solid fa-house-chimney text-sm" aria-hidden="true"></i> <a href="/blog" aria-label="返回首页"> <span class="hover:text-blue transition-colors duration-300">首页</span> </a> </div> <!-- Category Breadcrumbs -->  <i class="fa-solid fa-angle-right text-muted-foreground/60 text-sm" aria-hidden="true"></i> <a href="/blog/categories/tech-tutorials" class="hover:text-blue transition-colors duration-300 text-primary bg-primary/10 hover:text-primary hover:bg-primary/20 rounded-full px-2.5 py-1" aria-label="前往技术教程分类"> 技术教程 </a>  </nav> <astro-island uid="OkDkT" prefix="r3" component-url="/_astro/SummaryPanel.B0wcA6xC.js" component-export="SummaryPanel" renderer-url="/_astro/client.lBR8ML2S.js" props="{&quot;summary&quot;:[0,&quot;深入实战 Electron 应用性能优化，通过启用 V8 代码缓存、Vite 模块拆包、按需导入和延迟加载等手段，将主进程启动时间从 1619ms 优化到 311ms，性能提升 80%。详解 V8 JIT 编译原理、manualChunks 拆包策略及实际优化效果对比。&quot;],&quot;source&quot;:[0,&quot;description&quot;],&quot;className&quot;:[0,&quot;mt-2&quot;]}" ssr client="visible" opts="{&quot;name&quot;:&quot;SummaryPanel&quot;,&quot;value&quot;:true}" await-children><div class="overflow-hidden rounded-lg mt-2"><button class="bg-foreground/5 flex w-full cursor-pointer items-center justify-between px-4 py-3 transition-all duration-250 hover:bg-foreground/10 rounded-lg" aria-expanded="false" aria-controls="summary-panel-content"><div class="text-muted-foreground flex items-center gap-1.5 text-sm font-medium"><span class="transition-transform duration-300"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" class="text-primary size-4" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M21 18H6C5.44772 18 5 18.4477 5 19C5 19.5523 5.44772 20 6 20H21V22H6C4.34315 22 3 20.6569 3 19V4C3 2.89543 3.89543 2 5 2H21V18ZM16 9V7H8V9H16Z"></path></svg></span>人工摘要</div><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="text-muted-foreground size-4 transition-transform duration-300" aria-hidden="true"><path d="M12 16L6 10H18L12 16Z"></path></svg></button><div id="summary-panel-content" class="grid transition-[grid-template-rows] duration-300 ease-out" style="grid-template-rows:0fr"><div class="overflow-hidden"><div class="bg-foreground/5 text-muted-foreground rounded-b-lg px-4 py-4 text-sm leading-relaxed"><span class="sr-only">深入实战 Electron 应用性能优化，通过启用 V8 代码缓存、Vite 模块拆包、按需导入和延迟加载等手段，将主进程启动时间从 1619ms 优化到 311ms，性能提升 80%。详解 V8 JIT 编译原理、manualChunks 拆包策略及实际优化效果对比。</span><p aria-hidden="true"><span></span></p></div></div></div></div><!--astro:end--></astro-island> <article class="prose md:prose-sm dark:prose-invert"> <div class="custom-content"> <h2 id="前言">前言<a class="anchor-link" href="#前言"><span class="icon icon-link"></span></a></h2>
<p>在 Electron 应用开发中，热更新后的首次启动速度直接影响用户体验。将主进程启动时间从 1619ms 优化到 311ms 的完整实践过程。</p>
<h2 id="性能数据对比">性能数据对比<a class="anchor-link" href="#性能数据对比"><span class="icon icon-link"></span></a></h2>
<p>通过以下优化手段，我们实现了显著的性能提升：</p>



































<table><thead><tr><th>指标</th><th>优化前</th><th>优化后</th><th>提升幅度</th></tr></thead><tbody><tr><td><strong>主进程启动总耗时</strong></td><td>1619.32ms</td><td>311.88ms</td><td><strong>80.7% ↓</strong></td></tr><tr><td><strong>app.whenReady 耗时</strong></td><td>833.46ms</td><td>126.61ms</td><td><strong>84.8% ↓</strong></td></tr><tr><td><strong>窗口创建耗时</strong></td><td>536.34ms</td><td>140.59ms</td><td><strong>73.8% ↓</strong></td></tr><tr><td><strong>V8 缓存文件数量</strong></td><td>9543 个</td><td>9043 个</td><td>优化后稳定</td></tr></tbody></table>
<p>从实际日志数据来看：</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="log"><code><span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8"># 优化前（</span><span style="color:#6A737D;--shiki-dark:#6A737D">2025-11-18</span><span style="color:#6A737D;--shiki-dark:#6A737D"> 16:37:59</span><span style="color:#24292E;--shiki-dark:#E1E4E8">）</span></span>
<span class="line"><span style="color:#22863A;--shiki-dark:#85E89D">[info]</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> ⏱️ 主进程启动开始</span></span>
<span class="line"><span style="color:#22863A;--shiki-dark:#85E89D">[info]</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> ⏱️ </span><span style="color:#005CC5;--shiki-dark:#79B8FF">app.whenReady</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> 触发，耗时: </span><span style="color:#005CC5;--shiki-dark:#79B8FF">833</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.46ms</span></span>
<span class="line"><span style="color:#22863A;--shiki-dark:#85E89D">[info]</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> 📦 V8 代码缓存文件数量: </span><span style="color:#005CC5;--shiki-dark:#79B8FF">9543</span></span>
<span class="line"><span style="color:#22863A;--shiki-dark:#85E89D">[info]</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> ⏱️ 窗口创建耗时: </span><span style="color:#005CC5;--shiki-dark:#79B8FF">536</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.34ms</span></span>
<span class="line"><span style="color:#22863A;--shiki-dark:#85E89D">[info]</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> ⏱️ ✅ 主进程启动完成，总耗时: </span><span style="color:#005CC5;--shiki-dark:#79B8FF">1619</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.32ms</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8"># 优化后（</span><span style="color:#6A737D;--shiki-dark:#6A737D">2025-11-18</span><span style="color:#6A737D;--shiki-dark:#6A737D"> 17:10:30</span><span style="color:#24292E;--shiki-dark:#E1E4E8">）</span></span>
<span class="line"><span style="color:#22863A;--shiki-dark:#85E89D">[info]</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> ⏱️ 主进程启动开始</span></span>
<span class="line"><span style="color:#22863A;--shiki-dark:#85E89D">[info]</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> ⏱️ </span><span style="color:#005CC5;--shiki-dark:#79B8FF">app.whenReady</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> 触发，耗时: </span><span style="color:#005CC5;--shiki-dark:#79B8FF">126</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.61ms</span></span>
<span class="line"><span style="color:#22863A;--shiki-dark:#85E89D">[info]</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> 📦 V8 代码缓存文件数量: </span><span style="color:#005CC5;--shiki-dark:#79B8FF">9043</span></span>
<span class="line"><span style="color:#22863A;--shiki-dark:#85E89D">[info]</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> ⏱️ 窗口创建耗时: </span><span style="color:#005CC5;--shiki-dark:#79B8FF">140</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.59ms</span></span>
<span class="line"><span style="color:#22863A;--shiki-dark:#85E89D">[info]</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> ⏱️ ✅ 主进程启动完成，总耗时: </span><span style="color:#005CC5;--shiki-dark:#79B8FF">311</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.88ms</span></span></code></pre>
<h2 id="核心优化策略">核心优化策略<a class="anchor-link" href="#核心优化策略"><span class="icon icon-link"></span></a></h2>
<h3 id="1-启用-v8-代码缓存">1. 启用 V8 代码缓存<a class="anchor-link" href="#1-启用-v8-代码缓存"><span class="icon icon-link"></span></a></h3>
<p>V8 代码缓存（Code Cache）是 Chrome 和 Node.js 中用于加速 JavaScript 代码执行的重要机制。通过缓存编译后的字节码，可以避免重复的解析和编译过程。</p>
<h4 id="实现方式">实现方式<a class="anchor-link" href="#实现方式"><span class="icon icon-link"></span></a></h4>
<p>在 Electron 主进程启动时添加命令行开关：</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="typescript"><code><span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">// src/main/index.ts</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">// 启用 V8 代码缓存优化，加速冷启动</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">app.commandLine.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">appendSwitch</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'enable-features'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#032F62;--shiki-dark:#9ECBFF">'V8CodeCache'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">app.commandLine.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">appendSwitch</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'v8-cache-options'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#032F62;--shiki-dark:#9ECBFF">'code'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">);</span></span></code></pre>
<h4 id="验证缓存效果">验证缓存效果<a class="anchor-link" href="#验证缓存效果"><span class="icon icon-link"></span></a></h4>
<p>在 <code>app.whenReady()</code> 中添加监控代码：</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="typescript"><code><span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">app.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">whenReady</span><span style="color:#24292E;--shiki-dark:#E1E4E8">().</span><span style="color:#6F42C1;--shiki-dark:#B392F0">then</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#D73A49;--shiki-dark:#F97583">async</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> () </span><span style="color:#D73A49;--shiki-dark:#F97583">=></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> readyTime</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> performance.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">now</span><span style="color:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  log.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">info</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span></span>
<span class="line"><span style="color:#032F62;--shiki-dark:#9ECBFF">    `⏱️ app.whenReady 触发，耗时: ${</span><span style="color:#032F62;--shiki-dark:#9ECBFF">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">readyTime</span><span style="color:#D73A49;--shiki-dark:#F97583"> -</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> startupTime</span><span style="color:#032F62;--shiki-dark:#9ECBFF">).</span><span style="color:#6F42C1;--shiki-dark:#B392F0">toFixed</span><span style="color:#032F62;--shiki-dark:#9ECBFF">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">2</span><span style="color:#032F62;--shiki-dark:#9ECBFF">)</span><span style="color:#032F62;--shiki-dark:#9ECBFF">}ms`</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  );</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">  // 验证 V8 代码缓存</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> cacheDir</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> join</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(app.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">getPath</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'userData'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">), </span><span style="color:#032F62;--shiki-dark:#9ECBFF">'Code Cache'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#032F62;--shiki-dark:#9ECBFF">'js'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  try</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> fs</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#D73A49;--shiki-dark:#F97583"> await</span><span style="color:#D73A49;--shiki-dark:#F97583"> import</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'fs'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    if</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (fs.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">existsSync</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(cacheDir)) {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">      const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> cacheFiles</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> fs.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">readdirSync</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(cacheDir);</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">      log.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">info</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">`📦 V8 代码缓存文件数量: ${</span><span style="color:#24292E;--shiki-dark:#E1E4E8">cacheFiles</span><span style="color:#032F62;--shiki-dark:#9ECBFF">.</span><span style="color:#005CC5;--shiki-dark:#79B8FF">length</span><span style="color:#032F62;--shiki-dark:#9ECBFF">}`</span><span style="color:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    } </span><span style="color:#D73A49;--shiki-dark:#F97583">else</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">      log.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">info</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'📦 V8 代码缓存目录不存在（首次启动会自动创建）'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  } </span><span style="color:#D73A49;--shiki-dark:#F97583">catch</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (error) {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    log.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">warn</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'无法检查 V8 缓存目录:'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, error);</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">});</span></span></code></pre>
<h4 id="工作原理">工作原理<a class="anchor-link" href="#工作原理"><span class="icon icon-link"></span></a></h4>
<p>V8 引擎在执行 JavaScript 时的流程：</p>
<ol>
<li><strong>解析（Parsing）</strong>：将源代码转换为抽象语法树（AST）</li>
<li><strong>编译（Compilation）</strong>：将 AST 编译为字节码</li>
<li><strong>执行（Execution）</strong>：V8 解释器执行字节码</li>
</ol>
<p>启用代码缓存后：</p>
<ul>
<li><strong>首次运行</strong>：V8 生成字节码并缓存到磁盘</li>
<li><strong>后续运行</strong>：直接加载缓存的字节码，跳过解析和编译阶段</li>
</ul>
<h3 id="2-模块拆包code-splitting-核心优化">2. 模块拆包（Code Splitting）—— 核心优化<a class="anchor-link" href="#2-模块拆包code-splitting-核心优化"><span class="icon icon-link"></span></a></h3>
<p>这是本次优化中最关键的一步。<strong>通过 Vite 配置将单一的 <code>main.js</code> 拆分为多个独立的 <code>utils/*.js</code> 文件，显著降低 V8 的 JIT 编译压力。</strong></p>
<h4 id="问题背景为什么需要拆包">问题背景：为什么需要拆包？<a class="anchor-link" href="#问题背景为什么需要拆包"><span class="icon icon-link"></span></a></h4>
<p>在优化前，项目使用 <code>src/main/utils/index.ts</code> 统一导出所有工具函数：</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="typescript"><code><span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">// src/main/utils/index.ts（优化前）</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">export</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> *</span><span style="color:#D73A49;--shiki-dark:#F97583"> from</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> './aesEncode'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">export</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> *</span><span style="color:#D73A49;--shiki-dark:#F97583"> from</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> './notifi'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">export</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> *</span><span style="color:#D73A49;--shiki-dark:#F97583"> from</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> './tray'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">export</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> *</span><span style="color:#D73A49;--shiki-dark:#F97583"> from</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> './latex2Docx'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">export</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> *</span><span style="color:#D73A49;--shiki-dark:#F97583"> from</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> './pathUtils'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">// ... 导出几十个工具模块</span></span></code></pre>
<p>Vite 打包后，所有工具代码会被 Tree Shaking 和 Rollup 合并到<strong>单一的 <code>main.js</code> 文件</strong>中。这会导致：</p>
<ol>
<li><strong>巨型 JS 文件</strong>：main.js 可能超过几 MB，包含所有工具函数代码</li>
<li><strong>JIT 热点集中</strong>：V8 引擎在启动时需要：
<ul>
<li>解析整个大文件的 AST（抽象语法树）</li>
<li>为所有函数生成字节码</li>
<li>识别热点函数并进行 JIT 优化编译</li>
</ul>
</li>
<li><strong>缓存粒度粗</strong>：任何一个工具函数的修改都会导致整个 main.js 的 V8 缓存失效</li>
</ol>
<h4 id="vite-配置方案">Vite 配置方案<a class="anchor-link" href="#vite-配置方案"><span class="icon icon-link"></span></a></h4>
<p>通过 <code>manualChunks</code> 配置，我们将每个 utils 模块拆分为独立的 chunk：</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="typescript"><code><span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">// src/main/vite.config.ts</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">export</span><span style="color:#D73A49;--shiki-dark:#F97583"> default</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> defineConfig</span><span style="color:#24292E;--shiki-dark:#E1E4E8">({</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  build: {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    rollupOptions: {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">      external: [</span></span>
<span class="line"><span style="color:#032F62;--shiki-dark:#9ECBFF">        'electron'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#032F62;--shiki-dark:#9ECBFF">        'node-screenshots'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        ...</span><span style="color:#24292E;--shiki-dark:#E1E4E8">builtinModules,</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        ...</span><span style="color:#24292E;--shiki-dark:#E1E4E8">Object.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">keys</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(pkg.dependencies </span><span style="color:#D73A49;--shiki-dark:#F97583">||</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {}),</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        ...</span><span style="color:#24292E;--shiki-dark:#E1E4E8">Object.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">keys</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(pkg.devDependencies </span><span style="color:#D73A49;--shiki-dark:#F97583">||</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {}),</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">      ],</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">      output: {</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">        // 🔥 关键配置：将 utils 模块拆分为独立 chunk</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">        manualChunks</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#E36209;--shiki-dark:#FFAB70">id</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">          // 为每个 utils 模块创建独立的 chunk</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">          if</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (id.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">includes</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'src/main/utils/'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x26;&#x26;</span><span style="color:#D73A49;--shiki-dark:#F97583"> !</span><span style="color:#24292E;--shiki-dark:#E1E4E8">id.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">includes</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'index.ts'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">)) {</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">            // 提取模块名称</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">            // 例如：src/main/utils/aesEncode.ts -> utils/aesEncode</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">            const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> match</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> id.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">match</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">/</span><span style="color:#032F62;--shiki-dark:#DBEDFF">utils</span><span style="color:#22863A;--shiki-light-font-weight:bold;--shiki-dark:#85E89D;--shiki-dark-font-weight:bold">\/</span><span style="color:#032F62;--shiki-dark:#DBEDFF">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">[</span><span style="color:#D73A49;--shiki-dark:#F97583">^</span><span style="color:#005CC5;--shiki-dark:#79B8FF">/]</span><span style="color:#D73A49;--shiki-dark:#F97583">+</span><span style="color:#032F62;--shiki-dark:#DBEDFF">)</span><span style="color:#22863A;--shiki-light-font-weight:bold;--shiki-dark:#85E89D;--shiki-dark-font-weight:bold">\.</span><span style="color:#032F62;--shiki-dark:#DBEDFF">(ts</span><span style="color:#D73A49;--shiki-dark:#F97583">|</span><span style="color:#032F62;--shiki-dark:#DBEDFF">js)</span><span style="color:#032F62;--shiki-dark:#9ECBFF">/</span><span style="color:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">            if</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (match) {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">              return</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> `utils/${</span><span style="color:#24292E;--shiki-dark:#E1E4E8">match</span><span style="color:#032F62;--shiki-dark:#9ECBFF">[</span><span style="color:#005CC5;--shiki-dark:#79B8FF">1</span><span style="color:#032F62;--shiki-dark:#9ECBFF">]</span><span style="color:#032F62;--shiki-dark:#9ECBFF">}`</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">            }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">          }</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">          return</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> undefined</span><span style="color:#24292E;--shiki-dark:#E1E4E8">; </span><span style="color:#6A737D;--shiki-dark:#6A737D">// 其他模块使用默认分包策略</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        },</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">      },</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    },</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  },</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">});</span></span></code></pre>
<h4 id="拆包效果对比">拆包效果对比<a class="anchor-link" href="#拆包效果对比"><span class="icon icon-link"></span></a></h4>
<p><strong>优化前的打包结构：</strong></p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>dist/main/</span></span>
<span class="line"><span>├── main.js          ← 单一巨型文件（包含所有代码）</span></span>
<span class="line"><span>└── main.js.map</span></span></code></pre>
<p><strong>优化后的打包结构：</strong></p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>dist/main/</span></span>
<span class="line"><span>├── main.js                    ← 主入口文件（精简）</span></span>
<span class="line"><span>├── utils/</span></span>
<span class="line"><span>│   ├── aesEncode.js          ← 独立工具模块</span></span>
<span class="line"><span>│   ├── notifi.js</span></span>
<span class="line"><span>│   ├── tray.js</span></span>
<span class="line"><span>│   ├── latex2Docx.js</span></span>
<span class="line"><span>│   ├── pathUtils.js</span></span>
<span class="line"><span>│   ├── renderLocalStrongHandle.js</span></span>
<span class="line"><span>│   ├── rustScreenshotWindow.js</span></span>
<span class="line"><span>│   ├── updateRender.js</span></span>
<span class="line"><span>│   └── ... 其他工具模块</span></span>
<span class="line"><span>└── *.js.map</span></span></code></pre>
<h4 id="拆包如何降低-jit-热点编译压力">拆包如何降低 JIT 热点编译压力？<a class="anchor-link" href="#拆包如何降低-jit-热点编译压力"><span class="icon icon-link"></span></a></h4>
<p><strong>1. 减少单次解析负担</strong></p>
<p>V8 的解析器（Parser）是单线程的，巨型文件会阻塞启动流程：</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>优化前：解析 5MB 的 main.js（耗时 ~800ms）</span></span>
<span class="line"><span>优化后：解析 500KB 的 main.js + 按需加载小模块（耗时 ~120ms）</span></span></code></pre>
<p><strong>2. 按需 JIT 编译</strong></p>
<p>V8 的 JIT 编译器（TurboFan）会识别热点函数并进行优化编译。拆包后：</p>
<ul>
<li><strong>冷启动时</strong>：只有主入口 <code>main.js</code> 中的代码被立即编译</li>
<li><strong>运行时</strong>：当调用 <code>utils/notifi.js</code> 时，才加载并编译该模块</li>
<li><strong>避免过度优化</strong>：非热点代码不会浪费 CPU 时间进行无谓的优化</li>
</ul>
<p><strong>3. 更细粒度的 V8 缓存</strong></p>
<p>从日志可以看到，优化后 V8 缓存文件数量从 9543 个降到 9043 个，但性能反而提升了：</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="log"><code><span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">优化前：📦 V8 代码缓存文件数量: </span><span style="color:#005CC5;--shiki-dark:#79B8FF">9543</span><span style="color:#24292E;--shiki-dark:#E1E4E8">  ← 大量小缓存 + 巨型 </span><span style="color:#005CC5;--shiki-dark:#79B8FF">main.js</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> 缓存</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">优化后：📦 V8 代码缓存文件数量: </span><span style="color:#005CC5;--shiki-dark:#79B8FF">9043</span><span style="color:#24292E;--shiki-dark:#E1E4E8">  ← 精简且高效的缓存结构</span></span></code></pre>
<p>这是因为：</p>
<ul>
<li>每个 utils 模块的缓存是独立的</li>
<li>修改 <code>utils/notifi.js</code> 时，只需重新生成该文件的缓存</li>
<li><code>main.js</code>、<code>utils/tray.js</code> 等其他模块的缓存继续有效</li>
</ul>
<p><strong>4. 降低内存压力</strong></p>
<p>巨型文件会导致更多的内存占用：</p>
<ul>
<li><strong>优化前</strong>：5MB 的 main.js 在解析阶段会生成大量临时 AST 节点对象</li>
<li><strong>优化后</strong>：小文件的 AST 更快被垃圾回收，降低内存峰值</li>
</ul>
<h4 id="实际性能提升">实际性能提升<a class="anchor-link" href="#实际性能提升"><span class="icon icon-link"></span></a></h4>
<p>结合日志数据分析，拆包带来的直接效果：</p>























<table><thead><tr><th>指标</th><th>优化前</th><th>优化后</th><th>说明</th></tr></thead><tbody><tr><td>app.whenReady 耗时</td><td>833.46ms</td><td>126.61ms</td><td><strong>减少 84.8%</strong>，主要归功于拆包减少解析时间</td></tr><tr><td>窗口创建耗时</td><td>536.34ms</td><td>140.59ms</td><td><strong>减少 73.8%</strong>，主流程代码更精简</td></tr></tbody></table>
<h4 id="注意事项">注意事项<a class="anchor-link" href="#注意事项"><span class="icon icon-link"></span></a></h4>
<ol>
<li><strong>不要拆分过细</strong>：每个文件应有一定体积（建议 >10KB），否则模块加载开销会抵消拆包收益</li>
<li><strong>排除 index.ts</strong>：<code>utils/index.ts</code> 只是导出聚合文件，不应单独成为 chunk</li>
<li><strong>外部化原生模块</strong>：如 <code>electron</code> 必须标记为 external，避免打包失败</li>
</ol>
<h4 id="日志中的证据">日志中的证据<a class="anchor-link" href="#日志中的证据"><span class="icon icon-link"></span></a></h4>
<p>对比日志可以看到拆包优化的关键时间点：</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="log"><code><span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8"># 优化前：巨型文件导致启动缓慢</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">[</span><span style="color:#6A737D;--shiki-dark:#6A737D">2025-11-18</span><span style="color:#6A737D;--shiki-dark:#6A737D"> 16:38:00.298</span><span style="color:#24292E;--shiki-dark:#E1E4E8">] ⏱️ </span><span style="color:#005CC5;--shiki-dark:#79B8FF">app.whenReady</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> 触发，耗时: </span><span style="color:#005CC5;--shiki-dark:#79B8FF">833</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.46ms  ← 解析耗时长</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">[</span><span style="color:#6A737D;--shiki-dark:#6A737D">2025-11-18</span><span style="color:#6A737D;--shiki-dark:#6A737D"> 16:38:00.951</span><span style="color:#24292E;--shiki-dark:#E1E4E8">] unzipper模块加载成功                    ← 延迟加载</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8"># 优化后：拆包后模块提前加载，启动迅速</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">[</span><span style="color:#6A737D;--shiki-dark:#6A737D">2025-11-18</span><span style="color:#6A737D;--shiki-dark:#6A737D"> 17:10:30.749</span><span style="color:#24292E;--shiki-dark:#E1E4E8">] unzipper模块加载成功                    ← 立即加载</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">[</span><span style="color:#6A737D;--shiki-dark:#6A737D">2025-11-18</span><span style="color:#6A737D;--shiki-dark:#6A737D"> 17:10:30.810</span><span style="color:#24292E;--shiki-dark:#E1E4E8">] ⏱️ </span><span style="color:#005CC5;--shiki-dark:#79B8FF">app.whenReady</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> 触发，耗时: </span><span style="color:#005CC5;--shiki-dark:#79B8FF">166</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.22ms  ← 解析耗时大幅降低</span></span></code></pre>
<p>拆包后，原本需要延迟加载的模块（如 <code>unzipper</code>）可以更快加载，因为它们不再被打包到巨型 <code>main.js</code> 中。</p>
<p><strong>关键优化：原生模块提前加载</strong></p>
<p>从日志时间戳可以看到一个有趣的现象：</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="log"><code><span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8"># 优化前：原生模块在 </span><span style="color:#005CC5;--shiki-dark:#79B8FF">app.whenReady</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> 之后才加载</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">[</span><span style="color:#6A737D;--shiki-dark:#6A737D">16:37:59.464</span><span style="color:#24292E;--shiki-dark:#E1E4E8">] 主进程启动开始</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">[</span><span style="color:#6A737D;--shiki-dark:#6A737D">16:38:00.298</span><span style="color:#24292E;--shiki-dark:#E1E4E8">] </span><span style="color:#005CC5;--shiki-dark:#79B8FF">app.whenReady</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> 触发，耗时: </span><span style="color:#005CC5;--shiki-dark:#79B8FF">833</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.46ms</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">[</span><span style="color:#6A737D;--shiki-dark:#6A737D">16:38:00.951</span><span style="color:#24292E;--shiki-dark:#E1E4E8">] unzipper模块加载成功                          ← +1470ms（严重延迟）</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8"># 优化后：原生模块立即加载</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">[</span><span style="color:#6A737D;--shiki-dark:#6A737D">17:10:30.776</span><span style="color:#24292E;--shiki-dark:#E1E4E8">] 主进程启动开始</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">[</span><span style="color:#6A737D;--shiki-dark:#6A737D">17:10:30.851</span><span style="color:#24292E;--shiki-dark:#E1E4E8">] unzipper模块加载成功                          ← +75ms（几乎同时）</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">[</span><span style="color:#6A737D;--shiki-dark:#6A737D">17:10:30.903</span><span style="color:#24292E;--shiki-dark:#E1E4E8">] </span><span style="color:#005CC5;--shiki-dark:#79B8FF">app.whenReady</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> 触发，耗时: </span><span style="color:#005CC5;--shiki-dark:#79B8FF">126</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.61ms</span></span></code></pre>
<p><strong>为什么会这样？</strong></p>
<p>这是因为优化前 <code>unzipper</code> 模块被打包到 <code>main.js</code> 的深层依赖中，只有在整个巨型文件解析完成后才能执行它们的初始化代码。拆包后：</p>
<ol>
<li>这些模块成为独立的 chunk</li>
<li>ESM 的并行加载机制可以更早地加载它们</li>
<li>不再被 main.js 的解析阻塞</li>
</ol>
<p>这进一步验证了<strong>拆包对启动流程的巨大优化作用</strong>。</p>
<h3 id="3-按需导入依赖tree-shaking">3. 按需导入依赖（Tree Shaking）<a class="anchor-link" href="#3-按需导入依赖tree-shaking"><span class="icon icon-link"></span></a></h3>
<p>大型库的全量导入会引入大量未使用的代码，增加启动开销。</p>
<h4 id="优化前">优化前<a class="anchor-link" href="#优化前"><span class="icon icon-link"></span></a></h4>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="typescript"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">import</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> *</span><span style="color:#D73A49;--shiki-dark:#F97583"> as</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> lodash </span><span style="color:#D73A49;--shiki-dark:#F97583">from</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> 'lodash-es'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">// 使用时</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">win.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">on</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span></span>
<span class="line"><span style="color:#032F62;--shiki-dark:#9ECBFF">  'moved'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  lodash.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">throttle</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(() </span><span style="color:#D73A49;--shiki-dark:#F97583">=></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">    /* ... */</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  }, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">500</span><span style="color:#24292E;--shiki-dark:#E1E4E8">),</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">);</span></span></code></pre>
<h4 id="优化后">优化后<a class="anchor-link" href="#优化后"><span class="icon icon-link"></span></a></h4>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="typescript"><code><span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">// 只导入需要的函数</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">import</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> { throttle, debounce } </span><span style="color:#D73A49;--shiki-dark:#F97583">from</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> 'lodash-es'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">win.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">on</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span></span>
<span class="line"><span style="color:#032F62;--shiki-dark:#9ECBFF">  'moved'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  throttle</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(() </span><span style="color:#D73A49;--shiki-dark:#F97583">=></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">    /* ... */</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  }, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">500</span><span style="color:#24292E;--shiki-dark:#E1E4E8">),</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">);</span></span></code></pre>
<h4 id="效果分析">效果分析<a class="anchor-link" href="#效果分析"><span class="icon icon-link"></span></a></h4>
<ul>
<li>减少 bundle 体积</li>
<li>降低 V8 解析负担</li>
<li>提升 Tree Shaking 效率</li>
</ul>
<h3 id="4-延迟加载非关键模块">4. 延迟加载非关键模块<a class="anchor-link" href="#4-延迟加载非关键模块"><span class="icon icon-link"></span></a></h3>
<p>将非启动必需的功能（如划词翻译）延迟到主窗口创建完成后再初始化。</p>
<h4 id="实现方案">实现方案<a class="anchor-link" href="#实现方案"><span class="icon icon-link"></span></a></h4>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="typescript"><code><span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">// 优化前：同步导入，阻塞启动</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">import</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> './utils/selectionWord/ipcListener'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">import</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  cleanupTranslation,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  initTranslationShortcut,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">} </span><span style="color:#D73A49;--shiki-dark:#F97583">from</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> './utils/selectionWord/init'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">app.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">whenReady</span><span style="color:#24292E;--shiki-dark:#E1E4E8">().</span><span style="color:#6F42C1;--shiki-dark:#B392F0">then</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#D73A49;--shiki-dark:#F97583">async</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> () </span><span style="color:#D73A49;--shiki-dark:#F97583">=></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">  // ...创建主窗口</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  mainWin </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#D73A49;--shiki-dark:#F97583"> await</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> createWindow</span><span style="color:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  initTranslationShortcut</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(); </span><span style="color:#6A737D;--shiki-dark:#6A737D">// 阻塞启动流程</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">});</span></span></code></pre>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="typescript"><code><span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">// 优化后：异步动态导入，不阻塞启动</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">app.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">whenReady</span><span style="color:#24292E;--shiki-dark:#E1E4E8">().</span><span style="color:#6F42C1;--shiki-dark:#B392F0">then</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#D73A49;--shiki-dark:#F97583">async</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> () </span><span style="color:#D73A49;--shiki-dark:#F97583">=></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">  // ...创建主窗口</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  mainWin </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#D73A49;--shiki-dark:#F97583"> await</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> createWindow</span><span style="color:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">  // 延迟初始化划词翻译，避免阻塞主窗口启动</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  setImmediate</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#D73A49;--shiki-dark:#F97583">async</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> () </span><span style="color:#D73A49;--shiki-dark:#F97583">=></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> translationStart</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> performance.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">now</span><span style="color:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    try</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">      // 动态导入模块</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">      await</span><span style="color:#D73A49;--shiki-dark:#F97583"> import</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'./utils/selectionWord/ipcListener'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">      const</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> { </span><span style="color:#005CC5;--shiki-dark:#79B8FF">initTranslationShortcut</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> } </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        await</span><span style="color:#D73A49;--shiki-dark:#F97583"> import</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'./utils/selectionWord/init'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">      initTranslationShortcut</span><span style="color:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">      const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> translationEnd</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> performance.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">now</span><span style="color:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">      log.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">info</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span></span>
<span class="line"><span style="color:#032F62;--shiki-dark:#9ECBFF">        `⏱️ 划词翻译功能已初始化，耗时: ${</span><span style="color:#032F62;--shiki-dark:#9ECBFF">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">translationEnd</span><span style="color:#D73A49;--shiki-dark:#F97583"> -</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> translationStart</span><span style="color:#032F62;--shiki-dark:#9ECBFF">).</span><span style="color:#6F42C1;--shiki-dark:#B392F0">toFixed</span><span style="color:#032F62;--shiki-dark:#9ECBFF">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">2</span><span style="color:#032F62;--shiki-dark:#9ECBFF">)</span><span style="color:#032F62;--shiki-dark:#9ECBFF">}ms`</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">      );</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    } </span><span style="color:#D73A49;--shiki-dark:#F97583">catch</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (error) {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">      log.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">error</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'初始化划词翻译失败:'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, error);</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> totalTime</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> performance.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">now</span><span style="color:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  log.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">info</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span></span>
<span class="line"><span style="color:#032F62;--shiki-dark:#9ECBFF">    `⏱️ ✅ 主进程启动完成，总耗时: ${</span><span style="color:#032F62;--shiki-dark:#9ECBFF">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">totalTime</span><span style="color:#D73A49;--shiki-dark:#F97583"> -</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> startupTime</span><span style="color:#032F62;--shiki-dark:#9ECBFF">).</span><span style="color:#6F42C1;--shiki-dark:#B392F0">toFixed</span><span style="color:#032F62;--shiki-dark:#9ECBFF">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">2</span><span style="color:#032F62;--shiki-dark:#9ECBFF">)</span><span style="color:#032F62;--shiki-dark:#9ECBFF">}ms`</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  );</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">});</span></span></code></pre>
<h4 id="关键技术点">关键技术点<a class="anchor-link" href="#关键技术点"><span class="icon icon-link"></span></a></h4>
<ol>
<li><strong>使用 <code>setImmediate</code></strong>：确保主窗口完全初始化后再加载</li>
<li><strong>动态 <code>import()</code></strong>：按需加载模块，不影响主流程</li>
<li><strong>错误隔离</strong>：避免非核心功能的失败影响主程序</li>
</ol>
<p>日志输出显示划词翻译初始化耗时约 70-123ms，通过延迟加载完全不影响主窗口启动：</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="log"><code><span class="line"><span style="color:#22863A;--shiki-dark:#85E89D">[info]</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> ⏱️ ✅ 主进程启动完成，总耗时: </span><span style="color:#005CC5;--shiki-dark:#79B8FF">311</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.88ms</span></span>
<span class="line"><span style="color:#22863A;--shiki-dark:#85E89D">[info]</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> ⏱️ 划词翻译功能已初始化，耗时: </span><span style="color:#005CC5;--shiki-dark:#79B8FF">59</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.88ms</span></span></code></pre>
<h3 id="5-性能监控埋点">5. 性能监控埋点<a class="anchor-link" href="#5-性能监控埋点"><span class="icon icon-link"></span></a></h3>
<p>在关键路径添加时间戳记录，便于定位性能瓶颈。</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="typescript"><code><span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">// 启动开始</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> startupTime</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> performance.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">now</span><span style="color:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">log.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">info</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'⏱️ 主进程启动开始'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">// app.whenReady 触发</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">app.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">whenReady</span><span style="color:#24292E;--shiki-dark:#E1E4E8">().</span><span style="color:#6F42C1;--shiki-dark:#B392F0">then</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#D73A49;--shiki-dark:#F97583">async</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> () </span><span style="color:#D73A49;--shiki-dark:#F97583">=></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> readyTime</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> performance.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">now</span><span style="color:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  log.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">info</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span></span>
<span class="line"><span style="color:#032F62;--shiki-dark:#9ECBFF">    `⏱️ app.whenReady 触发，耗时: ${</span><span style="color:#032F62;--shiki-dark:#9ECBFF">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">readyTime</span><span style="color:#D73A49;--shiki-dark:#F97583"> -</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> startupTime</span><span style="color:#032F62;--shiki-dark:#9ECBFF">).</span><span style="color:#6F42C1;--shiki-dark:#B392F0">toFixed</span><span style="color:#032F62;--shiki-dark:#9ECBFF">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">2</span><span style="color:#032F62;--shiki-dark:#9ECBFF">)</span><span style="color:#032F62;--shiki-dark:#9ECBFF">}ms`</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  );</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">  // 窗口创建</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> createWindowStart</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> performance.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">now</span><span style="color:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  mainWin </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#D73A49;--shiki-dark:#F97583"> await</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> createWindow</span><span style="color:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> createWindowEnd</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> performance.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">now</span><span style="color:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  log.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">info</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span></span>
<span class="line"><span style="color:#032F62;--shiki-dark:#9ECBFF">    `⏱️ 窗口创建耗时: ${</span><span style="color:#032F62;--shiki-dark:#9ECBFF">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">createWindowEnd</span><span style="color:#D73A49;--shiki-dark:#F97583"> -</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> createWindowStart</span><span style="color:#032F62;--shiki-dark:#9ECBFF">).</span><span style="color:#6F42C1;--shiki-dark:#B392F0">toFixed</span><span style="color:#032F62;--shiki-dark:#9ECBFF">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">2</span><span style="color:#032F62;--shiki-dark:#9ECBFF">)</span><span style="color:#032F62;--shiki-dark:#9ECBFF">}ms`</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  );</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">  // 总耗时</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> totalTime</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> performance.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">now</span><span style="color:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  log.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">info</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span></span>
<span class="line"><span style="color:#032F62;--shiki-dark:#9ECBFF">    `⏱️ ✅ 主进程启动完成，总耗时: ${</span><span style="color:#032F62;--shiki-dark:#9ECBFF">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">totalTime</span><span style="color:#D73A49;--shiki-dark:#F97583"> -</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> startupTime</span><span style="color:#032F62;--shiki-dark:#9ECBFF">).</span><span style="color:#6F42C1;--shiki-dark:#B392F0">toFixed</span><span style="color:#032F62;--shiki-dark:#9ECBFF">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">2</span><span style="color:#032F62;--shiki-dark:#9ECBFF">)</span><span style="color:#032F62;--shiki-dark:#9ECBFF">}ms`</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  );</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">});</span></span></code></pre>
<h2 id="常见问题">常见问题<a class="anchor-link" href="#常见问题"><span class="icon icon-link"></span></a></h2>
<h3 id="q1-v8-缓存文件会无限增长吗">Q1: V8 缓存文件会无限增长吗？<a class="anchor-link" href="#q1-v8-缓存文件会无限增长吗"><span class="icon icon-link"></span></a></h3>
<p>A: 不会。Electron 会自动管理缓存大小，定期清理过期文件。通常缓存目录大小在几十 MB 左右。</p>
<h3 id="q2-代码拆包会影响运行时性能吗">Q2: 代码拆包会影响运行时性能吗？<a class="anchor-link" href="#q2-代码拆包会影响运行时性能吗"><span class="icon icon-link"></span></a></h3>
<p>A: 影响极小。模块拆分后，V8 的模块加载机制（ESM）可以高效处理多文件依赖，且拆包后的缓存粒度更细，整体性能反而更优。</p>
<h3 id="q3-动态-import-会导致功能延迟吗">Q3: 动态 import 会导致功能延迟吗？<a class="anchor-link" href="#q3-动态-import-会导致功能延迟吗"><span class="icon icon-link"></span></a></h3>
<p>A: 对用户几乎无感知。以划词翻译为例，从主窗口启动到用户实际使用该功能有足够的时间差，异步加载完全可以在用户操作前完成。</p>
<h2 id="总结">总结<a class="anchor-link" href="#总结"><span class="icon icon-link"></span></a></h2>
<p>通过本次优化，我们实现了：</p>
<ol>
<li><strong>启动速度提升 80%+</strong>：从 1.6s 降至 0.3s</li>
<li><strong>用户体验改善</strong>：热更新后几乎无感知</li>
<li><strong>可维护性提升</strong>：性能监控埋点便于后续定位问题</li>
</ol>
<p>关键要点：</p>
<ul>
<li><strong>模块拆包是核心</strong>：将单一 <code>main.js</code> 拆分为多个 <code>utils/*.js</code> 文件，显著降低 V8 的 JIT 热点编译压力（app.whenReady 耗时从 833ms 降至 126ms）</li>
<li><strong>V8 缓存是基础</strong>：启用代码缓存跳过重复的解析和编译过程</li>
<li><strong>延迟加载优化关键路径</strong>：非关键功能异步加载，不阻塞主窗口启动</li>
<li><strong>性能监控提供数据支撑</strong>：埋点日志帮助定位瓶颈</li>
</ul>
<p><strong>最重要的启示：</strong></p>
<p>在 Electron 应用中，<strong>打包产物的结构比打包体积更重要</strong>。一个 5MB 的巨型 <code>main.js</code> 文件对 V8 引擎来说是灾难，即使它的总代码量并不大。通过 Vite 的 <code>manualChunks</code> 配置，将代码拆分为合理的模块结构，让 V8 能够按需解析和编译，这才是启动性能优化的关键。</p>
<p>Electron 性能优化是一个持续的过程，建议定期检查启动日志，针对性地优化瓶颈环节。</p>
<hr> </div>  <script>(()=>{var e=async t=>{await(await t())()};(self.Astro||(self.Astro={})).load=e;window.dispatchEvent(new Event("astro:load"));})();</script><astro-island uid="Z1v8zuY" prefix="r20" component-url="/_astro/EmbedHydrator.D-DMb5Sw.js" component-export="default" renderer-url="/_astro/client.lBR8ML2S.js" props="{}" ssr client="load" opts="{&quot;name&quot;:&quot;EmbedHydrator&quot;,&quot;value&quot;:true}"></astro-island> <astro-island uid="1BDvuf" prefix="r21" component-url="/_astro/CustomContentEnhancer.CzZzfWHD.js" component-export="CustomContentEnhancer" renderer-url="/_astro/client.lBR8ML2S.js" props="{&quot;config&quot;:[0,{&quot;addBlankTarget&quot;:[0,true],&quot;smoothScroll&quot;:[0,true],&quot;addHeadingLevel&quot;:[0,true],&quot;enhanceCodeBlock&quot;:[0,true],&quot;enableCodeCopy&quot;:[0,true],&quot;enableCodeFullscreen&quot;:[0,true],&quot;enableLinkEmbed&quot;:[0,true],&quot;enableTweetEmbed&quot;:[0,true],&quot;enableOGPreview&quot;:[0,true],&quot;previewCacheTime&quot;:[0,3600],&quot;lazyLoadEmbeds&quot;:[0,true]}]}" ssr client="load" opts="{&quot;name&quot;:&quot;CustomContentEnhancer&quot;,&quot;value&quot;:true}"></astro-island> </article> <astro-island uid="wBKw9" prefix="r4" component-url="/_astro/GiscusComments.BKx0T_3G.js" component-export="default" renderer-url="/_astro/client.lBR8ML2S.js" props="{}" ssr client="visible" opts="{&quot;name&quot;:&quot;GiscusComments&quot;,&quot;value&quot;:true}" await-children><div class="w-full pb-12"></div><!--astro:end--></astro-island> </div>  <div class="tablet:grid-cols-1 grid grid-cols-2 gap-4 px-10 md:px-6"><div class="flex flex-col gap-4"><h2 class="text-foreground/80 text-2xl font-semibold">推荐文章</h2><div class="flex flex-col gap-2"><a href="/blog/post/22" class="group hover:text-primary hover:bg-foreground/5 flex gap-3 rounded-md p-2 text-sm transition-colors duration-300"><span class="text-foreground/30 shrink-0 font-mono">1</span><div class="flex min-w-0 flex-col gap-0.5"><div class="text-foreground/50 truncate text-xs">技术教程</div><div class="text-foreground/80 group-hover:text-primary line-clamp-2 transition-colors">关于前端数据库indexDB</div></div></a><a href="/blog/post/38" class="group hover:text-primary hover:bg-foreground/5 flex gap-3 rounded-md p-2 text-sm transition-colors duration-300"><span class="text-foreground/30 shrink-0 font-mono">2</span><div class="flex min-w-0 flex-col gap-0.5"><div class="text-foreground/50 truncate text-xs">技术教程</div><div class="text-foreground/80 group-hover:text-primary line-clamp-2 transition-colors">Rust 树结构中 Rc 与 Weak 的配合使用</div></div></a><a href="/blog/post/2" class="group hover:text-primary hover:bg-foreground/5 flex gap-3 rounded-md p-2 text-sm transition-colors duration-300"><span class="text-foreground/30 shrink-0 font-mono">3</span><div class="flex min-w-0 flex-col gap-0.5"><div class="text-foreground/50 truncate text-xs">学习笔记</div><div class="text-foreground/80 group-hover:text-primary line-clamp-2 transition-colors">JavaScript-ES5笔记</div></div></a><a href="/blog/post/21" class="group hover:text-primary hover:bg-foreground/5 flex gap-3 rounded-md p-2 text-sm transition-colors duration-300"><span class="text-foreground/30 shrink-0 font-mono">4</span><div class="flex min-w-0 flex-col gap-0.5"><div class="text-foreground/50 truncate text-xs">技术教程</div><div class="text-foreground/80 group-hover:text-primary line-clamp-2 transition-colors">表格拖拽方法手写</div></div></a><a href="/blog/post/7" class="group hover:text-primary hover:bg-foreground/5 flex gap-3 rounded-md p-2 text-sm transition-colors duration-300"><span class="text-foreground/30 shrink-0 font-mono">5</span><div class="flex min-w-0 flex-col gap-0.5"><div class="text-foreground/50 truncate text-xs">学习笔记</div><div class="text-foreground/80 group-hover:text-primary line-clamp-2 transition-colors">Vue.js基础</div></div></a></div></div><div class="flex flex-col gap-4"><h2 class="text-foreground/80 text-2xl font-semibold">相关文章</h2><div class="flex flex-col gap-2"><a href="/blog/post/6" class="group hover:text-primary hover:bg-foreground/5 flex gap-3 rounded-md p-2 text-sm transition-colors duration-300"><span class="text-foreground/30 shrink-0 font-mono">1</span><div class="flex min-w-0 flex-col gap-0.5"><div class="text-foreground/50 truncate text-xs">学习笔记</div><div class="text-foreground/80 group-hover:text-primary line-clamp-2 transition-colors">前端工程化开发</div></div></a><a href="/blog/post/23" class="group hover:text-primary hover:bg-foreground/5 flex gap-3 rounded-md p-2 text-sm transition-colors duration-300"><span class="text-foreground/30 shrink-0 font-mono">2</span><div class="flex min-w-0 flex-col gap-0.5"><div class="text-foreground/50 truncate text-xs">技术教程</div><div class="text-foreground/80 group-hover:text-primary line-clamp-2 transition-colors">前端链表运用场景</div></div></a><a href="/blog/post/42" class="group hover:text-primary hover:bg-foreground/5 flex gap-3 rounded-md p-2 text-sm transition-colors duration-300"><span class="text-foreground/30 shrink-0 font-mono">3</span><div class="flex min-w-0 flex-col gap-0.5"><div class="text-foreground/50 truncate text-xs">学习笔记</div><div class="text-foreground/80 group-hover:text-primary line-clamp-2 transition-colors">ES2025 JavaScript新特性速览</div></div></a><a href="/blog/post/8" class="group hover:text-primary hover:bg-foreground/5 flex gap-3 rounded-md p-2 text-sm transition-colors duration-300"><span class="text-foreground/30 shrink-0 font-mono">4</span><div class="flex min-w-0 flex-col gap-0.5"><div class="text-foreground/50 truncate text-xs">学习笔记</div><div class="text-foreground/80 group-hover:text-primary line-clamp-2 transition-colors">Typescript小试牛刀</div></div></a></div></div></div><footer class="mt-auto pb-6 md:pb-4"><div class="mx-auto flex flex-col items-center gap-3 px-6 md:px-3 max-w-7xl"><div class="text-muted-foreground flex flex-wrap items-center justify-center gap-6 text-sm md:gap-4"><button class="flex items-center gap-2 opacity-75 transition-opacity duration-300 hover:opacity-100" title="站点总字数"><i class="fa-regular fa-file-lines text-sm" aria-hidden="true"></i><span class="font-medium">110k</span><span class="text-xs">字</span></button><div class="bg-muted-foreground/30 h-4 w-px"></div><button class="flex items-center gap-2 opacity-75 transition-opacity duration-300 hover:opacity-100" title="站点阅读时长"><i class="fa-regular fa-clock text-sm" aria-hidden="true"></i><span class="font-medium">9:37</span></button><div class="bg-muted-foreground/30 h-4 w-px"></div><button class="flex items-center gap-2 opacity-75 transition-opacity duration-300 hover:opacity-100" title="文章总数"><i class="fa-regular fa-newspaper text-sm" aria-hidden="true"></i><span class="font-medium">45</span><span class="text-xs">篇</span></button></div><div class="text-muted-foreground flex items-center gap-0.5 text-sm"><span class="opacity-75">Â©</span><span class="font-medium opacity-75">2022</span><span class="opacity-50">-</span><span class="font-medium opacity-75" itemProp="copyrightYear">2026</span><svg class="mx-1 size-5 animate-spin text-[#FFC0CB] duration-10000" viewBox="0 0 512 512" fill="currentColor"><g><path fill="currentColor" d="M330.555,101.873c0-34.164-13.767-65.108-36.047-87.622c-2.432-2.465-9.63-4.349-14.212,3.466
		c-4.589,7.808-17.205,27.431-17.205,27.431c-1.534,2.438-4.219,3.918-7.089,3.918c-2.883,0-5.555-1.48-7.089-3.918
		c0,0-12.623-19.623-17.205-27.431c-4.582-7.815-11.781-5.931-14.219-3.466c-22.274,22.514-36.04,53.458-36.04,87.622
		c0,51.02,30.663,94.847,74.553,114.142C299.892,196.72,330.555,152.892,330.555,101.873z"></path><path fill="currentColor" d="M204.51,253.425c-4.78-47.705-36.998-90.409-85.518-106.176c-32.492-10.554-66.177-7.027-94.47,7.205
		c-3.096,1.555-7.117,7.822-1.096,14.589c6.007,6.774,20.766,24.842,20.766,24.842c1.849,2.212,2.432,5.22,1.542,7.952
		c-0.891,2.74-3.13,4.829-5.918,5.528c0,0-22.562,5.945-31.404,7.89c-8.849,1.945-9.281,9.37-7.692,12.445
		c14.527,28.144,39.698,50.801,72.197,61.362C121.436,304.828,172.6,289.212,204.51,253.425z"></path><path fill="currentColor" d="M96.772,362.484c-20.082,27.643-27.136,60.766-22.342,92.074c0.527,3.424,5.233,9.178,13.527,5.554
		c8.308-3.63,30.054-12.088,30.054-12.088c2.672-1.062,5.698-0.692,8.041,1c2.329,1.692,3.623,4.466,3.418,7.335
		c0,0-1.308,23.294-2.199,32.315c-0.883,9.006,6.048,11.712,9.466,11.15c31.252-5.116,60.581-22.054,80.662-49.704
		c29.993-41.266,30.944-94.758,6.781-136.155C177.332,303.773,126.758,321.204,96.772,362.484z"></path><path fill="currentColor" d="M287.824,313.964c-24.165,41.397-23.212,94.888,6.78,136.155c20.082,27.65,49.41,44.588,80.663,49.704
		c3.418,0.562,10.349-2.144,9.466-11.15c-0.89-9.021-2.205-32.315-2.205-32.315c-0.198-2.869,1.102-5.643,3.431-7.335
		c2.322-1.692,5.363-2.062,8.034-1c0,0,21.746,8.458,30.047,12.088c8.294,3.623,13.007-2.13,13.534-5.554
		c4.787-31.308-2.254-64.43-22.342-92.074C385.246,321.204,334.672,303.766,287.824,313.964z"></path><path fill="currentColor" d="M503.6,215.254c-8.849-1.945-31.41-7.89-31.41-7.89c-2.795-0.706-5.027-2.788-5.918-5.528
		c-0.89-2.732-0.308-5.74,1.534-7.952c0,0,14.76-18.068,20.78-24.842c6.014-6.766,1.993-13.034-1.096-14.589
		c-28.301-14.232-61.978-17.76-94.485-7.205c-48.519,15.767-80.731,58.472-85.512,106.176
		c31.91,35.787,83.067,51.403,131.593,35.636c32.492-10.561,57.67-33.218,72.191-61.362
		C512.867,224.624,512.449,217.199,503.6,215.254z"></path></g></svg><span class="author font-medium opacity-75" itemProp="copyrightHolder">snow<!-- -->@snow</span></div><div class="text-muted-foreground/80 flex items-center gap-2 text-xs"><span class="opacity-75">Powered by theme</span><a href="https://github.com/XueHua-s/astro-snow" target="_blank" rel="noreferrer" class="footer-link font-medium transition-all duration-300">snow-koharu</a><span class="opacity-50">In·</span><span class="opacity-75">From by</span><a href="https://github.com/amehime/hexo-theme-shoka" target="_blank" rel="noreferrer" class="footer-link font-medium transition-all duration-300">astro-koharu</a></div></div></footer> </div> </div> </div>  </main> <script>(()=>{var l=(n,t)=>{let i=async()=>{await(await n())()},e=typeof t.value=="object"?t.value:void 0,s={timeout:e==null?void 0:e.timeout};"requestIdleCallback"in window?window.requestIdleCallback(i,s):setTimeout(i,s.timeout||200)};(self.Astro||(self.Astro={})).idle=l;window.dispatchEvent(new Event("astro:idle"));})();</script><astro-island uid="Z13ezmH" prefix="r18" component-url="/_astro/FloatingGroup.CLhOhoBm.js" component-export="default" renderer-url="/_astro/client.lBR8ML2S.js" props="{}" ssr client="idle" opts="{&quot;name&quot;:&quot;FloatingGroupClient&quot;,&quot;value&quot;:true}" await-children><div id="floating-nav" class="text-primary fixed right-4 bottom-4 z-50 flex flex-col gap-2" data-expanded="true"><div id="nav-content" class="flex scale-y-100 flex-col gap-2 opacity-100"><button id="scroll-to-top" class="bg-background/80 hover:bg-background rounded-full p-2 shadow-lg backdrop-blur-sm transition-colors duration-200" aria-label="回到顶部" title="回到顶部" data-tooltip-interactive="false" data-tooltip-placement="left"><i class="fa-solid fa-angle-up text-lg" aria-hidden="true"></i></button><button id="scroll-to-bottom" class="bg-background/80 hover:bg-background rounded-full p-2 shadow-lg backdrop-blur-sm transition-colors duration-200" aria-label="滚到底部" title="滚到底部" data-tooltip-interactive="false" data-tooltip-placement="left"><i class="fa-solid fa-angle-down text-lg" aria-hidden="true"></i></button></div><button id="toggle-nav" class="flex-center bg-background/80 hover:bg-background size-9 rounded-full shadow-lg backdrop-blur-sm transition-colors duration-200" aria-label="展开/收起工具栏" title="展开/收起工具栏" aria-expanded="true" data-tooltip-interactive="false" data-tooltip-placement="left"><i class="fa-solid fa-wand-magic-sparkles menu-nav-icon text-sm transition-transform duration-300 hidden" aria-hidden="true"></i><i class="fa-solid fa-xmark close-nav-icon text-sm transition-transform duration-300 " aria-hidden="true"></i></button></div><!--astro:end--></astro-island>  <astro-island uid="12Ijm4" prefix="r23" component-url="/_astro/MobileDrawerPanel.CysdPqHB.js" component-export="default" renderer-url="/_astro/client.lBR8ML2S.js" props="{}" ssr client="media" opts="{&quot;name&quot;:&quot;MobileDrawerPanel&quot;,&quot;value&quot;:&quot;(max-width: 992px)&quot;}" await-children><div id="drawer-overlay" class="fixed inset-0 z-[60] bg-black/50 hidden" role="presentation" aria-hidden="true"></div><div id="mobile-drawer" class="bg-gradient-start tablet:flex fixed inset-y-0 left-0 z-[70] hidden h-screen w-[70vw] min-w-64 transform px-4 pt-6 shadow-lg backdrop-blur-sm transition-transform duration-300 md:px-0 -translate-x-full" role="dialog" aria-label="导航菜单" aria-modal="true"><div class="flex h-full w-full flex-col overflow-auto"><div class="flex justify-end pb-2 pr-4"><div class="flex" id="close-drawer"><button class="flex-center text-shoka size-10 cursor-pointer rounded-full bg-white/20 select-none hidden" aria-label="关闭菜单" aria-expanded="false" type="button"><i class="text-xl fa-solid fa-xmark" aria-hidden="true" style="opacity:1;transform:rotate(90deg)"></i></button></div></div><astro-slot> <div class="page-home-sider shadow-home-sider sticky top-0 self-start max-w-64 flex-col overflow-hidden h-screen min-h-0 items-center tablet:flex mt-4 hidden w-full min-w-full p-0"> <astro-island uid="2brEAs" prefix="r17" component-url="/_astro/HomeSiderPanel.Cf8zkySA.js" component-export="default" renderer-url="/_astro/client.lBR8ML2S.js" props="{&quot;type&quot;:[0,&quot;post&quot;],&quot;defaultSegmentType&quot;:[0,&quot;directory&quot;],&quot;homeInfo&quot;:[0,{&quot;avatar&quot;:[0,&quot;/img/724d7fb480c8ac0db472ca5c7e36d239.jpg&quot;],&quot;name&quot;:[0,&quot;snow&quot;],&quot;description&quot;:[0,&quot;ACG / 养猫人 / 菜逼 / 前端什锦&quot;],&quot;postCount&quot;:[0,45],&quot;categoryCount&quot;:[0,8],&quot;tagCount&quot;:[0,76],&quot;routes&quot;:[1,[[0,{&quot;name&quot;:[0,&quot;首页&quot;],&quot;path&quot;:[0,&quot;/blog&quot;],&quot;icon&quot;:[0,&quot;fa-solid fa-house-chimney&quot;]}],[0,{&quot;name&quot;:[0,&quot;文章&quot;],&quot;icon&quot;:[0,&quot;fa-solid fa-pen-nib&quot;],&quot;children&quot;:[1,[[0,{&quot;name&quot;:[0,&quot;分类&quot;],&quot;path&quot;:[0,&quot;/blog/categories&quot;],&quot;icon&quot;:[0,&quot;fa-solid fa-layer-group&quot;]}],[0,{&quot;name&quot;:[0,&quot;标签&quot;],&quot;path&quot;:[0,&quot;/blog/tags&quot;],&quot;icon&quot;:[0,&quot;fa-solid fa-tags&quot;]}],[0,{&quot;name&quot;:[0,&quot;周刊&quot;],&quot;path&quot;:[0,&quot;/blog/weekly&quot;],&quot;icon&quot;:[0,&quot;fa-regular fa-newspaper&quot;]}]]]}],[0,{&quot;name&quot;:[0,&quot;友链&quot;],&quot;path&quot;:[0,&quot;/blog/friends&quot;],&quot;icon&quot;:[0,&quot;fa-solid fa-link&quot;]}],[0,{&quot;name&quot;:[0,&quot;关于&quot;],&quot;path&quot;:[0,&quot;/blog/about&quot;],&quot;icon&quot;:[0,&quot;fa-regular fa-circle-user&quot;]}]]],&quot;currentPath&quot;:[0,&quot;/blog/post/33/&quot;]}],&quot;tocHeadings&quot;:[1,[[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;前言&quot;],&quot;text&quot;:[0,&quot;前言&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;性能数据对比&quot;],&quot;text&quot;:[0,&quot;性能数据对比&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;核心优化策略&quot;],&quot;text&quot;:[0,&quot;核心优化策略&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;1-启用-v8-代码缓存&quot;],&quot;text&quot;:[0,&quot;1. 启用 V8 代码缓存&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;实现方式&quot;],&quot;text&quot;:[0,&quot;实现方式&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;验证缓存效果&quot;],&quot;text&quot;:[0,&quot;验证缓存效果&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;工作原理&quot;],&quot;text&quot;:[0,&quot;工作原理&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;2-模块拆包code-splitting-核心优化&quot;],&quot;text&quot;:[0,&quot;2. 模块拆包（Code Splitting）—— 核心优化&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;问题背景为什么需要拆包&quot;],&quot;text&quot;:[0,&quot;问题背景：为什么需要拆包？&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;vite-配置方案&quot;],&quot;text&quot;:[0,&quot;Vite 配置方案&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;拆包效果对比&quot;],&quot;text&quot;:[0,&quot;拆包效果对比&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;拆包如何降低-jit-热点编译压力&quot;],&quot;text&quot;:[0,&quot;拆包如何降低 JIT 热点编译压力？&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;实际性能提升&quot;],&quot;text&quot;:[0,&quot;实际性能提升&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;注意事项&quot;],&quot;text&quot;:[0,&quot;注意事项&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;日志中的证据&quot;],&quot;text&quot;:[0,&quot;日志中的证据&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;3-按需导入依赖tree-shaking&quot;],&quot;text&quot;:[0,&quot;3. 按需导入依赖（Tree Shaking）&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;优化前&quot;],&quot;text&quot;:[0,&quot;优化前&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;优化后&quot;],&quot;text&quot;:[0,&quot;优化后&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;效果分析&quot;],&quot;text&quot;:[0,&quot;效果分析&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;4-延迟加载非关键模块&quot;],&quot;text&quot;:[0,&quot;4. 延迟加载非关键模块&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;实现方案&quot;],&quot;text&quot;:[0,&quot;实现方案&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;关键技术点&quot;],&quot;text&quot;:[0,&quot;关键技术点&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;5-性能监控埋点&quot;],&quot;text&quot;:[0,&quot;5. 性能监控埋点&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;常见问题&quot;],&quot;text&quot;:[0,&quot;常见问题&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;q1-v8-缓存文件会无限增长吗&quot;],&quot;text&quot;:[0,&quot;Q1: V8 缓存文件会无限增长吗？&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;q2-代码拆包会影响运行时性能吗&quot;],&quot;text&quot;:[0,&quot;Q2: 代码拆包会影响运行时性能吗？&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;q3-动态-import-会导致功能延迟吗&quot;],&quot;text&quot;:[0,&quot;Q3: 动态 import 会导致功能延迟吗？&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;总结&quot;],&quot;text&quot;:[0,&quot;总结&quot;]}]]],&quot;tocNumbering&quot;:[0,true],&quot;seriesPostItems&quot;:[1,[[0,{&quot;post&quot;:[0,{&quot;id&quot;:[0,&quot;rk3528开发板部署openclaw-telegram-bot全记录&quot;],&quot;data&quot;:[0,{&quot;title&quot;:[0,&quot;在 RK3528 ARM 开发板上部署 OpenClaw + Telegram Bot 全记录&quot;],&quot;date&quot;:[3,&quot;2026-02-07T10:30:00.000Z&quot;],&quot;tags&quot;:[1,[[0,&quot;OpenClaw&quot;],[0,&quot;Telegram Bot&quot;],[0,&quot;RK3528&quot;],[0,&quot;Armbian&quot;],[0,&quot;AI Agent&quot;]]],&quot;categories&quot;:[0,&quot;技术教程&quot;]}],&quot;body&quot;:[0,&quot;&gt; **TL;DR**：在一块 4GB 内存的 RK3528 ARM 板子（Armbian）上，从零搭建了 Telegram Bot，接入 Gemini / GPT-5 / Claude 多模型，支持 AI 聊天、图片生成和系统代理操作。本文完整复盘部署步骤与核心踩坑。\n\n## 一、硬件与系统环境\n\n| 项目    | 配置                                       |\n| ------- | ------------------------------------------ |\n| SoC     | Rockchip RK3528（四核 ARM Cortex-A53）     |\n| 内存    | 4GB DDR4                                   |\n| 存储    | 64GB eMMC                                  |\n| 系统    | Armbian 25.11.0-trunk (Ubuntu 24.04 Noble) |\n| 内核    | Linux 6.1.115-vendor-rk35xx aarch64        |\n| Python  | 3.12.3                                     |\n| Node.js | v24.11.1（通过 nvm）                       |\n| 网络    | Clash TUN 模式全局代理                     |\n\n这块板子原本用于轻量服务。实测下来，4GB 内存跑这种“网络请求驱动型”AI Bot 完全够用，瓶颈主要不在算力，而在网络质量和 API 稳定性。\n\n## 二、架构总览\n\n最终部署架构：\n\n```text\nTelegram 用户\n    │\n    ▼ (Long Polling)\n┌──────────────────────────┐\n│  telegram-adapter.py     │ ← systemd 托管\n│  (Python 3.12)           │\n│                          │\n│  ┌─ /chat 聊天模式 ─────┐│\n│  │  Gemini 3 Flash/Pro  ││\n│  │  GPT-5.2 / 5-Mini    ││\n│  │  Claude Code (本地)   ││\n│  └──────────────────────┘│\n│  ┌─ /agent 代理模式 ────┐│\n│  │  Gemini Function Call -&gt; model think -&gt; openClaw do ││\n│  │  → shell / file / web ││\n│  └──────────────────────┘│\n│  ┌─ 图片生成 ───────────┐│\n│  │  Gemini 2.5 Flash    ││\n│  │  Image（自动检测）    ││\n│  └──────────────────────┘│\n└──────────────────────────┘\n    │                  │\n    ▼                  ▼\n SQLite DB        审计日志\n (状态/历史/Key)   /var/log/openclaw-agent/\n```\n\n核心设计决策：\n\n- 使用 **Long Polling**：无需公网 IP、无需 HTTPS 证书，部署成本最低。\n- 支持 **多模型热切换**：`/model gpt-5.2` 直接切换，无需重启。\n- 支持 **图片生成自动路由**：识别“生成图片 / 画一张”类指令自动走图像模型。\n- 代理模式使用 **Function Calling**：AI 自主规划工具调用。\n- 使用 **SQLite 统一存储**：聊天历史、状态、API Key、任务审计集中管理。\n\n## 三、部署步骤\n\n### 3.1 目录结构\n\n```bash\nmkdir -p /opt/openclaw/{scripts,config,work}\nmkdir -p /var/log/openclaw-agent\n```\n\n```text\n/opt/openclaw/\n├── config/\n│   └── .env\n├── scripts/\n│   └── telegram-adapter.py\n└── work/\n```\n\n### 3.2 创建 Telegram Bot\n\n1. 在 Telegram 搜索 `@BotFather`，发送 `/newbot`。\n2. 按提示创建 Bot，拿到 `Bot Token`。\n3. 通过 `@userinfobot` 获取自己的 `User ID`。\n4. 将 Token 和 User ID 写入环境变量。\n\n### 3.3 环境变量配置\n\n```bash\ncat &gt; /opt/openclaw/config/.env &lt;&lt; &#39;EOF&#39;\nTELEGRAM_BOT_TOKEN=你的Bot_Token\nTELEGRAM_ADMIN_USER_ID=你的User_ID\nGEMINI_API_KEY=你的Gemini_Key\nOPENCLAW_WORK_DIR=/opt/openclaw/work\nOPENCLAW_LOG_DIR=/var/log/openclaw-agent\nEOF\n\nchmod 600 /opt/openclaw/config/.env\n```\n\n### 3.4 安装 Python 依赖\n\n```bash\npip3 install --break-system-packages requests google-genai\n```\n\n&gt; Ubuntu 24.04 + Python 3.12 默认受 PEP 668 约束。要么使用 venv，要么加 `--break-system-packages` 做系统级安装。\n\n### 3.5 部署主程序\n\n```bash\nchmod +x /opt/openclaw/scripts/telegram-adapter.py\n```\n\n脚本首行为 `#!/usr/bin/env python3`，可直接执行。\n\n### 3.6 systemd 服务\n\n```bash\ncat &gt; /etc/systemd/system/openclaw-telegram.service &lt;&lt; &#39;EOF&#39;\n[Unit]\nDescription=OpenClaw Telegram Agent\nAfter=network-online.target\nWants=network-online.target\nStartLimitIntervalSec=60\nStartLimitBurst=3\n\n[Service]\nType=simple\nUser=root\nWorkingDirectory=/opt/openclaw/work\nEnvironmentFile=/opt/openclaw/config/.env\nExecStart=/opt/openclaw/scripts/telegram-adapter.py\nRestart=on-failure\nRestartSec=10\nStandardOutput=journal\nStandardError=journal\nSyslogIdentifier=openclaw-telegram\n\nMemoryMax=500M\nCPUQuota=50%\n\nPrivateTmp=yes\nNoNewPrivileges=true\nProtectSystem=strict\nProtectHome=yes\nReadWritePaths=/opt/openclaw/work /var/log/openclaw-agent\n\n[Install]\nWantedBy=multi-user.target\nEOF\n\nsystemctl daemon-reload\nsystemctl enable openclaw-telegram\nsystemctl start openclaw-telegram\n```\n\n### 3.7 验证\n\n```bash\nsystemctl status openclaw-telegram\njournalctl -u openclaw-telegram -f\n```\n\n在 Telegram 发送 `/ping`，应收到 `pong + 主机名 + 时间`。\n\n## 四、踩坑全记录（重点）\n\n从“能跑”到“稳定可用”，这 6 个坑最关键。\n\n### 坑 1：`google-generativeai` 已废弃，必须换 `google-genai`\n\n现象：启动后出现 `FutureWarning`，提示旧 SDK 停止维护。  \n结论：直接切换到新 SDK，避免后续兼容问题。\n\n```bash\npip3 install --break-system-packages google-genai\n```\n\n```python\nimport google.genai as genai\nfrom google.genai import types\n\nclient = genai.Client(api_key=api_key)\n```\n\n### 坑 2：新 SDK 没有 `genai.configure()`\n\n现象：调用 `genai.configure(api_key=...)` 报 `AttributeError`。  \n原因：这是旧 SDK 写法。  \n修复：初始化时直接传 API Key。\n\n```python\n# 错误（旧写法）\ngenai.configure(api_key=api_key)\nclient = genai.Client()\n\n# 正确（新写法）\nclient = genai.Client(api_key=api_key)\n```\n\n### 坑 3：Gemini API 地理位置限制（数据中心出口 IP）\n\n现象：Key 正确、代码正确，仍报 `User location is not supported for the API use.`  \n原因：出口 IP 不在可用策略范围内。  \n修复：通过 Cloudflare Worker 做中转，再在 SDK 指定 `base_url`。\n\n```javascript\nexport default {\n  async fetch(request) {\n    const url = new URL(request.url);\n    url.hostname = &#39;generativelanguage.googleapis.com&#39;;\n    return fetch(new Request(url, request));\n  },\n};\n```\n\n```python\nclient = genai.Client(\n    api_key=api_key,\n    http_options=types.HttpOptions(\n        base_url=&#39;https://your-worker.your-domain.workers.dev&#39;\n    )\n)\n```\n\n### 坑 4：Telegram Markdown 解析炸裂\n\n现象：AI 返回里只要含不规范 Markdown（如 `*`、`_`、`` ` ``、`[` 未闭合），Telegram 直接 400。  \n风险：业务代码以为“已发送”，用户却收不到消息。  \n修复：发送失败后自动降级纯文本重试。\n\n```python\ndef send_message(chat_id, text, reply_markup=None):\n    data = {\n        &#39;chat_id&#39;: chat_id,\n        &#39;text&#39;: text,\n        &#39;parse_mode&#39;: &#39;Markdown&#39;\n    }\n    resp = requests.post(url, json=data, timeout=10)\n    if resp.status_code == 400:\n        logger.warning(&#39;Markdown parse failed, retrying as plain text&#39;)\n        data.pop(&#39;parse_mode&#39;, None)\n        resp = requests.post(url, json=data, timeout=10)\n```\n\n同样逻辑也要覆盖 `send_photo` 的 caption。\n\n### 坑 5：Gemini 图片生成 `temperature` 必须为 `1.0`\n\n现象：复用聊天参数（如 `temperature=0.7`）会导致图片接口异常或空响应。  \n修复：图像模式固定 `temperature=1.0`，并声明 `response_modalities`。\n\n```python\nconfig = types.GenerateContentConfig(\n    temperature=1.0,\n    max_output_tokens=2048,\n    response_modalities=[&#39;TEXT&#39;, &#39;IMAGE&#39;],\n)\n```\n\n### 坑 6：GPT-5 系列参数兼容变更\n\n现象：`max_tokens` 不生效。  \n修复：改用 `max_completion_tokens`。\n\n```python\nresponse = requests.post(\n    &#39;https://api.openai.com/v1/chat/completions&#39;,\n    json={\n        &#39;model&#39;: &#39;gpt-5-mini-2025-08-07&#39;,\n        &#39;messages&#39;: messages,\n        &#39;max_completion_tokens&#39;: 2048,\n    },\n    headers={&#39;Authorization&#39;: f&#39;Bearer {api_key}&#39;},\n)\n```\n\n## 五、最终能力与安全策略\n\n### 基础命令\n\n| 命令                   | 功能                                |\n| ---------------------- | ----------------------------------- |\n| `/ping`                | 返回 pong + 主机名 + 时间           |\n| `/chat`                | 进入 AI 聊天模式                    |\n| `/agent`               | 进入代理模式（AI 操作系统OpenClaw） |\n| `/model`               | 查看/切换模型                       |\n| `/setkey gemini &lt;key&gt;` | 设置 API Key                        |\n| `/clear`               | 清空对话历史                        |\n| `/help`                | 显示帮助                            |\n\n### 主要能力\n\n- 多轮对话与上下文记忆\n- 多模型热切换（Gemini / GPT-5 / Claude）\n- 图片生成与继续编辑\n- 代理模式下的 shell / file / web 工具调用\n- 危险命令拦截与审计日志记录\n\n### 安全机制\n\n- **用户白名单**：仅允许配置的管理员 User ID 操作。\n- **命令黑名单**：默认拦截 `rm -rf`、`dd`、`mkfs` 等高危命令。\n- **审计追踪**：SQLite + 文件日志双轨记录。\n- **资源限制**：`MemoryMax=500M`、`CPUQuota=50%`。\n- **最小权限运行**：`ProtectSystem=strict`、`ProtectHome=yes`、`NoNewPrivileges=true`。\n\n## 六、经验总结\n\n给准备在 ARM 板上跑 AI Bot 的同学几个建议：\n\n1. **ARM 兼容性不是问题**：真正的问题是网络、API 和异常处理。\n2. **Long Polling 是边缘部署最优解**：简单、稳定、低成本。\n3. **先做失败兜底，再做功能扩展**：特别是 Telegram Markdown fallback。\n4. **尽早切到新 SDK**：别在废弃 SDK 上继续堆逻辑。\n5. **资源限制必须上**：边缘设备内存和 CPU 都是硬约束。\n\n## 七、踩坑速查表\n\n| 问题                 | 症状                             | 解决                       |\n| -------------------- | -------------------------------- | -------------------------- |\n| 旧 SDK 废弃          | `google.generativeai has ended`  | 切换 `google-genai`        |\n| `configure()` 不存在 | `AttributeError`                 | `Client(api_key=key)`      |\n| 地理限制             | `User location is not supported` | Cloudflare Worker 中转     |\n| Markdown 失败        | Telegram 400                     | 降级纯文本重试             |\n| 图片参数异常         | 空响应或报错                     | 固定 `temperature=1.0`     |\n| GPT-5 参数不兼容     | `max_tokens` 无效                | 改 `max_completion_tokens` |\n\n## 八、结语\n\n个人感觉, openClaw 还是挺好用的。\n如果你能忽略它以下几个缺点\n\n- 不能开箱即用(指写完配置就能跑)\n- 费钱, 帮我改了个很小的需求，烧了我的gemini 3刀....\n\n感觉当当玩具还是不错的.\n最后放上使用截图啦！\n![部署完成](/img/img_11.png)\n![开始使用](/img/img_12.png)&quot;],&quot;filePath&quot;:[0,&quot;source/posts/RK3528开发板部署OpenClaw-Telegram-Bot全记录.md&quot;],&quot;digest&quot;:[0,&quot;c1f2e3d1b77ff5c1&quot;],&quot;rendered&quot;:[0,{&quot;html&quot;:[0,&quot;&lt;blockquote&gt;\n&lt;p&gt;&lt;strong&gt;TL;DR&lt;/strong&gt;：在一块 4GB 内存的 RK3528 ARM 板子（Armbian）上，从零搭建了 Telegram Bot，接入 Gemini / GPT-5 / Claude 多模型，支持 AI 聊天、图片生成和系统代理操作。本文完整复盘部署步骤与核心踩坑。&lt;/p&gt;\n&lt;/blockquote&gt;\n&lt;h2 id=\&quot;一硬件与系统环境\&quot;&gt;一、硬件与系统环境&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#一硬件与系统环境\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;项目&lt;/th&gt;&lt;th&gt;配置&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;SoC&lt;/td&gt;&lt;td&gt;Rockchip RK3528（四核 ARM Cortex-A53）&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;内存&lt;/td&gt;&lt;td&gt;4GB DDR4&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;存储&lt;/td&gt;&lt;td&gt;64GB eMMC&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;系统&lt;/td&gt;&lt;td&gt;Armbian 25.11.0-trunk (Ubuntu 24.04 Noble)&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;内核&lt;/td&gt;&lt;td&gt;Linux 6.1.115-vendor-rk35xx aarch64&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;Python&lt;/td&gt;&lt;td&gt;3.12.3&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;Node.js&lt;/td&gt;&lt;td&gt;v24.11.1（通过 nvm）&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;网络&lt;/td&gt;&lt;td&gt;Clash TUN 模式全局代理&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;\n&lt;p&gt;这块板子原本用于轻量服务。实测下来，4GB 内存跑这种“网络请求驱动型”AI Bot 完全够用，瓶颈主要不在算力，而在网络质量和 API 稳定性。&lt;/p&gt;\n&lt;h2 id=\&quot;二架构总览\&quot;&gt;二、架构总览&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#二架构总览\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;最终部署架构：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;text\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;Telegram 用户&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;    │&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;    ▼ (Long Polling)&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;┌──────────────────────────┐&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;│  telegram-adapter.py     │ ← systemd 托管&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;│  (Python 3.12)           │&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;│                          │&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;│  ┌─ /chat 聊天模式 ─────┐│&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;│  │  Gemini 3 Flash/Pro  ││&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;│  │  GPT-5.2 / 5-Mini    ││&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;│  │  Claude Code (本地)   ││&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;│  └──────────────────────┘│&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;│  ┌─ /agent 代理模式 ────┐│&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;│  │  Gemini Function Call -&gt; model think -&gt; openClaw do ││&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;│  │  → shell / file / web ││&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;│  └──────────────────────┘│&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;│  ┌─ 图片生成 ───────────┐│&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;│  │  Gemini 2.5 Flash    ││&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;│  │  Image（自动检测）    ││&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;│  └──────────────────────┘│&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;└──────────────────────────┘&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;    │                  │&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;    ▼                  ▼&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt; SQLite DB        审计日志&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt; (状态/历史/Key)   /var/log/openclaw-agent/&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;核心设计决策：&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;使用 &lt;strong&gt;Long Polling&lt;/strong&gt;：无需公网 IP、无需 HTTPS 证书，部署成本最低。&lt;/li&gt;\n&lt;li&gt;支持 &lt;strong&gt;多模型热切换&lt;/strong&gt;：&lt;code&gt;/model gpt-5.2&lt;/code&gt; 直接切换，无需重启。&lt;/li&gt;\n&lt;li&gt;支持 &lt;strong&gt;图片生成自动路由&lt;/strong&gt;：识别“生成图片 / 画一张”类指令自动走图像模型。&lt;/li&gt;\n&lt;li&gt;代理模式使用 &lt;strong&gt;Function Calling&lt;/strong&gt;：AI 自主规划工具调用。&lt;/li&gt;\n&lt;li&gt;使用 &lt;strong&gt;SQLite 统一存储&lt;/strong&gt;：聊天历史、状态、API Key、任务审计集中管理。&lt;/li&gt;\n&lt;/ul&gt;\n&lt;h2 id=\&quot;三部署步骤\&quot;&gt;三、部署步骤&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#三部署步骤\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;h3 id=\&quot;31-目录结构\&quot;&gt;3.1 目录结构&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#31-目录结构\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;bash\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;mkdir&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; -p&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; /opt/openclaw/{scripts,config,work}&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;mkdir&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; -p&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; /var/log/openclaw-agent&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;text\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;/opt/openclaw/&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;├── config/&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;│   └── .env&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;├── scripts/&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;│   └── telegram-adapter.py&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;└── work/&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h3 id=\&quot;32-创建-telegram-bot\&quot;&gt;3.2 创建 Telegram Bot&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#32-创建-telegram-bot\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;ol&gt;\n&lt;li&gt;在 Telegram 搜索 &lt;code&gt;@BotFather&lt;/code&gt;，发送 &lt;code&gt;/newbot&lt;/code&gt;。&lt;/li&gt;\n&lt;li&gt;按提示创建 Bot，拿到 &lt;code&gt;Bot Token&lt;/code&gt;。&lt;/li&gt;\n&lt;li&gt;通过 &lt;code&gt;@userinfobot&lt;/code&gt; 获取自己的 &lt;code&gt;User ID&lt;/code&gt;。&lt;/li&gt;\n&lt;li&gt;将 Token 和 User ID 写入环境变量。&lt;/li&gt;\n&lt;/ol&gt;\n&lt;h3 id=\&quot;33-环境变量配置\&quot;&gt;3.3 环境变量配置&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#33-环境变量配置\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;bash\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;cat&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; &gt;&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; /opt/openclaw/config/.env&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; &amp;#x3C;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; &#39;EOF&#39;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;TELEGRAM_BOT_TOKEN=你的Bot_Token&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;TELEGRAM_ADMIN_USER_ID=你的User_ID&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;GEMINI_API_KEY=你的Gemini_Key&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;OPENCLAW_WORK_DIR=/opt/openclaw/work&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;OPENCLAW_LOG_DIR=/var/log/openclaw-agent&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;EOF&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;chmod&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; 600&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; /opt/openclaw/config/.env&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h3 id=\&quot;34-安装-python-依赖\&quot;&gt;3.4 安装 Python 依赖&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#34-安装-python-依赖\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;bash\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;pip3&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; install&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; --break-system-packages&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; requests&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; google-genai&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;blockquote&gt;\n&lt;p&gt;Ubuntu 24.04 + Python 3.12 默认受 PEP 668 约束。要么使用 venv，要么加 &lt;code&gt;--break-system-packages&lt;/code&gt; 做系统级安装。&lt;/p&gt;\n&lt;/blockquote&gt;\n&lt;h3 id=\&quot;35-部署主程序\&quot;&gt;3.5 部署主程序&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#35-部署主程序\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;bash\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;chmod&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; +x&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; /opt/openclaw/scripts/telegram-adapter.py&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;脚本首行为 &lt;code&gt;#!/usr/bin/env python3&lt;/code&gt;，可直接执行。&lt;/p&gt;\n&lt;h3 id=\&quot;36-systemd-服务\&quot;&gt;3.6 systemd 服务&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#36-systemd-服务\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;bash\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;cat&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; &gt;&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; /etc/systemd/system/openclaw-telegram.service&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; &amp;#x3C;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; &#39;EOF&#39;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;[Unit]&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;Description=OpenClaw Telegram Agent&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;After=network-online.target&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;Wants=network-online.target&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;StartLimitIntervalSec=60&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;StartLimitBurst=3&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;[Service]&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;Type=simple&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;User=root&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;WorkingDirectory=/opt/openclaw/work&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;EnvironmentFile=/opt/openclaw/config/.env&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;ExecStart=/opt/openclaw/scripts/telegram-adapter.py&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;Restart=on-failure&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;RestartSec=10&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;StandardOutput=journal&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;StandardError=journal&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;SyslogIdentifier=openclaw-telegram&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;MemoryMax=500M&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;CPUQuota=50%&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;PrivateTmp=yes&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;NoNewPrivileges=true&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;ProtectSystem=strict&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;ProtectHome=yes&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;ReadWritePaths=/opt/openclaw/work /var/log/openclaw-agent&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;[Install]&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;WantedBy=multi-user.target&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;EOF&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;systemctl&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; daemon-reload&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;systemctl&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; enable&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; openclaw-telegram&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;systemctl&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; start&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; openclaw-telegram&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h3 id=\&quot;37-验证\&quot;&gt;3.7 验证&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#37-验证\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;bash\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;systemctl&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; status&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; openclaw-telegram&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;journalctl&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; -u&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; openclaw-telegram&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; -f&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;在 Telegram 发送 &lt;code&gt;/ping&lt;/code&gt;，应收到 &lt;code&gt;pong + 主机名 + 时间&lt;/code&gt;。&lt;/p&gt;\n&lt;h2 id=\&quot;四踩坑全记录重点\&quot;&gt;四、踩坑全记录（重点）&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#四踩坑全记录重点\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;从“能跑”到“稳定可用”，这 6 个坑最关键。&lt;/p&gt;\n&lt;h3 id=\&quot;坑-1google-generativeai-已废弃必须换-google-genai\&quot;&gt;坑 1：&lt;code&gt;google-generativeai&lt;/code&gt; 已废弃，必须换 &lt;code&gt;google-genai&lt;/code&gt;&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#坑-1google-generativeai-已废弃必须换-google-genai\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;现象：启动后出现 &lt;code&gt;FutureWarning&lt;/code&gt;，提示旧 SDK 停止维护。&lt;br&gt;\n结论：直接切换到新 SDK，避免后续兼容问题。&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;bash\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;pip3&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; install&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; --break-system-packages&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; google-genai&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;python\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;import&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; google.genai &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;as&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; genai&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;from&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; google.genai &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;import&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; types&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;client &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; genai.Client(&lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;api_key&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;api_key)&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h3 id=\&quot;坑-2新-sdk-没有-genaiconfigure\&quot;&gt;坑 2：新 SDK 没有 &lt;code&gt;genai.configure()&lt;/code&gt;&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#坑-2新-sdk-没有-genaiconfigure\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;现象：调用 &lt;code&gt;genai.configure(api_key=...)&lt;/code&gt; 报 &lt;code&gt;AttributeError&lt;/code&gt;。&lt;br&gt;\n原因：这是旧 SDK 写法。&lt;br&gt;\n修复：初始化时直接传 API Key。&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;python\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;# 错误（旧写法）&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;genai.configure(&lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;api_key&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;api_key)&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;client &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; genai.Client()&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;# 正确（新写法）&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;client &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; genai.Client(&lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;api_key&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;api_key)&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h3 id=\&quot;坑-3gemini-api-地理位置限制数据中心出口-ip\&quot;&gt;坑 3：Gemini API 地理位置限制（数据中心出口 IP）&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#坑-3gemini-api-地理位置限制数据中心出口-ip\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;现象：Key 正确、代码正确，仍报 &lt;code&gt;User location is not supported for the API use.&lt;/code&gt;&lt;br&gt;\n原因：出口 IP 不在可用策略范围内。&lt;br&gt;\n修复：通过 Cloudflare Worker 做中转，再在 SDK 指定 &lt;code&gt;base_url&lt;/code&gt;。&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;javascript\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;export&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; default&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  async&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; fetch&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;request&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; url&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; new&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; URL&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(request.url);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    url.hostname &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; &#39;generativelanguage.googleapis.com&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    return&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; fetch&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;new&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Request&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(url, request));&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  },&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;};&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;python\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;client &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; genai.Client(&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;    api_key&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;api_key,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;    http_options&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;types.HttpOptions(&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;        base_url&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;https://your-worker.your-domain.workers.dev&#39;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    )&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h3 id=\&quot;坑-4telegram-markdown-解析炸裂\&quot;&gt;坑 4：Telegram Markdown 解析炸裂&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#坑-4telegram-markdown-解析炸裂\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;现象：AI 返回里只要含不规范 Markdown（如 &lt;code&gt;*&lt;/code&gt;、&lt;code&gt;_&lt;/code&gt;、&lt;code&gt;`&lt;/code&gt;、&lt;code&gt;[&lt;/code&gt; 未闭合），Telegram 直接 400。&lt;br&gt;\n风险：业务代码以为“已发送”，用户却收不到消息。&lt;br&gt;\n修复：发送失败后自动降级纯文本重试。&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;python\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;def&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; send_message&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(chat_id, text, reply_markup&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;None&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;):&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    data &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;        &#39;chat_id&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: chat_id,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;        &#39;text&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: text,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;        &#39;parse_mode&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;Markdown&#39;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    resp &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; requests.post(url, &lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;json&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;data, &lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;timeout&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;10&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;)&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    if&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; resp.status_code &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;==&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; 400&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;:&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;        logger.warning(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;Markdown parse failed, retrying as plain text&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;)&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;        data.pop(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;parse_mode&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;None&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;)&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;        resp &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; requests.post(url, &lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;json&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;data, &lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;timeout&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;10&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;同样逻辑也要覆盖 &lt;code&gt;send_photo&lt;/code&gt; 的 caption。&lt;/p&gt;\n&lt;h3 id=\&quot;坑-5gemini-图片生成-temperature-必须为-10\&quot;&gt;坑 5：Gemini 图片生成 &lt;code&gt;temperature&lt;/code&gt; 必须为 &lt;code&gt;1.0&lt;/code&gt;&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#坑-5gemini-图片生成-temperature-必须为-10\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;现象：复用聊天参数（如 &lt;code&gt;temperature=0.7&lt;/code&gt;）会导致图片接口异常或空响应。&lt;br&gt;\n修复：图像模式固定 &lt;code&gt;temperature=1.0&lt;/code&gt;，并声明 &lt;code&gt;response_modalities&lt;/code&gt;。&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;python\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;config &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; types.GenerateContentConfig(&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;    temperature&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;1.0&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;    max_output_tokens&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;2048&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;    response_modalities&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;[&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;TEXT&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;IMAGE&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;],&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h3 id=\&quot;坑-6gpt-5-系列参数兼容变更\&quot;&gt;坑 6：GPT-5 系列参数兼容变更&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#坑-6gpt-5-系列参数兼容变更\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;现象：&lt;code&gt;max_tokens&lt;/code&gt; 不生效。&lt;br&gt;\n修复：改用 &lt;code&gt;max_completion_tokens&lt;/code&gt;。&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;python\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;response &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; requests.post(&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;    &#39;https://api.openai.com/v1/chat/completions&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;    json&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;{&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;        &#39;model&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;gpt-5-mini-2025-08-07&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;        &#39;messages&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: messages,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;        &#39;max_completion_tokens&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;2048&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    },&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;    headers&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;{&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;Authorization&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;f&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;Bearer &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;{&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;api_key&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;}&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;},&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h2 id=\&quot;五最终能力与安全策略\&quot;&gt;五、最终能力与安全策略&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#五最终能力与安全策略\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;h3 id=\&quot;基础命令\&quot;&gt;基础命令&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#基础命令\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;命令&lt;/th&gt;&lt;th&gt;功能&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;&lt;code&gt;/ping&lt;/code&gt;&lt;/td&gt;&lt;td&gt;返回 pong + 主机名 + 时间&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;code&gt;/chat&lt;/code&gt;&lt;/td&gt;&lt;td&gt;进入 AI 聊天模式&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;code&gt;/agent&lt;/code&gt;&lt;/td&gt;&lt;td&gt;进入代理模式（AI 操作系统OpenClaw）&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;code&gt;/model&lt;/code&gt;&lt;/td&gt;&lt;td&gt;查看/切换模型&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;code&gt;/setkey gemini &amp;#x3C;key&gt;&lt;/code&gt;&lt;/td&gt;&lt;td&gt;设置 API Key&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;code&gt;/clear&lt;/code&gt;&lt;/td&gt;&lt;td&gt;清空对话历史&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;code&gt;/help&lt;/code&gt;&lt;/td&gt;&lt;td&gt;显示帮助&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;\n&lt;h3 id=\&quot;主要能力\&quot;&gt;主要能力&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#主要能力\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;ul&gt;\n&lt;li&gt;多轮对话与上下文记忆&lt;/li&gt;\n&lt;li&gt;多模型热切换（Gemini / GPT-5 / Claude）&lt;/li&gt;\n&lt;li&gt;图片生成与继续编辑&lt;/li&gt;\n&lt;li&gt;代理模式下的 shell / file / web 工具调用&lt;/li&gt;\n&lt;li&gt;危险命令拦截与审计日志记录&lt;/li&gt;\n&lt;/ul&gt;\n&lt;h3 id=\&quot;安全机制\&quot;&gt;安全机制&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#安全机制\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;strong&gt;用户白名单&lt;/strong&gt;：仅允许配置的管理员 User ID 操作。&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;命令黑名单&lt;/strong&gt;：默认拦截 &lt;code&gt;rm -rf&lt;/code&gt;、&lt;code&gt;dd&lt;/code&gt;、&lt;code&gt;mkfs&lt;/code&gt; 等高危命令。&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;审计追踪&lt;/strong&gt;：SQLite + 文件日志双轨记录。&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;资源限制&lt;/strong&gt;：&lt;code&gt;MemoryMax=500M&lt;/code&gt;、&lt;code&gt;CPUQuota=50%&lt;/code&gt;。&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;最小权限运行&lt;/strong&gt;：&lt;code&gt;ProtectSystem=strict&lt;/code&gt;、&lt;code&gt;ProtectHome=yes&lt;/code&gt;、&lt;code&gt;NoNewPrivileges=true&lt;/code&gt;。&lt;/li&gt;\n&lt;/ul&gt;\n&lt;h2 id=\&quot;六经验总结\&quot;&gt;六、经验总结&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#六经验总结\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;给准备在 ARM 板上跑 AI Bot 的同学几个建议：&lt;/p&gt;\n&lt;ol&gt;\n&lt;li&gt;&lt;strong&gt;ARM 兼容性不是问题&lt;/strong&gt;：真正的问题是网络、API 和异常处理。&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;Long Polling 是边缘部署最优解&lt;/strong&gt;：简单、稳定、低成本。&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;先做失败兜底，再做功能扩展&lt;/strong&gt;：特别是 Telegram Markdown fallback。&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;尽早切到新 SDK&lt;/strong&gt;：别在废弃 SDK 上继续堆逻辑。&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;资源限制必须上&lt;/strong&gt;：边缘设备内存和 CPU 都是硬约束。&lt;/li&gt;\n&lt;/ol&gt;\n&lt;h2 id=\&quot;七踩坑速查表\&quot;&gt;七、踩坑速查表&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#七踩坑速查表\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;问题&lt;/th&gt;&lt;th&gt;症状&lt;/th&gt;&lt;th&gt;解决&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;旧 SDK 废弃&lt;/td&gt;&lt;td&gt;&lt;code&gt;google.generativeai has ended&lt;/code&gt;&lt;/td&gt;&lt;td&gt;切换 &lt;code&gt;google-genai&lt;/code&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;code&gt;configure()&lt;/code&gt; 不存在&lt;/td&gt;&lt;td&gt;&lt;code&gt;AttributeError&lt;/code&gt;&lt;/td&gt;&lt;td&gt;&lt;code&gt;Client(api_key=key)&lt;/code&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;地理限制&lt;/td&gt;&lt;td&gt;&lt;code&gt;User location is not supported&lt;/code&gt;&lt;/td&gt;&lt;td&gt;Cloudflare Worker 中转&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;Markdown 失败&lt;/td&gt;&lt;td&gt;Telegram 400&lt;/td&gt;&lt;td&gt;降级纯文本重试&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;图片参数异常&lt;/td&gt;&lt;td&gt;空响应或报错&lt;/td&gt;&lt;td&gt;固定 &lt;code&gt;temperature=1.0&lt;/code&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;GPT-5 参数不兼容&lt;/td&gt;&lt;td&gt;&lt;code&gt;max_tokens&lt;/code&gt; 无效&lt;/td&gt;&lt;td&gt;改 &lt;code&gt;max_completion_tokens&lt;/code&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;\n&lt;h2 id=\&quot;八结语\&quot;&gt;八、结语&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#八结语\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;个人感觉, openClaw 还是挺好用的。\n如果你能忽略它以下几个缺点&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;不能开箱即用(指写完配置就能跑)&lt;/li&gt;\n&lt;li&gt;费钱, 帮我改了个很小的需求，烧了我的gemini 3刀…&lt;/li&gt;\n&lt;/ul&gt;\n&lt;p&gt;感觉当当玩具还是不错的.\n最后放上使用截图啦！\n&lt;/p&gt;&lt;figure class=\&quot;markdown-image-wrapper\&quot;&gt;&lt;img src=\&quot;/img/img_11.png\&quot; alt=\&quot;部署完成\&quot; loading=\&quot;lazy\&quot; decoding=\&quot;async\&quot; class=\&quot;markdown-image\&quot;&gt;&lt;/figure&gt;\n&lt;figure class=\&quot;markdown-image-wrapper\&quot;&gt;&lt;img src=\&quot;/img/img_12.png\&quot; alt=\&quot;开始使用\&quot; loading=\&quot;lazy\&quot; decoding=\&quot;async\&quot; class=\&quot;markdown-image\&quot;&gt;&lt;/figure&gt;&lt;p&gt;&lt;/p&gt;&quot;],&quot;metadata&quot;:[0,{&quot;headings&quot;:[1,[[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;一硬件与系统环境&quot;],&quot;text&quot;:[0,&quot;一、硬件与系统环境&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;二架构总览&quot;],&quot;text&quot;:[0,&quot;二、架构总览&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;三部署步骤&quot;],&quot;text&quot;:[0,&quot;三、部署步骤&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;31-目录结构&quot;],&quot;text&quot;:[0,&quot;3.1 目录结构&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;32-创建-telegram-bot&quot;],&quot;text&quot;:[0,&quot;3.2 创建 Telegram Bot&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;33-环境变量配置&quot;],&quot;text&quot;:[0,&quot;3.3 环境变量配置&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;34-安装-python-依赖&quot;],&quot;text&quot;:[0,&quot;3.4 安装 Python 依赖&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;35-部署主程序&quot;],&quot;text&quot;:[0,&quot;3.5 部署主程序&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;36-systemd-服务&quot;],&quot;text&quot;:[0,&quot;3.6 systemd 服务&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;37-验证&quot;],&quot;text&quot;:[0,&quot;3.7 验证&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;四踩坑全记录重点&quot;],&quot;text&quot;:[0,&quot;四、踩坑全记录（重点）&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;坑-1google-generativeai-已废弃必须换-google-genai&quot;],&quot;text&quot;:[0,&quot;坑 1：google-generativeai 已废弃，必须换 google-genai&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;坑-2新-sdk-没有-genaiconfigure&quot;],&quot;text&quot;:[0,&quot;坑 2：新 SDK 没有 genai.configure()&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;坑-3gemini-api-地理位置限制数据中心出口-ip&quot;],&quot;text&quot;:[0,&quot;坑 3：Gemini API 地理位置限制（数据中心出口 IP）&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;坑-4telegram-markdown-解析炸裂&quot;],&quot;text&quot;:[0,&quot;坑 4：Telegram Markdown 解析炸裂&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;坑-5gemini-图片生成-temperature-必须为-10&quot;],&quot;text&quot;:[0,&quot;坑 5：Gemini 图片生成 temperature 必须为 1.0&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;坑-6gpt-5-系列参数兼容变更&quot;],&quot;text&quot;:[0,&quot;坑 6：GPT-5 系列参数兼容变更&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;五最终能力与安全策略&quot;],&quot;text&quot;:[0,&quot;五、最终能力与安全策略&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;基础命令&quot;],&quot;text&quot;:[0,&quot;基础命令&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;主要能力&quot;],&quot;text&quot;:[0,&quot;主要能力&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;安全机制&quot;],&quot;text&quot;:[0,&quot;安全机制&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;六经验总结&quot;],&quot;text&quot;:[0,&quot;六、经验总结&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;七踩坑速查表&quot;],&quot;text&quot;:[0,&quot;七、踩坑速查表&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;八结语&quot;],&quot;text&quot;:[0,&quot;八、结语&quot;]}]]],&quot;localImagePaths&quot;:[1,[]],&quot;remoteImagePaths&quot;:[1,[]],&quot;frontmatter&quot;:[0,{&quot;title&quot;:[0,&quot;在 RK3528 ARM 开发板上部署 OpenClaw + Telegram Bot 全记录&quot;],&quot;date&quot;:[3,&quot;2026-02-07T10:30:00.000Z&quot;],&quot;tags&quot;:[1,[[0,&quot;OpenClaw&quot;],[0,&quot;Telegram Bot&quot;],[0,&quot;RK3528&quot;],[0,&quot;Armbian&quot;],[0,&quot;AI Agent&quot;]]],&quot;categories&quot;:[0,&quot;技术教程&quot;]}],&quot;imagePaths&quot;:[1,[]]}]}],&quot;collection&quot;:[0,&quot;blog&quot;]}],&quot;href&quot;:[0,&quot;/blog/post/45&quot;]}],[0,{&quot;post&quot;:[0,{&quot;id&quot;:[0,&quot;rust-树结构中-rc-与-weak-的配合使用&quot;],&quot;data&quot;:[0,{&quot;title&quot;:[0,&quot;Rust 树结构中 Rc 与 Weak 的配合使用&quot;],&quot;description&quot;:[0,&quot;深入探讨在 Rust 中构建树结构时，如何通过 Rc 和 Weak 智能指针的配合使用来避免循环引用导致的内存泄漏。本文详细讲解父子节点之间的引用关系设计原则，以及为什么父节点用 Rc 指向子节点，而子节点用 Weak 指向父节点。&quot;],&quot;date&quot;:[3,&quot;2025-12-06T00:00:00.000Z&quot;],&quot;tags&quot;:[1,[[0,&quot;Rust&quot;],[0,&quot;Rc&quot;],[0,&quot;Weak&quot;],[0,&quot;Smart Pointers&quot;],[0,&quot;Data Structures&quot;]]]}],&quot;body&quot;:[0,&quot;在 Rust 中构建树形数据结构时，我们经常需要处理父子节点之间的双向引用关系。如果处理不当，会导致循环引用（circular reference）和内存泄漏。本文将详细介绍如何通过 `Rc` 和 `Weak` 智能指针的配合使用来优雅地解决这个问题。\n\n## 核心原则\n\n在树结构中，节点之间的引用遵循以下原则：\n\n**父节点指向子节点：使用 `Rc&lt;T&gt;`**\n**子节点指向父节点：使用 `Weak&lt;T&gt;`**\n\n这个设计模式是避免循环引用的关键。\n\n## 为什么需要 Weak？\n\n### 循环引用问题\n\n如果我们同时使用 `Rc` 来表示父子双向引用，会产生循环引用：\n\n```rust\nuse std::rc::Rc;\nuse std::cell::RefCell;\n\n// ❌ 错误示例：会导致循环引用\nstruct Node {\n    value: i32,\n    parent: Option&lt;Rc&lt;RefCell&lt;Node&gt;&gt;&gt;,    // 使用 Rc 指向父节点\n    children: Vec&lt;Rc&lt;RefCell&lt;Node&gt;&gt;&gt;,     // 使用 Rc 指向子节点\n}\n```\n\n在这种设计下：\n\n- 父节点持有子节点的 `Rc`，引用计数 +1\n- 子节点持有父节点的 `Rc`，引用计数 +1\n- 当树结构离开作用域时，父子节点互相持有对方的强引用，引用计数永远不会降为 0\n- 结果：内存泄漏\n\n### 使用 Weak 打破循环\n\n`Weak&lt;T&gt;` 是一种不影响引用计数的\&quot;弱引用\&quot;。它可以观察 `Rc&lt;T&gt;` 指向的数据，但不会阻止数据被释放。\n\n```rust\nuse std::rc::{Rc, Weak};\nuse std::cell::RefCell;\n\n// ✅ 正确示例：使用 Weak 打破循环引用\nstruct Node {\n    value: i32,\n    parent: Option&lt;Weak&lt;RefCell&lt;Node&gt;&gt;&gt;,  // 使用 Weak 指向父节点\n    children: Vec&lt;Rc&lt;RefCell&lt;Node&gt;&gt;&gt;,     // 使用 Rc 指向子节点\n}\n\nimpl Node {\n    fn new(value: i32) -&gt; Rc&lt;RefCell&lt;Node&gt;&gt; {\n        Rc::new(RefCell::new(Node {\n            value,\n            parent: None,\n            children: Vec::new(),\n        }))\n    }\n}\n```\n\n## 所有权关系分析\n\n### 所有权流向\n\n在树结构中，所有权的流向是从上到下的：\n\n1. **父节点拥有子节点**：父节点通过 `Rc&lt;RefCell&lt;Node&gt;&gt;` 持有子节点的所有权\n2. **子节点不拥有父节点**：子节点通过 `Weak&lt;RefCell&lt;Node&gt;&gt;` 观察父节点，但不持有所有权\n3. **释放顺序**：当根节点被释放时，子节点的引用计数会递减，最终整棵树被正确释放\n\n### 为什么是这个方向？\n\n这个设计符合树结构的自然语义：\n\n- **父节点控制子节点的生命周期**：父节点存在，子节点才有意义\n- **子节点不应该延长父节点的生命**：子节点被某处引用时，不应该阻止父节点（乃至整棵树）被释放\n- **访问父节点需要检查有效性**：通过 `Weak::upgrade()` 访问父节点时，会得到 `Option&lt;Rc&lt;T&gt;&gt;`，自动处理父节点已被释放的情况\n\n## 实际使用示例\n\n```rust\nuse std::rc::{Rc, Weak};\nuse std::cell::RefCell;\n\nstruct Node {\n    value: i32,\n    parent: Option&lt;Weak&lt;RefCell&lt;Node&gt;&gt;&gt;,\n    children: Vec&lt;Rc&lt;RefCell&lt;Node&gt;&gt;&gt;,\n}\n\nimpl Node {\n    fn new(value: i32) -&gt; Rc&lt;RefCell&lt;Node&gt;&gt; {\n        Rc::new(RefCell::new(Node {\n            value,\n            parent: None,\n            children: Vec::new(),\n        }))\n    }\n\n    fn add_child(parent: &amp;Rc&lt;RefCell&lt;Node&gt;&gt;, child_value: i32) -&gt; Rc&lt;RefCell&lt;Node&gt;&gt; {\n        let child = Node::new(child_value);\n\n        // 子节点设置父节点的弱引用\n        child.borrow_mut().parent = Some(Rc::downgrade(parent));\n\n        // 父节点添加子节点的强引用\n        parent.borrow_mut().children.push(Rc::clone(&amp;child));\n\n        child\n    }\n\n    fn get_parent_value(node: &amp;Rc&lt;RefCell&lt;Node&gt;&gt;) -&gt; Option&lt;i32&gt; {\n        node.borrow()\n            .parent\n            .as_ref()\n            .and_then(|weak_parent| weak_parent.upgrade()) // 尝试升级为强引用\n            .map(|parent| parent.borrow().value)\n    }\n}\n\nfn main() {\n    // 创建根节点\n    let root = Node::new(1);\n\n    // 添加子节点\n    let child1 = Node::add_child(&amp;root, 2);\n    let child2 = Node::add_child(&amp;root, 3);\n\n    // 为子节点添加子节点\n    let grandchild = Node::add_child(&amp;child1, 4);\n\n    // 访问父节点\n    println!(\&quot;Grandchild&#39;s parent: {:?}\&quot;, Node::get_parent_value(&amp;grandchild)); // Some(2)\n    println!(\&quot;Child1&#39;s parent: {:?}\&quot;, Node::get_parent_value(&amp;child1));         // Some(1)\n\n    // 当 root 离开作用域时，整棵树会被正确释放\n}\n```\n\n## RefCell 的作用\n\n你可能注意到我们使用了 `Rc&lt;RefCell&lt;Node&gt;&gt;` 而不是 `Rc&lt;Node&gt;`。这是因为：\n\n- `Rc&lt;T&gt;` 提供共享所有权，但只允许不可变借用\n- `RefCell&lt;T&gt;` 提供内部可变性，允许在运行时进行可变借用检查\n- 组合使用可以实现\&quot;多个所有者可以修改数据\&quot;的需求\n\n在树结构中，我们需要从父节点修改子节点（添加子节点），也需要从子节点设置父节点引用，因此需要 `RefCell` 提供的内部可变性。\n\n## 关键要点总结\n\n1. **父 → 子：`Rc`**，表示强引用和所有权\n2. **子 → 父：`Weak`**，表示弱引用和观察关系\n3. **访问 Weak 引用**：使用 `upgrade()` 方法尝试获取 `Rc`，返回 `Option&lt;Rc&lt;T&gt;&gt;`\n4. **创建 Weak 引用**：使用 `Rc::downgrade()` 从 `Rc` 创建 `Weak`\n5. **避免循环引用**：Weak 不增加引用计数，打破循环\n6. **配合 RefCell**：实现共享可变性\n\n通过这种设计模式，我们可以在 Rust 中安全地构建复杂的树形数据结构，既满足所有权规则，又避免内存泄漏。&quot;],&quot;filePath&quot;:[0,&quot;source/posts/Rust-树结构中-Rc-与-Weak-的配合使用.md&quot;],&quot;digest&quot;:[0,&quot;95fd25134235bb5b&quot;],&quot;rendered&quot;:[0,{&quot;html&quot;:[0,&quot;&lt;p&gt;在 Rust 中构建树形数据结构时，我们经常需要处理父子节点之间的双向引用关系。如果处理不当，会导致循环引用（circular reference）和内存泄漏。本文将详细介绍如何通过 &lt;code&gt;Rc&lt;/code&gt; 和 &lt;code&gt;Weak&lt;/code&gt; 智能指针的配合使用来优雅地解决这个问题。&lt;/p&gt;\n&lt;h2 id=\&quot;核心原则\&quot;&gt;核心原则&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#核心原则\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;在树结构中，节点之间的引用遵循以下原则：&lt;/p&gt;\n&lt;p&gt;&lt;strong&gt;父节点指向子节点：使用 &lt;code&gt;Rc&amp;#x3C;T&gt;&lt;/code&gt;&lt;/strong&gt;\n&lt;strong&gt;子节点指向父节点：使用 &lt;code&gt;Weak&amp;#x3C;T&gt;&lt;/code&gt;&lt;/strong&gt;&lt;/p&gt;\n&lt;p&gt;这个设计模式是避免循环引用的关键。&lt;/p&gt;\n&lt;h2 id=\&quot;为什么需要-weak\&quot;&gt;为什么需要 Weak？&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#为什么需要-weak\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;h3 id=\&quot;循环引用问题\&quot;&gt;循环引用问题&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#循环引用问题\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;如果我们同时使用 &lt;code&gt;Rc&lt;/code&gt; 来表示父子双向引用，会产生循环引用：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;rust\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;use&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; std&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;rc&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Rc&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;use&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; std&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;cell&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;RefCell&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// ❌ 错误示例：会导致循环引用&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;struct&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Node&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    value&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;:&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; i32&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    parent&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;:&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Option&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Rc&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;RefCell&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Node&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&gt;&gt;&gt;,    &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 使用 Rc 指向父节点&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    children&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;:&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Vec&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Rc&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;RefCell&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Node&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&gt;&gt;&gt;,     &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 使用 Rc 指向子节点&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;在这种设计下：&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;父节点持有子节点的 &lt;code&gt;Rc&lt;/code&gt;，引用计数 +1&lt;/li&gt;\n&lt;li&gt;子节点持有父节点的 &lt;code&gt;Rc&lt;/code&gt;，引用计数 +1&lt;/li&gt;\n&lt;li&gt;当树结构离开作用域时，父子节点互相持有对方的强引用，引用计数永远不会降为 0&lt;/li&gt;\n&lt;li&gt;结果：内存泄漏&lt;/li&gt;\n&lt;/ul&gt;\n&lt;h3 id=\&quot;使用-weak-打破循环\&quot;&gt;使用 Weak 打破循环&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#使用-weak-打破循环\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;&lt;code&gt;Weak&amp;#x3C;T&gt;&lt;/code&gt; 是一种不影响引用计数的”弱引用”。它可以观察 &lt;code&gt;Rc&amp;#x3C;T&gt;&lt;/code&gt; 指向的数据，但不会阻止数据被释放。&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;rust\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;use&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; std&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;rc&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;{&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Rc&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Weak&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;};&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;use&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; std&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;cell&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;RefCell&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// ✅ 正确示例：使用 Weak 打破循环引用&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;struct&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Node&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    value&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;:&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; i32&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    parent&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;:&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Option&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Weak&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;RefCell&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Node&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&gt;&gt;&gt;,  &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 使用 Weak 指向父节点&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    children&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;:&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Vec&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Rc&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;RefCell&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Node&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&gt;&gt;&gt;,     &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 使用 Rc 指向子节点&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;impl&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Node&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    fn&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; new&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(value&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;:&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; i32&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;) &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;-&gt;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Rc&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;RefCell&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Node&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&gt;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;        Rc&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;new&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;RefCell&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;new&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Node&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;            value,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;            parent&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;:&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; None&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;            children&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;:&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Vec&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;new&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(),&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;        }))&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h2 id=\&quot;所有权关系分析\&quot;&gt;所有权关系分析&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#所有权关系分析\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;h3 id=\&quot;所有权流向\&quot;&gt;所有权流向&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#所有权流向\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;在树结构中，所有权的流向是从上到下的：&lt;/p&gt;\n&lt;ol&gt;\n&lt;li&gt;&lt;strong&gt;父节点拥有子节点&lt;/strong&gt;：父节点通过 &lt;code&gt;Rc&amp;#x3C;RefCell&amp;#x3C;Node&gt;&gt;&lt;/code&gt; 持有子节点的所有权&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;子节点不拥有父节点&lt;/strong&gt;：子节点通过 &lt;code&gt;Weak&amp;#x3C;RefCell&amp;#x3C;Node&gt;&gt;&lt;/code&gt; 观察父节点，但不持有所有权&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;释放顺序&lt;/strong&gt;：当根节点被释放时，子节点的引用计数会递减，最终整棵树被正确释放&lt;/li&gt;\n&lt;/ol&gt;\n&lt;h3 id=\&quot;为什么是这个方向\&quot;&gt;为什么是这个方向？&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#为什么是这个方向\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;这个设计符合树结构的自然语义：&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;strong&gt;父节点控制子节点的生命周期&lt;/strong&gt;：父节点存在，子节点才有意义&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;子节点不应该延长父节点的生命&lt;/strong&gt;：子节点被某处引用时，不应该阻止父节点（乃至整棵树）被释放&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;访问父节点需要检查有效性&lt;/strong&gt;：通过 &lt;code&gt;Weak::upgrade()&lt;/code&gt; 访问父节点时，会得到 &lt;code&gt;Option&amp;#x3C;Rc&amp;#x3C;T&gt;&gt;&lt;/code&gt;，自动处理父节点已被释放的情况&lt;/li&gt;\n&lt;/ul&gt;\n&lt;h2 id=\&quot;实际使用示例\&quot;&gt;实际使用示例&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#实际使用示例\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;rust\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;use&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; std&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;rc&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;{&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Rc&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Weak&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;};&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;use&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; std&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;cell&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;RefCell&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;struct&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Node&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    value&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;:&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; i32&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    parent&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;:&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Option&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Weak&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;RefCell&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Node&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&gt;&gt;&gt;,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    children&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;:&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Vec&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Rc&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;RefCell&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Node&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&gt;&gt;&gt;,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;impl&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Node&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    fn&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; new&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(value&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;:&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; i32&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;) &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;-&gt;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Rc&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;RefCell&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Node&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&gt;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;        Rc&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;new&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;RefCell&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;new&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Node&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;            value,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;            parent&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;:&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; None&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;            children&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;:&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Vec&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;new&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(),&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;        }))&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    fn&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; add_child&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(parent&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;:&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; &amp;#x26;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Rc&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;RefCell&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Node&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&gt;&gt;, child_value&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;:&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; i32&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;) &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;-&gt;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Rc&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;RefCell&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Node&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&gt;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;        let&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; child &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Node&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;new&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(child_value);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;        // 子节点设置父节点的弱引用&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;        child&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;borrow_mut&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;()&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;.&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;parent &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Some&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Rc&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;downgrade&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(parent));&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;        // 父节点添加子节点的强引用&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;        parent&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;borrow_mut&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;()&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;.&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;children&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;push&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Rc&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;clone&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;&amp;#x26;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;child));&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;        child&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    fn&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; get_parent_value&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(node&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;:&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; &amp;#x26;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Rc&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;RefCell&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Node&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&gt;&gt;) &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;-&gt;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Option&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;i32&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;        node&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;borrow&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;()&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;            .&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;parent&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;            .&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;as_ref&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;()&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;            .&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;and_then&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;|&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;weak_parent&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;|&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; weak_parent&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;upgrade&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;()) &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 尝试升级为强引用&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;            .&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;map&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;|&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;parent&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;|&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; parent&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;borrow&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;()&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;.&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;value)&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;fn&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; main&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;() {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;    // 创建根节点&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    let&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; root &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Node&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;new&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;1&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;    // 添加子节点&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    let&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; child1 &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Node&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;add_child&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;&amp;#x26;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;root, &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;2&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    let&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; child2 &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Node&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;add_child&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;&amp;#x26;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;root, &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;3&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;    // 为子节点添加子节点&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    let&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; grandchild &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Node&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;add_child&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;&amp;#x26;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;child1, &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;4&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;    // 访问父节点&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;    println!&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;\&quot;Grandchild&#39;s parent: {:?}\&quot;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Node&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;get_parent_value&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;&amp;#x26;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;grandchild)); &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// Some(2)&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;    println!&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;\&quot;Child1&#39;s parent: {:?}\&quot;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Node&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;get_parent_value&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;&amp;#x26;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;child1));         &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// Some(1)&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;    // 当 root 离开作用域时，整棵树会被正确释放&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h2 id=\&quot;refcell-的作用\&quot;&gt;RefCell 的作用&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#refcell-的作用\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;你可能注意到我们使用了 &lt;code&gt;Rc&amp;#x3C;RefCell&amp;#x3C;Node&gt;&gt;&lt;/code&gt; 而不是 &lt;code&gt;Rc&amp;#x3C;Node&gt;&lt;/code&gt;。这是因为：&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;code&gt;Rc&amp;#x3C;T&gt;&lt;/code&gt; 提供共享所有权，但只允许不可变借用&lt;/li&gt;\n&lt;li&gt;&lt;code&gt;RefCell&amp;#x3C;T&gt;&lt;/code&gt; 提供内部可变性，允许在运行时进行可变借用检查&lt;/li&gt;\n&lt;li&gt;组合使用可以实现”多个所有者可以修改数据”的需求&lt;/li&gt;\n&lt;/ul&gt;\n&lt;p&gt;在树结构中，我们需要从父节点修改子节点（添加子节点），也需要从子节点设置父节点引用，因此需要 &lt;code&gt;RefCell&lt;/code&gt; 提供的内部可变性。&lt;/p&gt;\n&lt;h2 id=\&quot;关键要点总结\&quot;&gt;关键要点总结&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#关键要点总结\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;ol&gt;\n&lt;li&gt;&lt;strong&gt;父 → 子：&lt;code&gt;Rc&lt;/code&gt;&lt;/strong&gt;，表示强引用和所有权&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;子 → 父：&lt;code&gt;Weak&lt;/code&gt;&lt;/strong&gt;，表示弱引用和观察关系&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;访问 Weak 引用&lt;/strong&gt;：使用 &lt;code&gt;upgrade()&lt;/code&gt; 方法尝试获取 &lt;code&gt;Rc&lt;/code&gt;，返回 &lt;code&gt;Option&amp;#x3C;Rc&amp;#x3C;T&gt;&gt;&lt;/code&gt;&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;创建 Weak 引用&lt;/strong&gt;：使用 &lt;code&gt;Rc::downgrade()&lt;/code&gt; 从 &lt;code&gt;Rc&lt;/code&gt; 创建 &lt;code&gt;Weak&lt;/code&gt;&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;避免循环引用&lt;/strong&gt;：Weak 不增加引用计数，打破循环&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;配合 RefCell&lt;/strong&gt;：实现共享可变性&lt;/li&gt;\n&lt;/ol&gt;\n&lt;p&gt;通过这种设计模式，我们可以在 Rust 中安全地构建复杂的树形数据结构，既满足所有权规则，又避免内存泄漏。&lt;/p&gt;&quot;],&quot;metadata&quot;:[0,{&quot;headings&quot;:[1,[[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;核心原则&quot;],&quot;text&quot;:[0,&quot;核心原则&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;为什么需要-weak&quot;],&quot;text&quot;:[0,&quot;为什么需要 Weak？&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;循环引用问题&quot;],&quot;text&quot;:[0,&quot;循环引用问题&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;使用-weak-打破循环&quot;],&quot;text&quot;:[0,&quot;使用 Weak 打破循环&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;所有权关系分析&quot;],&quot;text&quot;:[0,&quot;所有权关系分析&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;所有权流向&quot;],&quot;text&quot;:[0,&quot;所有权流向&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;为什么是这个方向&quot;],&quot;text&quot;:[0,&quot;为什么是这个方向？&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;实际使用示例&quot;],&quot;text&quot;:[0,&quot;实际使用示例&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;refcell-的作用&quot;],&quot;text&quot;:[0,&quot;RefCell 的作用&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;关键要点总结&quot;],&quot;text&quot;:[0,&quot;关键要点总结&quot;]}]]],&quot;localImagePaths&quot;:[1,[]],&quot;remoteImagePaths&quot;:[1,[]],&quot;frontmatter&quot;:[0,{&quot;title&quot;:[0,&quot;Rust 树结构中 Rc 与 Weak 的配合使用&quot;],&quot;date&quot;:[3,&quot;2025-12-06T00:00:00.000Z&quot;],&quot;tags&quot;:[1,[[0,&quot;Rust&quot;],[0,&quot;Rc&quot;],[0,&quot;Weak&quot;],[0,&quot;Smart Pointers&quot;],[0,&quot;Data Structures&quot;]]],&quot;description&quot;:[0,&quot;深入探讨在 Rust 中构建树结构时，如何通过 Rc 和 Weak 智能指针的配合使用来避免循环引用导致的内存泄漏。本文详细讲解父子节点之间的引用关系设计原则，以及为什么父节点用 Rc 指向子节点，而子节点用 Weak 指向父节点。&quot;]}],&quot;imagePaths&quot;:[1,[]]}]}],&quot;collection&quot;:[0,&quot;blog&quot;]}],&quot;href&quot;:[0,&quot;/blog/post/38&quot;]}],[0,{&quot;post&quot;:[0,{&quot;id&quot;:[0,&quot;rust-cow-learning-notes&quot;],&quot;data&quot;:[0,{&quot;title&quot;:[0,&quot;Rust Cow（Clone-On-Write）学习笔记：理解 Borrowed 状态&quot;],&quot;description&quot;:[0,&quot;本文通过一个具体的测试案例，深入探讨了 Rust 中 Cow（Clone-On-Write）智能指针的 Borrowed 状态。我们将理解在何种情况下 Cow 会保持借用，以及它何时会克隆数据变为所有。&quot;],&quot;date&quot;:[3,&quot;2025-12-05T00:00:00.000Z&quot;],&quot;tags&quot;:[1,[[0,&quot;Rust&quot;],[0,&quot;Cow&quot;],[0,&quot;Smart Pointers&quot;],[0,&quot;Borrowing&quot;]]]}],&quot;body&quot;:[0,&quot;在 Rust 的智能指针中，`Cow` (Clone-On-Write) 提供了一种灵活的数据处理方式，它可以在需要时才进行数据克隆，从而优化性能。本文将通过一个具体的案例，来深入理解 `Cow` 的 `Borrowed` 状态。\n\n### `Cow::Borrowed` 是什么？\n\n在 Rust 中，`Cow` 类型有两种主要的状态：\n\n- `Cow::Borrowed&lt;&#39;a, T&gt;`：表示 `Cow` 只是“借用”了原始数据，它持有一个对类型 `T` 的不可变引用 `&amp;&#39;a T`。在这种状态下，`Cow` 不拥有数据的所有权，也不会对原始数据进行任何修改。\n- `Cow::Owned&lt;T&gt;`：表示 `Cow` 拥有了一份数据的副本。当需要修改数据，且 `Cow` 当前处于 `Borrowed` 状态时，它会自动克隆一份数据，并转换为 `Owned` 状态，从而允许进行修改。\n\n### 案例分析：`reference_no_mutation` 测试\n\n我们来看一个在 `rustlings` 练习中常见的测试案例，它帮助我们理解 `Cow` 的行为：\n\n```rust\n// 假设有如下的 abs_all 函数\nfn abs_all&lt;&#39;a, T&gt;(input: Cow&lt;&#39;a, [T]&gt;) -&gt; Cow&lt;&#39;a, [T]&gt;\nwhere\n    T: Clone + Copy + PartialOrd + std::ops::Neg&lt;Output = T&gt;,\n{\n    input\n        .into_iter()\n        .map(|&amp;x| if x &lt; T::from(0) { -x } else { x })\n        .collect::&lt;Vec&lt;T&gt;&gt;()\n        .into()\n}\n\n// 在 reference_no_mutation 测试中\nlet input_vec = vec![0, 1, 2];\nlet mut input = Cow::from(&amp;input_vec); // 通过 Cow::from(&amp;vec) 创建，此时 input 是 Borrowed 状态\nlet result = abs_all(input.clone()); // 传入 abs_all 函数\n\nassert!(matches!(input, Cow::Borrowed(_))); // 这个断言会成功\n```\n\n**分析过程：**\n\n1.  **创建 `Cow`：** 在 `reference_no_mutation` 测试中，`input` 是通过 `Cow::from(&amp;input_vec)` 创建的。这意味着 `input` 最初是对 `input_vec` 的一个借用 (`Cow::Borrowed`)，它不拥有数据的所有权。\n\n2.  **`abs_all` 函数的行为：** `abs_all` 函数的目的是将切片中的所有负数变为正数（取绝对值）。它通过 `into_iter().map(...)` 遍历元素。关键在于 `map` 内部的逻辑：`if x &lt; T::from(0) { -x } else { x }`。只有当元素 `x` 小于 0 时，才会进行操作 `-x`。\n\n3.  **无修改发生：** 在这个特定的测试中，`input_vec` 的内容是 `[0, 1, 2]`，所有元素都是非负数。因此，在 `abs_all` 函数内部，条件 `x &lt; T::from(0)` **从未**满足。这意味着 `input`（或者其内部数据）并没有被实际修改。\n\n4.  **`to_mut()` 未被调用：** `Cow` 只有在需要修改借用的数据时，才会调用 `to_mut()` 方法来克隆数据并转换为 `Owned` 状态。由于上述原因，没有任何元素需要修改，所以 `to_mut()` 从未被调用。\n\n5.  **结果：保持 `Borrowed` 状态：** 因为 `input` 在 `abs_all` 函数的整个执行过程中都没有被修改，也因此没有触发数据克隆，`input` 仍然保持着对原始数据 `input_vec` 的借用状态。\n\n### 结论\n\n因此，`assert!(matches!(input, Cow::Borrowed(_)))` 断言成立。这个例子清晰地展示了 `Cow` 的“Copy-On-Write”机制：只有在实际需要写入（修改）时，才会发生数据的克隆和所有权的转移。如果数据仅仅被读取，`Cow` 会高效地保持 `Borrowed` 状态，避免不必要的内存分配和数据复制。理解这一点对于编写高效的 Rust 代码至关重要。&quot;],&quot;filePath&quot;:[0,&quot;source/posts/rust-cow-learning-notes.md&quot;],&quot;digest&quot;:[0,&quot;dbda7a0aedd34573&quot;],&quot;rendered&quot;:[0,{&quot;html&quot;:[0,&quot;&lt;p&gt;在 Rust 的智能指针中，&lt;code&gt;Cow&lt;/code&gt; (Clone-On-Write) 提供了一种灵活的数据处理方式，它可以在需要时才进行数据克隆，从而优化性能。本文将通过一个具体的案例，来深入理解 &lt;code&gt;Cow&lt;/code&gt; 的 &lt;code&gt;Borrowed&lt;/code&gt; 状态。&lt;/p&gt;\n&lt;h3 id=\&quot;cowborrowed-是什么\&quot;&gt;&lt;code&gt;Cow::Borrowed&lt;/code&gt; 是什么？&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#cowborrowed-是什么\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;在 Rust 中，&lt;code&gt;Cow&lt;/code&gt; 类型有两种主要的状态：&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;code&gt;Cow::Borrowed&amp;#x3C;&#39;a, T&gt;&lt;/code&gt;：表示 &lt;code&gt;Cow&lt;/code&gt; 只是“借用”了原始数据，它持有一个对类型 &lt;code&gt;T&lt;/code&gt; 的不可变引用 &lt;code&gt;&amp;#x26;&#39;a T&lt;/code&gt;。在这种状态下，&lt;code&gt;Cow&lt;/code&gt; 不拥有数据的所有权，也不会对原始数据进行任何修改。&lt;/li&gt;\n&lt;li&gt;&lt;code&gt;Cow::Owned&amp;#x3C;T&gt;&lt;/code&gt;：表示 &lt;code&gt;Cow&lt;/code&gt; 拥有了一份数据的副本。当需要修改数据，且 &lt;code&gt;Cow&lt;/code&gt; 当前处于 &lt;code&gt;Borrowed&lt;/code&gt; 状态时，它会自动克隆一份数据，并转换为 &lt;code&gt;Owned&lt;/code&gt; 状态，从而允许进行修改。&lt;/li&gt;\n&lt;/ul&gt;\n&lt;h3 id=\&quot;案例分析reference_no_mutation-测试\&quot;&gt;案例分析：&lt;code&gt;reference_no_mutation&lt;/code&gt; 测试&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#案例分析reference_no_mutation-测试\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;我们来看一个在 &lt;code&gt;rustlings&lt;/code&gt; 练习中常见的测试案例，它帮助我们理解 &lt;code&gt;Cow&lt;/code&gt; 的行为：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;rust\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 假设有如下的 abs_all 函数&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;fn&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; abs_all&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&#39;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;a&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;T&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&gt;(input&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;:&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Cow&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&#39;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;a&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, [&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;T&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;]&gt;) &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;-&gt;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Cow&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&#39;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;a&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, [&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;T&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;]&gt;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;where&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;    T&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;:&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Clone&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; +&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Copy&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; +&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; PartialOrd&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; +&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; std&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;ops&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Neg&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Output&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; T&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&gt;,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;{&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    input&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;        .&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;into_iter&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;()&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;        .&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;map&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;|&amp;#x26;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;x&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;|&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; if&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; x &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; T&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;from&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;0&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;) { &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;-&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;x } &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;else&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; { x })&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;        .&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;collect&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Vec&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;T&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&gt;&gt;()&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;        .&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;into&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;()&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 在 reference_no_mutation 测试中&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;let&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; input_vec &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; vec!&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;[&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;0&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;1&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;2&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;];&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;let&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; mut&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; input &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Cow&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;from&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;&amp;#x26;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;input_vec); &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 通过 Cow::from(&amp;#x26;vec) 创建，此时 input 是 Borrowed 状态&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;let&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; result &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; abs_all&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(input&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;clone&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;()); &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 传入 abs_all 函数&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;assert!&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;matches!&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(input, &lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Cow&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Borrowed&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(_))); &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 这个断言会成功&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;&lt;strong&gt;分析过程：&lt;/strong&gt;&lt;/p&gt;\n&lt;ol&gt;\n&lt;li&gt;\n&lt;p&gt;&lt;strong&gt;创建 &lt;code&gt;Cow&lt;/code&gt;：&lt;/strong&gt; 在 &lt;code&gt;reference_no_mutation&lt;/code&gt; 测试中，&lt;code&gt;input&lt;/code&gt; 是通过 &lt;code&gt;Cow::from(&amp;#x26;input_vec)&lt;/code&gt; 创建的。这意味着 &lt;code&gt;input&lt;/code&gt; 最初是对 &lt;code&gt;input_vec&lt;/code&gt; 的一个借用 (&lt;code&gt;Cow::Borrowed&lt;/code&gt;)，它不拥有数据的所有权。&lt;/p&gt;\n&lt;/li&gt;\n&lt;li&gt;\n&lt;p&gt;&lt;strong&gt;&lt;code&gt;abs_all&lt;/code&gt; 函数的行为：&lt;/strong&gt; &lt;code&gt;abs_all&lt;/code&gt; 函数的目的是将切片中的所有负数变为正数（取绝对值）。它通过 &lt;code&gt;into_iter().map(...)&lt;/code&gt; 遍历元素。关键在于 &lt;code&gt;map&lt;/code&gt; 内部的逻辑：&lt;code&gt;if x &amp;#x3C; T::from(0) { -x } else { x }&lt;/code&gt;。只有当元素 &lt;code&gt;x&lt;/code&gt; 小于 0 时，才会进行操作 &lt;code&gt;-x&lt;/code&gt;。&lt;/p&gt;\n&lt;/li&gt;\n&lt;li&gt;\n&lt;p&gt;&lt;strong&gt;无修改发生：&lt;/strong&gt; 在这个特定的测试中，&lt;code&gt;input_vec&lt;/code&gt; 的内容是 &lt;code&gt;[0, 1, 2]&lt;/code&gt;，所有元素都是非负数。因此，在 &lt;code&gt;abs_all&lt;/code&gt; 函数内部，条件 &lt;code&gt;x &amp;#x3C; T::from(0)&lt;/code&gt; &lt;strong&gt;从未&lt;/strong&gt;满足。这意味着 &lt;code&gt;input&lt;/code&gt;（或者其内部数据）并没有被实际修改。&lt;/p&gt;\n&lt;/li&gt;\n&lt;li&gt;\n&lt;p&gt;&lt;strong&gt;&lt;code&gt;to_mut()&lt;/code&gt; 未被调用：&lt;/strong&gt; &lt;code&gt;Cow&lt;/code&gt; 只有在需要修改借用的数据时，才会调用 &lt;code&gt;to_mut()&lt;/code&gt; 方法来克隆数据并转换为 &lt;code&gt;Owned&lt;/code&gt; 状态。由于上述原因，没有任何元素需要修改，所以 &lt;code&gt;to_mut()&lt;/code&gt; 从未被调用。&lt;/p&gt;\n&lt;/li&gt;\n&lt;li&gt;\n&lt;p&gt;&lt;strong&gt;结果：保持 &lt;code&gt;Borrowed&lt;/code&gt; 状态：&lt;/strong&gt; 因为 &lt;code&gt;input&lt;/code&gt; 在 &lt;code&gt;abs_all&lt;/code&gt; 函数的整个执行过程中都没有被修改，也因此没有触发数据克隆，&lt;code&gt;input&lt;/code&gt; 仍然保持着对原始数据 &lt;code&gt;input_vec&lt;/code&gt; 的借用状态。&lt;/p&gt;\n&lt;/li&gt;\n&lt;/ol&gt;\n&lt;h3 id=\&quot;结论\&quot;&gt;结论&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#结论\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;因此，&lt;code&gt;assert!(matches!(input, Cow::Borrowed(_)))&lt;/code&gt; 断言成立。这个例子清晰地展示了 &lt;code&gt;Cow&lt;/code&gt; 的“Copy-On-Write”机制：只有在实际需要写入（修改）时，才会发生数据的克隆和所有权的转移。如果数据仅仅被读取，&lt;code&gt;Cow&lt;/code&gt; 会高效地保持 &lt;code&gt;Borrowed&lt;/code&gt; 状态，避免不必要的内存分配和数据复制。理解这一点对于编写高效的 Rust 代码至关重要。&lt;/p&gt;&quot;],&quot;metadata&quot;:[0,{&quot;headings&quot;:[1,[[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;cowborrowed-是什么&quot;],&quot;text&quot;:[0,&quot;Cow::Borrowed 是什么？&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;案例分析reference_no_mutation-测试&quot;],&quot;text&quot;:[0,&quot;案例分析：reference_no_mutation 测试&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;结论&quot;],&quot;text&quot;:[0,&quot;结论&quot;]}]]],&quot;localImagePaths&quot;:[1,[]],&quot;remoteImagePaths&quot;:[1,[]],&quot;frontmatter&quot;:[0,{&quot;title&quot;:[0,&quot;Rust Cow（Clone-On-Write）学习笔记：理解 Borrowed 状态&quot;],&quot;date&quot;:[3,&quot;2025-12-05T00:00:00.000Z&quot;],&quot;tags&quot;:[1,[[0,&quot;Rust&quot;],[0,&quot;Cow&quot;],[0,&quot;Smart Pointers&quot;],[0,&quot;Borrowing&quot;]]],&quot;description&quot;:[0,&quot;本文通过一个具体的测试案例，深入探讨了 Rust 中 Cow（Clone-On-Write）智能指针的 Borrowed 状态。我们将理解在何种情况下 Cow 会保持借用，以及它何时会克隆数据变为所有。&quot;]}],&quot;imagePaths&quot;:[1,[]]}]}],&quot;collection&quot;:[0,&quot;blog&quot;]}],&quot;href&quot;:[0,&quot;/blog/post/37&quot;]}],[0,{&quot;post&quot;:[0,{&quot;id&quot;:[0,&quot;electron热更新后启动性能优化-v8缓存与代码拆包实战&quot;],&quot;data&quot;:[0,{&quot;title&quot;:[0,&quot;Electron 热更新后启动性能优化：V8 缓存与代码拆包实战&quot;],&quot;description&quot;:[0,&quot;深入实战 Electron 应用性能优化，通过启用 V8 代码缓存、Vite 模块拆包、按需导入和延迟加载等手段，将主进程启动时间从 1619ms 优化到 311ms，性能提升 80%。详解 V8 JIT 编译原理、manualChunks 拆包策略及实际优化效果对比。&quot;],&quot;date&quot;:[3,&quot;2025-11-18T18:00:00.000Z&quot;],&quot;tags&quot;:[1,[[0,&quot;Electron&quot;],[0,&quot;性能优化&quot;],[0,&quot;V8&quot;],[0,&quot;Vite&quot;],[0,&quot;热更新&quot;]]],&quot;categories&quot;:[0,&quot;技术教程&quot;]}],&quot;body&quot;:[0,&quot;## 前言\n\n在 Electron 应用开发中，热更新后的首次启动速度直接影响用户体验。将主进程启动时间从 1619ms 优化到 311ms 的完整实践过程。\n\n## 性能数据对比\n\n通过以下优化手段，我们实现了显著的性能提升：\n\n| 指标                   | 优化前    | 优化后   | 提升幅度    |\n| ---------------------- | --------- | -------- | ----------- |\n| **主进程启动总耗时**   | 1619.32ms | 311.88ms | **80.7% ↓** |\n| **app.whenReady 耗时** | 833.46ms  | 126.61ms | **84.8% ↓** |\n| **窗口创建耗时**       | 536.34ms  | 140.59ms | **73.8% ↓** |\n| **V8 缓存文件数量**    | 9543 个   | 9043 个  | 优化后稳定  |\n\n从实际日志数据来看：\n\n```log\n# 优化前（2025-11-18 16:37:59）\n[info] ⏱️ 主进程启动开始\n[info] ⏱️ app.whenReady 触发，耗时: 833.46ms\n[info] 📦 V8 代码缓存文件数量: 9543\n[info] ⏱️ 窗口创建耗时: 536.34ms\n[info] ⏱️ ✅ 主进程启动完成，总耗时: 1619.32ms\n\n# 优化后（2025-11-18 17:10:30）\n[info] ⏱️ 主进程启动开始\n[info] ⏱️ app.whenReady 触发，耗时: 126.61ms\n[info] 📦 V8 代码缓存文件数量: 9043\n[info] ⏱️ 窗口创建耗时: 140.59ms\n[info] ⏱️ ✅ 主进程启动完成，总耗时: 311.88ms\n```\n\n## 核心优化策略\n\n### 1. 启用 V8 代码缓存\n\nV8 代码缓存（Code Cache）是 Chrome 和 Node.js 中用于加速 JavaScript 代码执行的重要机制。通过缓存编译后的字节码，可以避免重复的解析和编译过程。\n\n#### 实现方式\n\n在 Electron 主进程启动时添加命令行开关：\n\n```typescript\n// src/main/index.ts\n\n// 启用 V8 代码缓存优化，加速冷启动\napp.commandLine.appendSwitch(&#39;enable-features&#39;, &#39;V8CodeCache&#39;);\napp.commandLine.appendSwitch(&#39;v8-cache-options&#39;, &#39;code&#39;);\n```\n\n#### 验证缓存效果\n\n在 `app.whenReady()` 中添加监控代码：\n\n```typescript\napp.whenReady().then(async () =&gt; {\n  const readyTime = performance.now();\n  log.info(\n    `⏱️ app.whenReady 触发，耗时: ${(readyTime - startupTime).toFixed(2)}ms`,\n  );\n\n  // 验证 V8 代码缓存\n  const cacheDir = join(app.getPath(&#39;userData&#39;), &#39;Code Cache&#39;, &#39;js&#39;);\n  try {\n    const fs = await import(&#39;fs&#39;);\n    if (fs.existsSync(cacheDir)) {\n      const cacheFiles = fs.readdirSync(cacheDir);\n      log.info(`📦 V8 代码缓存文件数量: ${cacheFiles.length}`);\n    } else {\n      log.info(&#39;📦 V8 代码缓存目录不存在（首次启动会自动创建）&#39;);\n    }\n  } catch (error) {\n    log.warn(&#39;无法检查 V8 缓存目录:&#39;, error);\n  }\n});\n```\n\n#### 工作原理\n\nV8 引擎在执行 JavaScript 时的流程：\n\n1. **解析（Parsing）**：将源代码转换为抽象语法树（AST）\n2. **编译（Compilation）**：将 AST 编译为字节码\n3. **执行（Execution）**：V8 解释器执行字节码\n\n启用代码缓存后：\n\n- **首次运行**：V8 生成字节码并缓存到磁盘\n- **后续运行**：直接加载缓存的字节码，跳过解析和编译阶段\n\n### 2. 模块拆包（Code Splitting）—— 核心优化\n\n这是本次优化中最关键的一步。**通过 Vite 配置将单一的 `main.js` 拆分为多个独立的 `utils/*.js` 文件，显著降低 V8 的 JIT 编译压力。**\n\n#### 问题背景：为什么需要拆包？\n\n在优化前，项目使用 `src/main/utils/index.ts` 统一导出所有工具函数：\n\n```typescript\n// src/main/utils/index.ts（优化前）\nexport * from &#39;./aesEncode&#39;;\nexport * from &#39;./notifi&#39;;\nexport * from &#39;./tray&#39;;\nexport * from &#39;./latex2Docx&#39;;\nexport * from &#39;./pathUtils&#39;;\n// ... 导出几十个工具模块\n```\n\nVite 打包后，所有工具代码会被 Tree Shaking 和 Rollup 合并到**单一的 `main.js` 文件**中。这会导致：\n\n1. **巨型 JS 文件**：main.js 可能超过几 MB，包含所有工具函数代码\n2. **JIT 热点集中**：V8 引擎在启动时需要：\n   - 解析整个大文件的 AST（抽象语法树）\n   - 为所有函数生成字节码\n   - 识别热点函数并进行 JIT 优化编译\n3. **缓存粒度粗**：任何一个工具函数的修改都会导致整个 main.js 的 V8 缓存失效\n\n#### Vite 配置方案\n\n通过 `manualChunks` 配置，我们将每个 utils 模块拆分为独立的 chunk：\n\n```typescript\n// src/main/vite.config.ts\n\nexport default defineConfig({\n  build: {\n    rollupOptions: {\n      external: [\n        &#39;electron&#39;,\n        &#39;node-screenshots&#39;,\n        ...builtinModules,\n        ...Object.keys(pkg.dependencies || {}),\n        ...Object.keys(pkg.devDependencies || {}),\n      ],\n      output: {\n        // 🔥 关键配置：将 utils 模块拆分为独立 chunk\n        manualChunks(id) {\n          // 为每个 utils 模块创建独立的 chunk\n          if (id.includes(&#39;src/main/utils/&#39;) &amp;&amp; !id.includes(&#39;index.ts&#39;)) {\n            // 提取模块名称\n            // 例如：src/main/utils/aesEncode.ts -&gt; utils/aesEncode\n            const match = id.match(/utils\\/([^/]+)\\.(ts|js)/);\n            if (match) {\n              return `utils/${match[1]}`;\n            }\n          }\n          return undefined; // 其他模块使用默认分包策略\n        },\n      },\n    },\n  },\n});\n```\n\n#### 拆包效果对比\n\n**优化前的打包结构：**\n\n```\ndist/main/\n├── main.js          ← 单一巨型文件（包含所有代码）\n└── main.js.map\n```\n\n**优化后的打包结构：**\n\n```\ndist/main/\n├── main.js                    ← 主入口文件（精简）\n├── utils/\n│   ├── aesEncode.js          ← 独立工具模块\n│   ├── notifi.js\n│   ├── tray.js\n│   ├── latex2Docx.js\n│   ├── pathUtils.js\n│   ├── renderLocalStrongHandle.js\n│   ├── rustScreenshotWindow.js\n│   ├── updateRender.js\n│   └── ... 其他工具模块\n└── *.js.map\n```\n\n#### 拆包如何降低 JIT 热点编译压力？\n\n**1. 减少单次解析负担**\n\nV8 的解析器（Parser）是单线程的，巨型文件会阻塞启动流程：\n\n```\n优化前：解析 5MB 的 main.js（耗时 ~800ms）\n优化后：解析 500KB 的 main.js + 按需加载小模块（耗时 ~120ms）\n```\n\n**2. 按需 JIT 编译**\n\nV8 的 JIT 编译器（TurboFan）会识别热点函数并进行优化编译。拆包后：\n\n- **冷启动时**：只有主入口 `main.js` 中的代码被立即编译\n- **运行时**：当调用 `utils/notifi.js` 时，才加载并编译该模块\n- **避免过度优化**：非热点代码不会浪费 CPU 时间进行无谓的优化\n\n**3. 更细粒度的 V8 缓存**\n\n从日志可以看到，优化后 V8 缓存文件数量从 9543 个降到 9043 个，但性能反而提升了：\n\n```log\n优化前：📦 V8 代码缓存文件数量: 9543  ← 大量小缓存 + 巨型 main.js 缓存\n优化后：📦 V8 代码缓存文件数量: 9043  ← 精简且高效的缓存结构\n```\n\n这是因为：\n\n- 每个 utils 模块的缓存是独立的\n- 修改 `utils/notifi.js` 时，只需重新生成该文件的缓存\n- `main.js`、`utils/tray.js` 等其他模块的缓存继续有效\n\n**4. 降低内存压力**\n\n巨型文件会导致更多的内存占用：\n\n- **优化前**：5MB 的 main.js 在解析阶段会生成大量临时 AST 节点对象\n- **优化后**：小文件的 AST 更快被垃圾回收，降低内存峰值\n\n#### 实际性能提升\n\n结合日志数据分析，拆包带来的直接效果：\n\n| 指标               | 优化前   | 优化后   | 说明                                       |\n| ------------------ | -------- | -------- | ------------------------------------------ |\n| app.whenReady 耗时 | 833.46ms | 126.61ms | **减少 84.8%**，主要归功于拆包减少解析时间 |\n| 窗口创建耗时       | 536.34ms | 140.59ms | **减少 73.8%**，主流程代码更精简           |\n\n#### 注意事项\n\n1. **不要拆分过细**：每个文件应有一定体积（建议 &gt;10KB），否则模块加载开销会抵消拆包收益\n2. **排除 index.ts**：`utils/index.ts` 只是导出聚合文件，不应单独成为 chunk\n3. **外部化原生模块**：如 `electron` 必须标记为 external，避免打包失败\n\n#### 日志中的证据\n\n对比日志可以看到拆包优化的关键时间点：\n\n```log\n# 优化前：巨型文件导致启动缓慢\n[2025-11-18 16:38:00.298] ⏱️ app.whenReady 触发，耗时: 833.46ms  ← 解析耗时长\n[2025-11-18 16:38:00.951] unzipper模块加载成功                    ← 延迟加载\n\n# 优化后：拆包后模块提前加载，启动迅速\n[2025-11-18 17:10:30.749] unzipper模块加载成功                    ← 立即加载\n[2025-11-18 17:10:30.810] ⏱️ app.whenReady 触发，耗时: 166.22ms  ← 解析耗时大幅降低\n```\n\n拆包后，原本需要延迟加载的模块（如 `unzipper`）可以更快加载，因为它们不再被打包到巨型 `main.js` 中。\n\n**关键优化：原生模块提前加载**\n\n从日志时间戳可以看到一个有趣的现象：\n\n```log\n# 优化前：原生模块在 app.whenReady 之后才加载\n[16:37:59.464] 主进程启动开始\n[16:38:00.298] app.whenReady 触发，耗时: 833.46ms\n[16:38:00.951] unzipper模块加载成功                          ← +1470ms（严重延迟）\n\n# 优化后：原生模块立即加载\n[17:10:30.776] 主进程启动开始\n[17:10:30.851] unzipper模块加载成功                          ← +75ms（几乎同时）\n[17:10:30.903] app.whenReady 触发，耗时: 126.61ms\n```\n\n**为什么会这样？**\n\n这是因为优化前 `unzipper` 模块被打包到 `main.js` 的深层依赖中，只有在整个巨型文件解析完成后才能执行它们的初始化代码。拆包后：\n\n1. 这些模块成为独立的 chunk\n2. ESM 的并行加载机制可以更早地加载它们\n3. 不再被 main.js 的解析阻塞\n\n这进一步验证了**拆包对启动流程的巨大优化作用**。\n\n### 3. 按需导入依赖（Tree Shaking）\n\n大型库的全量导入会引入大量未使用的代码，增加启动开销。\n\n#### 优化前\n\n```typescript\nimport * as lodash from &#39;lodash-es&#39;;\n\n// 使用时\nwin.on(\n  &#39;moved&#39;,\n  lodash.throttle(() =&gt; {\n    /* ... */\n  }, 500),\n);\n```\n\n#### 优化后\n\n```typescript\n// 只导入需要的函数\nimport { throttle, debounce } from &#39;lodash-es&#39;;\n\nwin.on(\n  &#39;moved&#39;,\n  throttle(() =&gt; {\n    /* ... */\n  }, 500),\n);\n```\n\n#### 效果分析\n\n- 减少 bundle 体积\n- 降低 V8 解析负担\n- 提升 Tree Shaking 效率\n\n### 4. 延迟加载非关键模块\n\n将非启动必需的功能（如划词翻译）延迟到主窗口创建完成后再初始化。\n\n#### 实现方案\n\n```typescript\n// 优化前：同步导入，阻塞启动\nimport &#39;./utils/selectionWord/ipcListener&#39;;\nimport {\n  cleanupTranslation,\n  initTranslationShortcut,\n} from &#39;./utils/selectionWord/init&#39;;\n\napp.whenReady().then(async () =&gt; {\n  // ...创建主窗口\n  mainWin = await createWindow();\n\n  initTranslationShortcut(); // 阻塞启动流程\n});\n```\n\n```typescript\n// 优化后：异步动态导入，不阻塞启动\napp.whenReady().then(async () =&gt; {\n  // ...创建主窗口\n  mainWin = await createWindow();\n\n  // 延迟初始化划词翻译，避免阻塞主窗口启动\n  setImmediate(async () =&gt; {\n    const translationStart = performance.now();\n    try {\n      // 动态导入模块\n      await import(&#39;./utils/selectionWord/ipcListener&#39;);\n      const { initTranslationShortcut } =\n        await import(&#39;./utils/selectionWord/init&#39;);\n      initTranslationShortcut();\n\n      const translationEnd = performance.now();\n      log.info(\n        `⏱️ 划词翻译功能已初始化，耗时: ${(translationEnd - translationStart).toFixed(2)}ms`,\n      );\n    } catch (error) {\n      log.error(&#39;初始化划词翻译失败:&#39;, error);\n    }\n  });\n\n  const totalTime = performance.now();\n  log.info(\n    `⏱️ ✅ 主进程启动完成，总耗时: ${(totalTime - startupTime).toFixed(2)}ms`,\n  );\n});\n```\n\n#### 关键技术点\n\n1. **使用 `setImmediate`**：确保主窗口完全初始化后再加载\n2. **动态 `import()`**：按需加载模块，不影响主流程\n3. **错误隔离**：避免非核心功能的失败影响主程序\n\n日志输出显示划词翻译初始化耗时约 70-123ms，通过延迟加载完全不影响主窗口启动：\n\n```log\n[info] ⏱️ ✅ 主进程启动完成，总耗时: 311.88ms\n[info] ⏱️ 划词翻译功能已初始化，耗时: 59.88ms\n```\n\n### 5. 性能监控埋点\n\n在关键路径添加时间戳记录，便于定位性能瓶颈。\n\n```typescript\n// 启动开始\nconst startupTime = performance.now();\nlog.info(&#39;⏱️ 主进程启动开始&#39;);\n\n// app.whenReady 触发\napp.whenReady().then(async () =&gt; {\n  const readyTime = performance.now();\n  log.info(\n    `⏱️ app.whenReady 触发，耗时: ${(readyTime - startupTime).toFixed(2)}ms`,\n  );\n\n  // 窗口创建\n  const createWindowStart = performance.now();\n  mainWin = await createWindow();\n  const createWindowEnd = performance.now();\n  log.info(\n    `⏱️ 窗口创建耗时: ${(createWindowEnd - createWindowStart).toFixed(2)}ms`,\n  );\n\n  // 总耗时\n  const totalTime = performance.now();\n  log.info(\n    `⏱️ ✅ 主进程启动完成，总耗时: ${(totalTime - startupTime).toFixed(2)}ms`,\n  );\n});\n```\n\n## 常见问题\n\n### Q1: V8 缓存文件会无限增长吗？\n\nA: 不会。Electron 会自动管理缓存大小，定期清理过期文件。通常缓存目录大小在几十 MB 左右。\n\n### Q2: 代码拆包会影响运行时性能吗？\n\nA: 影响极小。模块拆分后，V8 的模块加载机制（ESM）可以高效处理多文件依赖，且拆包后的缓存粒度更细，整体性能反而更优。\n\n### Q3: 动态 import 会导致功能延迟吗？\n\nA: 对用户几乎无感知。以划词翻译为例，从主窗口启动到用户实际使用该功能有足够的时间差，异步加载完全可以在用户操作前完成。\n\n## 总结\n\n通过本次优化，我们实现了：\n\n1. **启动速度提升 80%+**：从 1.6s 降至 0.3s\n2. **用户体验改善**：热更新后几乎无感知\n3. **可维护性提升**：性能监控埋点便于后续定位问题\n\n关键要点：\n\n- **模块拆包是核心**：将单一 `main.js` 拆分为多个 `utils/*.js` 文件，显著降低 V8 的 JIT 热点编译压力（app.whenReady 耗时从 833ms 降至 126ms）\n- **V8 缓存是基础**：启用代码缓存跳过重复的解析和编译过程\n- **延迟加载优化关键路径**：非关键功能异步加载，不阻塞主窗口启动\n- **性能监控提供数据支撑**：埋点日志帮助定位瓶颈\n\n**最重要的启示：**\n\n在 Electron 应用中，**打包产物的结构比打包体积更重要**。一个 5MB 的巨型 `main.js` 文件对 V8 引擎来说是灾难，即使它的总代码量并不大。通过 Vite 的 `manualChunks` 配置，将代码拆分为合理的模块结构，让 V8 能够按需解析和编译，这才是启动性能优化的关键。\n\nElectron 性能优化是一个持续的过程，建议定期检查启动日志，针对性地优化瓶颈环节。\n\n---&quot;],&quot;filePath&quot;:[0,&quot;source/posts/Electron热更新后启动性能优化-V8缓存与代码拆包实战.md&quot;],&quot;digest&quot;:[0,&quot;01a3ecd10b29cfc0&quot;],&quot;rendered&quot;:[0,{&quot;html&quot;:[0,&quot;&lt;h2 id=\&quot;前言\&quot;&gt;前言&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#前言\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;在 Electron 应用开发中，热更新后的首次启动速度直接影响用户体验。将主进程启动时间从 1619ms 优化到 311ms 的完整实践过程。&lt;/p&gt;\n&lt;h2 id=\&quot;性能数据对比\&quot;&gt;性能数据对比&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#性能数据对比\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;通过以下优化手段，我们实现了显著的性能提升：&lt;/p&gt;\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;指标&lt;/th&gt;&lt;th&gt;优化前&lt;/th&gt;&lt;th&gt;优化后&lt;/th&gt;&lt;th&gt;提升幅度&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;&lt;strong&gt;主进程启动总耗时&lt;/strong&gt;&lt;/td&gt;&lt;td&gt;1619.32ms&lt;/td&gt;&lt;td&gt;311.88ms&lt;/td&gt;&lt;td&gt;&lt;strong&gt;80.7% ↓&lt;/strong&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;strong&gt;app.whenReady 耗时&lt;/strong&gt;&lt;/td&gt;&lt;td&gt;833.46ms&lt;/td&gt;&lt;td&gt;126.61ms&lt;/td&gt;&lt;td&gt;&lt;strong&gt;84.8% ↓&lt;/strong&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;strong&gt;窗口创建耗时&lt;/strong&gt;&lt;/td&gt;&lt;td&gt;536.34ms&lt;/td&gt;&lt;td&gt;140.59ms&lt;/td&gt;&lt;td&gt;&lt;strong&gt;73.8% ↓&lt;/strong&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;strong&gt;V8 缓存文件数量&lt;/strong&gt;&lt;/td&gt;&lt;td&gt;9543 个&lt;/td&gt;&lt;td&gt;9043 个&lt;/td&gt;&lt;td&gt;优化后稳定&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;\n&lt;p&gt;从实际日志数据来看：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;log\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;# 优化前（&lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;2025-11-18&lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt; 16:37:59&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;）&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;[info]&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; ⏱️ 主进程启动开始&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;[info]&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; ⏱️ &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;app.whenReady&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; 触发，耗时: &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;833&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;.46ms&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;[info]&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; 📦 V8 代码缓存文件数量: &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;9543&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;[info]&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; ⏱️ 窗口创建耗时: &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;536&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;.34ms&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;[info]&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; ⏱️ ✅ 主进程启动完成，总耗时: &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;1619&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;.32ms&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;# 优化后（&lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;2025-11-18&lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt; 17:10:30&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;）&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;[info]&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; ⏱️ 主进程启动开始&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;[info]&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; ⏱️ &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;app.whenReady&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; 触发，耗时: &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;126&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;.61ms&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;[info]&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; 📦 V8 代码缓存文件数量: &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;9043&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;[info]&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; ⏱️ 窗口创建耗时: &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;140&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;.59ms&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;[info]&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; ⏱️ ✅ 主进程启动完成，总耗时: &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;311&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;.88ms&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h2 id=\&quot;核心优化策略\&quot;&gt;核心优化策略&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#核心优化策略\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;h3 id=\&quot;1-启用-v8-代码缓存\&quot;&gt;1. 启用 V8 代码缓存&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#1-启用-v8-代码缓存\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;V8 代码缓存（Code Cache）是 Chrome 和 Node.js 中用于加速 JavaScript 代码执行的重要机制。通过缓存编译后的字节码，可以避免重复的解析和编译过程。&lt;/p&gt;\n&lt;h4 id=\&quot;实现方式\&quot;&gt;实现方式&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#实现方式\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h4&gt;\n&lt;p&gt;在 Electron 主进程启动时添加命令行开关：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;typescript\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// src/main/index.ts&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 启用 V8 代码缓存优化，加速冷启动&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;app.commandLine.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;appendSwitch&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;enable-features&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;V8CodeCache&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;app.commandLine.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;appendSwitch&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;v8-cache-options&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;code&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h4 id=\&quot;验证缓存效果\&quot;&gt;验证缓存效果&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#验证缓存效果\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h4&gt;\n&lt;p&gt;在 &lt;code&gt;app.whenReady()&lt;/code&gt; 中添加监控代码：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;typescript\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;app.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;whenReady&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;().&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;then&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;async&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; () &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; readyTime&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; performance.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;now&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;();&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  log.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;info&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;    `⏱️ app.whenReady 触发，耗时: ${&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;readyTime&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; -&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; startupTime&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;).&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;toFixed&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;2&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;)&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;}ms`&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  );&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;  // 验证 V8 代码缓存&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; cacheDir&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; join&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(app.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;getPath&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;userData&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;), &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;Code Cache&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;js&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  try&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; fs&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; await&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; import&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;fs&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    if&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; (fs.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;existsSync&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(cacheDir)) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;      const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; cacheFiles&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; fs.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;readdirSync&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(cacheDir);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      log.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;info&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;`📦 V8 代码缓存文件数量: ${&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;cacheFiles&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;.&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;length&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;}`&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    } &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;else&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      log.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;info&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;📦 V8 代码缓存目录不存在（首次启动会自动创建）&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  } &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;catch&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; (error) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    log.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;warn&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;无法检查 V8 缓存目录:&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, error);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;});&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h4 id=\&quot;工作原理\&quot;&gt;工作原理&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#工作原理\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h4&gt;\n&lt;p&gt;V8 引擎在执行 JavaScript 时的流程：&lt;/p&gt;\n&lt;ol&gt;\n&lt;li&gt;&lt;strong&gt;解析（Parsing）&lt;/strong&gt;：将源代码转换为抽象语法树（AST）&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;编译（Compilation）&lt;/strong&gt;：将 AST 编译为字节码&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;执行（Execution）&lt;/strong&gt;：V8 解释器执行字节码&lt;/li&gt;\n&lt;/ol&gt;\n&lt;p&gt;启用代码缓存后：&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;strong&gt;首次运行&lt;/strong&gt;：V8 生成字节码并缓存到磁盘&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;后续运行&lt;/strong&gt;：直接加载缓存的字节码，跳过解析和编译阶段&lt;/li&gt;\n&lt;/ul&gt;\n&lt;h3 id=\&quot;2-模块拆包code-splitting-核心优化\&quot;&gt;2. 模块拆包（Code Splitting）—— 核心优化&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#2-模块拆包code-splitting-核心优化\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;这是本次优化中最关键的一步。&lt;strong&gt;通过 Vite 配置将单一的 &lt;code&gt;main.js&lt;/code&gt; 拆分为多个独立的 &lt;code&gt;utils/*.js&lt;/code&gt; 文件，显著降低 V8 的 JIT 编译压力。&lt;/strong&gt;&lt;/p&gt;\n&lt;h4 id=\&quot;问题背景为什么需要拆包\&quot;&gt;问题背景：为什么需要拆包？&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#问题背景为什么需要拆包\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h4&gt;\n&lt;p&gt;在优化前，项目使用 &lt;code&gt;src/main/utils/index.ts&lt;/code&gt; 统一导出所有工具函数：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;typescript\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// src/main/utils/index.ts（优化前）&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;export&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; *&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; from&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; &#39;./aesEncode&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;export&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; *&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; from&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; &#39;./notifi&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;export&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; *&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; from&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; &#39;./tray&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;export&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; *&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; from&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; &#39;./latex2Docx&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;export&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; *&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; from&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; &#39;./pathUtils&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// ... 导出几十个工具模块&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;Vite 打包后，所有工具代码会被 Tree Shaking 和 Rollup 合并到&lt;strong&gt;单一的 &lt;code&gt;main.js&lt;/code&gt; 文件&lt;/strong&gt;中。这会导致：&lt;/p&gt;\n&lt;ol&gt;\n&lt;li&gt;&lt;strong&gt;巨型 JS 文件&lt;/strong&gt;：main.js 可能超过几 MB，包含所有工具函数代码&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;JIT 热点集中&lt;/strong&gt;：V8 引擎在启动时需要：\n&lt;ul&gt;\n&lt;li&gt;解析整个大文件的 AST（抽象语法树）&lt;/li&gt;\n&lt;li&gt;为所有函数生成字节码&lt;/li&gt;\n&lt;li&gt;识别热点函数并进行 JIT 优化编译&lt;/li&gt;\n&lt;/ul&gt;\n&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;缓存粒度粗&lt;/strong&gt;：任何一个工具函数的修改都会导致整个 main.js 的 V8 缓存失效&lt;/li&gt;\n&lt;/ol&gt;\n&lt;h4 id=\&quot;vite-配置方案\&quot;&gt;Vite 配置方案&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#vite-配置方案\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h4&gt;\n&lt;p&gt;通过 &lt;code&gt;manualChunks&lt;/code&gt; 配置，我们将每个 utils 模块拆分为独立的 chunk：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;typescript\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// src/main/vite.config.ts&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;export&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; default&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; defineConfig&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;({&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  build: {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    rollupOptions: {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      external: [&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;        &#39;electron&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;        &#39;node-screenshots&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;        ...&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;builtinModules,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;        ...&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;Object.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;keys&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(pkg.dependencies &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;||&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {}),&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;        ...&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;Object.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;keys&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(pkg.devDependencies &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;||&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {}),&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      ],&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      output: {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;        // 🔥 关键配置：将 utils 模块拆分为独立 chunk&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;        manualChunks&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;id&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;          // 为每个 utils 模块创建独立的 chunk&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;          if&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; (id.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;includes&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;src/main/utils/&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;) &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;&amp;#x26;&amp;#x26;&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; !&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;id.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;includes&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;index.ts&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;)) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;            // 提取模块名称&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;            // 例如：src/main/utils/aesEncode.ts -&gt; utils/aesEncode&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;            const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; match&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; id.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;match&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;/&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#DBEDFF\&quot;&gt;utils&lt;/span&gt;&lt;span style=\&quot;color:#22863A;--shiki-light-font-weight:bold;--shiki-dark:#85E89D;--shiki-dark-font-weight:bold\&quot;&gt;\\/&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#DBEDFF\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;[&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;^&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;/]&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;+&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#DBEDFF\&quot;&gt;)&lt;/span&gt;&lt;span style=\&quot;color:#22863A;--shiki-light-font-weight:bold;--shiki-dark:#85E89D;--shiki-dark-font-weight:bold\&quot;&gt;\\.&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#DBEDFF\&quot;&gt;(ts&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;|&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#DBEDFF\&quot;&gt;js)&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;/&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;            if&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; (match) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;              return&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; `utils/${&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;match&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;[&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;1&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;]&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;}`&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;            }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;          }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;          return&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; undefined&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;; &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 其他模块使用默认分包策略&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;        },&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      },&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    },&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  },&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;});&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h4 id=\&quot;拆包效果对比\&quot;&gt;拆包效果对比&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#拆包效果对比\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h4&gt;\n&lt;p&gt;&lt;strong&gt;优化前的打包结构：&lt;/strong&gt;&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;plaintext\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;dist/main/&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;├── main.js          ← 单一巨型文件（包含所有代码）&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;└── main.js.map&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;&lt;strong&gt;优化后的打包结构：&lt;/strong&gt;&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;plaintext\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;dist/main/&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;├── main.js                    ← 主入口文件（精简）&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;├── utils/&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;│   ├── aesEncode.js          ← 独立工具模块&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;│   ├── notifi.js&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;│   ├── tray.js&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;│   ├── latex2Docx.js&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;│   ├── pathUtils.js&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;│   ├── renderLocalStrongHandle.js&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;│   ├── rustScreenshotWindow.js&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;│   ├── updateRender.js&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;│   └── ... 其他工具模块&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;└── *.js.map&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h4 id=\&quot;拆包如何降低-jit-热点编译压力\&quot;&gt;拆包如何降低 JIT 热点编译压力？&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#拆包如何降低-jit-热点编译压力\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h4&gt;\n&lt;p&gt;&lt;strong&gt;1. 减少单次解析负担&lt;/strong&gt;&lt;/p&gt;\n&lt;p&gt;V8 的解析器（Parser）是单线程的，巨型文件会阻塞启动流程：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;plaintext\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;优化前：解析 5MB 的 main.js（耗时 ~800ms）&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span&gt;优化后：解析 500KB 的 main.js + 按需加载小模块（耗时 ~120ms）&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;&lt;strong&gt;2. 按需 JIT 编译&lt;/strong&gt;&lt;/p&gt;\n&lt;p&gt;V8 的 JIT 编译器（TurboFan）会识别热点函数并进行优化编译。拆包后：&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;strong&gt;冷启动时&lt;/strong&gt;：只有主入口 &lt;code&gt;main.js&lt;/code&gt; 中的代码被立即编译&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;运行时&lt;/strong&gt;：当调用 &lt;code&gt;utils/notifi.js&lt;/code&gt; 时，才加载并编译该模块&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;避免过度优化&lt;/strong&gt;：非热点代码不会浪费 CPU 时间进行无谓的优化&lt;/li&gt;\n&lt;/ul&gt;\n&lt;p&gt;&lt;strong&gt;3. 更细粒度的 V8 缓存&lt;/strong&gt;&lt;/p&gt;\n&lt;p&gt;从日志可以看到，优化后 V8 缓存文件数量从 9543 个降到 9043 个，但性能反而提升了：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;log\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;优化前：📦 V8 代码缓存文件数量: &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;9543&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  ← 大量小缓存 + 巨型 &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;main.js&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; 缓存&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;优化后：📦 V8 代码缓存文件数量: &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;9043&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  ← 精简且高效的缓存结构&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;这是因为：&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;每个 utils 模块的缓存是独立的&lt;/li&gt;\n&lt;li&gt;修改 &lt;code&gt;utils/notifi.js&lt;/code&gt; 时，只需重新生成该文件的缓存&lt;/li&gt;\n&lt;li&gt;&lt;code&gt;main.js&lt;/code&gt;、&lt;code&gt;utils/tray.js&lt;/code&gt; 等其他模块的缓存继续有效&lt;/li&gt;\n&lt;/ul&gt;\n&lt;p&gt;&lt;strong&gt;4. 降低内存压力&lt;/strong&gt;&lt;/p&gt;\n&lt;p&gt;巨型文件会导致更多的内存占用：&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;strong&gt;优化前&lt;/strong&gt;：5MB 的 main.js 在解析阶段会生成大量临时 AST 节点对象&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;优化后&lt;/strong&gt;：小文件的 AST 更快被垃圾回收，降低内存峰值&lt;/li&gt;\n&lt;/ul&gt;\n&lt;h4 id=\&quot;实际性能提升\&quot;&gt;实际性能提升&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#实际性能提升\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h4&gt;\n&lt;p&gt;结合日志数据分析，拆包带来的直接效果：&lt;/p&gt;\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;指标&lt;/th&gt;&lt;th&gt;优化前&lt;/th&gt;&lt;th&gt;优化后&lt;/th&gt;&lt;th&gt;说明&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;app.whenReady 耗时&lt;/td&gt;&lt;td&gt;833.46ms&lt;/td&gt;&lt;td&gt;126.61ms&lt;/td&gt;&lt;td&gt;&lt;strong&gt;减少 84.8%&lt;/strong&gt;，主要归功于拆包减少解析时间&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;窗口创建耗时&lt;/td&gt;&lt;td&gt;536.34ms&lt;/td&gt;&lt;td&gt;140.59ms&lt;/td&gt;&lt;td&gt;&lt;strong&gt;减少 73.8%&lt;/strong&gt;，主流程代码更精简&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;\n&lt;h4 id=\&quot;注意事项\&quot;&gt;注意事项&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#注意事项\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h4&gt;\n&lt;ol&gt;\n&lt;li&gt;&lt;strong&gt;不要拆分过细&lt;/strong&gt;：每个文件应有一定体积（建议 &gt;10KB），否则模块加载开销会抵消拆包收益&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;排除 index.ts&lt;/strong&gt;：&lt;code&gt;utils/index.ts&lt;/code&gt; 只是导出聚合文件，不应单独成为 chunk&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;外部化原生模块&lt;/strong&gt;：如 &lt;code&gt;electron&lt;/code&gt; 必须标记为 external，避免打包失败&lt;/li&gt;\n&lt;/ol&gt;\n&lt;h4 id=\&quot;日志中的证据\&quot;&gt;日志中的证据&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#日志中的证据\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h4&gt;\n&lt;p&gt;对比日志可以看到拆包优化的关键时间点：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;log\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;# 优化前：巨型文件导致启动缓慢&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;[&lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;2025-11-18&lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt; 16:38:00.298&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;] ⏱️ &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;app.whenReady&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; 触发，耗时: &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;833&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;.46ms  ← 解析耗时长&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;[&lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;2025-11-18&lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt; 16:38:00.951&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;] unzipper模块加载成功                    ← 延迟加载&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;# 优化后：拆包后模块提前加载，启动迅速&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;[&lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;2025-11-18&lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt; 17:10:30.749&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;] unzipper模块加载成功                    ← 立即加载&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;[&lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;2025-11-18&lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt; 17:10:30.810&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;] ⏱️ &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;app.whenReady&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; 触发，耗时: &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;166&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;.22ms  ← 解析耗时大幅降低&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;拆包后，原本需要延迟加载的模块（如 &lt;code&gt;unzipper&lt;/code&gt;）可以更快加载，因为它们不再被打包到巨型 &lt;code&gt;main.js&lt;/code&gt; 中。&lt;/p&gt;\n&lt;p&gt;&lt;strong&gt;关键优化：原生模块提前加载&lt;/strong&gt;&lt;/p&gt;\n&lt;p&gt;从日志时间戳可以看到一个有趣的现象：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;log\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;# 优化前：原生模块在 &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;app.whenReady&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; 之后才加载&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;[&lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;16:37:59.464&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;] 主进程启动开始&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;[&lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;16:38:00.298&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;] &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;app.whenReady&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; 触发，耗时: &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;833&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;.46ms&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;[&lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;16:38:00.951&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;] unzipper模块加载成功                          ← +1470ms（严重延迟）&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;# 优化后：原生模块立即加载&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;[&lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;17:10:30.776&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;] 主进程启动开始&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;[&lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;17:10:30.851&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;] unzipper模块加载成功                          ← +75ms（几乎同时）&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;[&lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;17:10:30.903&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;] &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;app.whenReady&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; 触发，耗时: &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;126&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;.61ms&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;&lt;strong&gt;为什么会这样？&lt;/strong&gt;&lt;/p&gt;\n&lt;p&gt;这是因为优化前 &lt;code&gt;unzipper&lt;/code&gt; 模块被打包到 &lt;code&gt;main.js&lt;/code&gt; 的深层依赖中，只有在整个巨型文件解析完成后才能执行它们的初始化代码。拆包后：&lt;/p&gt;\n&lt;ol&gt;\n&lt;li&gt;这些模块成为独立的 chunk&lt;/li&gt;\n&lt;li&gt;ESM 的并行加载机制可以更早地加载它们&lt;/li&gt;\n&lt;li&gt;不再被 main.js 的解析阻塞&lt;/li&gt;\n&lt;/ol&gt;\n&lt;p&gt;这进一步验证了&lt;strong&gt;拆包对启动流程的巨大优化作用&lt;/strong&gt;。&lt;/p&gt;\n&lt;h3 id=\&quot;3-按需导入依赖tree-shaking\&quot;&gt;3. 按需导入依赖（Tree Shaking）&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#3-按需导入依赖tree-shaking\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;大型库的全量导入会引入大量未使用的代码，增加启动开销。&lt;/p&gt;\n&lt;h4 id=\&quot;优化前\&quot;&gt;优化前&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#优化前\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h4&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;typescript\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;import&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; *&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; as&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; lodash &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;from&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; &#39;lodash-es&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 使用时&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;win.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;on&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;  &#39;moved&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  lodash.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;throttle&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(() &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;    /* ... */&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  }, &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;500&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;),&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h4 id=\&quot;优化后\&quot;&gt;优化后&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#优化后\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h4&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;typescript\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 只导入需要的函数&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;import&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; { throttle, debounce } &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;from&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; &#39;lodash-es&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;win.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;on&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;  &#39;moved&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;  throttle&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(() &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;    /* ... */&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  }, &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;500&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;),&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h4 id=\&quot;效果分析\&quot;&gt;效果分析&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#效果分析\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h4&gt;\n&lt;ul&gt;\n&lt;li&gt;减少 bundle 体积&lt;/li&gt;\n&lt;li&gt;降低 V8 解析负担&lt;/li&gt;\n&lt;li&gt;提升 Tree Shaking 效率&lt;/li&gt;\n&lt;/ul&gt;\n&lt;h3 id=\&quot;4-延迟加载非关键模块\&quot;&gt;4. 延迟加载非关键模块&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#4-延迟加载非关键模块\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;将非启动必需的功能（如划词翻译）延迟到主窗口创建完成后再初始化。&lt;/p&gt;\n&lt;h4 id=\&quot;实现方案\&quot;&gt;实现方案&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#实现方案\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h4&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;typescript\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 优化前：同步导入，阻塞启动&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;import&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; &#39;./utils/selectionWord/ipcListener&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;import&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  cleanupTranslation,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  initTranslationShortcut,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;} &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;from&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; &#39;./utils/selectionWord/init&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;app.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;whenReady&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;().&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;then&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;async&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; () &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;  // ...创建主窗口&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  mainWin &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; await&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; createWindow&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;();&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;  initTranslationShortcut&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(); &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 阻塞启动流程&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;});&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;typescript\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 优化后：异步动态导入，不阻塞启动&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;app.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;whenReady&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;().&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;then&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;async&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; () &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;  // ...创建主窗口&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  mainWin &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; await&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; createWindow&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;();&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;  // 延迟初始化划词翻译，避免阻塞主窗口启动&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;  setImmediate&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;async&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; () &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; translationStart&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; performance.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;now&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;();&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    try&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;      // 动态导入模块&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;      await&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; import&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;./utils/selectionWord/ipcListener&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;      const&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; { &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;initTranslationShortcut&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; } &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;        await&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; import&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;./utils/selectionWord/init&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;      initTranslationShortcut&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;();&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;      const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; translationEnd&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; performance.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;now&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;();&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      log.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;info&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;        `⏱️ 划词翻译功能已初始化，耗时: ${&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;translationEnd&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; -&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; translationStart&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;).&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;toFixed&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;2&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;)&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;}ms`&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      );&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    } &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;catch&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; (error) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      log.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;error&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;初始化划词翻译失败:&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, error);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  });&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; totalTime&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; performance.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;now&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;();&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  log.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;info&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;    `⏱️ ✅ 主进程启动完成，总耗时: ${&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;totalTime&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; -&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; startupTime&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;).&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;toFixed&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;2&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;)&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;}ms`&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  );&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;});&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h4 id=\&quot;关键技术点\&quot;&gt;关键技术点&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#关键技术点\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h4&gt;\n&lt;ol&gt;\n&lt;li&gt;&lt;strong&gt;使用 &lt;code&gt;setImmediate&lt;/code&gt;&lt;/strong&gt;：确保主窗口完全初始化后再加载&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;动态 &lt;code&gt;import()&lt;/code&gt;&lt;/strong&gt;：按需加载模块，不影响主流程&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;错误隔离&lt;/strong&gt;：避免非核心功能的失败影响主程序&lt;/li&gt;\n&lt;/ol&gt;\n&lt;p&gt;日志输出显示划词翻译初始化耗时约 70-123ms，通过延迟加载完全不影响主窗口启动：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;log\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;[info]&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; ⏱️ ✅ 主进程启动完成，总耗时: &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;311&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;.88ms&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;[info]&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; ⏱️ 划词翻译功能已初始化，耗时: &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;59&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;.88ms&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h3 id=\&quot;5-性能监控埋点\&quot;&gt;5. 性能监控埋点&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#5-性能监控埋点\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;在关键路径添加时间戳记录，便于定位性能瓶颈。&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;typescript\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 启动开始&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; startupTime&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; performance.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;now&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;();&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;log.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;info&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;⏱️ 主进程启动开始&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// app.whenReady 触发&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;app.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;whenReady&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;().&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;then&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;async&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; () &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; readyTime&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; performance.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;now&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;();&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  log.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;info&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;    `⏱️ app.whenReady 触发，耗时: ${&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;readyTime&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; -&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; startupTime&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;).&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;toFixed&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;2&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;)&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;}ms`&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  );&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;  // 窗口创建&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; createWindowStart&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; performance.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;now&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;();&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  mainWin &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; await&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; createWindow&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;();&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; createWindowEnd&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; performance.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;now&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;();&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  log.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;info&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;    `⏱️ 窗口创建耗时: ${&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;createWindowEnd&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; -&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; createWindowStart&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;).&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;toFixed&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;2&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;)&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;}ms`&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  );&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;  // 总耗时&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; totalTime&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; performance.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;now&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;();&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  log.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;info&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;    `⏱️ ✅ 主进程启动完成，总耗时: ${&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;totalTime&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; -&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; startupTime&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;).&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;toFixed&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;2&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;)&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;}ms`&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  );&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;});&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h2 id=\&quot;常见问题\&quot;&gt;常见问题&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#常见问题\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;h3 id=\&quot;q1-v8-缓存文件会无限增长吗\&quot;&gt;Q1: V8 缓存文件会无限增长吗？&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#q1-v8-缓存文件会无限增长吗\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;A: 不会。Electron 会自动管理缓存大小，定期清理过期文件。通常缓存目录大小在几十 MB 左右。&lt;/p&gt;\n&lt;h3 id=\&quot;q2-代码拆包会影响运行时性能吗\&quot;&gt;Q2: 代码拆包会影响运行时性能吗？&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#q2-代码拆包会影响运行时性能吗\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;A: 影响极小。模块拆分后，V8 的模块加载机制（ESM）可以高效处理多文件依赖，且拆包后的缓存粒度更细，整体性能反而更优。&lt;/p&gt;\n&lt;h3 id=\&quot;q3-动态-import-会导致功能延迟吗\&quot;&gt;Q3: 动态 import 会导致功能延迟吗？&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#q3-动态-import-会导致功能延迟吗\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;A: 对用户几乎无感知。以划词翻译为例，从主窗口启动到用户实际使用该功能有足够的时间差，异步加载完全可以在用户操作前完成。&lt;/p&gt;\n&lt;h2 id=\&quot;总结\&quot;&gt;总结&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#总结\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;通过本次优化，我们实现了：&lt;/p&gt;\n&lt;ol&gt;\n&lt;li&gt;&lt;strong&gt;启动速度提升 80%+&lt;/strong&gt;：从 1.6s 降至 0.3s&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;用户体验改善&lt;/strong&gt;：热更新后几乎无感知&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;可维护性提升&lt;/strong&gt;：性能监控埋点便于后续定位问题&lt;/li&gt;\n&lt;/ol&gt;\n&lt;p&gt;关键要点：&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;strong&gt;模块拆包是核心&lt;/strong&gt;：将单一 &lt;code&gt;main.js&lt;/code&gt; 拆分为多个 &lt;code&gt;utils/*.js&lt;/code&gt; 文件，显著降低 V8 的 JIT 热点编译压力（app.whenReady 耗时从 833ms 降至 126ms）&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;V8 缓存是基础&lt;/strong&gt;：启用代码缓存跳过重复的解析和编译过程&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;延迟加载优化关键路径&lt;/strong&gt;：非关键功能异步加载，不阻塞主窗口启动&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;性能监控提供数据支撑&lt;/strong&gt;：埋点日志帮助定位瓶颈&lt;/li&gt;\n&lt;/ul&gt;\n&lt;p&gt;&lt;strong&gt;最重要的启示：&lt;/strong&gt;&lt;/p&gt;\n&lt;p&gt;在 Electron 应用中，&lt;strong&gt;打包产物的结构比打包体积更重要&lt;/strong&gt;。一个 5MB 的巨型 &lt;code&gt;main.js&lt;/code&gt; 文件对 V8 引擎来说是灾难，即使它的总代码量并不大。通过 Vite 的 &lt;code&gt;manualChunks&lt;/code&gt; 配置，将代码拆分为合理的模块结构，让 V8 能够按需解析和编译，这才是启动性能优化的关键。&lt;/p&gt;\n&lt;p&gt;Electron 性能优化是一个持续的过程，建议定期检查启动日志，针对性地优化瓶颈环节。&lt;/p&gt;\n&lt;hr&gt;&quot;],&quot;metadata&quot;:[0,{&quot;headings&quot;:[1,[[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;前言&quot;],&quot;text&quot;:[0,&quot;前言&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;性能数据对比&quot;],&quot;text&quot;:[0,&quot;性能数据对比&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;核心优化策略&quot;],&quot;text&quot;:[0,&quot;核心优化策略&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;1-启用-v8-代码缓存&quot;],&quot;text&quot;:[0,&quot;1. 启用 V8 代码缓存&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;实现方式&quot;],&quot;text&quot;:[0,&quot;实现方式&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;验证缓存效果&quot;],&quot;text&quot;:[0,&quot;验证缓存效果&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;工作原理&quot;],&quot;text&quot;:[0,&quot;工作原理&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;2-模块拆包code-splitting-核心优化&quot;],&quot;text&quot;:[0,&quot;2. 模块拆包（Code Splitting）—— 核心优化&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;问题背景为什么需要拆包&quot;],&quot;text&quot;:[0,&quot;问题背景：为什么需要拆包？&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;vite-配置方案&quot;],&quot;text&quot;:[0,&quot;Vite 配置方案&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;拆包效果对比&quot;],&quot;text&quot;:[0,&quot;拆包效果对比&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;拆包如何降低-jit-热点编译压力&quot;],&quot;text&quot;:[0,&quot;拆包如何降低 JIT 热点编译压力？&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;实际性能提升&quot;],&quot;text&quot;:[0,&quot;实际性能提升&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;注意事项&quot;],&quot;text&quot;:[0,&quot;注意事项&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;日志中的证据&quot;],&quot;text&quot;:[0,&quot;日志中的证据&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;3-按需导入依赖tree-shaking&quot;],&quot;text&quot;:[0,&quot;3. 按需导入依赖（Tree Shaking）&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;优化前&quot;],&quot;text&quot;:[0,&quot;优化前&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;优化后&quot;],&quot;text&quot;:[0,&quot;优化后&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;效果分析&quot;],&quot;text&quot;:[0,&quot;效果分析&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;4-延迟加载非关键模块&quot;],&quot;text&quot;:[0,&quot;4. 延迟加载非关键模块&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;实现方案&quot;],&quot;text&quot;:[0,&quot;实现方案&quot;]}],[0,{&quot;depth&quot;:[0,4],&quot;slug&quot;:[0,&quot;关键技术点&quot;],&quot;text&quot;:[0,&quot;关键技术点&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;5-性能监控埋点&quot;],&quot;text&quot;:[0,&quot;5. 性能监控埋点&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;常见问题&quot;],&quot;text&quot;:[0,&quot;常见问题&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;q1-v8-缓存文件会无限增长吗&quot;],&quot;text&quot;:[0,&quot;Q1: V8 缓存文件会无限增长吗？&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;q2-代码拆包会影响运行时性能吗&quot;],&quot;text&quot;:[0,&quot;Q2: 代码拆包会影响运行时性能吗？&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;q3-动态-import-会导致功能延迟吗&quot;],&quot;text&quot;:[0,&quot;Q3: 动态 import 会导致功能延迟吗？&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;总结&quot;],&quot;text&quot;:[0,&quot;总结&quot;]}]]],&quot;localImagePaths&quot;:[1,[]],&quot;remoteImagePaths&quot;:[1,[]],&quot;frontmatter&quot;:[0,{&quot;title&quot;:[0,&quot;Electron 热更新后启动性能优化：V8 缓存与代码拆包实战&quot;],&quot;date&quot;:[3,&quot;2025-11-18T18:00:00.000Z&quot;],&quot;tags&quot;:[1,[[0,&quot;Electron&quot;],[0,&quot;性能优化&quot;],[0,&quot;V8&quot;],[0,&quot;Vite&quot;],[0,&quot;热更新&quot;]]],&quot;categories&quot;:[0,&quot;技术教程&quot;],&quot;description&quot;:[0,&quot;深入实战 Electron 应用性能优化，通过启用 V8 代码缓存、Vite 模块拆包、按需导入和延迟加载等手段，将主进程启动时间从 1619ms 优化到 311ms，性能提升 80%。详解 V8 JIT 编译原理、manualChunks 拆包策略及实际优化效果对比。&quot;]}],&quot;imagePaths&quot;:[1,[]]}]}],&quot;collection&quot;:[0,&quot;blog&quot;]}],&quot;href&quot;:[0,&quot;/blog/post/33&quot;]}],[0,{&quot;post&quot;:[0,{&quot;id&quot;:[0,&quot;配置-codex-自定义三方api&quot;],&quot;data&quot;:[0,{&quot;title&quot;:[0,&quot;配置 Codex 自定义三方API&quot;],&quot;date&quot;:[3,&quot;2025-10-22T10:00:00.000Z&quot;],&quot;tags&quot;:[1,[[0,&quot;CodeX&quot;],[0,&quot;AI&quot;],[0,&quot;配置&quot;]]],&quot;categories&quot;:[0,&quot;技术教程&quot;]}],&quot;body&quot;:[0,&quot;最近在用 Claude Code,换了成本更低的Codex,记录一下配置过程。方便以后查看，快速配置。\n\n## 配置路径\n\n配置文件位置:\n\n- **macOS/Linux**: `~/.codex/config.toml`\n- **Windows**: `C:\\Users\\你的用户名\\.codex\\config.toml`\n\n## 配置文件\n\n直接上配置:\n\n```toml\nmodel_provider = \&quot;codex\&quot;\nmodel = \&quot;gpt-4.1-mini\&quot;\nmodel_reasoning_effort = \&quot;medium\&quot;\ndisable_response_storage = true\nwindows_wsl_setup_acknowledged = true\n\n[model_providers.codex]\nname = \&quot;codex\&quot;\nbase_url=\&quot;https://api.burn.hair/v1\&quot; #使用官方或第三方的\nwire_api = \&quot;responses\&quot;\nenv_key = \&quot;K_CODEX\&quot; #不要改成自己的密钥,在系统环境变量中设置\n```\n\n## 参数说明\n\n几个关键配置:\n\n- `model_provider`: 设置成 `\&quot;codex\&quot;` 就行\n- `model`: 用的模型,这里是 `gpt-4.1-mini`\n- `model_reasoning_effort`: 推理强度,`low`/`medium`/`high` 三档,medium 够用\n- `disable_response_storage`: 不保存历史记录,开启更安全\n- `base_url`: API 地址,换成你自己的\n- `env_key`: 环境变量名,**密钥别直接写配置文件里**\n\n## 设置步骤\n\n### 1. 修改配置文件\n\n找到配置文件,把上面的配置复制进去,改一下 `base_url` 和 `model`。\n\n### 2. 设置环境变量\n\n**macOS/Linux** 在 `~/.zshrc` 或 `~/.bashrc` 加一行:\n\n```bash\nexport K_CODEX=\&quot;your-api-key-here\&quot;\n```\n\n然后 `source ~/.zshrc` 生效。\n\n**Windows** PowerShell 执行:\n\n```powershell\n[System.Environment]::SetEnvironmentVariable(&#39;K_CODEX&#39;, &#39;your-api-key-here&#39;, &#39;User&#39;)\n```\n\n### 3. 重启终端\n\n重启终端就能用了。&quot;],&quot;filePath&quot;:[0,&quot;source/posts/配置 Codex 自定义三方API.md&quot;],&quot;digest&quot;:[0,&quot;b4fa279e184dff34&quot;],&quot;rendered&quot;:[0,{&quot;html&quot;:[0,&quot;&lt;p&gt;最近在用 Claude Code,换了成本更低的Codex,记录一下配置过程。方便以后查看，快速配置。&lt;/p&gt;\n&lt;h2 id=\&quot;配置路径\&quot;&gt;配置路径&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#配置路径\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;配置文件位置:&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;strong&gt;macOS/Linux&lt;/strong&gt;: &lt;code&gt;~/.codex/config.toml&lt;/code&gt;&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;Windows&lt;/strong&gt;: &lt;code&gt;C:\\Users\\你的用户名\\.codex\\config.toml&lt;/code&gt;&lt;/li&gt;\n&lt;/ul&gt;\n&lt;h2 id=\&quot;配置文件\&quot;&gt;配置文件&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#配置文件\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;直接上配置:&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;toml\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;model_provider = &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;\&quot;codex\&quot;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;model = &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;\&quot;gpt-4.1-mini\&quot;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;model_reasoning_effort = &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;\&quot;medium\&quot;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;disable_response_storage = &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;true&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;windows_wsl_setup_acknowledged = &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;true&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;[&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;model_providers&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;codex&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;]&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;name = &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;\&quot;codex\&quot;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;base_url=&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;\&quot;https://api.burn.hair/v1\&quot;&lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt; #使用官方或第三方的&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;wire_api = &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;\&quot;responses\&quot;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;env_key = &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;\&quot;K_CODEX\&quot;&lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt; #不要改成自己的密钥,在系统环境变量中设置&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h2 id=\&quot;参数说明\&quot;&gt;参数说明&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#参数说明\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;几个关键配置:&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;code&gt;model_provider&lt;/code&gt;: 设置成 &lt;code&gt;\&quot;codex\&quot;&lt;/code&gt; 就行&lt;/li&gt;\n&lt;li&gt;&lt;code&gt;model&lt;/code&gt;: 用的模型,这里是 &lt;code&gt;gpt-4.1-mini&lt;/code&gt;&lt;/li&gt;\n&lt;li&gt;&lt;code&gt;model_reasoning_effort&lt;/code&gt;: 推理强度,&lt;code&gt;low&lt;/code&gt;/&lt;code&gt;medium&lt;/code&gt;/&lt;code&gt;high&lt;/code&gt; 三档,medium 够用&lt;/li&gt;\n&lt;li&gt;&lt;code&gt;disable_response_storage&lt;/code&gt;: 不保存历史记录,开启更安全&lt;/li&gt;\n&lt;li&gt;&lt;code&gt;base_url&lt;/code&gt;: API 地址,换成你自己的&lt;/li&gt;\n&lt;li&gt;&lt;code&gt;env_key&lt;/code&gt;: 环境变量名,&lt;strong&gt;密钥别直接写配置文件里&lt;/strong&gt;&lt;/li&gt;\n&lt;/ul&gt;\n&lt;h2 id=\&quot;设置步骤\&quot;&gt;设置步骤&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#设置步骤\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;h3 id=\&quot;1-修改配置文件\&quot;&gt;1. 修改配置文件&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#1-修改配置文件\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;找到配置文件,把上面的配置复制进去,改一下 &lt;code&gt;base_url&lt;/code&gt; 和 &lt;code&gt;model&lt;/code&gt;。&lt;/p&gt;\n&lt;h3 id=\&quot;2-设置环境变量\&quot;&gt;2. 设置环境变量&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#2-设置环境变量\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;&lt;strong&gt;macOS/Linux&lt;/strong&gt; 在 &lt;code&gt;~/.zshrc&lt;/code&gt; 或 &lt;code&gt;~/.bashrc&lt;/code&gt; 加一行:&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;bash\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;export&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; K_CODEX&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;\&quot;your-api-key-here\&quot;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;然后 &lt;code&gt;source ~/.zshrc&lt;/code&gt; 生效。&lt;/p&gt;\n&lt;p&gt;&lt;strong&gt;Windows&lt;/strong&gt; PowerShell 执行:&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;powershell\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;[&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;System.Environment&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;]::SetEnvironmentVariable(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;K_CODEX&#39;&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;,&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; &#39;your-api-key-here&#39;&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;,&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; &#39;User&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h3 id=\&quot;3-重启终端\&quot;&gt;3. 重启终端&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#3-重启终端\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;重启终端就能用了。&lt;/p&gt;&quot;],&quot;metadata&quot;:[0,{&quot;headings&quot;:[1,[[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;配置路径&quot;],&quot;text&quot;:[0,&quot;配置路径&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;配置文件&quot;],&quot;text&quot;:[0,&quot;配置文件&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;参数说明&quot;],&quot;text&quot;:[0,&quot;参数说明&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;设置步骤&quot;],&quot;text&quot;:[0,&quot;设置步骤&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;1-修改配置文件&quot;],&quot;text&quot;:[0,&quot;1. 修改配置文件&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;2-设置环境变量&quot;],&quot;text&quot;:[0,&quot;2. 设置环境变量&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;3-重启终端&quot;],&quot;text&quot;:[0,&quot;3. 重启终端&quot;]}]]],&quot;localImagePaths&quot;:[1,[]],&quot;remoteImagePaths&quot;:[1,[]],&quot;frontmatter&quot;:[0,{&quot;title&quot;:[0,&quot;配置 Codex 自定义三方API&quot;],&quot;date&quot;:[3,&quot;2025-10-22T10:00:00.000Z&quot;],&quot;tags&quot;:[1,[[0,&quot;CodeX&quot;],[0,&quot;AI&quot;],[0,&quot;配置&quot;]]],&quot;categories&quot;:[0,&quot;技术教程&quot;]}],&quot;imagePaths&quot;:[1,[]]}]}],&quot;collection&quot;:[0,&quot;blog&quot;]}],&quot;href&quot;:[0,&quot;/blog/post/31&quot;]}],[0,{&quot;post&quot;:[0,{&quot;id&quot;:[0,&quot;react-effect依赖优化最佳实践与源码解析&quot;],&quot;data&quot;:[0,{&quot;title&quot;:[0,&quot;React Effect 依赖优化最佳实践&quot;],&quot;date&quot;:[3,&quot;2025-10-21T21:00:34.000Z&quot;],&quot;tags&quot;:[1,[[0,&quot;React&quot;],[0,&quot;Hooks&quot;],[0,&quot;性能优化&quot;],[0,&quot;源码解析&quot;]]],&quot;categories&quot;:[0,&quot;技术教程&quot;]}],&quot;body&quot;:[0,&quot;## 前言\n\n在使用 React Hooks 开发时，`useEffect` 的依赖数组管理是一个常见的痛点。很多开发者遇到过这样的困扰：依赖项过多导致 Effect 频繁执行，或者为了图方便直接禁用 ESLint 规则，最终引发难以调试的 bug。\n\n本文将从 React 官方文档和源码层面深入探讨如何正确管理 Effect 依赖，帮助你写出更高效、更可维护的 React 代码。\n\n## 核心原则：依赖必须与代码匹配\n\nReact 官方文档明确指出：**依赖应该与代码匹配**。这意味着 Effect 中使用的每一个响应式值（props、state）都必须出现在依赖数组中。\n\nReact 的 ESLint 插件 `eslint-plugin-react-hooks` 会自动检查这一规则，确保你的依赖声明是完整的。\n\n### ⚠️ 关键警告\n\n**永远不要用注释禁用依赖检查：**\n\n```javascript\n// ❌ 危险做法\nuseEffect(() =&gt; {\n  // ...\n  // eslint-disable-next-line react-hooks/exhaustive-deps\n}, []);\n```\n\nReact 文档强调：**应该把依赖检查错误当作编译错误来对待**。忽略它会导致微妙且难以诊断的 bug。\n\n## 六大策略移除不必要的依赖\n\n### 1. 将逻辑移至事件处理器\n\n如果某段代码应该响应特定的用户交互而非响应式变化，应该放在事件处理器中：\n\n```javascript\n// ❌ 不好的做法\nfunction ChatRoom({ roomId }) {\n  const [message, setMessage] = useState(&#39;&#39;);\n\n  useEffect(() =&gt; {\n    if (message) {\n      logVisit(roomId, message);\n    }\n  }, [roomId, message]); // message 变化会重复记录\n\n  return &lt;input value={message} onChange={(e) =&gt; setMessage(e.target.value)} /&gt;;\n}\n\n// ✅ 好的做法\nfunction ChatRoom({ roomId }) {\n  const [message, setMessage] = useState(&#39;&#39;);\n\n  const handleSend = () =&gt; {\n    logVisit(roomId, message); // 只在发送时记录\n  };\n\n  return (\n    &lt;&gt;\n      &lt;input value={message} onChange={(e) =&gt; setMessage(e.target.value)} /&gt;\n      &lt;button onClick={handleSend}&gt;发送&lt;/button&gt;\n    &lt;/&gt;\n  );\n}\n```\n\n### 2. 拆分多目的 Effect\n\n当一个 Effect 同步多个不相关的过程时,应该拆分成多个 Effect：\n\n```javascript\n// ❌ 不好的做法\nuseEffect(() =&gt; {\n  connectToChat(roomId);\n  trackPageView(page);\n}, [roomId, page]); // roomId 变化会触发不必要的页面追踪\n\n// ✅ 好的做法\nuseEffect(() =&gt; {\n  connectToChat(roomId);\n}, [roomId]);\n\nuseEffect(() =&gt; {\n  trackPageView(page);\n}, [page]);\n```\n\n### 3. 使用状态更新函数\n\n通过传递更新函数而非直接读取 state，可以移除状态依赖：\n\n```javascript\n// ❌ 不好的做法\nfunction Counter() {\n  const [count, setCount] = useState(0);\n\n  useEffect(() =&gt; {\n    const timer = setInterval(() =&gt; {\n      setCount(count + 1); // 依赖 count\n    }, 1000);\n    return () =&gt; clearInterval(timer);\n  }, [count]); // 每次 count 变化都会重置定时器\n\n  return &lt;div&gt;{count}&lt;/div&gt;;\n}\n\n// ✅ 好的做法\nfunction Counter() {\n  const [count, setCount] = useState(0);\n\n  useEffect(() =&gt; {\n    const timer = setInterval(() =&gt; {\n      setCount((c) =&gt; c + 1); // 使用更新函数,不依赖 count\n    }, 1000);\n    return () =&gt; clearInterval(timer);\n  }, []); // 空依赖数组,定时器不会重置\n\n  return &lt;div&gt;{count}&lt;/div&gt;;\n}\n```\n\n### 4. 使用 Effect Event（实验性）\n\n`useEffectEvent` 允许你提取非响应式逻辑，读取最新值而不触发重新同步：\n\n```javascript\n// ✅ 使用 Effect Event\nfunction ChatRoom({ roomId, theme }) {\n  const onConnected = useEffectEvent(() =&gt; {\n    showNotification(&#39;已连接&#39;, theme); // 读取最新的 theme\n  });\n\n  useEffect(() =&gt; {\n    const connection = connectToChat(roomId);\n    connection.on(&#39;connected&#39;, onConnected);\n    return () =&gt; connection.disconnect();\n  }, [roomId]); // theme 变化不会重新连接\n}\n```\n\n**注意：** `useEffectEvent` 目前仍是实验性 API，尚未包含在稳定版 React 中。\n\n### 5. 避免对象和函数依赖\n\n对象和函数在每次渲染时都是新的引用，会导致不必要的重新执行：\n\n```javascript\n// ❌ 不好的做法\nfunction SearchResults({ query }) {\n  const options = {\n    // 每次渲染都是新对象\n    includeArchived: true,\n  };\n\n  useEffect(() =&gt; {\n    fetchResults(query, options);\n  }, [query, options]); // options 每次都会触发\n}\n\n// ✅ 解决方案 1: 移到 Effect 内部\nfunction SearchResults({ query }) {\n  useEffect(() =&gt; {\n    const options = { includeArchived: true };\n    fetchResults(query, options);\n  }, [query]);\n}\n\n// ✅ 解决方案 2: 移到组件外部\nconst OPTIONS = { includeArchived: true };\n\nfunction SearchResults({ query }) {\n  useEffect(() =&gt; {\n    fetchResults(query, OPTIONS);\n  }, [query]);\n}\n\n// ✅ 解决方案 3: 使用 useMemo\nfunction SearchResults({ query, includeArchived }) {\n  const options = useMemo(\n    () =&gt; ({\n      includeArchived,\n    }),\n    [includeArchived],\n  );\n\n  useEffect(() =&gt; {\n    fetchResults(query, options);\n  }, [query, options]);\n}\n```\n\n### 6. 提取原始值\n\n当接收对象 props 时，解构出原始值作为依赖：\n\n```javascript\n// ❌ 不好的做法\nfunction ChatRoom({ options }) {\n  useEffect(() =&gt; {\n    connectToChat(options.roomId);\n  }, [options]); // options 对象每次渲染都是新的\n}\n\n// ✅ 好的做法\nfunction ChatRoom({ options }) {\n  const { roomId } = options;\n\n  useEffect(() =&gt; {\n    connectToChat(roomId);\n  }, [roomId]); // 只依赖原始值\n}\n```\n\n## 源码解析：React 如何初始化 State\n\n让我们深入 React 源码，看看 `useState` 背后的实现机制。以下代码来自 React v19.1.1 的 `ReactFiberHooks.js`：\n\n```javascript\nfunction mountStateImpl&lt;S&gt;(initialState: (() =&gt; S) | S): Hook {\n  const hook = mountWorkInProgressHook();\n  if (typeof initialState === &#39;function&#39;) {\n    const initialStateInitializer = initialState;\n    // 执行初始化函数获取初始值\n    initialState = initialStateInitializer();\n    if (shouldDoubleInvokeUserFnsInHooksDEV) {\n      setIsStrictModeForDevtools(true);\n      try {\n        // 严格模式下会执行两次,检测副作用\n        initialStateInitializer();\n      } finally {\n        setIsStrictModeForDevtools(false);\n      }\n    }\n  }\n  hook.memoizedState = hook.baseState = initialState;\n  // ...\n}\n```\n\n### 源码要点解读\n\n1. **惰性初始化支持**：当 `initialState` 是函数时，React 会执行它来获取初始值。这就是为什么我们可以写 `useState(() =&gt; expensiveComputation())`。\n\n2. **严格模式双重调用**：在开发模式的严格模式下，初始化函数会被调用两次。这是 React 的一个特性，用于帮助检测不纯的初始化函数中的副作用。\n\n3. **状态存储**：初始值会同时存储在 `memoizedState`（当前状态）和 `baseState`（基础状态）中。这是 React 实现状态更新和并发渲染的基础。\n\n### 与 Effect 依赖的关联\n\n理解 `useState` 的实现有助于我们更好地管理 Effect 依赖：\n\n```javascript\n// 为什么惰性初始化不需要依赖\nfunction Component() {\n  // ✅ 初始化函数只在首次渲染时执行一次\n  const [data] = useState(() =&gt; {\n    return expensiveComputation(); // 不会重复执行\n  });\n\n  useEffect(() =&gt; {\n    // data 来自 state,是响应式的,需要作为依赖\n    processData(data);\n  }, [data]);\n}\n```\n\n## 实战案例：聊天室连接管理\n\n让我们通过一个完整的例子整合这些最佳实践：\n\n```javascript\nfunction ChatRoom({ roomId, theme, currentUser }) {\n  const [messages, setMessages] = useState([]);\n  const [isConnected, setIsConnected] = useState(false);\n\n  // ✅ 使用 Effect Event 处理非响应式逻辑\n  const onMessage = useEffectEvent((message) =&gt; {\n    setMessages((msgs) =&gt; [...msgs, message]); // 使用更新函数\n    showNotification(message, theme); // 读取最新 theme,但不触发重连\n  });\n\n  const onConnectionChange = useEffectEvent((connected) =&gt; {\n    setIsConnected(connected);\n    if (connected) {\n      logUserActivity(currentUser.id); // 读取最新 user,但不触发重连\n    }\n  });\n\n  // ✅ 只在 roomId 变化时重新连接\n  useEffect(() =&gt; {\n    const connection = createConnection(roomId);\n\n    connection.on(&#39;message&#39;, onMessage);\n    connection.on(&#39;connection&#39;, onConnectionChange);\n    connection.connect();\n\n    return () =&gt; {\n      connection.disconnect();\n    };\n  }, [roomId]); // 只依赖 roomId\n\n  return (\n    &lt;div className={theme}&gt;\n      &lt;ConnectionStatus isConnected={isConnected} /&gt;\n      &lt;MessageList messages={messages} /&gt;\n    &lt;/div&gt;\n  );\n}\n```\n\n### 这个例子的优点\n\n1. **最小化依赖**：Effect 只依赖 `roomId`，只在切换房间时重新连接\n2. **避免不必要的重连**：`theme` 和 `currentUser` 变化不会导致重新连接\n3. **使用更新函数**：`setMessages(msgs =&gt; [...msgs, message])` 避免依赖 `messages`\n4. **清晰的职责分离**：连接逻辑、消息处理、通知展示各司其职\n\n## 调试技巧\n\n### 1. 使用 React DevTools\n\nReact DevTools 的 Profiler 可以帮你识别哪些组件因为 Effect 重新渲染：\n\n- 记录渲染原因\n- 查看 Hook 的依赖变化\n- 识别性能瓶颈\n\n### 2. 添加日志\n\n在开发环境添加日志帮助理解 Effect 执行时机：\n\n```javascript\nuseEffect(() =&gt; {\n  console.log(&#39;Effect 执行:&#39;, { roomId, theme });\n  // ...\n  return () =&gt; {\n    console.log(&#39;Effect 清理:&#39;, { roomId, theme });\n  };\n}, [roomId, theme]);\n```\n\n### 3. 使用 eslint-plugin-react-hooks\n\n确保在项目中启用并配置该插件：\n\n```json\n{\n  \&quot;plugins\&quot;: [\&quot;react-hooks\&quot;],\n  \&quot;rules\&quot;: {\n    \&quot;react-hooks/rules-of-hooks\&quot;: \&quot;error\&quot;,\n    \&quot;react-hooks/exhaustive-deps\&quot;: \&quot;warn\&quot;\n  }\n}\n```\n\n## 常见误区\n\n### 误区 1：空依赖数组万能\n\n```javascript\n// ❌ 错误理解\nuseEffect(() =&gt; {\n  setCount(count + 1); // count 永远是初始值\n}, []); // 缺少 count 依赖\n```\n\n### 误区 2：依赖越少越好\n\n依赖少不是目标，**准确的依赖**才是目标。不要为了减少依赖而牺牲正确性。\n\n### 误区 3：随意禁用 ESLint 规则\n\n```javascript\n// ❌ 这是技术债务\nuseEffect(() =&gt; {\n  // ...\n  // eslint-disable-next-line react-hooks/exhaustive-deps\n}, []);\n```\n\n这会在未来引发难以追踪的 bug，绝对不要这样做。\n\n## 性能优化建议\n\n1. **优先使用事件处理器**：能用事件处理器就不用 Effect\n2. **拆分细粒度 Effect**：每个 Effect 只负责一件事\n3. **合理使用 useMemo/useCallback**：对复杂对象和函数进行缓存\n4. **避免过度优化**：先保证正确性，再优化性能\n\n## 总结\n\nEffect 依赖管理是 React Hooks 开发中的重要技能。关键要点：\n\n1. **依赖必须与代码匹配** - 这是不可妥协的原则\n2. **永远不要禁用 ESLint 规则** - 把依赖警告当作编译错误对待\n3. **优先使用事件处理器** - 不是所有逻辑都需要 Effect\n4. **使用更新函数** - 减少对 state 的依赖\n5. **避免对象和函数依赖** - 它们每次渲染都是新的\n6. **理解源码实现** - 帮助我们更好地使用 API\n\n通过遵循这些最佳实践，你可以写出更高效、更易维护的 React 代码，避免常见的 Effect 依赖陷阱。\n\n## 参考资料\n\n- [React 官方文档 - Removing Effect Dependencies](https://react.dev/learn/removing-effect-dependencies#removing-unnecessary-dependencies)\n- [React 源码 - ReactFiberHooks.js](https://github.com/facebook/react/blob/v19.1.1/packages/react-reconciler/src/ReactFiberHooks.js#L2927-L2942)\n- [eslint-plugin-react-hooks](https://www.npmjs.com/package/eslint-plugin-react-hooks)&quot;],&quot;filePath&quot;:[0,&quot;source/posts/React-Effect依赖优化最佳实践与源码解析.md&quot;],&quot;digest&quot;:[0,&quot;f4463f21344080fc&quot;],&quot;rendered&quot;:[0,{&quot;html&quot;:[0,&quot;&lt;h2 id=\&quot;前言\&quot;&gt;前言&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#前言\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;在使用 React Hooks 开发时，&lt;code&gt;useEffect&lt;/code&gt; 的依赖数组管理是一个常见的痛点。很多开发者遇到过这样的困扰：依赖项过多导致 Effect 频繁执行，或者为了图方便直接禁用 ESLint 规则，最终引发难以调试的 bug。&lt;/p&gt;\n&lt;p&gt;本文将从 React 官方文档和源码层面深入探讨如何正确管理 Effect 依赖，帮助你写出更高效、更可维护的 React 代码。&lt;/p&gt;\n&lt;h2 id=\&quot;核心原则依赖必须与代码匹配\&quot;&gt;核心原则：依赖必须与代码匹配&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#核心原则依赖必须与代码匹配\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;React 官方文档明确指出：&lt;strong&gt;依赖应该与代码匹配&lt;/strong&gt;。这意味着 Effect 中使用的每一个响应式值（props、state）都必须出现在依赖数组中。&lt;/p&gt;\n&lt;p&gt;React 的 ESLint 插件 &lt;code&gt;eslint-plugin-react-hooks&lt;/code&gt; 会自动检查这一规则，确保你的依赖声明是完整的。&lt;/p&gt;\n&lt;h3 id=\&quot;️-关键警告\&quot;&gt;⚠️ 关键警告&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#️-关键警告\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;&lt;strong&gt;永远不要用注释禁用依赖检查：&lt;/strong&gt;&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;javascript\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// ❌ 危险做法&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;useEffect&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(() &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;  // ...&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;  // eslint-disable-next-line react-hooks/exhaustive-deps&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}, []);&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;React 文档强调：&lt;strong&gt;应该把依赖检查错误当作编译错误来对待&lt;/strong&gt;。忽略它会导致微妙且难以诊断的 bug。&lt;/p&gt;\n&lt;h2 id=\&quot;六大策略移除不必要的依赖\&quot;&gt;六大策略移除不必要的依赖&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#六大策略移除不必要的依赖\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;h3 id=\&quot;1-将逻辑移至事件处理器\&quot;&gt;1. 将逻辑移至事件处理器&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#1-将逻辑移至事件处理器\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;如果某段代码应该响应特定的用户交互而非响应式变化，应该放在事件处理器中：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;javascript\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// ❌ 不好的做法&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;function&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; ChatRoom&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;({ &lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;roomId&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; }) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  const&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; [&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;message&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;setMessage&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;] &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; useState&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;  useEffect&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(() &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    if&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; (message) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;      logVisit&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(roomId, message);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  }, [roomId, message]); &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// message 变化会重复记录&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  return&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; &amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;input&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; value&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;{message} &lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;onChange&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;{(&lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;e&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;) &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; setMessage&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(e.target.value)} /&gt;;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// ✅ 好的做法&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;function&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; ChatRoom&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;({ &lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;roomId&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; }) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  const&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; [&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;message&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;setMessage&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;] &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; useState&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  const&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; handleSend&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; () &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;    logVisit&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(roomId, message); &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 只在发送时记录&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  };&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  return&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; (&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    &amp;#x3C;&gt;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      &amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;input&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; value&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;{message} &lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;onChange&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;{(&lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;e&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;) &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; setMessage&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(e.target.value)} /&gt;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      &amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;button&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; onClick&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;{handleSend}&gt;发送&amp;#x3C;/&lt;/span&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;button&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    &amp;#x3C;/&gt;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  );&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h3 id=\&quot;2-拆分多目的-effect\&quot;&gt;2. 拆分多目的 Effect&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#2-拆分多目的-effect\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;当一个 Effect 同步多个不相关的过程时,应该拆分成多个 Effect：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;javascript\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// ❌ 不好的做法&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;useEffect&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(() &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;  connectToChat&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(roomId);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;  trackPageView&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(page);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}, [roomId, page]); &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// roomId 变化会触发不必要的页面追踪&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// ✅ 好的做法&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;useEffect&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(() &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;  connectToChat&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(roomId);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}, [roomId]);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;useEffect&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(() &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;  trackPageView&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(page);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}, [page]);&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h3 id=\&quot;3-使用状态更新函数\&quot;&gt;3. 使用状态更新函数&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#3-使用状态更新函数\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;通过传递更新函数而非直接读取 state，可以移除状态依赖：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;javascript\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// ❌ 不好的做法&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;function&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Counter&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;() {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  const&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; [&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;count&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;setCount&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;] &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; useState&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;0&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;  useEffect&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(() &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; timer&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; setInterval&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(() &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;      setCount&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(count &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;+&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; 1&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;); &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 依赖 count&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    }, &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;1000&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    return&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; () &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; clearInterval&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(timer);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  }, [count]); &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 每次 count 变化都会重置定时器&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  return&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; &amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;div&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&gt;{count}&amp;#x3C;/&lt;/span&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;div&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&gt;;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// ✅ 好的做法&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;function&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Counter&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;() {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  const&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; [&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;count&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;setCount&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;] &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; useState&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;0&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;  useEffect&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(() &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; timer&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; setInterval&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(() &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;      setCount&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;((&lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;c&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;) &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; c &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;+&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; 1&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;); &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 使用更新函数,不依赖 count&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    }, &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;1000&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    return&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; () &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; clearInterval&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(timer);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  }, []); &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 空依赖数组,定时器不会重置&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  return&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; &amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;div&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&gt;{count}&amp;#x3C;/&lt;/span&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;div&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&gt;;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h3 id=\&quot;4-使用-effect-event实验性\&quot;&gt;4. 使用 Effect Event（实验性）&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#4-使用-effect-event实验性\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;&lt;code&gt;useEffectEvent&lt;/code&gt; 允许你提取非响应式逻辑，读取最新值而不触发重新同步：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;javascript\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// ✅ 使用 Effect Event&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;function&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; ChatRoom&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;({ &lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;roomId&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;theme&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; }) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; onConnected&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; useEffectEvent&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(() &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;    showNotification&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;已连接&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, theme); &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 读取最新的 theme&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  });&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;  useEffect&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(() &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; connection&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; connectToChat&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(roomId);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    connection.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;on&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;connected&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, onConnected);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    return&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; () &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; connection.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;disconnect&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;();&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  }, [roomId]); &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// theme 变化不会重新连接&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;&lt;strong&gt;注意：&lt;/strong&gt; &lt;code&gt;useEffectEvent&lt;/code&gt; 目前仍是实验性 API，尚未包含在稳定版 React 中。&lt;/p&gt;\n&lt;h3 id=\&quot;5-避免对象和函数依赖\&quot;&gt;5. 避免对象和函数依赖&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#5-避免对象和函数依赖\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;对象和函数在每次渲染时都是新的引用，会导致不必要的重新执行：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;javascript\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// ❌ 不好的做法&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;function&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; SearchResults&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;({ &lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;query&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; }) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; options&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;    // 每次渲染都是新对象&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    includeArchived: &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;true&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  };&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;  useEffect&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(() &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;    fetchResults&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(query, options);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  }, [query, options]); &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// options 每次都会触发&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// ✅ 解决方案 1: 移到 Effect 内部&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;function&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; SearchResults&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;({ &lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;query&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; }) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;  useEffect&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(() &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; options&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; { includeArchived: &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;true&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; };&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;    fetchResults&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(query, options);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  }, [query]);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// ✅ 解决方案 2: 移到组件外部&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; OPTIONS&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; { includeArchived: &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;true&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; };&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;function&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; SearchResults&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;({ &lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;query&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; }) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;  useEffect&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(() &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;    fetchResults&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(query, &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;OPTIONS&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  }, [query]);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// ✅ 解决方案 3: 使用 useMemo&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;function&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; SearchResults&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;({ &lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;query&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;includeArchived&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; }) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; options&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; useMemo&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    () &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; ({&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      includeArchived,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    }),&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    [includeArchived],&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  );&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;  useEffect&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(() &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;    fetchResults&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(query, options);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  }, [query, options]);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h3 id=\&quot;6-提取原始值\&quot;&gt;6. 提取原始值&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#6-提取原始值\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;当接收对象 props 时，解构出原始值作为依赖：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;javascript\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// ❌ 不好的做法&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;function&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; ChatRoom&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;({ &lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;options&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; }) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;  useEffect&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(() &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;    connectToChat&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(options.roomId);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  }, [options]); &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// options 对象每次渲染都是新的&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// ✅ 好的做法&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;function&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; ChatRoom&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;({ &lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;options&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; }) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  const&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; { &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;roomId&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; } &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; options;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;  useEffect&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(() &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;    connectToChat&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(roomId);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  }, [roomId]); &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 只依赖原始值&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h2 id=\&quot;源码解析react-如何初始化-state\&quot;&gt;源码解析：React 如何初始化 State&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#源码解析react-如何初始化-state\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;让我们深入 React 源码，看看 &lt;code&gt;useState&lt;/code&gt; 背后的实现机制。以下代码来自 React v19.1.1 的 &lt;code&gt;ReactFiberHooks.js&lt;/code&gt;：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;javascript\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;function&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; mountStateImpl&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;S&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;initialState&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;:&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; (() &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; S&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;) &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;|&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; S&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;)&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;:&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Hook&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; hook&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; mountWorkInProgressHook&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;();&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  if&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; (&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;typeof&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; initialState &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;===&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; &#39;function&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; initialStateInitializer&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; initialState;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;    // 执行初始化函数获取初始值&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    initialState &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; initialStateInitializer&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;();&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    if&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; (shouldDoubleInvokeUserFnsInHooksDEV) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;      setIsStrictModeForDevtools&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;true&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;      try&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;        // 严格模式下会执行两次,检测副作用&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;        initialStateInitializer&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;();&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      } &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;finally&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;        setIsStrictModeForDevtools&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;false&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  hook.memoizedState &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; hook.baseState &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; initialState;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;  // ...&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h3 id=\&quot;源码要点解读\&quot;&gt;源码要点解读&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#源码要点解读\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;ol&gt;\n&lt;li&gt;\n&lt;p&gt;&lt;strong&gt;惰性初始化支持&lt;/strong&gt;：当 &lt;code&gt;initialState&lt;/code&gt; 是函数时，React 会执行它来获取初始值。这就是为什么我们可以写 &lt;code&gt;useState(() =&gt; expensiveComputation())&lt;/code&gt;。&lt;/p&gt;\n&lt;/li&gt;\n&lt;li&gt;\n&lt;p&gt;&lt;strong&gt;严格模式双重调用&lt;/strong&gt;：在开发模式的严格模式下，初始化函数会被调用两次。这是 React 的一个特性，用于帮助检测不纯的初始化函数中的副作用。&lt;/p&gt;\n&lt;/li&gt;\n&lt;li&gt;\n&lt;p&gt;&lt;strong&gt;状态存储&lt;/strong&gt;：初始值会同时存储在 &lt;code&gt;memoizedState&lt;/code&gt;（当前状态）和 &lt;code&gt;baseState&lt;/code&gt;（基础状态）中。这是 React 实现状态更新和并发渲染的基础。&lt;/p&gt;\n&lt;/li&gt;\n&lt;/ol&gt;\n&lt;h3 id=\&quot;与-effect-依赖的关联\&quot;&gt;与 Effect 依赖的关联&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#与-effect-依赖的关联\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;理解 &lt;code&gt;useState&lt;/code&gt; 的实现有助于我们更好地管理 Effect 依赖：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;javascript\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 为什么惰性初始化不需要依赖&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;function&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Component&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;() {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;  // ✅ 初始化函数只在首次渲染时执行一次&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  const&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; [&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;data&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;] &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; useState&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(() &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    return&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; expensiveComputation&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(); &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 不会重复执行&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  });&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;  useEffect&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(() &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;    // data 来自 state,是响应式的,需要作为依赖&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;    processData&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(data);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  }, [data]);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h2 id=\&quot;实战案例聊天室连接管理\&quot;&gt;实战案例：聊天室连接管理&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#实战案例聊天室连接管理\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;让我们通过一个完整的例子整合这些最佳实践：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;javascript\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;function&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; ChatRoom&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;({ &lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;roomId&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;theme&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;currentUser&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; }) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  const&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; [&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;messages&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;setMessages&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;] &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; useState&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;([]);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  const&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; [&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;isConnected&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;setIsConnected&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;] &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; useState&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;false&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;  // ✅ 使用 Effect Event 处理非响应式逻辑&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; onMessage&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; useEffectEvent&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;((&lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;message&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;) &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;    setMessages&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;((&lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;msgs&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;) &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; [&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;...&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;msgs, message]); &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 使用更新函数&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;    showNotification&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(message, theme); &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 读取最新 theme,但不触发重连&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  });&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; onConnectionChange&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; useEffectEvent&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;((&lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;connected&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;) &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;    setIsConnected&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(connected);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    if&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; (connected) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;      logUserActivity&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(currentUser.id); &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 读取最新 user,但不触发重连&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  });&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;  // ✅ 只在 roomId 变化时重新连接&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;  useEffect&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(() &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; connection&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; createConnection&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(roomId);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    connection.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;on&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;message&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, onMessage);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    connection.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;on&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;connection&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, onConnectionChange);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    connection.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;connect&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;();&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    return&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; () &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      connection.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;disconnect&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;();&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    };&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  }, [roomId]); &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 只依赖 roomId&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  return&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; (&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    &amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;div&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; className&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;{theme}&gt;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      &amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;ConnectionStatus&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; isConnected&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;{isConnected} /&gt;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      &amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;MessageList&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; messages&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;{messages} /&gt;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    &amp;#x3C;/&lt;/span&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;div&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  );&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h3 id=\&quot;这个例子的优点\&quot;&gt;这个例子的优点&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#这个例子的优点\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;ol&gt;\n&lt;li&gt;&lt;strong&gt;最小化依赖&lt;/strong&gt;：Effect 只依赖 &lt;code&gt;roomId&lt;/code&gt;，只在切换房间时重新连接&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;避免不必要的重连&lt;/strong&gt;：&lt;code&gt;theme&lt;/code&gt; 和 &lt;code&gt;currentUser&lt;/code&gt; 变化不会导致重新连接&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;使用更新函数&lt;/strong&gt;：&lt;code&gt;setMessages(msgs =&gt; [...msgs, message])&lt;/code&gt; 避免依赖 &lt;code&gt;messages&lt;/code&gt;&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;清晰的职责分离&lt;/strong&gt;：连接逻辑、消息处理、通知展示各司其职&lt;/li&gt;\n&lt;/ol&gt;\n&lt;h2 id=\&quot;调试技巧\&quot;&gt;调试技巧&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#调试技巧\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;h3 id=\&quot;1-使用-react-devtools\&quot;&gt;1. 使用 React DevTools&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#1-使用-react-devtools\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;React DevTools 的 Profiler 可以帮你识别哪些组件因为 Effect 重新渲染：&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;记录渲染原因&lt;/li&gt;\n&lt;li&gt;查看 Hook 的依赖变化&lt;/li&gt;\n&lt;li&gt;识别性能瓶颈&lt;/li&gt;\n&lt;/ul&gt;\n&lt;h3 id=\&quot;2-添加日志\&quot;&gt;2. 添加日志&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#2-添加日志\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;在开发环境添加日志帮助理解 Effect 执行时机：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;javascript\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;useEffect&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(() &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  console.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;log&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;Effect 执行:&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, { roomId, theme });&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;  // ...&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  return&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; () &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    console.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;log&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;Effect 清理:&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, { roomId, theme });&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  };&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}, [roomId, theme]);&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h3 id=\&quot;3-使用-eslint-plugin-react-hooks\&quot;&gt;3. 使用 eslint-plugin-react-hooks&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#3-使用-eslint-plugin-react-hooks\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;确保在项目中启用并配置该插件：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;json\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;{&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;  \&quot;plugins\&quot;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: [&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;\&quot;react-hooks\&quot;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;],&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;  \&quot;rules\&quot;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;    \&quot;react-hooks/rules-of-hooks\&quot;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;\&quot;error\&quot;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;    \&quot;react-hooks/exhaustive-deps\&quot;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;\&quot;warn\&quot;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h2 id=\&quot;常见误区\&quot;&gt;常见误区&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#常见误区\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;h3 id=\&quot;误区-1空依赖数组万能\&quot;&gt;误区 1：空依赖数组万能&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#误区-1空依赖数组万能\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;javascript\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// ❌ 错误理解&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;useEffect&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(() &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;  setCount&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(count &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;+&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; 1&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;); &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// count 永远是初始值&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}, []); &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 缺少 count 依赖&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h3 id=\&quot;误区-2依赖越少越好\&quot;&gt;误区 2：依赖越少越好&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#误区-2依赖越少越好\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;依赖少不是目标，&lt;strong&gt;准确的依赖&lt;/strong&gt;才是目标。不要为了减少依赖而牺牲正确性。&lt;/p&gt;\n&lt;h3 id=\&quot;误区-3随意禁用-eslint-规则\&quot;&gt;误区 3：随意禁用 ESLint 规则&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#误区-3随意禁用-eslint-规则\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;javascript\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// ❌ 这是技术债务&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;useEffect&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(() &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;  // ...&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;  // eslint-disable-next-line react-hooks/exhaustive-deps&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}, []);&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;这会在未来引发难以追踪的 bug，绝对不要这样做。&lt;/p&gt;\n&lt;h2 id=\&quot;性能优化建议\&quot;&gt;性能优化建议&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#性能优化建议\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;ol&gt;\n&lt;li&gt;&lt;strong&gt;优先使用事件处理器&lt;/strong&gt;：能用事件处理器就不用 Effect&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;拆分细粒度 Effect&lt;/strong&gt;：每个 Effect 只负责一件事&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;合理使用 useMemo/useCallback&lt;/strong&gt;：对复杂对象和函数进行缓存&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;避免过度优化&lt;/strong&gt;：先保证正确性，再优化性能&lt;/li&gt;\n&lt;/ol&gt;\n&lt;h2 id=\&quot;总结\&quot;&gt;总结&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#总结\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;Effect 依赖管理是 React Hooks 开发中的重要技能。关键要点：&lt;/p&gt;\n&lt;ol&gt;\n&lt;li&gt;&lt;strong&gt;依赖必须与代码匹配&lt;/strong&gt; - 这是不可妥协的原则&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;永远不要禁用 ESLint 规则&lt;/strong&gt; - 把依赖警告当作编译错误对待&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;优先使用事件处理器&lt;/strong&gt; - 不是所有逻辑都需要 Effect&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;使用更新函数&lt;/strong&gt; - 减少对 state 的依赖&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;避免对象和函数依赖&lt;/strong&gt; - 它们每次渲染都是新的&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;理解源码实现&lt;/strong&gt; - 帮助我们更好地使用 API&lt;/li&gt;\n&lt;/ol&gt;\n&lt;p&gt;通过遵循这些最佳实践，你可以写出更高效、更易维护的 React 代码，避免常见的 Effect 依赖陷阱。&lt;/p&gt;\n&lt;h2 id=\&quot;参考资料\&quot;&gt;参考资料&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#参考资料\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;a href=\&quot;https://react.dev/learn/removing-effect-dependencies#removing-unnecessary-dependencies\&quot;&gt;React 官方文档 - Removing Effect Dependencies&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&quot;https://github.com/facebook/react/blob/v19.1.1/packages/react-reconciler/src/ReactFiberHooks.js#L2927-L2942\&quot;&gt;React 源码 - ReactFiberHooks.js&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;\n&lt;div class=\&quot;link-preview-block not-prose\&quot; data-state=\&quot;error\&quot;&gt;\n  &lt;a href=\&quot;https://www.npmjs.com/package/eslint-plugin-react-hooks\&quot; target=\&quot;_blank\&quot; class=\&quot;hover:border-primary/50 group block rounded-lg border bg-card p-4 transition-all hover:shadow-md\&quot; aria-label=\&quot;https://www.npmjs.com/package/eslint-plugin-react-hooks\&quot;&gt;\n    &lt;div class=\&quot;flex items-center justify-between gap-3\&quot;&gt;\n      &lt;div class=\&quot;flex items-center gap-3 min-w-0 flex-1\&quot;&gt;\n        &lt;div class=\&quot;bg-primary/10 text-primary flex h-10 w-10 shrink-0 items-center justify-center rounded-lg\&quot;&gt;\n          &lt;svg class=\&quot;h-5 w-5\&quot; viewBox=\&quot;0 0 24 24\&quot; aria-hidden=\&quot;true\&quot;&gt;&lt;path fill=\&quot;none\&quot; stroke=\&quot;currentColor\&quot; stroke-dasharray=\&quot;28\&quot; stroke-dashoffset=\&quot;28\&quot; stroke-linecap=\&quot;round\&quot; stroke-linejoin=\&quot;round\&quot; stroke-width=\&quot;2\&quot; d=\&quot;M13 6l2 -2c1 -1 3 -1 4 0l1 1c1 1 1 3 0 4l-5 5c-1 1 -3 1 -4 0M11 18l-2 2c-1 1 -3 1 -4 0l-1 -1c-1 -1 -1 -3 0 -4l5 -5c1 -1 3 -1 4 0\&quot;&gt;&lt;animate fill=\&quot;freeze\&quot; attributeName=\&quot;stroke-dashoffset\&quot; dur=\&quot;0.6s\&quot; values=\&quot;28;0\&quot;&gt;&lt;/animate&gt;&lt;/path&gt;&lt;/svg&gt;\n        &lt;/div&gt;\n        &lt;div class=\&quot;min-w-0 flex-1\&quot;&gt;\n          &lt;div class=\&quot;text-foreground font-medium truncate\&quot;&gt;https://www.npmjs.com/package/eslint-plugin-react-hooks&lt;/div&gt;\n          &lt;div class=\&quot;text-muted-foreground text-xs truncate mt-0.5\&quot;&gt;npmjs.com&lt;/div&gt;\n        &lt;/div&gt;\n      &lt;/div&gt;\n      &lt;svg class=\&quot;text-primary h-5 w-5 shrink-0 transition-transform group-hover:translate-x-1\&quot; fill=\&quot;none\&quot; stroke=\&quot;currentColor\&quot; viewBox=\&quot;0 0 24 24\&quot;&gt;\n        &lt;path stroke-linecap=\&quot;round\&quot; stroke-linejoin=\&quot;round\&quot; stroke-width=\&quot;2\&quot; d=\&quot;M14 5l7 7m0 0l-7 7m7-7H3\&quot;&gt;&lt;/path&gt;\n      &lt;/svg&gt;\n    &lt;/div&gt;\n  &lt;/a&gt;\n&lt;/div&gt;\n&lt;/li&gt;\n&lt;/ul&gt;&quot;],&quot;metadata&quot;:[0,{&quot;headings&quot;:[1,[[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;前言&quot;],&quot;text&quot;:[0,&quot;前言&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;核心原则依赖必须与代码匹配&quot;],&quot;text&quot;:[0,&quot;核心原则：依赖必须与代码匹配&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;️-关键警告&quot;],&quot;text&quot;:[0,&quot;⚠️ 关键警告&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;六大策略移除不必要的依赖&quot;],&quot;text&quot;:[0,&quot;六大策略移除不必要的依赖&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;1-将逻辑移至事件处理器&quot;],&quot;text&quot;:[0,&quot;1. 将逻辑移至事件处理器&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;2-拆分多目的-effect&quot;],&quot;text&quot;:[0,&quot;2. 拆分多目的 Effect&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;3-使用状态更新函数&quot;],&quot;text&quot;:[0,&quot;3. 使用状态更新函数&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;4-使用-effect-event实验性&quot;],&quot;text&quot;:[0,&quot;4. 使用 Effect Event（实验性）&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;5-避免对象和函数依赖&quot;],&quot;text&quot;:[0,&quot;5. 避免对象和函数依赖&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;6-提取原始值&quot;],&quot;text&quot;:[0,&quot;6. 提取原始值&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;源码解析react-如何初始化-state&quot;],&quot;text&quot;:[0,&quot;源码解析：React 如何初始化 State&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;源码要点解读&quot;],&quot;text&quot;:[0,&quot;源码要点解读&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;与-effect-依赖的关联&quot;],&quot;text&quot;:[0,&quot;与 Effect 依赖的关联&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;实战案例聊天室连接管理&quot;],&quot;text&quot;:[0,&quot;实战案例：聊天室连接管理&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;这个例子的优点&quot;],&quot;text&quot;:[0,&quot;这个例子的优点&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;调试技巧&quot;],&quot;text&quot;:[0,&quot;调试技巧&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;1-使用-react-devtools&quot;],&quot;text&quot;:[0,&quot;1. 使用 React DevTools&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;2-添加日志&quot;],&quot;text&quot;:[0,&quot;2. 添加日志&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;3-使用-eslint-plugin-react-hooks&quot;],&quot;text&quot;:[0,&quot;3. 使用 eslint-plugin-react-hooks&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;常见误区&quot;],&quot;text&quot;:[0,&quot;常见误区&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;误区-1空依赖数组万能&quot;],&quot;text&quot;:[0,&quot;误区 1：空依赖数组万能&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;误区-2依赖越少越好&quot;],&quot;text&quot;:[0,&quot;误区 2：依赖越少越好&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;误区-3随意禁用-eslint-规则&quot;],&quot;text&quot;:[0,&quot;误区 3：随意禁用 ESLint 规则&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;性能优化建议&quot;],&quot;text&quot;:[0,&quot;性能优化建议&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;总结&quot;],&quot;text&quot;:[0,&quot;总结&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;参考资料&quot;],&quot;text&quot;:[0,&quot;参考资料&quot;]}]]],&quot;localImagePaths&quot;:[1,[]],&quot;remoteImagePaths&quot;:[1,[]],&quot;frontmatter&quot;:[0,{&quot;title&quot;:[0,&quot;React Effect 依赖优化最佳实践&quot;],&quot;date&quot;:[3,&quot;2025-10-21T21:00:34.000Z&quot;],&quot;tags&quot;:[1,[[0,&quot;React&quot;],[0,&quot;Hooks&quot;],[0,&quot;性能优化&quot;],[0,&quot;源码解析&quot;]]],&quot;categories&quot;:[0,&quot;技术教程&quot;]}],&quot;imagePaths&quot;:[1,[]]}]}],&quot;collection&quot;:[0,&quot;blog&quot;]}],&quot;href&quot;:[0,&quot;/blog/post/30&quot;]}],[0,{&quot;post&quot;:[0,{&quot;id&quot;:[0,&quot;hexo博客github-actions自动部署配置&quot;],&quot;data&quot;:[0,{&quot;title&quot;:[0,&quot;Hexo博客GitHub Actions自动部署配置&quot;],&quot;date&quot;:[3,&quot;2025-10-18T04:00:00.000Z&quot;],&quot;tags&quot;:[1,[[0,&quot;Hexo&quot;],[0,&quot;CI/CD&quot;],[0,&quot;GitHub Actions&quot;],[0,&quot;自动化部署&quot;]]],&quot;categories&quot;:[0,&quot;技术教程&quot;]}],&quot;body&quot;:[0,&quot;## 前言\n\n作为一个使用 Hexo 搭建博客的开发者，每次写完文章都要手动执行\n\n```bash\nhexo clean &amp;&amp; hexo generate &amp;&amp; hexo deploy\n```\n\n这一系列命令是不是很麻烦？今天就教大家如何使用 GitHub Actions 实现 Hexo 博客的自动化部署。\n\n## 什么是 GitHub Actions\n\nGitHub Actions 是 GitHub 提供的持续集成和持续部署（CI/CD）服务。它可以在代码仓库发生特定事件时自动执行预定义的工作流程，比如代码提交、PR 创建等。\n\n## 自动部署方案\n\n我们的方案是：\n\n1. 源代码仓库：存放 Hexo 源文件（Markdown 文章、配置文件等）\n2. GitHub Pages 仓库：存放编译后的静态网站文件\n3. GitHub Actions：自动构建并部署到 GitHub Pages 仓库\n\n## 配置步骤\n\n### 1. 创建 GitHub Actions 工作流\n\n在 Hexo 博客源码仓库根目录下创建 `.github/workflows/deploy.yml` 文件：\n\n```yaml\nname: Deploy Hexo to GitHub Pages\n\non:\n  push:\n    branches:\n      - main\n    paths:\n      - &#39;source/_posts/**&#39;\n      - &#39;source/**&#39;\n      - &#39;themes/**&#39;\n      - &#39;_config*.yml&#39;\n      - &#39;package.json&#39;\n  workflow_dispatch:\n\njobs:\n  deploy:\n    runs-on: ubuntu-latest\n\n    steps:\n      - name: Checkout source\n        uses: actions/checkout@v4\n        with:\n          submodules: true\n          fetch-depth: 0\n\n      - name: Setup Node.js\n        uses: actions/setup-node@v4\n        with:\n          node-version: &#39;18&#39;\n          cache: &#39;npm&#39;\n\n      - name: Install dependencies\n        run: npm ci\n\n      - name: Clean and generate static files\n        run: |\n          npm run clean\n          npm run build\n\n      - name: Deploy to GitHub Pages\n        uses: peaceiris/actions-gh-pages@v3\n        with:\n          personal_token: ${{ secrets.DEPLOY_TOKEN }}\n          external_repository: 你的用户名/你的用户名.github.io\n          publish_branch: main\n          publish_dir: ./public\n          user_name: &#39;github-actions[bot]&#39;\n          user_email: &#39;github-actions[bot]@users.noreply.github.com&#39;\n          commit_message: ${{ github.event.head_commit.message }}\n```\n\n### 2. 配置触发条件\n\n在上述配置中，工作流会在以下情况触发：\n\n- 推送到 `main` 分支\n- 修改了 `source/_posts/**`、`source/**`、`themes/**` 目录下的文件\n- 修改了配置文件 `_config*.yml` 或 `package.json`\n- 手动触发（`workflow_dispatch`）\n\n### 3. 创建 GitHub Personal Access Token\n\n1. 访问 GitHub 设置页面：https://github.com/settings/tokens\n2. 点击 \&quot;Generate new token\&quot; → \&quot;Generate new token (classic)\&quot;\n3. 填写以下信息：\n   - **Note**: `Hexo Blog Deploy`（或其他描述）\n   - **Expiration**: 选择过期时间（建议 1 year 或 No expiration）\n   - **Select scopes**: 勾选 **repo**（完整的仓库权限）\n4. 点击 \&quot;Generate token\&quot;\n5. **立即复制生成的 token**（只会显示一次，关闭页面后无法再次查看）\n\n### 4. 添加 Secret 到源码仓库\n\n1. 进入你的 Hexo 源码仓库\n2. 点击 `Settings` → `Secrets and variables` → `Actions`\n3. 点击 \&quot;New repository secret\&quot;\n4. 填写：\n   - **Name**: `DEPLOY_TOKEN`\n   - **Secret**: 粘贴刚才复制的 token\n5. 点击 \&quot;Add secret\&quot;\n\n### 5. 修改配置中的仓库名\n\n将 `deploy.yml` 中的 `external_repository` 改为你的 GitHub Pages 仓库名：\n\n```yaml\nexternal_repository: 你的用户名/你的用户名.github.io\n```\n\n## 使用流程\n\n配置完成后，使用流程变得非常简单：\n\n1. 在 `source/_posts` 目录下创建或修改 Markdown 文章\n2. 提交代码到 Git 仓库：\n   ```bash\n   git add .\n   git commit -m \&quot;新增文章：Hexo 自动部署配置\&quot;\n   git push origin main\n   ```\n3. GitHub Actions 自动触发，构建并部署\n4. 几分钟后，访问你的 GitHub Pages 网站即可看到更新\n\n## 查看部署状态\n\n1. 进入源码仓库的 `Actions` 页面\n2. 查看最新的工作流运行状态\n3. 点击查看详细日志，排查问题\n\n## 优势总结\n\n使用 GitHub Actions 自动部署有以下优势：\n\n1. **省时省力**: 不需要手动执行构建和部署命令\n2. **环境一致**: 在云端统一的环境中构建，避免本地环境问题\n3. **随时随地**: 只要能提交代码就能发布文章，甚至可以在 GitHub 网页端直接编辑\n4. **版本管理**: 源文件和部署文件分离，源码有完整的 Git 历史记录\n5. **免费使用**: GitHub Actions 对公开仓库完全免费\n\n## 常见问题\n\n### Q: 部署失败怎么办？\n\nA: 查看 Actions 页面的详细日志，常见问题包括：\n\n- Token 权限不足或过期\n- 仓库名配置错误\n- 依赖安装失败\n\n### Q: 能否部署到自定义域名？\n\nA: 可以，在 `source` 目录下添加 `CNAME` 文件，内容为你的域名即可。\n\n### Q: 构建时间太长怎么办？\n\nA: 可以使用 `npm ci` 代替 `npm install`，并启用 npm 缓存（配置中已包含）。\n\n## 总结\n\n通过 GitHub Actions，我们实现了 Hexo 博客的全自动部署。从此以后，写博客只需要专注于内容创作，提交代码后坐等自动部署完成即可。&quot;],&quot;filePath&quot;:[0,&quot;source/posts/Hexo博客GitHub-Actions自动部署配置.md&quot;],&quot;digest&quot;:[0,&quot;b64229b338859a65&quot;],&quot;rendered&quot;:[0,{&quot;html&quot;:[0,&quot;&lt;h2 id=\&quot;前言\&quot;&gt;前言&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#前言\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;作为一个使用 Hexo 搭建博客的开发者，每次写完文章都要手动执行&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;bash\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;hexo&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; clean&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; &amp;#x26;&amp;#x26; &lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;hexo&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; generate&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; &amp;#x26;&amp;#x26; &lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;hexo&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; deploy&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;这一系列命令是不是很麻烦？今天就教大家如何使用 GitHub Actions 实现 Hexo 博客的自动化部署。&lt;/p&gt;\n&lt;h2 id=\&quot;什么是-github-actions\&quot;&gt;什么是 GitHub Actions&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#什么是-github-actions\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;GitHub Actions 是 GitHub 提供的持续集成和持续部署（CI/CD）服务。它可以在代码仓库发生特定事件时自动执行预定义的工作流程，比如代码提交、PR 创建等。&lt;/p&gt;\n&lt;h2 id=\&quot;自动部署方案\&quot;&gt;自动部署方案&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#自动部署方案\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;我们的方案是：&lt;/p&gt;\n&lt;ol&gt;\n&lt;li&gt;源代码仓库：存放 Hexo 源文件（Markdown 文章、配置文件等）&lt;/li&gt;\n&lt;li&gt;GitHub Pages 仓库：存放编译后的静态网站文件&lt;/li&gt;\n&lt;li&gt;GitHub Actions：自动构建并部署到 GitHub Pages 仓库&lt;/li&gt;\n&lt;/ol&gt;\n&lt;h2 id=\&quot;配置步骤\&quot;&gt;配置步骤&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#配置步骤\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;h3 id=\&quot;1-创建-github-actions-工作流\&quot;&gt;1. 创建 GitHub Actions 工作流&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#1-创建-github-actions-工作流\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;在 Hexo 博客源码仓库根目录下创建 &lt;code&gt;.github/workflows/deploy.yml&lt;/code&gt; 文件：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;yaml\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;name&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;Deploy Hexo to GitHub Pages&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;on&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;:&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;  push&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;:&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;    branches&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;:&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      - &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;main&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;    paths&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;:&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      - &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;source/_posts/**&#39;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      - &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;source/**&#39;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      - &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;themes/**&#39;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      - &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;_config*.yml&#39;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      - &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;package.json&#39;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;  workflow_dispatch&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;:&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;jobs&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;:&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;  deploy&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;:&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;    runs-on&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;ubuntu-latest&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;    steps&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;:&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      - &lt;/span&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;name&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;Checkout source&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;        uses&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;actions/checkout@v4&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;        with&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;:&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;          submodules&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;true&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;          fetch-depth&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;0&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      - &lt;/span&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;name&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;Setup Node.js&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;        uses&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;actions/setup-node@v4&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;        with&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;:&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;          node-version&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;18&#39;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;          cache&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;npm&#39;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      - &lt;/span&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;name&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;Install dependencies&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;        run&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;npm ci&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      - &lt;/span&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;name&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;Clean and generate static files&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;        run&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;|&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;          npm run clean&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;          npm run build&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      - &lt;/span&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;name&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;Deploy to GitHub Pages&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;        uses&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;peaceiris/actions-gh-pages@v3&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;        with&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;:&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;          personal_token&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;${{ secrets.DEPLOY_TOKEN }}&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;          external_repository&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;你的用户名/你的用户名.github.io&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;          publish_branch&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;main&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;          publish_dir&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;./public&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;          user_name&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;github-actions[bot]&#39;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;          user_email&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;github-actions[bot]@users.noreply.github.com&#39;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;          commit_message&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;${{ github.event.head_commit.message }}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h3 id=\&quot;2-配置触发条件\&quot;&gt;2. 配置触发条件&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#2-配置触发条件\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;在上述配置中，工作流会在以下情况触发：&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;推送到 &lt;code&gt;main&lt;/code&gt; 分支&lt;/li&gt;\n&lt;li&gt;修改了 &lt;code&gt;source/_posts/**&lt;/code&gt;、&lt;code&gt;source/**&lt;/code&gt;、&lt;code&gt;themes/**&lt;/code&gt; 目录下的文件&lt;/li&gt;\n&lt;li&gt;修改了配置文件 &lt;code&gt;_config*.yml&lt;/code&gt; 或 &lt;code&gt;package.json&lt;/code&gt;&lt;/li&gt;\n&lt;li&gt;手动触发（&lt;code&gt;workflow_dispatch&lt;/code&gt;）&lt;/li&gt;\n&lt;/ul&gt;\n&lt;h3 id=\&quot;3-创建-github-personal-access-token\&quot;&gt;3. 创建 GitHub Personal Access Token&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#3-创建-github-personal-access-token\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;ol&gt;\n&lt;li&gt;访问 GitHub 设置页面：&lt;a href=\&quot;https://github.com/settings/tokens\&quot;&gt;https://github.com/settings/tokens&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;点击 “Generate new token” → “Generate new token (classic)”&lt;/li&gt;\n&lt;li&gt;填写以下信息：\n&lt;ul&gt;\n&lt;li&gt;&lt;strong&gt;Note&lt;/strong&gt;: &lt;code&gt;Hexo Blog Deploy&lt;/code&gt;（或其他描述）&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;Expiration&lt;/strong&gt;: 选择过期时间（建议 1 year 或 No expiration）&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;Select scopes&lt;/strong&gt;: 勾选 &lt;strong&gt;repo&lt;/strong&gt;（完整的仓库权限）&lt;/li&gt;\n&lt;/ul&gt;\n&lt;/li&gt;\n&lt;li&gt;点击 “Generate token”&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;立即复制生成的 token&lt;/strong&gt;（只会显示一次，关闭页面后无法再次查看）&lt;/li&gt;\n&lt;/ol&gt;\n&lt;h3 id=\&quot;4-添加-secret-到源码仓库\&quot;&gt;4. 添加 Secret 到源码仓库&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#4-添加-secret-到源码仓库\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;ol&gt;\n&lt;li&gt;进入你的 Hexo 源码仓库&lt;/li&gt;\n&lt;li&gt;点击 &lt;code&gt;Settings&lt;/code&gt; → &lt;code&gt;Secrets and variables&lt;/code&gt; → &lt;code&gt;Actions&lt;/code&gt;&lt;/li&gt;\n&lt;li&gt;点击 “New repository secret”&lt;/li&gt;\n&lt;li&gt;填写：\n&lt;ul&gt;\n&lt;li&gt;&lt;strong&gt;Name&lt;/strong&gt;: &lt;code&gt;DEPLOY_TOKEN&lt;/code&gt;&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;Secret&lt;/strong&gt;: 粘贴刚才复制的 token&lt;/li&gt;\n&lt;/ul&gt;\n&lt;/li&gt;\n&lt;li&gt;点击 “Add secret”&lt;/li&gt;\n&lt;/ol&gt;\n&lt;h3 id=\&quot;5-修改配置中的仓库名\&quot;&gt;5. 修改配置中的仓库名&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#5-修改配置中的仓库名\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;将 &lt;code&gt;deploy.yml&lt;/code&gt; 中的 &lt;code&gt;external_repository&lt;/code&gt; 改为你的 GitHub Pages 仓库名：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;yaml\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt;external_repository&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;你的用户名/你的用户名.github.io&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h2 id=\&quot;使用流程\&quot;&gt;使用流程&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#使用流程\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;配置完成后，使用流程变得非常简单：&lt;/p&gt;\n&lt;ol&gt;\n&lt;li&gt;在 &lt;code&gt;source/_posts&lt;/code&gt; 目录下创建或修改 Markdown 文章&lt;/li&gt;\n&lt;li&gt;提交代码到 Git 仓库：\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;bash\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;git&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; add&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; .&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;git&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; commit&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; -m&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; \&quot;新增文章：Hexo 自动部署配置\&quot;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;git&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; push&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; origin&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; main&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;/li&gt;\n&lt;li&gt;GitHub Actions 自动触发，构建并部署&lt;/li&gt;\n&lt;li&gt;几分钟后，访问你的 GitHub Pages 网站即可看到更新&lt;/li&gt;\n&lt;/ol&gt;\n&lt;h2 id=\&quot;查看部署状态\&quot;&gt;查看部署状态&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#查看部署状态\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;ol&gt;\n&lt;li&gt;进入源码仓库的 &lt;code&gt;Actions&lt;/code&gt; 页面&lt;/li&gt;\n&lt;li&gt;查看最新的工作流运行状态&lt;/li&gt;\n&lt;li&gt;点击查看详细日志，排查问题&lt;/li&gt;\n&lt;/ol&gt;\n&lt;h2 id=\&quot;优势总结\&quot;&gt;优势总结&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#优势总结\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;使用 GitHub Actions 自动部署有以下优势：&lt;/p&gt;\n&lt;ol&gt;\n&lt;li&gt;&lt;strong&gt;省时省力&lt;/strong&gt;: 不需要手动执行构建和部署命令&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;环境一致&lt;/strong&gt;: 在云端统一的环境中构建，避免本地环境问题&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;随时随地&lt;/strong&gt;: 只要能提交代码就能发布文章，甚至可以在 GitHub 网页端直接编辑&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;版本管理&lt;/strong&gt;: 源文件和部署文件分离，源码有完整的 Git 历史记录&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;免费使用&lt;/strong&gt;: GitHub Actions 对公开仓库完全免费&lt;/li&gt;\n&lt;/ol&gt;\n&lt;h2 id=\&quot;常见问题\&quot;&gt;常见问题&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#常见问题\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;h3 id=\&quot;q-部署失败怎么办\&quot;&gt;Q: 部署失败怎么办？&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#q-部署失败怎么办\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;A: 查看 Actions 页面的详细日志，常见问题包括：&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;Token 权限不足或过期&lt;/li&gt;\n&lt;li&gt;仓库名配置错误&lt;/li&gt;\n&lt;li&gt;依赖安装失败&lt;/li&gt;\n&lt;/ul&gt;\n&lt;h3 id=\&quot;q-能否部署到自定义域名\&quot;&gt;Q: 能否部署到自定义域名？&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#q-能否部署到自定义域名\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;A: 可以，在 &lt;code&gt;source&lt;/code&gt; 目录下添加 &lt;code&gt;CNAME&lt;/code&gt; 文件，内容为你的域名即可。&lt;/p&gt;\n&lt;h3 id=\&quot;q-构建时间太长怎么办\&quot;&gt;Q: 构建时间太长怎么办？&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#q-构建时间太长怎么办\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;A: 可以使用 &lt;code&gt;npm ci&lt;/code&gt; 代替 &lt;code&gt;npm install&lt;/code&gt;，并启用 npm 缓存（配置中已包含）。&lt;/p&gt;\n&lt;h2 id=\&quot;总结\&quot;&gt;总结&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#总结\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;通过 GitHub Actions，我们实现了 Hexo 博客的全自动部署。从此以后，写博客只需要专注于内容创作，提交代码后坐等自动部署完成即可。&lt;/p&gt;&quot;],&quot;metadata&quot;:[0,{&quot;headings&quot;:[1,[[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;前言&quot;],&quot;text&quot;:[0,&quot;前言&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;什么是-github-actions&quot;],&quot;text&quot;:[0,&quot;什么是 GitHub Actions&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;自动部署方案&quot;],&quot;text&quot;:[0,&quot;自动部署方案&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;配置步骤&quot;],&quot;text&quot;:[0,&quot;配置步骤&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;1-创建-github-actions-工作流&quot;],&quot;text&quot;:[0,&quot;1. 创建 GitHub Actions 工作流&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;2-配置触发条件&quot;],&quot;text&quot;:[0,&quot;2. 配置触发条件&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;3-创建-github-personal-access-token&quot;],&quot;text&quot;:[0,&quot;3. 创建 GitHub Personal Access Token&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;4-添加-secret-到源码仓库&quot;],&quot;text&quot;:[0,&quot;4. 添加 Secret 到源码仓库&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;5-修改配置中的仓库名&quot;],&quot;text&quot;:[0,&quot;5. 修改配置中的仓库名&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;使用流程&quot;],&quot;text&quot;:[0,&quot;使用流程&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;查看部署状态&quot;],&quot;text&quot;:[0,&quot;查看部署状态&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;优势总结&quot;],&quot;text&quot;:[0,&quot;优势总结&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;常见问题&quot;],&quot;text&quot;:[0,&quot;常见问题&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;q-部署失败怎么办&quot;],&quot;text&quot;:[0,&quot;Q: 部署失败怎么办？&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;q-能否部署到自定义域名&quot;],&quot;text&quot;:[0,&quot;Q: 能否部署到自定义域名？&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;q-构建时间太长怎么办&quot;],&quot;text&quot;:[0,&quot;Q: 构建时间太长怎么办？&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;总结&quot;],&quot;text&quot;:[0,&quot;总结&quot;]}]]],&quot;localImagePaths&quot;:[1,[]],&quot;remoteImagePaths&quot;:[1,[]],&quot;frontmatter&quot;:[0,{&quot;title&quot;:[0,&quot;Hexo博客GitHub Actions自动部署配置&quot;],&quot;date&quot;:[3,&quot;2025-10-18T04:00:00.000Z&quot;],&quot;tags&quot;:[1,[[0,&quot;Hexo&quot;],[0,&quot;CI/CD&quot;],[0,&quot;GitHub Actions&quot;],[0,&quot;自动化部署&quot;]]],&quot;categories&quot;:[0,&quot;技术教程&quot;]}],&quot;imagePaths&quot;:[1,[]]}]}],&quot;collection&quot;:[0,&quot;blog&quot;]}],&quot;href&quot;:[0,&quot;/blog/post/28&quot;]}],[0,{&quot;post&quot;:[0,{&quot;id&quot;:[0,&quot;nestjs关于循环依赖&quot;],&quot;data&quot;:[0,{&quot;title&quot;:[0,&quot;NestJs关于循环依赖&quot;],&quot;date&quot;:[3,&quot;2023-11-15T21:21:35.000Z&quot;],&quot;tags&quot;:[0,&quot;技术分享&quot;]}],&quot;body&quot;:[0,&quot;## 有感而发\n\nNestJS循环依赖问题：角色依赖了权限，权限依赖了角色模块。使用了循环依赖导入。\n\n但是，在角色模块的服务里使用权限模块里的service方法时，就会提示导入的权限模块不正确。\n\n但是，把角色里调用权限模块的方法逻辑删了，就正常了。\n\n但是这段逻辑放角色控制器里调用并不会报错。\n\n就很奇妙，所以，**还是得避免使用循环依赖**。我查阅了文档后才得知官网不推荐这么做。\n\n## 总结\n\nNestJS开发者们，希望不要和我一样。**尽量避免循环依赖吧**！\n\n## 相关截图\n\n![img.png](../img/img_8.png)\n![img_1.png](../img/img_9.png)\n![img_2.png](../img/img_10.png)&quot;],&quot;filePath&quot;:[0,&quot;source/posts/NestJs关于循环依赖.md&quot;],&quot;assetImports&quot;:[1,[[0,&quot;../img/img_8.png&quot;],[0,&quot;../img/img_9.png&quot;],[0,&quot;../img/img_10.png&quot;]]],&quot;digest&quot;:[0,&quot;0db331e629a639de&quot;],&quot;rendered&quot;:[0,{&quot;html&quot;:[0,&quot;&lt;h2 id=\&quot;有感而发\&quot;&gt;有感而发&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#有感而发\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;NestJS循环依赖问题：角色依赖了权限，权限依赖了角色模块。使用了循环依赖导入。&lt;/p&gt;\n&lt;p&gt;但是，在角色模块的服务里使用权限模块里的service方法时，就会提示导入的权限模块不正确。&lt;/p&gt;\n&lt;p&gt;但是，把角色里调用权限模块的方法逻辑删了，就正常了。&lt;/p&gt;\n&lt;p&gt;但是这段逻辑放角色控制器里调用并不会报错。&lt;/p&gt;\n&lt;p&gt;就很奇妙，所以，&lt;strong&gt;还是得避免使用循环依赖&lt;/strong&gt;。我查阅了文档后才得知官网不推荐这么做。&lt;/p&gt;\n&lt;h2 id=\&quot;总结\&quot;&gt;总结&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#总结\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;NestJS开发者们，希望不要和我一样。&lt;strong&gt;尽量避免循环依赖吧&lt;/strong&gt;！&lt;/p&gt;\n&lt;h2 id=\&quot;相关截图\&quot;&gt;相关截图&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#相关截图\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;&lt;/p&gt;&lt;figure class=\&quot;markdown-image-wrapper\&quot;&gt;&lt;img __ASTRO_IMAGE_=\&quot;{&amp;#x22;src&amp;#x22;:&amp;#x22;../img/img_8.png&amp;#x22;,&amp;#x22;alt&amp;#x22;:&amp;#x22;img.png&amp;#x22;,&amp;#x22;loading&amp;#x22;:&amp;#x22;lazy&amp;#x22;,&amp;#x22;decoding&amp;#x22;:&amp;#x22;async&amp;#x22;,&amp;#x22;class&amp;#x22;:&amp;#x22;markdown-image&amp;#x22;,&amp;#x22;index&amp;#x22;:0}\&quot;&gt;&lt;/figure&gt;\n&lt;figure class=\&quot;markdown-image-wrapper\&quot;&gt;&lt;img __ASTRO_IMAGE_=\&quot;{&amp;#x22;src&amp;#x22;:&amp;#x22;../img/img_9.png&amp;#x22;,&amp;#x22;alt&amp;#x22;:&amp;#x22;img_1.png&amp;#x22;,&amp;#x22;loading&amp;#x22;:&amp;#x22;lazy&amp;#x22;,&amp;#x22;decoding&amp;#x22;:&amp;#x22;async&amp;#x22;,&amp;#x22;class&amp;#x22;:&amp;#x22;markdown-image&amp;#x22;,&amp;#x22;index&amp;#x22;:0}\&quot;&gt;&lt;/figure&gt;\n&lt;figure class=\&quot;markdown-image-wrapper\&quot;&gt;&lt;img __ASTRO_IMAGE_=\&quot;{&amp;#x22;src&amp;#x22;:&amp;#x22;../img/img_10.png&amp;#x22;,&amp;#x22;alt&amp;#x22;:&amp;#x22;img_2.png&amp;#x22;,&amp;#x22;loading&amp;#x22;:&amp;#x22;lazy&amp;#x22;,&amp;#x22;decoding&amp;#x22;:&amp;#x22;async&amp;#x22;,&amp;#x22;class&amp;#x22;:&amp;#x22;markdown-image&amp;#x22;,&amp;#x22;index&amp;#x22;:0}\&quot;&gt;&lt;/figure&gt;&lt;p&gt;&lt;/p&gt;&quot;],&quot;metadata&quot;:[0,{&quot;headings&quot;:[1,[[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;有感而发&quot;],&quot;text&quot;:[0,&quot;有感而发&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;总结&quot;],&quot;text&quot;:[0,&quot;总结&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;相关截图&quot;],&quot;text&quot;:[0,&quot;相关截图&quot;]}]]],&quot;localImagePaths&quot;:[1,[[0,&quot;../img/img_8.png&quot;],[0,&quot;../img/img_9.png&quot;],[0,&quot;../img/img_10.png&quot;]]],&quot;remoteImagePaths&quot;:[1,[]],&quot;frontmatter&quot;:[0,{&quot;title&quot;:[0,&quot;NestJs关于循环依赖&quot;],&quot;date&quot;:[3,&quot;2023-11-15T21:21:35.000Z&quot;],&quot;tags&quot;:[0,&quot;技术分享&quot;]}],&quot;imagePaths&quot;:[1,[[0,&quot;../img/img_8.png&quot;],[0,&quot;../img/img_9.png&quot;],[0,&quot;../img/img_10.png&quot;]]]}]}],&quot;collection&quot;:[0,&quot;blog&quot;]}],&quot;href&quot;:[0,&quot;/blog/post/27&quot;]}],[0,{&quot;post&quot;:[0,{&quot;id&quot;:[0,&quot;关于vue3如何判断父组件给子组件传了插槽&quot;],&quot;data&quot;:[0,{&quot;title&quot;:[0,&quot;关于Vue3如何判断父组件给子组件传了插槽&quot;],&quot;date&quot;:[3,&quot;2023-08-03T15:20:21.000Z&quot;],&quot;tags&quot;:[0,&quot;技术分享&quot;]}],&quot;body&quot;:[0,&quot;## 问题背景\n\n首先看下面这段代码。\n\n![img.png](../img/img_5.png)\n\n遇见了一个需求，需要在部门选择的时候，名称前面加上一级部门。\n\n但是，很多地方都用到了这个封装的组件。如何让这个地方优雅的处理掉，又不影响到别的地方呢?\n\n## 解决思路\n\n我想到了一个点子。子组件判断父组件有没有传递插槽。如果传了的话，就给elOption传递处理选择显示的插槽。\n\n经过我一番查阅文档和百度，发现setup语法糖没法实现。只能改成setup加return那种。\n\nsetup函数里第二个参数中去接收slot插槽。然后利用jsx的灵活性就能够优雅地实现需求了。\n\n## 为什么使用JSX\n\n为啥要用jsx?因为template中给Eloption传递插槽没法用对象的方式，只要对应上了插槽名Eloption就会渲染。\n\n## 代码实现\n\n代码见下图：\n\n![img.png](../img/img_6.png)\n![img.png](../img/img_7.png)\n\n[代码详情](https://github.com/XueHua-s/personUntil/blob/main/Vue3Components/requesetEnumSearchSelect.vue)&quot;],&quot;filePath&quot;:[0,&quot;source/posts/关于Vue3如何判断父组件给子组件传了插槽.md&quot;],&quot;assetImports&quot;:[1,[[0,&quot;../img/img_5.png&quot;],[0,&quot;../img/img_6.png&quot;],[0,&quot;../img/img_7.png&quot;]]],&quot;digest&quot;:[0,&quot;92e3abb9744dc4e4&quot;],&quot;rendered&quot;:[0,{&quot;html&quot;:[0,&quot;&lt;h2 id=\&quot;问题背景\&quot;&gt;问题背景&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#问题背景\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;首先看下面这段代码。&lt;/p&gt;\n&lt;p&gt;&lt;/p&gt;&lt;figure class=\&quot;markdown-image-wrapper\&quot;&gt;&lt;img __ASTRO_IMAGE_=\&quot;{&amp;#x22;src&amp;#x22;:&amp;#x22;../img/img_5.png&amp;#x22;,&amp;#x22;alt&amp;#x22;:&amp;#x22;img.png&amp;#x22;,&amp;#x22;loading&amp;#x22;:&amp;#x22;lazy&amp;#x22;,&amp;#x22;decoding&amp;#x22;:&amp;#x22;async&amp;#x22;,&amp;#x22;class&amp;#x22;:&amp;#x22;markdown-image&amp;#x22;,&amp;#x22;index&amp;#x22;:0}\&quot;&gt;&lt;/figure&gt;&lt;p&gt;&lt;/p&gt;\n&lt;p&gt;遇见了一个需求，需要在部门选择的时候，名称前面加上一级部门。&lt;/p&gt;\n&lt;p&gt;但是，很多地方都用到了这个封装的组件。如何让这个地方优雅的处理掉，又不影响到别的地方呢?&lt;/p&gt;\n&lt;h2 id=\&quot;解决思路\&quot;&gt;解决思路&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#解决思路\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;我想到了一个点子。子组件判断父组件有没有传递插槽。如果传了的话，就给elOption传递处理选择显示的插槽。&lt;/p&gt;\n&lt;p&gt;经过我一番查阅文档和百度，发现setup语法糖没法实现。只能改成setup加return那种。&lt;/p&gt;\n&lt;p&gt;setup函数里第二个参数中去接收slot插槽。然后利用jsx的灵活性就能够优雅地实现需求了。&lt;/p&gt;\n&lt;h2 id=\&quot;为什么使用jsx\&quot;&gt;为什么使用JSX&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#为什么使用jsx\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;为啥要用jsx?因为template中给Eloption传递插槽没法用对象的方式，只要对应上了插槽名Eloption就会渲染。&lt;/p&gt;\n&lt;h2 id=\&quot;代码实现\&quot;&gt;代码实现&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#代码实现\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;代码见下图：&lt;/p&gt;\n&lt;p&gt;&lt;/p&gt;&lt;figure class=\&quot;markdown-image-wrapper\&quot;&gt;&lt;img __ASTRO_IMAGE_=\&quot;{&amp;#x22;src&amp;#x22;:&amp;#x22;../img/img_6.png&amp;#x22;,&amp;#x22;alt&amp;#x22;:&amp;#x22;img.png&amp;#x22;,&amp;#x22;loading&amp;#x22;:&amp;#x22;lazy&amp;#x22;,&amp;#x22;decoding&amp;#x22;:&amp;#x22;async&amp;#x22;,&amp;#x22;class&amp;#x22;:&amp;#x22;markdown-image&amp;#x22;,&amp;#x22;index&amp;#x22;:0}\&quot;&gt;&lt;/figure&gt;\n&lt;figure class=\&quot;markdown-image-wrapper\&quot;&gt;&lt;img __ASTRO_IMAGE_=\&quot;{&amp;#x22;src&amp;#x22;:&amp;#x22;../img/img_7.png&amp;#x22;,&amp;#x22;alt&amp;#x22;:&amp;#x22;img.png&amp;#x22;,&amp;#x22;loading&amp;#x22;:&amp;#x22;lazy&amp;#x22;,&amp;#x22;decoding&amp;#x22;:&amp;#x22;async&amp;#x22;,&amp;#x22;class&amp;#x22;:&amp;#x22;markdown-image&amp;#x22;,&amp;#x22;index&amp;#x22;:0}\&quot;&gt;&lt;/figure&gt;&lt;p&gt;&lt;/p&gt;\n&lt;p&gt;&lt;a href=\&quot;https://github.com/XueHua-s/personUntil/blob/main/Vue3Components/requesetEnumSearchSelect.vue\&quot;&gt;代码详情&lt;/a&gt;&lt;/p&gt;&quot;],&quot;metadata&quot;:[0,{&quot;headings&quot;:[1,[[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;问题背景&quot;],&quot;text&quot;:[0,&quot;问题背景&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;解决思路&quot;],&quot;text&quot;:[0,&quot;解决思路&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;为什么使用jsx&quot;],&quot;text&quot;:[0,&quot;为什么使用JSX&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;代码实现&quot;],&quot;text&quot;:[0,&quot;代码实现&quot;]}]]],&quot;localImagePaths&quot;:[1,[[0,&quot;../img/img_5.png&quot;],[0,&quot;../img/img_6.png&quot;],[0,&quot;../img/img_7.png&quot;]]],&quot;remoteImagePaths&quot;:[1,[]],&quot;frontmatter&quot;:[0,{&quot;title&quot;:[0,&quot;关于Vue3如何判断父组件给子组件传了插槽&quot;],&quot;date&quot;:[3,&quot;2023-08-03T15:20:21.000Z&quot;],&quot;tags&quot;:[0,&quot;技术分享&quot;]}],&quot;imagePaths&quot;:[1,[[0,&quot;../img/img_5.png&quot;],[0,&quot;../img/img_6.png&quot;],[0,&quot;../img/img_7.png&quot;]]]}]}],&quot;collection&quot;:[0,&quot;blog&quot;]}],&quot;href&quot;:[0,&quot;/blog/post/26&quot;]}],[0,{&quot;post&quot;:[0,{&quot;id&quot;:[0,&quot;element-plus表格隐藏行数功能&quot;],&quot;data&quot;:[0,{&quot;title&quot;:[0,&quot;element-plus表格隐藏行数功能&quot;],&quot;date&quot;:[3,&quot;2023-07-27T15:42:08.000Z&quot;],&quot;tags&quot;:[0,&quot;技术分享&quot;]}],&quot;body&quot;:[0,&quot;![emj](../img/img_1.png)\n\n## 需求背景\n\n如图所示，element-plus中所带的，这些折叠屏折叠行、这些功能可能并不是我们想要的。\n\n最近有一个需求，就是表格如果超出了某行，遍将多余的行数给进行折叠。\n\n那么,有什么办法能够给element-plus添加易于维护的拓展代码吗?\n\n我也自行百度过一番，但是百度上的答案，很明显并不是我想要的。\n\n经过我一番思索，想到了css的序号选择器。序号选择器专门写一个子元素超过3隐藏的类型名。\n\n## CSS样式实现\n\n样式如下：\n\n```css\n.el-folding &gt; tr:nth-child(n + 4) {\n  display: none;\n}\n.el-folding-line {\n  transition-duration: 200ms;\n  cursor: pointer;\n  border-bottom: 1px solid var(--el-table-border-color);\n}\n.el-folding-line:active {\n  background-color: #f5f6fb;\n}\n.el-folding-extends {\n  /*cursor: pointer;*/\n  transition-duration: 400ms;\n}\n.el-folding-extends.rotate {\n  cursor: pointer;\n  transform: rotate(180deg);\n}\n```\n\n## Vue自定义指令实现\n\n如何让这个功能易于使用和维护，我这里想到了使用vue的自定义指令：\n\n```javascript\n// element-table折叠指令\napp.directive(&#39;elfold&#39;, (el, binding) =&gt; {\n  const elBody = el.querySelector(&#39;.el-table__body&gt;tbody&#39;);\n  const elBodyC = elBody.children;\n  if (elBodyC.length &gt; 3) {\n    // 给表格添加只展示三行的类名\n    if (el.querySelector(&#39;.rotate&#39;)) {\n      elBody.classList.remove(&#39;el-folding&#39;);\n    } else {\n      elBody.classList.add(&#39;el-folding&#39;);\n    }\n    // 判断有没有创建过面板\n    const foldingLine = el.querySelector(&#39;.el-folding-line&#39;);\n    if (foldingLine) {\n      if (el?.removeElement) {\n        el.removeElement(foldingLine);\n      }\n    }\n    if (!foldingLine) {\n      // 创建折叠面板元素\n      const extendsTop = document.createElement(&#39;div&#39;);\n      extendsTop.className = &#39;flex-ct p5 el-folding-line&#39;;\n      const extendsTopButton = document.createElement(&#39;i&#39;);\n      extendsTopButton.className = &#39;fa fa-angle-down el-folding-extends&#39;;\n      extendsTopButton.style.fontSize = &#39;30px&#39;;\n      extendsTop.append(extendsTopButton);\n      el.append(extendsTop);\n      // 控制变量\n      let controller = true;\n      extendsTop.addEventListener(&#39;click&#39;, () =&gt; {\n        if (controller) {\n          extendsTopButton.classList.add(&#39;rotate&#39;);\n          elBody.classList.remove(&#39;el-folding&#39;);\n        } else {\n          extendsTopButton.classList.remove(&#39;rotate&#39;);\n          elBody.classList.add(&#39;el-folding&#39;);\n        }\n        controller = !controller;\n      });\n    }\n  } else {\n    elBody.classList.remove(&#39;el-folding&#39;);\n  }\n});\n```\n\n## 效果展示\n\n诺，最后的效果就如图所示了。\n\n![emj](../img/img_2.png)\n![emj](../img/img_3.png)\n![emj](../img/img_4.png)&quot;],&quot;filePath&quot;:[0,&quot;source/posts/element-plus表格隐藏行数功能.md&quot;],&quot;assetImports&quot;:[1,[[0,&quot;../img/img_1.png&quot;],[0,&quot;../img/img_2.png&quot;],[0,&quot;../img/img_3.png&quot;],[0,&quot;../img/img_4.png&quot;]]],&quot;digest&quot;:[0,&quot;eabe7313c3e9a3c4&quot;],&quot;rendered&quot;:[0,{&quot;html&quot;:[0,&quot;&lt;p&gt;&lt;/p&gt;&lt;figure class=\&quot;markdown-image-wrapper\&quot;&gt;&lt;img __ASTRO_IMAGE_=\&quot;{&amp;#x22;src&amp;#x22;:&amp;#x22;../img/img_1.png&amp;#x22;,&amp;#x22;alt&amp;#x22;:&amp;#x22;emj&amp;#x22;,&amp;#x22;loading&amp;#x22;:&amp;#x22;lazy&amp;#x22;,&amp;#x22;decoding&amp;#x22;:&amp;#x22;async&amp;#x22;,&amp;#x22;class&amp;#x22;:&amp;#x22;markdown-image&amp;#x22;,&amp;#x22;index&amp;#x22;:0}\&quot;&gt;&lt;/figure&gt;&lt;p&gt;&lt;/p&gt;\n&lt;h2 id=\&quot;需求背景\&quot;&gt;需求背景&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#需求背景\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;如图所示，element-plus中所带的，这些折叠屏折叠行、这些功能可能并不是我们想要的。&lt;/p&gt;\n&lt;p&gt;最近有一个需求，就是表格如果超出了某行，遍将多余的行数给进行折叠。&lt;/p&gt;\n&lt;p&gt;那么,有什么办法能够给element-plus添加易于维护的拓展代码吗?&lt;/p&gt;\n&lt;p&gt;我也自行百度过一番，但是百度上的答案，很明显并不是我想要的。&lt;/p&gt;\n&lt;p&gt;经过我一番思索，想到了css的序号选择器。序号选择器专门写一个子元素超过3隐藏的类型名。&lt;/p&gt;\n&lt;h2 id=\&quot;css样式实现\&quot;&gt;CSS样式实现&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#css样式实现\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;样式如下：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;css\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;.el-folding&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; &gt;&lt;/span&gt;&lt;span style=\&quot;color:#22863A;--shiki-dark:#85E89D\&quot;&gt; tr&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;:nth-child&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;n + 4&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;  display&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;none&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;.el-folding-line&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;  transition-duration&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;200&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;ms&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;  cursor&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;pointer&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;  border-bottom&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;1&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;px&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; solid&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; var&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;--el-table-border-color&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;.el-folding-line:active&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;  background-color&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;#f5f6fb&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;.el-folding-extends&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;  /*cursor: pointer;*/&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;  transition-duration&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;400&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;ms&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;.el-folding-extends.rotate&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;  cursor&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;pointer&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;  transform&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;: &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;rotate&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;180&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;deg&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h2 id=\&quot;vue自定义指令实现\&quot;&gt;Vue自定义指令实现&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#vue自定义指令实现\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;如何让这个功能易于使用和维护，我这里想到了使用vue的自定义指令：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;javascript\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// element-table折叠指令&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;app.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;directive&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;elfold&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, (&lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;el&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;binding&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;) &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; elBody&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; el.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;querySelector&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;.el-table__body&gt;tbody&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; elBodyC&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; elBody.children;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  if&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; (elBodyC.&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;length&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; &gt;&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; 3&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;    // 给表格添加只展示三行的类名&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    if&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; (el.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;querySelector&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;.rotate&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;)) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      elBody.classList.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;remove&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;el-folding&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    } &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;else&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      elBody.classList.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;add&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;el-folding&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;    // 判断有没有创建过面板&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; foldingLine&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; el.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;querySelector&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;.el-folding-line&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    if&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; (foldingLine) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;      if&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; (el?.removeElement) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;        el.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;removeElement&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(foldingLine);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    if&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; (&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;!&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;foldingLine) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;      // 创建折叠面板元素&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;      const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; extendsTop&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; document.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;createElement&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;div&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      extendsTop.className &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; &#39;flex-ct p5 el-folding-line&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;      const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; extendsTopButton&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; document.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;createElement&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;i&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      extendsTopButton.className &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; &#39;fa fa-angle-down el-folding-extends&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      extendsTopButton.style.fontSize &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; &#39;30px&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      extendsTop.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;append&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(extendsTopButton);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      el.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;append&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(extendsTop);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;      // 控制变量&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;      let&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; controller &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; true&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      extendsTop.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;addEventListener&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;click&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, () &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;        if&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; (controller) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;          extendsTopButton.classList.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;add&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;rotate&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;          elBody.classList.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;remove&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;el-folding&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;        } &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;else&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;          extendsTopButton.classList.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;remove&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;rotate&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;          elBody.classList.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;add&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;el-folding&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;        }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;        controller &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; !&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;controller;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      });&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  } &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;else&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    elBody.classList.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;remove&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;el-folding&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;});&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h2 id=\&quot;效果展示\&quot;&gt;效果展示&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#效果展示\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;诺，最后的效果就如图所示了。&lt;/p&gt;\n&lt;p&gt;&lt;/p&gt;&lt;figure class=\&quot;markdown-image-wrapper\&quot;&gt;&lt;img __ASTRO_IMAGE_=\&quot;{&amp;#x22;src&amp;#x22;:&amp;#x22;../img/img_2.png&amp;#x22;,&amp;#x22;alt&amp;#x22;:&amp;#x22;emj&amp;#x22;,&amp;#x22;loading&amp;#x22;:&amp;#x22;lazy&amp;#x22;,&amp;#x22;decoding&amp;#x22;:&amp;#x22;async&amp;#x22;,&amp;#x22;class&amp;#x22;:&amp;#x22;markdown-image&amp;#x22;,&amp;#x22;index&amp;#x22;:0}\&quot;&gt;&lt;/figure&gt;\n&lt;figure class=\&quot;markdown-image-wrapper\&quot;&gt;&lt;img __ASTRO_IMAGE_=\&quot;{&amp;#x22;src&amp;#x22;:&amp;#x22;../img/img_3.png&amp;#x22;,&amp;#x22;alt&amp;#x22;:&amp;#x22;emj&amp;#x22;,&amp;#x22;loading&amp;#x22;:&amp;#x22;lazy&amp;#x22;,&amp;#x22;decoding&amp;#x22;:&amp;#x22;async&amp;#x22;,&amp;#x22;class&amp;#x22;:&amp;#x22;markdown-image&amp;#x22;,&amp;#x22;index&amp;#x22;:0}\&quot;&gt;&lt;/figure&gt;\n&lt;figure class=\&quot;markdown-image-wrapper\&quot;&gt;&lt;img __ASTRO_IMAGE_=\&quot;{&amp;#x22;src&amp;#x22;:&amp;#x22;../img/img_4.png&amp;#x22;,&amp;#x22;alt&amp;#x22;:&amp;#x22;emj&amp;#x22;,&amp;#x22;loading&amp;#x22;:&amp;#x22;lazy&amp;#x22;,&amp;#x22;decoding&amp;#x22;:&amp;#x22;async&amp;#x22;,&amp;#x22;class&amp;#x22;:&amp;#x22;markdown-image&amp;#x22;,&amp;#x22;index&amp;#x22;:0}\&quot;&gt;&lt;/figure&gt;&lt;p&gt;&lt;/p&gt;&quot;],&quot;metadata&quot;:[0,{&quot;headings&quot;:[1,[[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;需求背景&quot;],&quot;text&quot;:[0,&quot;需求背景&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;css样式实现&quot;],&quot;text&quot;:[0,&quot;CSS样式实现&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;vue自定义指令实现&quot;],&quot;text&quot;:[0,&quot;Vue自定义指令实现&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;效果展示&quot;],&quot;text&quot;:[0,&quot;效果展示&quot;]}]]],&quot;localImagePaths&quot;:[1,[[0,&quot;../img/img_1.png&quot;],[0,&quot;../img/img_2.png&quot;],[0,&quot;../img/img_3.png&quot;],[0,&quot;../img/img_4.png&quot;]]],&quot;remoteImagePaths&quot;:[1,[]],&quot;frontmatter&quot;:[0,{&quot;title&quot;:[0,&quot;element-plus表格隐藏行数功能&quot;],&quot;date&quot;:[3,&quot;2023-07-27T15:42:08.000Z&quot;],&quot;tags&quot;:[0,&quot;技术分享&quot;]}],&quot;imagePaths&quot;:[1,[[0,&quot;../img/img_1.png&quot;],[0,&quot;../img/img_2.png&quot;],[0,&quot;../img/img_3.png&quot;],[0,&quot;../img/img_4.png&quot;]]]}]}],&quot;collection&quot;:[0,&quot;blog&quot;]}],&quot;href&quot;:[0,&quot;/blog/post/25&quot;]}],[0,{&quot;post&quot;:[0,{&quot;id&quot;:[0,&quot;前端链表运用场景&quot;],&quot;data&quot;:[0,{&quot;title&quot;:[0,&quot;前端链表运用场景&quot;],&quot;date&quot;:[3,&quot;2023-06-24T13:55:42.000Z&quot;],&quot;tags&quot;:[0,&quot;技术分享&quot;]}],&quot;body&quot;:[0,&quot;## 数组操作的性能问题\n\n看下面这段代码：\n\n```javascript\nconst arr = [1, 2, 3, 4, 5];\narr.unshift(0);\n```\n\n比如像上面那两行代码, 大家都知道数组是有下标的。\n\n如果往输入前面插入一个元素，那么后面的所有元素下标整体都是会往后移动的。这个数组的下标移动，一旦数据量过多的话，就会造成很严重的性能损耗。\n\n## 实际应用场景\n\n### 场景一：物联网项目\n\n例如: 物联网项目，一个设备的模板，数据量大的可能有几千个参数。如果把第一个删除删除了，后面恐怖的数据量的下标前移，会给页面造成大概一秒钟的卡顿感。\n\n### 场景二：滑动加载页面\n\n再比如一些滑动加载的页面，那个页面还具有，自己的文章能右滑删除的功能。\n\n如果存放文章的数据到达了一定数量，用户再删除文章，如果我们重新请求接口，加载列表。这样显然，用户的体验是更不好的。一般在接口请求删除成功后，对本地的那个文章在进行删除。但是，显然有时候也会造成不好的体验。\n\n## 解决方案\n\n这个时候链表这种数据结构, 再配合上es6的迭代器就很合适了。\n\n代码见以下链接：\n\n[双端循环链表](https://github.com/XueHua-s/adt-customer/blob/main/link.js)&quot;],&quot;filePath&quot;:[0,&quot;source/posts/前端链表运用场景.md&quot;],&quot;digest&quot;:[0,&quot;2e281fb9ffa9bc09&quot;],&quot;rendered&quot;:[0,{&quot;html&quot;:[0,&quot;&lt;h2 id=\&quot;数组操作的性能问题\&quot;&gt;数组操作的性能问题&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#数组操作的性能问题\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;看下面这段代码：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;javascript\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;const&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; arr&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; [&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;1&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;2&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;3&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;4&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;5&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;];&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;arr.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;unshift&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;0&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;);&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;比如像上面那两行代码, 大家都知道数组是有下标的。&lt;/p&gt;\n&lt;p&gt;如果往输入前面插入一个元素，那么后面的所有元素下标整体都是会往后移动的。这个数组的下标移动，一旦数据量过多的话，就会造成很严重的性能损耗。&lt;/p&gt;\n&lt;h2 id=\&quot;实际应用场景\&quot;&gt;实际应用场景&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#实际应用场景\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;h3 id=\&quot;场景一物联网项目\&quot;&gt;场景一：物联网项目&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#场景一物联网项目\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;例如: 物联网项目，一个设备的模板，数据量大的可能有几千个参数。如果把第一个删除删除了，后面恐怖的数据量的下标前移，会给页面造成大概一秒钟的卡顿感。&lt;/p&gt;\n&lt;h3 id=\&quot;场景二滑动加载页面\&quot;&gt;场景二：滑动加载页面&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#场景二滑动加载页面\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;再比如一些滑动加载的页面，那个页面还具有，自己的文章能右滑删除的功能。&lt;/p&gt;\n&lt;p&gt;如果存放文章的数据到达了一定数量，用户再删除文章，如果我们重新请求接口，加载列表。这样显然，用户的体验是更不好的。一般在接口请求删除成功后，对本地的那个文章在进行删除。但是，显然有时候也会造成不好的体验。&lt;/p&gt;\n&lt;h2 id=\&quot;解决方案\&quot;&gt;解决方案&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#解决方案\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;这个时候链表这种数据结构, 再配合上es6的迭代器就很合适了。&lt;/p&gt;\n&lt;p&gt;代码见以下链接：&lt;/p&gt;\n&lt;p&gt;&lt;a href=\&quot;https://github.com/XueHua-s/adt-customer/blob/main/link.js\&quot;&gt;双端循环链表&lt;/a&gt;&lt;/p&gt;&quot;],&quot;metadata&quot;:[0,{&quot;headings&quot;:[1,[[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;数组操作的性能问题&quot;],&quot;text&quot;:[0,&quot;数组操作的性能问题&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;实际应用场景&quot;],&quot;text&quot;:[0,&quot;实际应用场景&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;场景一物联网项目&quot;],&quot;text&quot;:[0,&quot;场景一：物联网项目&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;场景二滑动加载页面&quot;],&quot;text&quot;:[0,&quot;场景二：滑动加载页面&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;解决方案&quot;],&quot;text&quot;:[0,&quot;解决方案&quot;]}]]],&quot;localImagePaths&quot;:[1,[]],&quot;remoteImagePaths&quot;:[1,[]],&quot;frontmatter&quot;:[0,{&quot;title&quot;:[0,&quot;前端链表运用场景&quot;],&quot;date&quot;:[3,&quot;2023-06-24T13:55:42.000Z&quot;],&quot;tags&quot;:[0,&quot;技术分享&quot;]}],&quot;imagePaths&quot;:[1,[]]}]}],&quot;collection&quot;:[0,&quot;blog&quot;]}],&quot;href&quot;:[0,&quot;/blog/post/23&quot;]}],[0,{&quot;post&quot;:[0,{&quot;id&quot;:[0,&quot;关于前端数据库indexdb&quot;],&quot;data&quot;:[0,{&quot;title&quot;:[0,&quot;关于前端数据库indexDB&quot;],&quot;date&quot;:[3,&quot;2023-06-23T14:25:11.000Z&quot;],&quot;tags&quot;:[0,&quot;技术分享&quot;]}],&quot;body&quot;:[0,&quot;## 为什么需要IndexDB\n\n前端加载某些过大的静态文件，而且还是无法被浏览器缓存的资源时。每次都要浪费很多时间。\n\n比如three.js需要使用的建模文件。如果只有几十kb，几MB的话倒还好。如果模型文件十多M，甚至是几百多M的话。每次关闭网页再重新打开，就又重新加载一遍。长时间的重复等待实在是倒人胃口。\n\n这个时候就可以用indexDB将这些大型文件存起来。避免重复加载这些资源，而倒人胃口。\n\n## 使用体验\n\n关于这个问题，我自己钻研了一下，并且封装了一个操作IndexDB的方法(详情见文章下链接)。\n\n有一说一，这个东西比MongoDB难用。不能够直接新建表，必须每次在升级数据版本的时候，触发的周期里才能去新建。实在是，太难受了。\n\n![emj](../img/src=http___img.nga.178.com_attachments_mon_202206_26_i2Q2q-8ns4Z1vT3cSwi-wi.jpg&amp;refer=http___img.nga.178.webp)\n\n## 相关资源\n\n[IndexDB使用方法](https://github.com/XueHua-s/personUntil/blob/main/indexDB.js)&quot;],&quot;filePath&quot;:[0,&quot;source/posts/关于前端数据库indexDB.md&quot;],&quot;assetImports&quot;:[1,[[0,&quot;../img/src=http___img.nga.178.com_attachments_mon_202206_26_i2Q2q-8ns4Z1vT3cSwi-wi.jpg&amp;refer=http___img.nga.178.webp&quot;]]],&quot;digest&quot;:[0,&quot;71fd74995e3a8bc9&quot;],&quot;rendered&quot;:[0,{&quot;html&quot;:[0,&quot;&lt;h2 id=\&quot;为什么需要indexdb\&quot;&gt;为什么需要IndexDB&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#为什么需要indexdb\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;前端加载某些过大的静态文件，而且还是无法被浏览器缓存的资源时。每次都要浪费很多时间。&lt;/p&gt;\n&lt;p&gt;比如three.js需要使用的建模文件。如果只有几十kb，几MB的话倒还好。如果模型文件十多M，甚至是几百多M的话。每次关闭网页再重新打开，就又重新加载一遍。长时间的重复等待实在是倒人胃口。&lt;/p&gt;\n&lt;p&gt;这个时候就可以用indexDB将这些大型文件存起来。避免重复加载这些资源，而倒人胃口。&lt;/p&gt;\n&lt;h2 id=\&quot;使用体验\&quot;&gt;使用体验&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#使用体验\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;关于这个问题，我自己钻研了一下，并且封装了一个操作IndexDB的方法(详情见文章下链接)。&lt;/p&gt;\n&lt;p&gt;有一说一，这个东西比MongoDB难用。不能够直接新建表，必须每次在升级数据版本的时候，触发的周期里才能去新建。实在是，太难受了。&lt;/p&gt;\n&lt;p&gt;&lt;/p&gt;&lt;figure class=\&quot;markdown-image-wrapper\&quot;&gt;&lt;img __ASTRO_IMAGE_=\&quot;{&amp;#x22;src&amp;#x22;:&amp;#x22;../img/src=http___img.nga.178.com_attachments_mon_202206_26_i2Q2q-8ns4Z1vT3cSwi-wi.jpg&amp;#x26;refer=http___img.nga.178.webp&amp;#x22;,&amp;#x22;alt&amp;#x22;:&amp;#x22;emj&amp;#x22;,&amp;#x22;loading&amp;#x22;:&amp;#x22;lazy&amp;#x22;,&amp;#x22;decoding&amp;#x22;:&amp;#x22;async&amp;#x22;,&amp;#x22;class&amp;#x22;:&amp;#x22;markdown-image&amp;#x22;,&amp;#x22;index&amp;#x22;:0}\&quot;&gt;&lt;/figure&gt;&lt;p&gt;&lt;/p&gt;\n&lt;h2 id=\&quot;相关资源\&quot;&gt;相关资源&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#相关资源\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;&lt;a href=\&quot;https://github.com/XueHua-s/personUntil/blob/main/indexDB.js\&quot;&gt;IndexDB使用方法&lt;/a&gt;&lt;/p&gt;&quot;],&quot;metadata&quot;:[0,{&quot;headings&quot;:[1,[[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;为什么需要indexdb&quot;],&quot;text&quot;:[0,&quot;为什么需要IndexDB&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;使用体验&quot;],&quot;text&quot;:[0,&quot;使用体验&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;相关资源&quot;],&quot;text&quot;:[0,&quot;相关资源&quot;]}]]],&quot;localImagePaths&quot;:[1,[[0,&quot;../img/src=http___img.nga.178.com_attachments_mon_202206_26_i2Q2q-8ns4Z1vT3cSwi-wi.jpg&amp;refer=http___img.nga.178.webp&quot;]]],&quot;remoteImagePaths&quot;:[1,[]],&quot;frontmatter&quot;:[0,{&quot;title&quot;:[0,&quot;关于前端数据库indexDB&quot;],&quot;date&quot;:[3,&quot;2023-06-23T14:25:11.000Z&quot;],&quot;tags&quot;:[0,&quot;技术分享&quot;]}],&quot;imagePaths&quot;:[1,[[0,&quot;../img/src=http___img.nga.178.com_attachments_mon_202206_26_i2Q2q-8ns4Z1vT3cSwi-wi.jpg&amp;refer=http___img.nga.178.webp&quot;]]]}]}],&quot;collection&quot;:[0,&quot;blog&quot;]}],&quot;href&quot;:[0,&quot;/blog/post/22&quot;]}],[0,{&quot;post&quot;:[0,{&quot;id&quot;:[0,&quot;表格拖拽方法手写&quot;],&quot;data&quot;:[0,{&quot;title&quot;:[0,&quot;表格拖拽方法手写&quot;],&quot;date&quot;:[3,&quot;2023-06-22T21:31:40.000Z&quot;],&quot;tags&quot;:[0,&quot;技术分享&quot;]}],&quot;body&quot;:[0,&quot;## 项目需求\n\n这几天公司做一个项目，遇见了一个需要拖拽表格顺序的项目。\n\n但是UI用的又是element。是没有这个功能的，所以自己就手写了一个插件。\n\n发在了github上面。如果有需要用到的朋友可以移步下面。\n\n## 代码地址\n\n&lt;a href=\&quot;https://github.com/XueHua-s/personUntil/blob/main/elementTableDrap.js\&quot; target=\&quot;_blank\&quot;&gt;\n打开github链接\n&lt;/a&gt;&quot;],&quot;filePath&quot;:[0,&quot;source/posts/表格拖拽方法手写.md&quot;],&quot;digest&quot;:[0,&quot;187f30350c33ca9b&quot;],&quot;rendered&quot;:[0,{&quot;html&quot;:[0,&quot;&lt;h2 id=\&quot;项目需求\&quot;&gt;项目需求&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#项目需求\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;这几天公司做一个项目，遇见了一个需要拖拽表格顺序的项目。&lt;/p&gt;\n&lt;p&gt;但是UI用的又是element。是没有这个功能的，所以自己就手写了一个插件。&lt;/p&gt;\n&lt;p&gt;发在了github上面。如果有需要用到的朋友可以移步下面。&lt;/p&gt;\n&lt;h2 id=\&quot;代码地址\&quot;&gt;代码地址&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#代码地址\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;a href=\&quot;https://github.com/XueHua-s/personUntil/blob/main/elementTableDrap.js\&quot; target=\&quot;_blank\&quot;&gt;\n打开github链接\n&lt;/a&gt;&quot;],&quot;metadata&quot;:[0,{&quot;headings&quot;:[1,[[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;项目需求&quot;],&quot;text&quot;:[0,&quot;项目需求&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;代码地址&quot;],&quot;text&quot;:[0,&quot;代码地址&quot;]}]]],&quot;localImagePaths&quot;:[1,[]],&quot;remoteImagePaths&quot;:[1,[]],&quot;frontmatter&quot;:[0,{&quot;layout&quot;:[0,&quot;element&quot;],&quot;title&quot;:[0,&quot;表格拖拽方法手写&quot;],&quot;date&quot;:[3,&quot;2023-06-22T21:31:40.000Z&quot;],&quot;tags&quot;:[0,&quot;技术分享&quot;]}],&quot;imagePaths&quot;:[1,[]]}]}],&quot;collection&quot;:[0,&quot;blog&quot;]}],&quot;href&quot;:[0,&quot;/blog/post/21&quot;]}],[0,{&quot;post&quot;:[0,{&quot;id&quot;:[0,&quot;js循环依赖对象深拷贝&quot;],&quot;data&quot;:[0,{&quot;title&quot;:[0,&quot;js循环依赖对象深拷贝&quot;],&quot;date&quot;:[3,&quot;2023-03-07T13:37:26.000Z&quot;],&quot;tags&quot;:[0,&quot;技术分享&quot;]}],&quot;body&quot;:[0,&quot;## 循环依赖示例\n\n```javascript\nlet a = {};\nlet b = { a };\na.b = b;\n```\n\n## 经验分享\n\n这样的循环依赖的对象，需要每次递归的时候保留上一次递归的层级。\n并判断这次递归的内容中，有没有上一次的内容。\n如果有的话，就直接返回上一次的内容就行了。中断了递归。\n\n## 代码实现\n\n```javascript\n/**\n * @param { object } obj\n * @returns { object }\n */\nconst deepCopy = (obj, stack = []) =&gt; {\n  let target = null;\n  if (typeof obj === &#39;object&#39;) {\n    if (stack.includes(obj)) {\n      return obj;\n    } else {\n      stack.push(obj);\n    }\n    if (Array.isArray(obj)) {\n      target = [];\n      obj.forEach((item) =&gt; {\n        target.push(deepCopy(item, stack));\n      });\n    } else if (obj) {\n      target = {};\n      for (const [key, value] of Object.entries(obj)) {\n        target[key] = deepCopy(obj[key], stack);\n      }\n    } else {\n      target = obj;\n    }\n  } else {\n    target = obj;\n  }\n  return target;\n};\nexport default deepCopy;\n```&quot;],&quot;filePath&quot;:[0,&quot;source/posts/js循环依赖对象深拷贝.md&quot;],&quot;digest&quot;:[0,&quot;6a6b263660444ebe&quot;],&quot;rendered&quot;:[0,{&quot;html&quot;:[0,&quot;&lt;h2 id=\&quot;循环依赖示例\&quot;&gt;循环依赖示例&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#循环依赖示例\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;javascript\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;let&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; a &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {};&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;let&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; b &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; { a };&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;a.b &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; b;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h2 id=\&quot;经验分享\&quot;&gt;经验分享&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#经验分享\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;这样的循环依赖的对象，需要每次递归的时候保留上一次递归的层级。\n并判断这次递归的内容中，有没有上一次的内容。\n如果有的话，就直接返回上一次的内容就行了。中断了递归。&lt;/p&gt;\n&lt;h2 id=\&quot;代码实现\&quot;&gt;代码实现&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#代码实现\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;javascript\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;/**&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt; * &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;@param&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; { object }&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; obj&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt; * &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;@returns&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; { object }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt; */&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;const&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; deepCopy&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; (&lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;obj&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;stack&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; []) &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  let&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; target &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; null&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  if&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; (&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;typeof&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; obj &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;===&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; &#39;object&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    if&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; (stack.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;includes&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(obj)) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;      return&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; obj;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    } &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;else&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      stack.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;push&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(obj);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    if&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; (Array.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;isArray&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(obj)) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      target &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; [];&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      obj.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;forEach&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;((&lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;item&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;) &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;        target.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;push&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;deepCopy&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(item, stack));&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      });&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    } &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;else&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; if&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; (obj) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      target &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {};&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;      for&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; (&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;const&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; [&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;key&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;value&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;] &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;of&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; Object.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;entries&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(obj)) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;        target[key] &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; deepCopy&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(obj[key], stack);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    } &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;else&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      target &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; obj;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  } &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;else&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    target &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; obj;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  return&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; target;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;};&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;export&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; default&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; deepCopy;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&quot;],&quot;metadata&quot;:[0,{&quot;headings&quot;:[1,[[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;循环依赖示例&quot;],&quot;text&quot;:[0,&quot;循环依赖示例&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;经验分享&quot;],&quot;text&quot;:[0,&quot;经验分享&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;代码实现&quot;],&quot;text&quot;:[0,&quot;代码实现&quot;]}]]],&quot;localImagePaths&quot;:[1,[]],&quot;remoteImagePaths&quot;:[1,[]],&quot;frontmatter&quot;:[0,{&quot;title&quot;:[0,&quot;js循环依赖对象深拷贝&quot;],&quot;date&quot;:[3,&quot;2023-03-07T13:37:26.000Z&quot;],&quot;tags&quot;:[0,&quot;技术分享&quot;]}],&quot;imagePaths&quot;:[1,[]]}]}],&quot;collection&quot;:[0,&quot;blog&quot;]}],&quot;href&quot;:[0,&quot;/blog/post/20&quot;]}],[0,{&quot;post&quot;:[0,{&quot;id&quot;:[0,&quot;js对象数组深拷贝&quot;],&quot;data&quot;:[0,{&quot;title&quot;:[0,&quot;JS对象数组深拷贝&quot;],&quot;date&quot;:[3,&quot;2023-02-08T21:52:20.000Z&quot;],&quot;tags&quot;:[0,&quot;技术分享&quot;]}],&quot;body&quot;:[0,&quot;```javascript\n/**\n * @param { object } obj\n * @returns { object }\n */\nconst deepCopy = (obj) =&gt; {\n  let target = null;\n  if (typeof obj === &#39;object&#39;) {\n    if (Array.isArray(obj)) {\n      target = [];\n      obj.forEach((item) =&gt; {\n        target.push(deepCopy(item));\n      });\n    } else if (obj) {\n      target = {};\n      for (const [key, value] of Object.entries(obj)) {\n        target[key] = deepCopy(obj[key]);\n      }\n    } else {\n      target = obj;\n    }\n  } else {\n    target = obj;\n  }\n  return target;\n};\n```&quot;],&quot;filePath&quot;:[0,&quot;source/posts/JS对象数组深拷贝.md&quot;],&quot;digest&quot;:[0,&quot;3d14c4354250b19b&quot;],&quot;rendered&quot;:[0,{&quot;html&quot;:[0,&quot;&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;javascript\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;/**&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt; * &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;@param&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; { object }&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; obj&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt; * &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;@returns&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; { object }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt; */&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;const&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; deepCopy&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; (&lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;obj&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;) &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  let&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; target &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; null&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  if&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; (&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;typeof&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; obj &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;===&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; &#39;object&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;    if&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; (Array.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;isArray&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(obj)) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      target &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; [];&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      obj.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;forEach&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;((&lt;/span&gt;&lt;span style=\&quot;color:#E36209;--shiki-dark:#FFAB70\&quot;&gt;item&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;) &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&gt;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;        target.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;push&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;deepCopy&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(item));&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      });&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    } &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;else&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; if&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; (obj) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      target &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {};&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;      for&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; (&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;const&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; [&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;key&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;value&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;] &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;of&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; Object.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;entries&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(obj)) {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;        target[key] &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; deepCopy&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(obj[key]);&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    } &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;else&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;      target &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; obj;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  } &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;else&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; {&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    target &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; obj;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;  }&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;  return&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; target;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;};&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&quot;],&quot;metadata&quot;:[0,{&quot;headings&quot;:[1,[]],&quot;localImagePaths&quot;:[1,[]],&quot;remoteImagePaths&quot;:[1,[]],&quot;frontmatter&quot;:[0,{&quot;title&quot;:[0,&quot;JS对象数组深拷贝&quot;],&quot;date&quot;:[3,&quot;2023-02-08T21:52:20.000Z&quot;],&quot;tags&quot;:[0,&quot;技术分享&quot;]}],&quot;imagePaths&quot;:[1,[]]}]}],&quot;collection&quot;:[0,&quot;blog&quot;]}],&quot;href&quot;:[0,&quot;/blog/post/19&quot;]}],[0,{&quot;post&quot;:[0,{&quot;id&quot;:[0,&quot;cenos-7-6搭建pptp服务&quot;],&quot;data&quot;:[0,{&quot;title&quot;:[0,&quot;CenOS-7.6搭建pptp服务&quot;],&quot;date&quot;:[3,&quot;2023-02-05T10:36:58.000Z&quot;],&quot;tags&quot;:[0,&quot;技术分享&quot;]}],&quot;body&quot;:[0,&quot;## 参考教程\n\n&lt;a href=\&quot;https://help.aliyun.com/document_detail/41345.html\&quot; target=\&quot;_blank\&quot;&gt;见阿里云教程&lt;/a&gt;\n\n## 防火墙配置问题\n\n按照阿里云步骤走完，如果提醒远程连接计算机端口已关闭的话。可能是没开放端口。\n\n需要更改防火墙的策略。\n\n```bash\n# 查看防火墙当前配置\niptables -L -n\n\n# 允许所有请求\niptables -P INPUT ACCEPT\n\n# 清空默认所有规则\niptables -F\n\n# 清空自定义所有规则\niptables -X\n\n# 计数器置0\niptables -Z\n\n# 允许127.0.0.1访问本地服务\niptables -A INPUT -i lo -j ACCEPT\n\n# 允许访问外部服务\niptables -A INPUT -m state --state ESTABLISHED -j ACCEPT\n\n# 允许 ping\niptables -A INPUT -p icmp -m icmp --icmp-type 8 -j ACCEPT\n\n# 开启 ssh 端口\niptables -A INPUT -p tcp --dport 22 -j ACCEPT\n\n# 开启 pptpd 端口\niptables -A INPUT -p tcp --dport 1723 -j ACCEPT\n```\n\n## 注意事项\n\n哎嘿,昨天我搞了半天连不上。后来看了很多教程。才知道是我防火墙未放行。\n\n很多网上的教程并未提及防火墙放行这一步步骤。\n\n### 补充说明\n\n每次如果更改了DNS和ip段配置后。都要运行这个命令来生效哦：\n\n```bash\nsysctl -p              # 生效配置\nservice iptables save  # 保存防火墙配置\nservice iptables restart  # 重启防火墙\n```\n\n如果更改，或添加pptpd账号。也是需要重启pptp的。\n\n```bash\nservice pptpd restart  # 重启pptp\n```&quot;],&quot;filePath&quot;:[0,&quot;source/posts/CenOS-7-6搭建pptp服务.md&quot;],&quot;digest&quot;:[0,&quot;a05f5af800f47570&quot;],&quot;rendered&quot;:[0,{&quot;html&quot;:[0,&quot;&lt;h2 id=\&quot;参考教程\&quot;&gt;参考教程&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#参考教程\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;&lt;a href=\&quot;https://help.aliyun.com/document_detail/41345.html\&quot; target=\&quot;_blank\&quot;&gt;见阿里云教程&lt;/a&gt;&lt;/p&gt;\n&lt;h2 id=\&quot;防火墙配置问题\&quot;&gt;防火墙配置问题&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#防火墙配置问题\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;按照阿里云步骤走完，如果提醒远程连接计算机端口已关闭的话。可能是没开放端口。&lt;/p&gt;\n&lt;p&gt;需要更改防火墙的策略。&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;bash\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;# 查看防火墙当前配置&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;iptables&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; -L&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; -n&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;# 允许所有请求&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;iptables&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; -P&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; INPUT&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; ACCEPT&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;# 清空默认所有规则&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;iptables&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; -F&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;# 清空自定义所有规则&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;iptables&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; -X&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;# 计数器置0&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;iptables&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; -Z&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;# 允许127.0.0.1访问本地服务&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;iptables&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; -A&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; INPUT&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; -i&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; lo&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; -j&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; ACCEPT&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;# 允许访问外部服务&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;iptables&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; -A&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; INPUT&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; -m&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; state&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; --state&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; ESTABLISHED&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; -j&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; ACCEPT&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;# 允许 ping&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;iptables&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; -A&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; INPUT&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; -p&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; icmp&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; -m&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; icmp&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; --icmp-type&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; 8&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; -j&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; ACCEPT&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;# 开启 ssh 端口&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;iptables&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; -A&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; INPUT&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; -p&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; tcp&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; --dport&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; 22&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; -j&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; ACCEPT&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;# 开启 pptpd 端口&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;iptables&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; -A&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; INPUT&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; -p&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; tcp&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; --dport&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; 1723&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; -j&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; ACCEPT&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h2 id=\&quot;注意事项\&quot;&gt;注意事项&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#注意事项\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;哎嘿,昨天我搞了半天连不上。后来看了很多教程。才知道是我防火墙未放行。&lt;/p&gt;\n&lt;p&gt;很多网上的教程并未提及防火墙放行这一步步骤。&lt;/p&gt;\n&lt;h3 id=\&quot;补充说明\&quot;&gt;补充说明&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#补充说明\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;每次如果更改了DNS和ip段配置后。都要运行这个命令来生效哦：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;bash\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;sysctl&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt; -p&lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;              # 生效配置&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;service&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; iptables&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; save&lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;  # 保存防火墙配置&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;service&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; iptables&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; restart&lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;  # 重启防火墙&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;如果更改，或添加pptpd账号。也是需要重启pptp的。&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;bash\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;service&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; pptpd&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; restart&lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;  # 重启pptp&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&quot;],&quot;metadata&quot;:[0,{&quot;headings&quot;:[1,[[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;参考教程&quot;],&quot;text&quot;:[0,&quot;参考教程&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;防火墙配置问题&quot;],&quot;text&quot;:[0,&quot;防火墙配置问题&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;注意事项&quot;],&quot;text&quot;:[0,&quot;注意事项&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;补充说明&quot;],&quot;text&quot;:[0,&quot;补充说明&quot;]}]]],&quot;localImagePaths&quot;:[1,[]],&quot;remoteImagePaths&quot;:[1,[]],&quot;frontmatter&quot;:[0,{&quot;title&quot;:[0,&quot;CenOS-7.6搭建pptp服务&quot;],&quot;date&quot;:[3,&quot;2023-02-05T10:36:58.000Z&quot;],&quot;tags&quot;:[0,&quot;技术分享&quot;]}],&quot;imagePaths&quot;:[1,[]]}]}],&quot;collection&quot;:[0,&quot;blog&quot;]}],&quot;href&quot;:[0,&quot;/blog/post/18&quot;]}],[0,{&quot;post&quot;:[0,{&quot;id&quot;:[0,&quot;不到半个月就要变猫了&quot;],&quot;data&quot;:[0,{&quot;title&quot;:[0,&quot;不到半个月就要变猫了&quot;],&quot;date&quot;:[3,&quot;2023-02-04T21:09:52.000Z&quot;],&quot;tags&quot;:[0,&quot;碎碎念&quot;]}],&quot;body&quot;:[0,&quot;&lt;p&gt;距离SRS还有12天大概的样子吧。如果不出意外的话。&lt;/p&gt;\n&lt;p&gt;说实话个人感觉挺慌的&lt;/p&gt;\n&lt;p&gt;术前紧张。肯定有的。害!!&lt;/p&gt;\n&lt;p&gt;但愿未来能够一切顺利吧&lt;/p&gt;\n\n![emj](../img/QQ图片20230204211241.jpg)&quot;],&quot;filePath&quot;:[0,&quot;source/posts/不到半个月就要变猫了.md&quot;],&quot;assetImports&quot;:[1,[[0,&quot;../img/QQ图片20230204211241.jpg&quot;]]],&quot;digest&quot;:[0,&quot;0e7d9a998d535192&quot;],&quot;rendered&quot;:[0,{&quot;html&quot;:[0,&quot;&lt;p&gt;距离SRS还有12天大概的样子吧。如果不出意外的话。&lt;/p&gt;\n&lt;p&gt;说实话个人感觉挺慌的&lt;/p&gt;\n&lt;p&gt;术前紧张。肯定有的。害!!&lt;/p&gt;\n&lt;p&gt;但愿未来能够一切顺利吧&lt;/p&gt;\n&lt;p&gt;&lt;/p&gt;&lt;figure class=\&quot;markdown-image-wrapper\&quot;&gt;&lt;img __ASTRO_IMAGE_=\&quot;{&amp;#x22;src&amp;#x22;:&amp;#x22;../img/QQ图片20230204211241.jpg&amp;#x22;,&amp;#x22;alt&amp;#x22;:&amp;#x22;emj&amp;#x22;,&amp;#x22;loading&amp;#x22;:&amp;#x22;lazy&amp;#x22;,&amp;#x22;decoding&amp;#x22;:&amp;#x22;async&amp;#x22;,&amp;#x22;class&amp;#x22;:&amp;#x22;markdown-image&amp;#x22;,&amp;#x22;index&amp;#x22;:0}\&quot;&gt;&lt;/figure&gt;&lt;p&gt;&lt;/p&gt;&quot;],&quot;metadata&quot;:[0,{&quot;headings&quot;:[1,[]],&quot;localImagePaths&quot;:[1,[[0,&quot;../img/QQ图片20230204211241.jpg&quot;]]],&quot;remoteImagePaths&quot;:[1,[]],&quot;frontmatter&quot;:[0,{&quot;title&quot;:[0,&quot;不到半个月就要变猫了&quot;],&quot;date&quot;:[3,&quot;2023-02-04T21:09:52.000Z&quot;],&quot;tags&quot;:[0,&quot;碎碎念&quot;]}],&quot;imagePaths&quot;:[1,[[0,&quot;../img/QQ图片20230204211241.jpg&quot;]]]}]}],&quot;collection&quot;:[0,&quot;blog&quot;]}],&quot;href&quot;:[0,&quot;/blog/post/17&quot;]}],[0,{&quot;post&quot;:[0,{&quot;id&quot;:[0,&quot;不知道怎么过年&quot;],&quot;data&quot;:[0,{&quot;title&quot;:[0,&quot;不知道怎么过年&quot;],&quot;date&quot;:[3,&quot;2023-01-18T00:06:04.000Z&quot;],&quot;tags&quot;:[0,&quot;碎碎念&quot;]}],&quot;body&quot;:[0,&quot;&lt;p&gt;\n 没车票，黄牛票太贵。不太想回去过年。而且，最近的烦心事真的是好多。今年三月、四月可能要进行SRS🍥，要向公司请一个月假，就非常地头疼。\n&lt;/p&gt;\n\n![emj](../img/u=3523309784,1268457401&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=JPEG.webp)&quot;],&quot;filePath&quot;:[0,&quot;source/posts/不知道怎么过年.md&quot;],&quot;assetImports&quot;:[1,[[0,&quot;../img/u=3523309784,1268457401&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=JPEG.webp&quot;]]],&quot;digest&quot;:[0,&quot;ce96061b5405f056&quot;],&quot;rendered&quot;:[0,{&quot;html&quot;:[0,&quot;&lt;p&gt;\n 没车票，黄牛票太贵。不太想回去过年。而且，最近的烦心事真的是好多。今年三月、四月可能要进行SRS🍥，要向公司请一个月假，就非常地头疼。\n&lt;/p&gt;\n&lt;p&gt;&lt;/p&gt;&lt;figure class=\&quot;markdown-image-wrapper\&quot;&gt;&lt;img __ASTRO_IMAGE_=\&quot;{&amp;#x22;src&amp;#x22;:&amp;#x22;../img/u=3523309784,1268457401&amp;#x26;fm=253&amp;#x26;fmt=auto&amp;#x26;app=138&amp;#x26;f=JPEG.webp&amp;#x22;,&amp;#x22;alt&amp;#x22;:&amp;#x22;emj&amp;#x22;,&amp;#x22;loading&amp;#x22;:&amp;#x22;lazy&amp;#x22;,&amp;#x22;decoding&amp;#x22;:&amp;#x22;async&amp;#x22;,&amp;#x22;class&amp;#x22;:&amp;#x22;markdown-image&amp;#x22;,&amp;#x22;index&amp;#x22;:0}\&quot;&gt;&lt;/figure&gt;&lt;p&gt;&lt;/p&gt;&quot;],&quot;metadata&quot;:[0,{&quot;headings&quot;:[1,[]],&quot;localImagePaths&quot;:[1,[[0,&quot;../img/u=3523309784,1268457401&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=JPEG.webp&quot;]]],&quot;remoteImagePaths&quot;:[1,[]],&quot;frontmatter&quot;:[0,{&quot;title&quot;:[0,&quot;不知道怎么过年&quot;],&quot;date&quot;:[3,&quot;2023-01-18T00:06:04.000Z&quot;],&quot;tags&quot;:[0,&quot;碎碎念&quot;]}],&quot;imagePaths&quot;:[1,[[0,&quot;../img/u=3523309784,1268457401&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=JPEG.webp&quot;]]]}]}],&quot;collection&quot;:[0,&quot;blog&quot;]}],&quot;href&quot;:[0,&quot;/blog/post/16&quot;]}]]],&quot;currentPostSlug&quot;:[0,&quot;electron热更新后启动性能优化-v8缓存与代码拆包实战&quot;],&quot;prevPostItem&quot;:[0,{&quot;post&quot;:[0,{&quot;id&quot;:[0,&quot;rust-cow-learning-notes&quot;],&quot;data&quot;:[0,{&quot;title&quot;:[0,&quot;Rust Cow（Clone-On-Write）学习笔记：理解 Borrowed 状态&quot;],&quot;description&quot;:[0,&quot;本文通过一个具体的测试案例，深入探讨了 Rust 中 Cow（Clone-On-Write）智能指针的 Borrowed 状态。我们将理解在何种情况下 Cow 会保持借用，以及它何时会克隆数据变为所有。&quot;],&quot;date&quot;:[3,&quot;2025-12-05T00:00:00.000Z&quot;],&quot;tags&quot;:[1,[[0,&quot;Rust&quot;],[0,&quot;Cow&quot;],[0,&quot;Smart Pointers&quot;],[0,&quot;Borrowing&quot;]]]}],&quot;body&quot;:[0,&quot;在 Rust 的智能指针中，`Cow` (Clone-On-Write) 提供了一种灵活的数据处理方式，它可以在需要时才进行数据克隆，从而优化性能。本文将通过一个具体的案例，来深入理解 `Cow` 的 `Borrowed` 状态。\n\n### `Cow::Borrowed` 是什么？\n\n在 Rust 中，`Cow` 类型有两种主要的状态：\n\n- `Cow::Borrowed&lt;&#39;a, T&gt;`：表示 `Cow` 只是“借用”了原始数据，它持有一个对类型 `T` 的不可变引用 `&amp;&#39;a T`。在这种状态下，`Cow` 不拥有数据的所有权，也不会对原始数据进行任何修改。\n- `Cow::Owned&lt;T&gt;`：表示 `Cow` 拥有了一份数据的副本。当需要修改数据，且 `Cow` 当前处于 `Borrowed` 状态时，它会自动克隆一份数据，并转换为 `Owned` 状态，从而允许进行修改。\n\n### 案例分析：`reference_no_mutation` 测试\n\n我们来看一个在 `rustlings` 练习中常见的测试案例，它帮助我们理解 `Cow` 的行为：\n\n```rust\n// 假设有如下的 abs_all 函数\nfn abs_all&lt;&#39;a, T&gt;(input: Cow&lt;&#39;a, [T]&gt;) -&gt; Cow&lt;&#39;a, [T]&gt;\nwhere\n    T: Clone + Copy + PartialOrd + std::ops::Neg&lt;Output = T&gt;,\n{\n    input\n        .into_iter()\n        .map(|&amp;x| if x &lt; T::from(0) { -x } else { x })\n        .collect::&lt;Vec&lt;T&gt;&gt;()\n        .into()\n}\n\n// 在 reference_no_mutation 测试中\nlet input_vec = vec![0, 1, 2];\nlet mut input = Cow::from(&amp;input_vec); // 通过 Cow::from(&amp;vec) 创建，此时 input 是 Borrowed 状态\nlet result = abs_all(input.clone()); // 传入 abs_all 函数\n\nassert!(matches!(input, Cow::Borrowed(_))); // 这个断言会成功\n```\n\n**分析过程：**\n\n1.  **创建 `Cow`：** 在 `reference_no_mutation` 测试中，`input` 是通过 `Cow::from(&amp;input_vec)` 创建的。这意味着 `input` 最初是对 `input_vec` 的一个借用 (`Cow::Borrowed`)，它不拥有数据的所有权。\n\n2.  **`abs_all` 函数的行为：** `abs_all` 函数的目的是将切片中的所有负数变为正数（取绝对值）。它通过 `into_iter().map(...)` 遍历元素。关键在于 `map` 内部的逻辑：`if x &lt; T::from(0) { -x } else { x }`。只有当元素 `x` 小于 0 时，才会进行操作 `-x`。\n\n3.  **无修改发生：** 在这个特定的测试中，`input_vec` 的内容是 `[0, 1, 2]`，所有元素都是非负数。因此，在 `abs_all` 函数内部，条件 `x &lt; T::from(0)` **从未**满足。这意味着 `input`（或者其内部数据）并没有被实际修改。\n\n4.  **`to_mut()` 未被调用：** `Cow` 只有在需要修改借用的数据时，才会调用 `to_mut()` 方法来克隆数据并转换为 `Owned` 状态。由于上述原因，没有任何元素需要修改，所以 `to_mut()` 从未被调用。\n\n5.  **结果：保持 `Borrowed` 状态：** 因为 `input` 在 `abs_all` 函数的整个执行过程中都没有被修改，也因此没有触发数据克隆，`input` 仍然保持着对原始数据 `input_vec` 的借用状态。\n\n### 结论\n\n因此，`assert!(matches!(input, Cow::Borrowed(_)))` 断言成立。这个例子清晰地展示了 `Cow` 的“Copy-On-Write”机制：只有在实际需要写入（修改）时，才会发生数据的克隆和所有权的转移。如果数据仅仅被读取，`Cow` 会高效地保持 `Borrowed` 状态，避免不必要的内存分配和数据复制。理解这一点对于编写高效的 Rust 代码至关重要。&quot;],&quot;filePath&quot;:[0,&quot;source/posts/rust-cow-learning-notes.md&quot;],&quot;digest&quot;:[0,&quot;dbda7a0aedd34573&quot;],&quot;rendered&quot;:[0,{&quot;html&quot;:[0,&quot;&lt;p&gt;在 Rust 的智能指针中，&lt;code&gt;Cow&lt;/code&gt; (Clone-On-Write) 提供了一种灵活的数据处理方式，它可以在需要时才进行数据克隆，从而优化性能。本文将通过一个具体的案例，来深入理解 &lt;code&gt;Cow&lt;/code&gt; 的 &lt;code&gt;Borrowed&lt;/code&gt; 状态。&lt;/p&gt;\n&lt;h3 id=\&quot;cowborrowed-是什么\&quot;&gt;&lt;code&gt;Cow::Borrowed&lt;/code&gt; 是什么？&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#cowborrowed-是什么\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;在 Rust 中，&lt;code&gt;Cow&lt;/code&gt; 类型有两种主要的状态：&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;code&gt;Cow::Borrowed&amp;#x3C;&#39;a, T&gt;&lt;/code&gt;：表示 &lt;code&gt;Cow&lt;/code&gt; 只是“借用”了原始数据，它持有一个对类型 &lt;code&gt;T&lt;/code&gt; 的不可变引用 &lt;code&gt;&amp;#x26;&#39;a T&lt;/code&gt;。在这种状态下，&lt;code&gt;Cow&lt;/code&gt; 不拥有数据的所有权，也不会对原始数据进行任何修改。&lt;/li&gt;\n&lt;li&gt;&lt;code&gt;Cow::Owned&amp;#x3C;T&gt;&lt;/code&gt;：表示 &lt;code&gt;Cow&lt;/code&gt; 拥有了一份数据的副本。当需要修改数据，且 &lt;code&gt;Cow&lt;/code&gt; 当前处于 &lt;code&gt;Borrowed&lt;/code&gt; 状态时，它会自动克隆一份数据，并转换为 &lt;code&gt;Owned&lt;/code&gt; 状态，从而允许进行修改。&lt;/li&gt;\n&lt;/ul&gt;\n&lt;h3 id=\&quot;案例分析reference_no_mutation-测试\&quot;&gt;案例分析：&lt;code&gt;reference_no_mutation&lt;/code&gt; 测试&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#案例分析reference_no_mutation-测试\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;我们来看一个在 &lt;code&gt;rustlings&lt;/code&gt; 练习中常见的测试案例，它帮助我们理解 &lt;code&gt;Cow&lt;/code&gt; 的行为：&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;rust\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 假设有如下的 abs_all 函数&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;fn&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; abs_all&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&#39;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;a&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;T&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&gt;(input&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;:&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Cow&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&#39;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;a&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, [&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;T&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;]&gt;) &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;-&gt;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Cow&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&#39;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;a&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, [&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;T&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;]&gt;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;where&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;    T&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;:&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Clone&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; +&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Copy&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; +&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; PartialOrd&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; +&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; std&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;ops&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Neg&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Output&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; =&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; T&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&gt;,&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;{&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;    input&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;        .&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;into_iter&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;()&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;        .&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;map&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;|&amp;#x26;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;x&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;|&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; if&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; x &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; T&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;from&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;0&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;) { &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;-&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;x } &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;else&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; { x })&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;        .&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;collect&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Vec&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&amp;#x3C;&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;T&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;&gt;&gt;()&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;        .&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;into&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;()&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;}&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 在 reference_no_mutation 测试中&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;let&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; input_vec &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; vec!&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;[&lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;0&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;1&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;, &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;2&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;];&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;let&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt; mut&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; input &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; Cow&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;from&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;&amp;#x26;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;input_vec); &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 通过 Cow::from(&amp;#x26;vec) 创建，此时 input 是 Borrowed 状态&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;let&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; result &lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt; abs_all&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(input&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;clone&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;()); &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 传入 abs_all 函数&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;assert!&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;matches!&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(input, &lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Cow&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;::&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;Borrowed&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;(_))); &lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt;// 这个断言会成功&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;&lt;strong&gt;分析过程：&lt;/strong&gt;&lt;/p&gt;\n&lt;ol&gt;\n&lt;li&gt;\n&lt;p&gt;&lt;strong&gt;创建 &lt;code&gt;Cow&lt;/code&gt;：&lt;/strong&gt; 在 &lt;code&gt;reference_no_mutation&lt;/code&gt; 测试中，&lt;code&gt;input&lt;/code&gt; 是通过 &lt;code&gt;Cow::from(&amp;#x26;input_vec)&lt;/code&gt; 创建的。这意味着 &lt;code&gt;input&lt;/code&gt; 最初是对 &lt;code&gt;input_vec&lt;/code&gt; 的一个借用 (&lt;code&gt;Cow::Borrowed&lt;/code&gt;)，它不拥有数据的所有权。&lt;/p&gt;\n&lt;/li&gt;\n&lt;li&gt;\n&lt;p&gt;&lt;strong&gt;&lt;code&gt;abs_all&lt;/code&gt; 函数的行为：&lt;/strong&gt; &lt;code&gt;abs_all&lt;/code&gt; 函数的目的是将切片中的所有负数变为正数（取绝对值）。它通过 &lt;code&gt;into_iter().map(...)&lt;/code&gt; 遍历元素。关键在于 &lt;code&gt;map&lt;/code&gt; 内部的逻辑：&lt;code&gt;if x &amp;#x3C; T::from(0) { -x } else { x }&lt;/code&gt;。只有当元素 &lt;code&gt;x&lt;/code&gt; 小于 0 时，才会进行操作 &lt;code&gt;-x&lt;/code&gt;。&lt;/p&gt;\n&lt;/li&gt;\n&lt;li&gt;\n&lt;p&gt;&lt;strong&gt;无修改发生：&lt;/strong&gt; 在这个特定的测试中，&lt;code&gt;input_vec&lt;/code&gt; 的内容是 &lt;code&gt;[0, 1, 2]&lt;/code&gt;，所有元素都是非负数。因此，在 &lt;code&gt;abs_all&lt;/code&gt; 函数内部，条件 &lt;code&gt;x &amp;#x3C; T::from(0)&lt;/code&gt; &lt;strong&gt;从未&lt;/strong&gt;满足。这意味着 &lt;code&gt;input&lt;/code&gt;（或者其内部数据）并没有被实际修改。&lt;/p&gt;\n&lt;/li&gt;\n&lt;li&gt;\n&lt;p&gt;&lt;strong&gt;&lt;code&gt;to_mut()&lt;/code&gt; 未被调用：&lt;/strong&gt; &lt;code&gt;Cow&lt;/code&gt; 只有在需要修改借用的数据时，才会调用 &lt;code&gt;to_mut()&lt;/code&gt; 方法来克隆数据并转换为 &lt;code&gt;Owned&lt;/code&gt; 状态。由于上述原因，没有任何元素需要修改，所以 &lt;code&gt;to_mut()&lt;/code&gt; 从未被调用。&lt;/p&gt;\n&lt;/li&gt;\n&lt;li&gt;\n&lt;p&gt;&lt;strong&gt;结果：保持 &lt;code&gt;Borrowed&lt;/code&gt; 状态：&lt;/strong&gt; 因为 &lt;code&gt;input&lt;/code&gt; 在 &lt;code&gt;abs_all&lt;/code&gt; 函数的整个执行过程中都没有被修改，也因此没有触发数据克隆，&lt;code&gt;input&lt;/code&gt; 仍然保持着对原始数据 &lt;code&gt;input_vec&lt;/code&gt; 的借用状态。&lt;/p&gt;\n&lt;/li&gt;\n&lt;/ol&gt;\n&lt;h3 id=\&quot;结论\&quot;&gt;结论&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#结论\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;因此，&lt;code&gt;assert!(matches!(input, Cow::Borrowed(_)))&lt;/code&gt; 断言成立。这个例子清晰地展示了 &lt;code&gt;Cow&lt;/code&gt; 的“Copy-On-Write”机制：只有在实际需要写入（修改）时，才会发生数据的克隆和所有权的转移。如果数据仅仅被读取，&lt;code&gt;Cow&lt;/code&gt; 会高效地保持 &lt;code&gt;Borrowed&lt;/code&gt; 状态，避免不必要的内存分配和数据复制。理解这一点对于编写高效的 Rust 代码至关重要。&lt;/p&gt;&quot;],&quot;metadata&quot;:[0,{&quot;headings&quot;:[1,[[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;cowborrowed-是什么&quot;],&quot;text&quot;:[0,&quot;Cow::Borrowed 是什么？&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;案例分析reference_no_mutation-测试&quot;],&quot;text&quot;:[0,&quot;案例分析：reference_no_mutation 测试&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;结论&quot;],&quot;text&quot;:[0,&quot;结论&quot;]}]]],&quot;localImagePaths&quot;:[1,[]],&quot;remoteImagePaths&quot;:[1,[]],&quot;frontmatter&quot;:[0,{&quot;title&quot;:[0,&quot;Rust Cow（Clone-On-Write）学习笔记：理解 Borrowed 状态&quot;],&quot;date&quot;:[3,&quot;2025-12-05T00:00:00.000Z&quot;],&quot;tags&quot;:[1,[[0,&quot;Rust&quot;],[0,&quot;Cow&quot;],[0,&quot;Smart Pointers&quot;],[0,&quot;Borrowing&quot;]]],&quot;description&quot;:[0,&quot;本文通过一个具体的测试案例，深入探讨了 Rust 中 Cow（Clone-On-Write）智能指针的 Borrowed 状态。我们将理解在何种情况下 Cow 会保持借用，以及它何时会克隆数据变为所有。&quot;]}],&quot;imagePaths&quot;:[1,[]]}]}],&quot;collection&quot;:[0,&quot;blog&quot;]}],&quot;href&quot;:[0,&quot;/blog/post/37&quot;]}],&quot;nextPostItem&quot;:[0,{&quot;post&quot;:[0,{&quot;id&quot;:[0,&quot;配置-codex-自定义三方api&quot;],&quot;data&quot;:[0,{&quot;title&quot;:[0,&quot;配置 Codex 自定义三方API&quot;],&quot;date&quot;:[3,&quot;2025-10-22T10:00:00.000Z&quot;],&quot;tags&quot;:[1,[[0,&quot;CodeX&quot;],[0,&quot;AI&quot;],[0,&quot;配置&quot;]]],&quot;categories&quot;:[0,&quot;技术教程&quot;]}],&quot;body&quot;:[0,&quot;最近在用 Claude Code,换了成本更低的Codex,记录一下配置过程。方便以后查看，快速配置。\n\n## 配置路径\n\n配置文件位置:\n\n- **macOS/Linux**: `~/.codex/config.toml`\n- **Windows**: `C:\\Users\\你的用户名\\.codex\\config.toml`\n\n## 配置文件\n\n直接上配置:\n\n```toml\nmodel_provider = \&quot;codex\&quot;\nmodel = \&quot;gpt-4.1-mini\&quot;\nmodel_reasoning_effort = \&quot;medium\&quot;\ndisable_response_storage = true\nwindows_wsl_setup_acknowledged = true\n\n[model_providers.codex]\nname = \&quot;codex\&quot;\nbase_url=\&quot;https://api.burn.hair/v1\&quot; #使用官方或第三方的\nwire_api = \&quot;responses\&quot;\nenv_key = \&quot;K_CODEX\&quot; #不要改成自己的密钥,在系统环境变量中设置\n```\n\n## 参数说明\n\n几个关键配置:\n\n- `model_provider`: 设置成 `\&quot;codex\&quot;` 就行\n- `model`: 用的模型,这里是 `gpt-4.1-mini`\n- `model_reasoning_effort`: 推理强度,`low`/`medium`/`high` 三档,medium 够用\n- `disable_response_storage`: 不保存历史记录,开启更安全\n- `base_url`: API 地址,换成你自己的\n- `env_key`: 环境变量名,**密钥别直接写配置文件里**\n\n## 设置步骤\n\n### 1. 修改配置文件\n\n找到配置文件,把上面的配置复制进去,改一下 `base_url` 和 `model`。\n\n### 2. 设置环境变量\n\n**macOS/Linux** 在 `~/.zshrc` 或 `~/.bashrc` 加一行:\n\n```bash\nexport K_CODEX=\&quot;your-api-key-here\&quot;\n```\n\n然后 `source ~/.zshrc` 生效。\n\n**Windows** PowerShell 执行:\n\n```powershell\n[System.Environment]::SetEnvironmentVariable(&#39;K_CODEX&#39;, &#39;your-api-key-here&#39;, &#39;User&#39;)\n```\n\n### 3. 重启终端\n\n重启终端就能用了。&quot;],&quot;filePath&quot;:[0,&quot;source/posts/配置 Codex 自定义三方API.md&quot;],&quot;digest&quot;:[0,&quot;b4fa279e184dff34&quot;],&quot;rendered&quot;:[0,{&quot;html&quot;:[0,&quot;&lt;p&gt;最近在用 Claude Code,换了成本更低的Codex,记录一下配置过程。方便以后查看，快速配置。&lt;/p&gt;\n&lt;h2 id=\&quot;配置路径\&quot;&gt;配置路径&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#配置路径\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;配置文件位置:&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;strong&gt;macOS/Linux&lt;/strong&gt;: &lt;code&gt;~/.codex/config.toml&lt;/code&gt;&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;Windows&lt;/strong&gt;: &lt;code&gt;C:\\Users\\你的用户名\\.codex\\config.toml&lt;/code&gt;&lt;/li&gt;\n&lt;/ul&gt;\n&lt;h2 id=\&quot;配置文件\&quot;&gt;配置文件&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#配置文件\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;直接上配置:&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;toml\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;model_provider = &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;\&quot;codex\&quot;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;model = &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;\&quot;gpt-4.1-mini\&quot;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;model_reasoning_effort = &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;\&quot;medium\&quot;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;disable_response_storage = &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;true&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;windows_wsl_setup_acknowledged = &lt;/span&gt;&lt;span style=\&quot;color:#005CC5;--shiki-dark:#79B8FF\&quot;&gt;true&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;[&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;model_providers&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;.&lt;/span&gt;&lt;span style=\&quot;color:#6F42C1;--shiki-dark:#B392F0\&quot;&gt;codex&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;]&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;name = &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;\&quot;codex\&quot;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;base_url=&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;\&quot;https://api.burn.hair/v1\&quot;&lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt; #使用官方或第三方的&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;wire_api = &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;\&quot;responses\&quot;&lt;/span&gt;&lt;/span&gt;\n&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;env_key = &lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;\&quot;K_CODEX\&quot;&lt;/span&gt;&lt;span style=\&quot;color:#6A737D;--shiki-dark:#6A737D\&quot;&gt; #不要改成自己的密钥,在系统环境变量中设置&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h2 id=\&quot;参数说明\&quot;&gt;参数说明&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#参数说明\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;p&gt;几个关键配置:&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;code&gt;model_provider&lt;/code&gt;: 设置成 &lt;code&gt;\&quot;codex\&quot;&lt;/code&gt; 就行&lt;/li&gt;\n&lt;li&gt;&lt;code&gt;model&lt;/code&gt;: 用的模型,这里是 &lt;code&gt;gpt-4.1-mini&lt;/code&gt;&lt;/li&gt;\n&lt;li&gt;&lt;code&gt;model_reasoning_effort&lt;/code&gt;: 推理强度,&lt;code&gt;low&lt;/code&gt;/&lt;code&gt;medium&lt;/code&gt;/&lt;code&gt;high&lt;/code&gt; 三档,medium 够用&lt;/li&gt;\n&lt;li&gt;&lt;code&gt;disable_response_storage&lt;/code&gt;: 不保存历史记录,开启更安全&lt;/li&gt;\n&lt;li&gt;&lt;code&gt;base_url&lt;/code&gt;: API 地址,换成你自己的&lt;/li&gt;\n&lt;li&gt;&lt;code&gt;env_key&lt;/code&gt;: 环境变量名,&lt;strong&gt;密钥别直接写配置文件里&lt;/strong&gt;&lt;/li&gt;\n&lt;/ul&gt;\n&lt;h2 id=\&quot;设置步骤\&quot;&gt;设置步骤&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#设置步骤\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;\n&lt;h3 id=\&quot;1-修改配置文件\&quot;&gt;1. 修改配置文件&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#1-修改配置文件\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;找到配置文件,把上面的配置复制进去,改一下 &lt;code&gt;base_url&lt;/code&gt; 和 &lt;code&gt;model&lt;/code&gt;。&lt;/p&gt;\n&lt;h3 id=\&quot;2-设置环境变量\&quot;&gt;2. 设置环境变量&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#2-设置环境变量\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;&lt;strong&gt;macOS/Linux&lt;/strong&gt; 在 &lt;code&gt;~/.zshrc&lt;/code&gt; 或 &lt;code&gt;~/.bashrc&lt;/code&gt; 加一行:&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;bash\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;export&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt; K_CODEX&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;=&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;\&quot;your-api-key-here\&quot;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;然后 &lt;code&gt;source ~/.zshrc&lt;/code&gt; 生效。&lt;/p&gt;\n&lt;p&gt;&lt;strong&gt;Windows&lt;/strong&gt; PowerShell 执行:&lt;/p&gt;\n&lt;pre class=\&quot;astro-code astro-code-themes github-light github-dark\&quot; style=\&quot;background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;\&quot; tabindex=\&quot;0\&quot; data-language=\&quot;powershell\&quot;&gt;&lt;code&gt;&lt;span class=\&quot;line\&quot;&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;[&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;System.Environment&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;]::SetEnvironmentVariable(&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt;&#39;K_CODEX&#39;&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;,&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; &#39;your-api-key-here&#39;&lt;/span&gt;&lt;span style=\&quot;color:#D73A49;--shiki-dark:#F97583\&quot;&gt;,&lt;/span&gt;&lt;span style=\&quot;color:#032F62;--shiki-dark:#9ECBFF\&quot;&gt; &#39;User&#39;&lt;/span&gt;&lt;span style=\&quot;color:#24292E;--shiki-dark:#E1E4E8\&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;h3 id=\&quot;3-重启终端\&quot;&gt;3. 重启终端&lt;a class=\&quot;anchor-link\&quot; href=\&quot;#3-重启终端\&quot;&gt;&lt;span class=\&quot;icon icon-link\&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/h3&gt;\n&lt;p&gt;重启终端就能用了。&lt;/p&gt;&quot;],&quot;metadata&quot;:[0,{&quot;headings&quot;:[1,[[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;配置路径&quot;],&quot;text&quot;:[0,&quot;配置路径&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;配置文件&quot;],&quot;text&quot;:[0,&quot;配置文件&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;参数说明&quot;],&quot;text&quot;:[0,&quot;参数说明&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;设置步骤&quot;],&quot;text&quot;:[0,&quot;设置步骤&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;1-修改配置文件&quot;],&quot;text&quot;:[0,&quot;1. 修改配置文件&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;2-设置环境变量&quot;],&quot;text&quot;:[0,&quot;2. 设置环境变量&quot;]}],[0,{&quot;depth&quot;:[0,3],&quot;slug&quot;:[0,&quot;3-重启终端&quot;],&quot;text&quot;:[0,&quot;3. 重启终端&quot;]}]]],&quot;localImagePaths&quot;:[1,[]],&quot;remoteImagePaths&quot;:[1,[]],&quot;frontmatter&quot;:[0,{&quot;title&quot;:[0,&quot;配置 Codex 自定义三方API&quot;],&quot;date&quot;:[3,&quot;2025-10-22T10:00:00.000Z&quot;],&quot;tags&quot;:[1,[[0,&quot;CodeX&quot;],[0,&quot;AI&quot;],[0,&quot;配置&quot;]]],&quot;categories&quot;:[0,&quot;技术教程&quot;]}],&quot;imagePaths&quot;:[1,[]]}]}],&quot;collection&quot;:[0,&quot;blog&quot;]}],&quot;href&quot;:[0,&quot;/blog/post/31&quot;]}]}" ssr client="media" opts="{&quot;name&quot;:&quot;HomeSiderPanel&quot;,&quot;value&quot;:&quot;(min-width: 993px)&quot;}" await-children><link rel="preload" as="image" href="/img/724d7fb480c8ac0db472ca5c7e36d239.jpg" fetchPriority="high"/><div class="cursor-pointer rounded-sm bg-black/8 p-1 font-semibold backdrop-blur-lg select-none my-4 flex w-full justify-between text-sm/6"><div class="flex-center relative cursor-pointer gap-1.5 px-3 py-1 first:rounded-l-xs last:rounded-r-xs opacity-50 grow"><span class="flex-center shrink-0"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" class="w-4 h-4" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2ZM12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM15.8329 7.33748C16.0697 7.17128 16.3916 7.19926 16.5962 7.40381C16.8002 7.60784 16.8267 7.92955 16.6587 8.16418C14.479 11.2095 13.2796 12.8417 13.0607 13.0607C12.4749 13.6464 11.5251 13.6464 10.9393 13.0607C10.3536 12.4749 10.3536 11.5251 10.9393 10.9393C11.3126 10.5661 12.9438 9.36549 15.8329 7.33748ZM17.5 11C18.0523 11 18.5 11.4477 18.5 12C18.5 12.5523 18.0523 13 17.5 13C16.9477 13 16.5 12.5523 16.5 12C16.5 11.4477 16.9477 11 17.5 11ZM6.5 11C7.05228 11 7.5 11.4477 7.5 12C7.5 12.5523 7.05228 13 6.5 13C5.94772 13 5.5 12.5523 5.5 12C5.5 11.4477 5.94772 11 6.5 11ZM8.81802 7.40381C9.20854 7.79433 9.20854 8.4275 8.81802 8.81802C8.4275 9.20854 7.79433 9.20854 7.40381 8.81802C7.01328 8.4275 7.01328 7.79433 7.40381 7.40381C7.79433 7.01328 8.4275 7.01328 8.81802 7.40381ZM12 5.5C12.5523 5.5 13 5.94772 13 6.5C13 7.05228 12.5523 7.5 12 7.5C11.4477 7.5 11 7.05228 11 6.5C11 5.94772 11.4477 5.5 12 5.5Z"></path></svg></span></div><div class="flex-center relative cursor-pointer gap-1.5 px-3 py-1 first:rounded-l-xs last:rounded-r-xs text-primary-foreground grow"><span class="flex-center shrink-0"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" class="w-4 h-4" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M5.75024 3.5H4.71733L3.25 3.89317V5.44582L4.25002 5.17782L4.25018 8.5H3V10H7V8.5H5.75024V3.5ZM10 4H21V6H10V4ZM10 11H21V13H10V11ZM10 18H21V20H10V18ZM2.875 15.625C2.875 14.4514 3.82639 13.5 5 13.5C6.17361 13.5 7.125 14.4514 7.125 15.625C7.125 16.1106 6.96183 16.5587 6.68747 16.9167L6.68271 16.9229L5.31587 18.5H7V20H3.00012L2.99959 18.8786L5.4717 16.035C5.5673 15.9252 5.625 15.7821 5.625 15.625C5.625 15.2798 5.34518 15 5 15C4.67378 15 4.40573 15.2501 4.37747 15.5688L4.3651 15.875H2.875V15.625Z"></path></svg></span><span class="overflow-hidden whitespace-nowrap" style="width:auto;opacity:1">文章目录</span><div class="bg-gradient-shoka-button absolute inset-0 -z-10 rounded-sm" style="will-change:transform"></div></div><div class="flex-center relative cursor-pointer gap-1.5 px-3 py-1 first:rounded-l-xs last:rounded-r-xs opacity-50 grow"><span class="flex-center shrink-0"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" class="w-4 h-4" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M20 22H4C3.44772 22 3 21.5523 3 21V3C3 2.44772 3.44772 2 4 2H20C20.5523 2 21 2.44772 21 3V21C21 21.5523 20.5523 22 20 22ZM19 20V4H5V20H19ZM7 6H11V10H7V6ZM7 12H17V14H7V12ZM7 16H17V18H7V16ZM13 7H17V9H13V7Z"></path></svg></span></div></div><div class="vertical-scrollbar pt-10 scroll-gutter-stable relative block w-full flex-1 min-h-0 overflow-x-hidden overflow-y-auto md:pt-4 md:pl-3" data-type="post" data-default-type="directory"><div class="sider-slot" data-slot-type="info"><div class="flex flex-col items-center"><div class="h-40 w-40 rounded-full" style="background-image:linear-gradient(135deg, #d78f6f 0%, #d3a691 50%, #dd9378 100%)"><img class="shadow-card-darker hover:animate-shake h-full w-full rounded-full transition" src="/img/724d7fb480c8ac0db472ca5c7e36d239.jpg" alt="snow avatar" loading="eager" fetchPriority="high"/></div><p class="mt-2">snow</p><p class="text-muted-foreground mt-3 text-center">ACG / 养猫人 / 菜逼 / 前端什锦</p><div class="mt-2 grid grid-cols-3 gap-2"><div><a class="social-link flex-center group relative overflow-hidden rounded-xl px-1.5 py-1 transition-all duration-300 group-hover:scale-105" style="--link-color:#191717" data-platform="github" href="https://github.com/XueHua-s" title="GitHub" data-tooltip-interactive="false" data-tooltip-placement="top" aria-label="GitHub"><i class="fa-brands fa-github social-icon" aria-hidden="true"></i><span class="absolute inset-0 -z-10 -translate-x-full translate-y-full rounded-xl transition-transform duration-300 group-hover:translate-x-0 group-hover:translate-y-0"></span></a></div><div><a class="social-link flex-center group relative overflow-hidden rounded-xl px-1.5 py-1 transition-all duration-300 group-hover:scale-105" style="--link-color:#4b9ae4" data-platform="x" href="https://x.com/xiaoxueljx?s=21" title="X (推特)" data-tooltip-interactive="false" data-tooltip-placement="top" aria-label="X (推特)"><i class="fa-brands fa-x-twitter social-icon" aria-hidden="true"></i><span class="absolute inset-0 -z-10 -translate-x-full translate-y-full rounded-xl transition-transform duration-300 group-hover:translate-x-0 group-hover:translate-y-0"></span></a></div><div><a class="social-link flex-center group relative overflow-hidden rounded-xl px-1.5 py-1 transition-all duration-300 group-hover:scale-105" style="--link-color:#55acd5" data-platform="email" href="mailto:xuehualjx@gmail.com" title="Email" data-tooltip-interactive="false" data-tooltip-placement="top" aria-label="Email"><i class="fa-regular fa-envelope social-icon" aria-hidden="true"></i><span class="absolute inset-0 -z-10 -translate-x-full translate-y-full rounded-xl transition-transform duration-300 group-hover:translate-x-0 group-hover:translate-y-0"></span></a></div><div><a class="social-link flex-center group relative overflow-hidden rounded-xl px-1.5 py-1 transition-all duration-300 group-hover:scale-105" style="--link-color:#229ed9" data-platform="telegram" href="https://t.me/litleSnow" title="Telegram" data-tooltip-interactive="false" data-tooltip-placement="top" aria-label="Telegram"><i class="fa-brands fa-telegram social-icon" aria-hidden="true"></i><span class="absolute inset-0 -z-10 -translate-x-full translate-y-full rounded-xl transition-transform duration-300 group-hover:translate-x-0 group-hover:translate-y-0"></span></a></div><div><a class="social-link flex-center group relative overflow-hidden rounded-xl px-1.5 py-1 transition-all duration-300 group-hover:scale-105" style="--link-color:#00a1d6" data-platform="bilibili" href="https://space.bilibili.com/158525031" title="哔哩哔哩" data-tooltip-interactive="false" data-tooltip-placement="top" aria-label="哔哩哔哩"><i class="fa-brands fa-bilibili social-icon" aria-hidden="true"></i><span class="absolute inset-0 -z-10 -translate-x-full translate-y-full rounded-xl transition-transform duration-300 group-hover:translate-x-0 group-hover:translate-y-0"></span></a></div></div><div class="text-muted-foreground mt-3 flex justify-center text-center text-sm/4 whitespace-nowrap select-none dark:text-white/80"><a href="/blog" class="hover:text-blue flex cursor-pointer flex-col gap-2 p-1 transition"><span class="text-lg/5 font-bold">45</span>文章</a><div class="bg-muted-foreground mx-3 w-px"></div><a href="/blog/categories" aria-label="分类" class="hover:text-blue"><p class="flex cursor-pointer flex-col gap-2 p-1 transition"><span class="text-lg/5 font-bold">8</span>分类</p></a><div class="bg-muted-foreground mx-3 w-px"></div><a href="/blog/tags" class="hover:text-blue flex cursor-pointer flex-col gap-2 p-1 transition"><span class="text-lg/5 font-bold">76</span>标签</a></div><div class="mt-6 flex w-full flex-col items-center gap-2.5"><a href="/blog" aria-label="首页" class="inline-flex items-center justify-center whitespace-nowrap ring-offset-background focus-visible:outline-hidden focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-gradient-shoka-button px-4 py-2 shoka-button-shadow h-12 w-40 rounded-xl text-base tracking-wider opacity-75 transition-all duration-300 hover:opacity-100 text-muted-foreground/80 hover:bg-muted-foreground/10 bg-none shadow-none hover:shadow-none"><i class="mr-1.5 fa-solid fa-house-chimney" aria-hidden="true"></i>首页</a><div class="bg-foreground/10 flex w-40 flex-col rounded-xl opacity-75 transition-all duration-300 hover:opacity-100" data-collapsible="true"><button class="flex-center hover:bg-foreground/5 h-12 w-full cursor-pointer rounded-xl transition-colors" aria-expanded="false" aria-controls="_r17R_a_-collapse-1" aria-label="文章菜单" type="button"><i class="mr-1.5 fa-solid fa-pen-nib" aria-hidden="true"></i>文章<i class="fa-solid fa-caret-down ml-2 text-base transition-transform duration-300" aria-hidden="true"></i></button><div id="_r17R_a_-collapse-1" class="collapse-content collapse-hidden" data-collapse-content="true"><div class="flex flex-col items-center"><a href="/blog/categories" aria-label="分类" class="inline-flex items-center justify-center whitespace-nowrap ring-offset-background transition-colors focus-visible:outline-hidden focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-gradient-shoka-button px-4 py-2 shoka-button-shadow h-12 w-40 rounded-xl text-base tracking-wider text-muted-foreground/80 hover:bg-muted-foreground/10 bg-none shadow-none hover:shadow-none"><i class="mr-1.5 fa-solid fa-layer-group" aria-hidden="true"></i>分类</a><a href="/blog/tags" aria-label="标签" class="inline-flex items-center justify-center whitespace-nowrap ring-offset-background transition-colors focus-visible:outline-hidden focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-gradient-shoka-button px-4 py-2 shoka-button-shadow h-12 w-40 rounded-xl text-base tracking-wider text-muted-foreground/80 hover:bg-muted-foreground/10 bg-none shadow-none hover:shadow-none"><i class="mr-1.5 fa-solid fa-tags" aria-hidden="true"></i>标签</a><a href="/blog/weekly" aria-label="周刊" class="inline-flex items-center justify-center whitespace-nowrap ring-offset-background transition-colors focus-visible:outline-hidden focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-gradient-shoka-button px-4 py-2 shoka-button-shadow h-12 w-40 rounded-xl text-base tracking-wider text-muted-foreground/80 hover:bg-muted-foreground/10 bg-none shadow-none hover:shadow-none"><i class="mr-1.5 fa-regular fa-newspaper" aria-hidden="true"></i>周刊</a></div></div></div><a href="/blog/friends" aria-label="友链" class="inline-flex items-center justify-center whitespace-nowrap ring-offset-background focus-visible:outline-hidden focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-gradient-shoka-button px-4 py-2 shoka-button-shadow h-12 w-40 rounded-xl text-base tracking-wider opacity-75 transition-all duration-300 hover:opacity-100 text-muted-foreground/80 hover:bg-muted-foreground/10 bg-none shadow-none hover:shadow-none"><i class="mr-1.5 fa-solid fa-link" aria-hidden="true"></i>友链</a><a href="/blog/about" aria-label="关于" class="inline-flex items-center justify-center whitespace-nowrap ring-offset-background focus-visible:outline-hidden focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-gradient-shoka-button px-4 py-2 shoka-button-shadow h-12 w-40 rounded-xl text-base tracking-wider opacity-75 transition-all duration-300 hover:opacity-100 text-muted-foreground/80 hover:bg-muted-foreground/10 bg-none shadow-none hover:shadow-none"><i class="mr-1.5 fa-regular fa-circle-user" aria-hidden="true"></i>关于</a></div></div></div><div class="sider-slot hidden" data-slot-type="directory"><nav class="toc-container " aria-label="文章目录"><div class="space-y-1 pr-2"><div class="heading-tree-item relative"><a href="#前言" class="heading-link group hover:bg-foreground/5 relative flex items-center rounded-md py-2 text-sm transition-all duration-200 hover:border-l-2" style="padding-left:0.75rem;padding-right:0.75rem" data-level="2" aria-label="前言"><span class="heading-text block flex-1 truncate leading-relaxed">前言</span></a></div><div class="heading-tree-item relative"><a href="#性能数据对比" class="heading-link group hover:bg-foreground/5 relative flex items-center rounded-md py-2 text-sm transition-all duration-200 hover:border-l-2" style="padding-left:0.75rem;padding-right:0.75rem" data-level="2" aria-label="性能数据对比"><span class="heading-text block flex-1 truncate leading-relaxed">性能数据对比</span></a></div><div class="heading-tree-item relative"><a href="#核心优化策略" class="heading-link group hover:bg-foreground/5 relative flex items-center rounded-md py-2 text-sm transition-all duration-200 hover:border-l-2" style="padding-left:0.75rem;padding-right:0.5rem" data-level="2" aria-label="核心优化策略"><span class="heading-text block flex-1 truncate leading-relaxed">核心优化策略</span></a></div><div class="heading-tree-item relative"><a href="#常见问题" class="heading-link group hover:bg-foreground/5 relative flex items-center rounded-md py-2 text-sm transition-all duration-200 hover:border-l-2" style="padding-left:0.75rem;padding-right:0.5rem" data-level="2" aria-label="常见问题"><span class="heading-text block flex-1 truncate leading-relaxed">常见问题</span></a></div><div class="heading-tree-item relative"><a href="#总结" class="heading-link group hover:bg-foreground/5 relative flex items-center rounded-md py-2 text-sm transition-all duration-200 hover:border-l-2" style="padding-left:0.75rem;padding-right:0.75rem" data-level="2" aria-label="总结"><span class="heading-text block flex-1 truncate leading-relaxed">总结</span></a></div></div></nav></div><div class="sider-slot hidden" data-slot-type="series"><div class="flex flex-col gap-1"><a href="/blog/post/45" class="group relative flex items-start gap-3 rounded-md px-1 py-2 transition-colors hover:bg-accent/50"><span class="mt-2 h-2 w-2 shrink-0 rounded-full transition-colors bg-muted-foreground/40 group-hover:bg-muted-foreground/60"></span><span class="line-clamp-2 flex-1 text-sm leading-relaxed transition-colors text-foreground group-hover:text-primary">在 RK3528 ARM 开发板上部署 OpenClaw + Telegram Bot 全记录</span></a><a href="/blog/post/38" class="group relative flex items-start gap-3 rounded-md px-1 py-2 transition-colors hover:bg-accent/50"><span class="mt-2 h-2 w-2 shrink-0 rounded-full transition-colors bg-muted-foreground/40 group-hover:bg-muted-foreground/60"></span><span class="line-clamp-2 flex-1 text-sm leading-relaxed transition-colors text-foreground group-hover:text-primary">Rust 树结构中 Rc 与 Weak 的配合使用</span></a><a href="/blog/post/37" class="group relative flex items-start gap-3 rounded-md px-1 py-2 transition-colors hover:bg-accent/50"><span class="mt-2 h-2 w-2 shrink-0 rounded-full transition-colors bg-muted-foreground/40 group-hover:bg-muted-foreground/60"></span><span class="line-clamp-2 flex-1 text-sm leading-relaxed transition-colors text-foreground group-hover:text-primary">Rust Cow（Clone-On-Write）学习笔记：理解 Borrowed 状态</span></a><a href="/blog/post/33" class="group relative flex items-start gap-3 rounded-md px-1 py-2 transition-colors hover:bg-accent/50 text-primary font-medium"><span class="mt-2 h-2 w-2 shrink-0 rounded-full transition-colors bg-primary"></span><span class="line-clamp-2 flex-1 text-sm leading-relaxed transition-colors text-primary">Electron 热更新后启动性能优化：V8 缓存与代码拆包实战</span></a><a href="/blog/post/31" class="group relative flex items-start gap-3 rounded-md px-1 py-2 transition-colors hover:bg-accent/50"><span class="mt-2 h-2 w-2 shrink-0 rounded-full transition-colors bg-muted-foreground/40 group-hover:bg-muted-foreground/60"></span><span class="line-clamp-2 flex-1 text-sm leading-relaxed transition-colors text-foreground group-hover:text-primary">配置 Codex 自定义三方API</span></a><a href="/blog/post/30" class="group relative flex items-start gap-3 rounded-md px-1 py-2 transition-colors hover:bg-accent/50"><span class="mt-2 h-2 w-2 shrink-0 rounded-full transition-colors bg-muted-foreground/40 group-hover:bg-muted-foreground/60"></span><span class="line-clamp-2 flex-1 text-sm leading-relaxed transition-colors text-foreground group-hover:text-primary">React Effect 依赖优化最佳实践</span></a><a href="/blog/post/28" class="group relative flex items-start gap-3 rounded-md px-1 py-2 transition-colors hover:bg-accent/50"><span class="mt-2 h-2 w-2 shrink-0 rounded-full transition-colors bg-muted-foreground/40 group-hover:bg-muted-foreground/60"></span><span class="line-clamp-2 flex-1 text-sm leading-relaxed transition-colors text-foreground group-hover:text-primary">Hexo博客GitHub Actions自动部署配置</span></a><a href="/blog/post/27" class="group relative flex items-start gap-3 rounded-md px-1 py-2 transition-colors hover:bg-accent/50"><span class="mt-2 h-2 w-2 shrink-0 rounded-full transition-colors bg-muted-foreground/40 group-hover:bg-muted-foreground/60"></span><span class="line-clamp-2 flex-1 text-sm leading-relaxed transition-colors text-foreground group-hover:text-primary">NestJs关于循环依赖</span></a><a href="/blog/post/26" class="group relative flex items-start gap-3 rounded-md px-1 py-2 transition-colors hover:bg-accent/50"><span class="mt-2 h-2 w-2 shrink-0 rounded-full transition-colors bg-muted-foreground/40 group-hover:bg-muted-foreground/60"></span><span class="line-clamp-2 flex-1 text-sm leading-relaxed transition-colors text-foreground group-hover:text-primary">关于Vue3如何判断父组件给子组件传了插槽</span></a><a href="/blog/post/25" class="group relative flex items-start gap-3 rounded-md px-1 py-2 transition-colors hover:bg-accent/50"><span class="mt-2 h-2 w-2 shrink-0 rounded-full transition-colors bg-muted-foreground/40 group-hover:bg-muted-foreground/60"></span><span class="line-clamp-2 flex-1 text-sm leading-relaxed transition-colors text-foreground group-hover:text-primary">element-plus表格隐藏行数功能</span></a><a href="/blog/post/23" class="group relative flex items-start gap-3 rounded-md px-1 py-2 transition-colors hover:bg-accent/50"><span class="mt-2 h-2 w-2 shrink-0 rounded-full transition-colors bg-muted-foreground/40 group-hover:bg-muted-foreground/60"></span><span class="line-clamp-2 flex-1 text-sm leading-relaxed transition-colors text-foreground group-hover:text-primary">前端链表运用场景</span></a><a href="/blog/post/22" class="group relative flex items-start gap-3 rounded-md px-1 py-2 transition-colors hover:bg-accent/50"><span class="mt-2 h-2 w-2 shrink-0 rounded-full transition-colors bg-muted-foreground/40 group-hover:bg-muted-foreground/60"></span><span class="line-clamp-2 flex-1 text-sm leading-relaxed transition-colors text-foreground group-hover:text-primary">关于前端数据库indexDB</span></a><a href="/blog/post/21" class="group relative flex items-start gap-3 rounded-md px-1 py-2 transition-colors hover:bg-accent/50"><span class="mt-2 h-2 w-2 shrink-0 rounded-full transition-colors bg-muted-foreground/40 group-hover:bg-muted-foreground/60"></span><span class="line-clamp-2 flex-1 text-sm leading-relaxed transition-colors text-foreground group-hover:text-primary">表格拖拽方法手写</span></a><a href="/blog/post/20" class="group relative flex items-start gap-3 rounded-md px-1 py-2 transition-colors hover:bg-accent/50"><span class="mt-2 h-2 w-2 shrink-0 rounded-full transition-colors bg-muted-foreground/40 group-hover:bg-muted-foreground/60"></span><span class="line-clamp-2 flex-1 text-sm leading-relaxed transition-colors text-foreground group-hover:text-primary">js循环依赖对象深拷贝</span></a><a href="/blog/post/19" class="group relative flex items-start gap-3 rounded-md px-1 py-2 transition-colors hover:bg-accent/50"><span class="mt-2 h-2 w-2 shrink-0 rounded-full transition-colors bg-muted-foreground/40 group-hover:bg-muted-foreground/60"></span><span class="line-clamp-2 flex-1 text-sm leading-relaxed transition-colors text-foreground group-hover:text-primary">JS对象数组深拷贝</span></a><a href="/blog/post/18" class="group relative flex items-start gap-3 rounded-md px-1 py-2 transition-colors hover:bg-accent/50"><span class="mt-2 h-2 w-2 shrink-0 rounded-full transition-colors bg-muted-foreground/40 group-hover:bg-muted-foreground/60"></span><span class="line-clamp-2 flex-1 text-sm leading-relaxed transition-colors text-foreground group-hover:text-primary">CenOS-7.6搭建pptp服务</span></a><a href="/blog/post/17" class="group relative flex items-start gap-3 rounded-md px-1 py-2 transition-colors hover:bg-accent/50"><span class="mt-2 h-2 w-2 shrink-0 rounded-full transition-colors bg-muted-foreground/40 group-hover:bg-muted-foreground/60"></span><span class="line-clamp-2 flex-1 text-sm leading-relaxed transition-colors text-foreground group-hover:text-primary">不到半个月就要变猫了</span></a><a href="/blog/post/16" class="group relative flex items-start gap-3 rounded-md px-1 py-2 transition-colors hover:bg-accent/50"><span class="mt-2 h-2 w-2 shrink-0 rounded-full transition-colors bg-muted-foreground/40 group-hover:bg-muted-foreground/60"></span><span class="line-clamp-2 flex-1 text-sm leading-relaxed transition-colors text-foreground group-hover:text-primary">不知道怎么过年</span></a></div></div></div><div class="border-border mt-4 flex flex-col gap-3 border-t pt-4 md:mt-0 md:pt-2 w-full px-2"><div class="flex items-center justify-between gap-2"><a href="/blog/post/37" class="group flex items-center gap-1.5 rounded-md px-2 py-1.5 transition-colors hover:bg-accent text-muted-foreground hover:text-primary max-w-[45%] min-w-0 flex-1" title="Rust Cow（Clone-On-Write）学习笔记：理解 Borrowed 状态"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" class="h-4 w-4 shrink-0" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M10.8284 12.0007L15.7782 16.9504L14.364 18.3646L8 12.0007L14.364 5.63672L15.7782 7.05093L10.8284 12.0007Z"></path></svg><span class="truncate text-xs">Rust Cow（Clone-On-Write）学习笔记：理解 Borrowed 状态</span></a><a href="/blog/post/31" class="group flex items-center gap-1.5 rounded-md px-2 py-1.5 transition-colors hover:bg-accent text-muted-foreground hover:text-primary max-w-[45%] min-w-0 flex-1 justify-end text-right" title="配置 Codex 自定义三方API"><span class="truncate text-xs">配置 Codex 自定义三方API</span><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" class="h-4 w-4 shrink-0" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M13.1717 12.0007L8.22192 7.05093L9.63614 5.63672L16.0001 12.0007L9.63614 18.3646L8.22192 16.9504L13.1717 12.0007Z"></path></svg></a></div><div class="flex justify-center gap-2"><button class="flex items-center justify-center gap-1.5 rounded-md px-3 py-1.5 transition-colors hover:bg-accent text-muted-foreground hover:text-primary text-xs" title="回到顶部" aria-label="回到顶部"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" class="h-4 w-4" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M11.9999 10.8284L7.0502 15.7782L5.63599 14.364L11.9999 8L18.3639 14.364L16.9497 15.7782L11.9999 10.8284Z"></path></svg>回到顶部</button><button class="flex items-center justify-center gap-1.5 rounded-md px-3 py-1.5 transition-colors hover:bg-accent text-muted-foreground hover:text-primary text-xs" title="滚到底部" aria-label="滚到底部"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" class="h-4 w-4" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M11.9999 13.1714L16.9497 8.22168L18.3639 9.63589L11.9999 15.9999L5.63599 9.63589L7.0502 8.22168L11.9999 13.1714Z"></path></svg>滚到底部</button></div></div><div class="mt-auto w-full rounded-full pt-4 sticky bottom-0"><div class="bg-primary h-1 origin-left rounded-full scale-x-0"></div></div><!--astro:end--></astro-island> </div> </astro-slot></div></div><!--astro:end--></astro-island> <astro-island uid="Mtw1o" prefix="r19" component-url="/_astro/SearchDialogPanel.COWKPNl1.js" component-export="default" renderer-url="/_astro/client.lBR8ML2S.js" props="{}" ssr client="idle" opts="{&quot;name&quot;:&quot;SearchDialogPanel&quot;,&quot;value&quot;:true}" await-children><button id="search-overlay" type="button" data-state="closed" class="fixed inset-0 z-40 bg-black/50 backdrop-blur-sm transition-opacity duration-200 opacity-0 hidden" aria-label="关闭搜索"></button><div id="search-dialog" data-state="closed" class="fixed inset-0 z-50 grid place-items-center px-4 hidden" role="dialog" aria-label="搜索文章" aria-modal="true"><div id="search-dialog-content" class="bg-gradient-start shadow-box w-full max-w-3xl overflow-auto rounded-xl transition-all duration-200 opacity-0"><div class="relative p-6 md:p-3"><div class="search-dialog"><div class="relative mb-4 flex items-center justify-between"><h2 class="flex items-center gap-2 text-lg font-semibold md:text-base"><i class="fa-solid fa-magnifying-glass text-base md:text-sm" aria-hidden="true"></i>搜索文章</h2><button id="search-dialog-close" class="flex size-8 items-center justify-center rounded-full bg-black/5 transition-colors duration-300 hover:bg-black/10 md:size-7 dark:bg-white/10 dark:hover:bg-white/20" aria-label="关闭搜索"><i class="fa-solid fa-xmark text-base md:text-sm" aria-hidden="true"></i></button></div><div id="search-empty-hint" class="search-empty-hint absolute inset-x-0 top-32 text-center text-sm opacity-60 md:top-28"><p>输入关键词搜索博客文章</p><p class="mt-1 text-xs">按<!-- --> <kbd class="rounded bg-black/10 px-1.5 py-0.5 font-mono dark:bg-white/10">ESC</kbd> <!-- -->关闭</p></div><div class="vertical-scrollbar scroll-feather-mask -mx-6 h-[calc(80dvh-140px)] overflow-auto scroll-smooth px-6 pb-10 md:-mx-3 md:h-[calc(80dvh-120px)] md:px-3"><div id="search-dialog-container"></div></div></div><div class="bg-background/2 absolute inset-x-0 bottom-0 z-10 flex items-center justify-center gap-4 px-4 pt-2 pb-4 text-xs text-black/50 dark:border-white/10 dark:text-white/50"><span><kbd class="kbd">↑↓</kbd> 选择</span><span><kbd class="kbd">Enter</kbd> 打开</span><span><kbd class="kbd">ESC</kbd> 关闭</span></div></div></div></div><!--astro:end--></astro-island>  <!-- 遮罩层 --><div id="code-fullscreen-overlay" data-state="closed" class="fixed inset-0 z-40 bg-black/80 opacity-0 backdrop-blur-sm transition-opacity duration-200 data-[state=closed]:hidden" role="presentation" aria-hidden="true"></div> <!-- 代码全屏对话框 --> <div id="code-fullscreen-dialog" data-state="closed" class="fixed inset-0 z-50 grid place-items-center px-4 data-[state=closed]:hidden" role="dialog" aria-label="代码全屏预览" aria-modal="true"> <div id="code-fullscreen-content" class="bg-background relative flex h-[85vh] w-[90vw] max-w-6xl flex-col overflow-hidden rounded-xl opacity-0 shadow-2xl transition-opacity duration-200 md:max-w-[90vw]"> <!-- Toolbar --> <div class="border-border bg-muted/50 flex shrink-0 items-center justify-between border-b px-4 py-3 backdrop-blur-sm"> <div class="flex items-center gap-3"> <div class="flex gap-2"> <span class="h-3 w-3 rounded-full bg-[#ff5f56]"></span> <span class="h-3 w-3 rounded-full bg-[#ffbd2e]"></span> <span class="h-3 w-3 rounded-full bg-[#27c93f]"></span> </div> <span id="code-fullscreen-language" class="text-muted-foreground font-mono text-xs font-medium tracking-wider uppercase">
text
</span> </div> <div class="flex items-center gap-1"> <button id="code-fullscreen-copy" class="text-muted-foreground hover:bg-accent hover:text-accent-foreground flex items-center gap-2 rounded-md px-3 py-1.5 transition-colors"> <!-- Copy icon --> <svg id="code-fullscreen-copy-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 448 512" fill="currentColor"> <path d="M192 0c-35.3 0-64 28.7-64 64l0 256c0 35.3 28.7 64 64 64l192 0c35.3 0 64-28.7 64-64l0-200.6c0-17.4-7.1-34.1-19.7-46.2L370.6 17.8C358.7 6.4 342.8 0 326.3 0L192 0zM64 128c-35.3 0-64 28.7-64 64L0 448c0 35.3 28.7 64 64 64l192 0c35.3 0 64-28.7 64-64l0-16-64 0 0 16-192 0 0-256 16 0 0-64-16 0z"></path> </svg> <!-- Checkmark icon (hidden by default) --> <svg id="code-fullscreen-check-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" class="hidden"> <mask id="checkmark-anim-fullscreen"> <g fill="none" stroke="#fff" stroke-dasharray="24" stroke-dashoffset="24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"> <path d="M2 13.5l4 4l10.75 -10.75"> <animate fill="freeze" attributeName="stroke-dashoffset" dur="0.4s" values="24;0"></animate> </path> <path stroke="#000" stroke-width="6" d="M7.5 13.5l4 4l10.75 -10.75"> <animate fill="freeze" attributeName="stroke-dashoffset" begin="0.4s" dur="0.4s" values="24;0"></animate> </path> <path d="M7.5 13.5l4 4l10.75 -10.75"> <animate fill="freeze" attributeName="stroke-dashoffset" begin="0.4s" dur="0.4s" values="24;0"></animate> </path> </g> </mask> <rect width="24" height="24" fill="currentColor" mask="url(#checkmark-anim-fullscreen)"></rect> </svg> <span id="code-fullscreen-copy-text" class="text-sm">复制</span> </button> <button id="code-fullscreen-close" class="text-muted-foreground hover:bg-accent hover:text-accent-foreground rounded-md p-2 transition-colors" aria-label="关闭"> <i class="fa-solid fa-xmark text-base" aria-hidden="true"></i> </button> </div> </div> <!-- Code Content --> <div class="scroll-feather-mask flex-1 overflow-auto"> <pre id="code-fullscreen-pre" class="p-4"><code id="code-fullscreen-code"></code></pre> </div> </div> </div> <script type="module" src="/_astro/CodeBlockFullscreen.astro_astro_type_script_index_0_lang.D8IoU9fp.js"></script> <!-- Overlay --><div id="mermaid-fullscreen-overlay" data-state="closed" class="fixed inset-0 z-40 bg-black/80 opacity-0 backdrop-blur-sm transition-opacity duration-200 data-[state=closed]:hidden" role="presentation" aria-hidden="true"></div> <!-- Mermaid Fullscreen Dialog --> <div id="mermaid-fullscreen-dialog" data-state="closed" class="fixed inset-0 z-50 grid place-items-center px-4 data-[state=closed]:hidden" role="dialog" aria-label="Mermaid diagram fullscreen" aria-modal="true"> <div id="mermaid-fullscreen-content" class="bg-background relative flex h-[85vh] w-[90vw] max-w-6xl flex-col overflow-hidden rounded-xl opacity-0 shadow-2xl transition-opacity duration-200 md:max-w-[90vw]"> <!-- Toolbar --> <div class="border-border bg-muted/50 flex shrink-0 items-center justify-between border-b px-4 py-3 backdrop-blur-sm"> <div class="flex items-center gap-3"> <div class="flex gap-2"> <span class="h-3 w-3 rounded-full bg-[#ff5f56]"></span> <span class="h-3 w-3 rounded-full bg-[#ffbd2e]"></span> <span class="h-3 w-3 rounded-full bg-[#27c93f]"></span> </div> <span class="text-muted-foreground font-mono text-xs font-medium tracking-wider uppercase"> mermaid </span> </div> <div class="flex items-center gap-1"> <!-- Zoom info --> <span id="mermaid-zoom-level" class="text-muted-foreground mr-2 text-sm">100%</span> <!-- Reset zoom button --> <button id="mermaid-fullscreen-reset" class="text-muted-foreground hover:bg-accent hover:text-accent-foreground flex items-center gap-2 rounded-md px-3 py-1.5 transition-colors" title="Reset zoom"> <i class="fa-solid fa-rotate-right text-sm" aria-hidden="true"></i> </button> <!-- Copy button --> <button id="mermaid-fullscreen-copy" class="text-muted-foreground hover:bg-accent hover:text-accent-foreground flex items-center gap-2 rounded-md px-3 py-1.5 transition-colors"> <svg id="mermaid-fullscreen-copy-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 448 512" fill="currentColor"> <path d="M192 0c-35.3 0-64 28.7-64 64l0 256c0 35.3 28.7 64 64 64l192 0c35.3 0 64-28.7 64-64l0-200.6c0-17.4-7.1-34.1-19.7-46.2L370.6 17.8C358.7 6.4 342.8 0 326.3 0L192 0zM64 128c-35.3 0-64 28.7-64 64L0 448c0 35.3 28.7 64 64 64l192 0c35.3 0 64-28.7 64-64l0-16-64 0 0 16-192 0 0-256 16 0 0-64-16 0z"></path> </svg> <svg id="mermaid-fullscreen-check-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" class="hidden"> <mask id="checkmark-anim-mermaid-fullscreen"> <g fill="none" stroke="#fff" stroke-dasharray="24" stroke-dashoffset="24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"> <path d="M2 13.5l4 4l10.75 -10.75"> <animate fill="freeze" attributeName="stroke-dashoffset" dur="0.4s" values="24;0"></animate> </path> <path stroke="#000" stroke-width="6" d="M7.5 13.5l4 4l10.75 -10.75"> <animate fill="freeze" attributeName="stroke-dashoffset" begin="0.4s" dur="0.4s" values="24;0"></animate> </path> <path d="M7.5 13.5l4 4l10.75 -10.75"> <animate fill="freeze" attributeName="stroke-dashoffset" begin="0.4s" dur="0.4s" values="24;0"></animate> </path> </g> </mask> <rect width="24" height="24" fill="currentColor" mask="url(#checkmark-anim-mermaid-fullscreen)"></rect> </svg> <span id="mermaid-fullscreen-copy-text" class="text-sm">Copy</span> </button> <!-- Close button --> <button id="mermaid-fullscreen-close" class="text-muted-foreground hover:bg-accent hover:text-accent-foreground rounded-md p-2 transition-colors" aria-label="Close"> <i class="fa-solid fa-xmark text-base" aria-hidden="true"></i> </button> </div> </div> <!-- SVG Container with zoom/pan --> <div id="mermaid-fullscreen-viewport" class="flex flex-1 cursor-grab items-center justify-center overflow-hidden active:cursor-grabbing"> <div id="mermaid-fullscreen-svg" class="mermaid-svg-container origin-center transition-transform duration-100"></div> </div> </div> </div> <script type="module" src="/_astro/MermaidFullscreen.astro_astro_type_script_index_0_lang.ChF_LWWE.js"></script> </div> </body></html>